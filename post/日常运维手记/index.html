<!doctype html><html lang=zh-cn dir=content/zh-cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv=content-security-policy content="upgrade-insecure-requests"><title>日常运维手记 - 热爱生活与梦想</title><meta name=keywords content="博客,程序员,容器,云原生"><meta name=author content="xshrim"><meta property="og:title" content="日常运维手记"><meta property="og:site_name" content="热爱生活与梦想"><meta property="og:image" content="/img/author.jpg"><meta name=title content="日常运维手记 - 热爱生活与梦想"><meta name=description content="运维备忘录"><link rel="shortcut icon" href=/img/favicon.ico><link rel=apple-touch-icon href=/img/apple-touch-icon.png><link rel=apple-touch-icon-precomposed href=/img/apple-touch-icon.png><link href=//cdn.bootcdn.net/ajax/libs/font-awesome/4.6.2/css/font-awesome.min.css rel=stylesheet type=text/css><link href=//cdn.bootcdn.net/ajax/libs/imageviewer/0.1.0/viewer.min.css rel=stylesheet><link href=/css/main.css rel=stylesheet type=text/css><link href=/css/syntax.css rel=stylesheet type=text/css><link href=/css/copycode.css rel=stylesheet type=text/css><script type=text/javascript>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?Your BaiduSiteId",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script><script async src="https://www.googletagmanager.com/gtag/js?id=Your%20GoogleSiteId"></script>
<script type=text/javascript>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","Your GoogleSiteId ")</script></head><body itemscope itemtype=http://schema.org/WebPage lang=zh-hans><div class="container one-collumn sidebar-position-left page-home"><div class=headband></div><header id=header class=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class=site-brand-container><div class=site-nav-toggle><div class=toggle role=button style=opacity:1;top:0><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div></div><div class=site-meta><div class=multi-lang-switch><i class="fa fa-fw fa-language" style=margin-right:5px></i>
<a class=lang-link id=zh-cn href=#>中文</a></div><div class=custom-logo-site-title><a href=/ class=brand rel=start><span class=logo-line-before><i></i></span>
<span class=site-title>热爱生活与梦想</span>
<span class=logo-line-after><i></i></span></a></div><p class=site-subtitle>没有伞的孩子要学会努力奔跑!</p></div><div class=site-nav-right><div class="toggle popup-trigger" style=opacity:1;top:0><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class=site-nav><ul id=menu class=menu><li class=menu-item><a href=/ rel=section><i class="menu-item-icon fa fa-fw fa-home"></i><br>首页</a></li><li class=menu-item><a href=/post rel=section><i class="menu-item-icon fa fa-fw fa-archive"></i><br>归档</a></li><li class=menu-item><a href=/about.html rel=section><i class="menu-item-icon fa fa-fw fa-user"></i><br>关于我</a></li><li class=menu-item><a href=/404.html rel=section><i class="menu-item-icon fa fa-fw fa-heartbeat"></i><br>公益404</a></li><li class="menu-item menu-item-search"><a href=javascript:; class=popup-trigger><i class="menu-item-icon fa fa-search fa-fw"></i><br>搜索</a></li></ul><div class=site-search><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class=search-icon><i class="fa fa-search"></i></span>
<span class=popup-btn-close><i class="fa fa-times-circle"></i></span><div class=local-search-input-wrapper><input autocomplete=off placeholder=搜索关键字... spellcheck=false type=text id=local-search-input autocapitalize=none autocorrect=off></div></div><div id=local-search-result></div></div></div></nav></div></header><main id=main class=main><div class=main-inner><div class=content-wrap><div id=content class=content><section id=posts class=posts-expand><article class="post post-type-normal" itemscope itemtype=http://schema.org/Article><header class=post-header><h1 class=post-title itemprop="name headline"><a class=post-title-link href=https://xshrim.github.io/post/%E6%97%A5%E5%B8%B8%E8%BF%90%E7%BB%B4%E6%89%8B%E8%AE%B0/ itemprop=url>日常运维手记</a></h1><div class=post-meta><span class=post-time><i class="fa fa-calendar-o fa-fw"></i>
<span class=post-meta-item-text>时间：</span>
<time itemprop=dateCreated datetime=2016-03-22T13:04:35+08:00 content="2021-08-08">2021-08-08</time></span>
<span class=post-category>&nbsp; | &nbsp;
<i class="fa fa-folder-o fa-fw"></i>
<span class=post-meta-item-text>分类：</span>
<span itemprop=about itemscope itemtype=https://schema.org/Thing><a href=/categories/ops itemprop=url rel=index style=text-decoration:underline><span itemprop=name>ops</span></a>
&nbsp;</span></span>
<span>|
<i class="fa fa-file-word-o fa-fw"></i>
<span class=post-meta-item-text>字数：</span>
<span class=leancloud-world-count>95364 字</span></span>
<span>|
<i class="fa fa-eye fa-fw"></i>
<span class=post-meta-item-text>阅读：</span>
<span class=leancloud-view-count>191分钟</span></span>
<span id=/post/%E6%97%A5%E5%B8%B8%E8%BF%90%E7%BB%B4%E6%89%8B%E8%AE%B0/ class=leancloud_visitors data-flag-title=日常运维手记>|
<i class="fa fa-binoculars fa-fw"></i>
<span class=post-meta-item-text>阅读次数：</span>
<span class=leancloud-visitors-count></span></span></div></header><div class=post-body itemprop=articleBody><h2 id=运维命令>运维命令</h2><h3 id=进程信息>进程信息</h3><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#080;font-style:italic># 查看进程基本信息</span>
</span></span><span style=display:flex><span>ps -fp &lt;pid&gt;
</span></span><span style=display:flex><span>ps aux | grep &lt;pid&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 进程跟踪</span>
</span></span><span style=display:flex><span>strace -p &lt;pid&gt;
</span></span><span style=display:flex><span>gdb -p &lt;pid&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 查看进程打开文件</span>
</span></span><span style=display:flex><span>lsof -p &lt;pid&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 查看进程中线程资源占用</span>
</span></span><span style=display:flex><span>ps -mp &lt;pid&gt; -o THREAD,tid,time  <span style=color:#080;font-style:italic># jstack &lt;pid&gt; &gt; log</span>
</span></span><span style=display:flex><span><span style=color:#a2f>printf</span> <span style=color:#b44>&#34;%x&#34;</span> &lt;tid&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 查看进程cpu用量</span>
</span></span><span style=display:flex><span>pidstat -p &lt;pid&gt; -u <span style=color:#666>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 查看进程内存用量</span>
</span></span><span style=display:flex><span>pidsta -p &lt;pid&gt; -r <span style=color:#666>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 查看进程磁盘用量</span>
</span></span><span style=display:flex><span>pidsta -p &lt;pid&gt; -d <span style=color:#666>1</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=系统信息>系统信息</h3><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#080;font-style:italic># 查看cpu</span>
</span></span><span style=display:flex><span>top -n <span style=color:#666>1</span>
</span></span><span style=display:flex><span>vmstat -n <span style=color:#666>2</span> <span style=color:#666>3</span>
</span></span><span style=display:flex><span>mpstat -P ALL <span style=color:#666>2</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 查看内存</span>
</span></span><span style=display:flex><span>free -h
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 查看磁盘读写性能</span>
</span></span><span style=display:flex><span>iostat -d -x -k <span style=color:#666>1</span> <span style=color:#666>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 查看网络</span>
</span></span><span style=display:flex><span>ifconfig
</span></span><span style=display:flex><span>ifstat <span style=color:#666>1</span>
</span></span><span style=display:flex><span>ip a
</span></span><span style=display:flex><span>ip r
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 查看目录下大文件</span>
</span></span><span style=display:flex><span>find ./ -type f -size +1G -print0|xargs -0 du -sh
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 查看系统日志</span>
</span></span><span style=display:flex><span>cat /var/log/messages
</span></span><span style=display:flex><span>journalctl -b
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 查看内核日志</span>
</span></span><span style=display:flex><span>dmesg -T
</span></span><span style=display:flex><span>journalctl -k 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 按服务/进程/用户查看日志</span>
</span></span><span style=display:flex><span>journalctl --no-pager <span style=color:#080;font-style:italic># 不分页</span>
</span></span><span style=display:flex><span>journalctl -n <span style=color:#666>20</span> <span style=color:#080;font-style:italic># 近20条</span>
</span></span><span style=display:flex><span>journalctl -f <span style=color:#080;font-style:italic># 持续监控日志输出</span>
</span></span><span style=display:flex><span>journalctl -u httpd -o  json-pretty <span style=color:#080;font-style:italic># 指定输出格式</span>
</span></span><span style=display:flex><span>journalctl -u httpd.service --since yesterday
</span></span><span style=display:flex><span>journalctl <span style=color:#b8860b>_UID</span><span style=color:#666>=</span><span style=color:#666>33</span> httpd.service --since <span style=color:#b44>&#34;20 min ago&#34;</span>
</span></span><span style=display:flex><span>journalctl <span style=color:#b8860b>_PID</span><span style=color:#666>=</span><span style=color:#666>8088</span> httpd.service --since 09:00 --until <span style=color:#b44>&#34;1 hour ago&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 查看dns服务器域名</span>
</span></span><span style=display:flex><span>dig @dnsserver -t AXFR &lt;domain&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 查看日志文件中指定时间段内容</span>
</span></span><span style=display:flex><span>sed -n <span style=color:#b44>&#34;/2021-08-12 10:20:01/,/2021-08-12 10:30:01/p&#34;</span> &lt;logfile&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 使用nmon进行系统监控和分析</span>
</span></span><span style=display:flex><span>nmon -f result.nmon -t -s <span style=color:#666>30</span> -c <span style=color:#666>100</span>  <span style=color:#080;font-style:italic># 可以使用nmon analyzer或者nmon visualizer对文件可视化分析</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=网络信息>网络信息</h3><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">63
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">64
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#080;font-style:italic># 跟踪网络</span>
</span></span><span style=display:flex><span>traceroute google.com
</span></span><span style=display:flex><span>mtr -r -c <span style=color:#666>50</span> google.com
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 域名解析</span>
</span></span><span style=display:flex><span>host baidu.com
</span></span><span style=display:flex><span>nslookup -type<span style=color:#666>=</span>mx baidu.com 8.8.8.8
</span></span><span style=display:flex><span>dig @8.8.8.8 baidu.com CNAME
</span></span><span style=display:flex><span>dig -p <span style=color:#666>5533</span> @8.8.8.8 baidu.com <span style=color:#080;font-style:italic># 指定dnsserver端口</span>
</span></span><span style=display:flex><span>dig baidu.com +trace <span style=color:#080;font-style:italic># 跟踪解析</span>
</span></span><span style=display:flex><span>dig -x 8.8.8.8 <span style=color:#080;font-style:italic># 反向解析</span>
</span></span><span style=display:flex><span>dig baidu.com +short <span style=color:#080;font-style:italic># 简化输出</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 主机探测</span>
</span></span><span style=display:flex><span>ping &lt;ip&gt;
</span></span><span style=display:flex><span>nc -zv -w <span style=color:#666>1</span> &lt;ip&gt; &lt;port&gt;
</span></span><span style=display:flex><span><span style=color:#a2f>echo</span> -e <span style=color:#b44>&#39;\035\nquit&#39;</span> | telnet &lt;ip&gt; &lt;port&gt;
</span></span><span style=display:flex><span>nmap -p &lt;port-range&gt; &lt;ip&gt; <span style=color:#080;font-style:italic># 端口扫描</span>
</span></span><span style=display:flex><span>nmap -vv &lt;ip&gt; <span style=color:#080;font-style:italic># 详细输出</span>
</span></span><span style=display:flex><span>namp -sP &lt;ip&gt; <span style=color:#080;font-style:italic># ping扫描</span>
</span></span><span style=display:flex><span>nmap -traceroute &lt;ip&gt; <span style=color:#080;font-style:italic># 路由跟踪</span>
</span></span><span style=display:flex><span>nmap -sP 192.168.0.1/24 <span style=color:#080;font-style:italic># 地址段扫描</span>
</span></span><span style=display:flex><span>nmap -O &lt;ip&gt; <span style=color:#080;font-style:italic># 操作系统探测</span>
</span></span><span style=display:flex><span>nmap -A &lt;ip&gt; <span style=color:#080;font-style:italic># 万能开关扫描</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># api检测</span>
</span></span><span style=display:flex><span> curl -ksvIL http://&lt;ip&gt;:&lt;port&gt;/&lt;path&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 查看tcp连接概览</span>
</span></span><span style=display:flex><span>netstat -nat |awk <span style=color:#b44>&#39;{print $6}&#39;</span>|sort|uniq -c|sort -rn
</span></span><span style=display:flex><span>netstat -n | awk <span style=color:#b44>&#39;/^tcp/ {++S[$NF]};END {for(a in S) print a, S[a]}&#39;</span>
</span></span><span style=display:flex><span>netstat -n | awk <span style=color:#b44>&#39;/^tcp/ {++state[$NF]}; END {for(key in state) print key,&#34;\t&#34;,state[key]}&#39;</span>
</span></span><span style=display:flex><span>netstat -n | awk <span style=color:#b44>&#39;/^tcp/ {++arr[$NF]};END {for(k in arr) print k,&#34;\t&#34;,arr[k]}&#39;</span>
</span></span><span style=display:flex><span>netstat -n |awk <span style=color:#b44>&#39;/^tcp/ {print $NF}&#39;</span>|sort|uniq -c|sort -rn 
</span></span><span style=display:flex><span>netstat -ant | awk <span style=color:#b44>&#39;{print $NF}&#39;</span> | grep -v <span style=color:#b44>&#39;[a-z]&#39;</span> | sort | uniq -c
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 查找较多time_wait连接</span>
</span></span><span style=display:flex><span>netstat -n|grep TIME_WAIT|awk <span style=color:#b44>&#39;{print $5}&#39;</span>|sort|uniq -c|sort -rn|head -n20
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 找查较多的SYN连接</span>
</span></span><span style=display:flex><span>netstat -an | grep SYN | awk <span style=color:#b44>&#39;{print $5}&#39;</span> | awk -F: <span style=color:#b44>&#39;{print $1}&#39;</span> | sort | uniq -c | sort -nr | more
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 查找请求数前20的IP</span>
</span></span><span style=display:flex><span>netstat -anlp|grep 80|grep tcp|awk <span style=color:#b44>&#39;{print $5}&#39;</span>|awk -F: <span style=color:#b44>&#39;{print $1}&#39;</span>|sort|uniq -c|sort -nr|head -n20
</span></span><span style=display:flex><span>netstat -ant |awk <span style=color:#b44>&#39;/:80/{split($5,ip,&#34;:&#34;);++A[ip[1]]}END{for(i in A) print A[i],i}&#39;</span> |sort -rn|head -n20
</span></span><span style=display:flex><span>tcpdump -i eth0 -tnn dst port <span style=color:#666>80</span> -c <span style=color:#666>1000</span> | awk -F<span style=color:#b44>&#34;.&#34;</span> <span style=color:#b44>&#39;{print $1&#34;.&#34;$2&#34;.&#34;$3&#34;.&#34;$4}&#39;</span> | sort | uniq -c | sort -nr |head -20
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 根据端口列出进程</span>
</span></span><span style=display:flex><span>netstat -ntlp | grep <span style=color:#666>80</span> | awk <span style=color:#b44>&#39;{print $7}&#39;</span> | cut -d/ -f1
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># ss命令</span>
</span></span><span style=display:flex><span>ss -t -a <span style=color:#080;font-style:italic># tcp连接</span>
</span></span><span style=display:flex><span>ss -u -a <span style=color:#080;font-style:italic># udp连接</span>
</span></span><span style=display:flex><span>ss -s <span style=color:#080;font-style:italic># socket摘要</span>
</span></span><span style=display:flex><span>ss -l <span style=color:#080;font-style:italic># 打开的端口</span>
</span></span><span style=display:flex><span>ss -pl <span style=color:#080;font-style:italic># 进程端口</span>
</span></span><span style=display:flex><span>ss -o state established <span style=color:#b44>&#39;( dport = :smtp or sport = :smtp )&#39;</span>  <span style=color:#080;font-style:italic># 建立的smtp连接</span>
</span></span><span style=display:flex><span>ss -o state established <span style=color:#b44>&#39;( dport = :http or sport = :http )&#39;</span>  <span style=color:#080;font-style:italic># 建立的http连接</span>
</span></span><span style=display:flex><span>ss -4 state &lt;state&gt; <span style=color:#080;font-style:italic># 指定状态的ipv4连接(established,syn-sent,syn-recv,fin-wait-1,fin-wait-2,time-wait,closed,close-wait,last-ack,listen,closing</span>
</span></span><span style=display:flex><span>ss dst &lt;ip&gt;:&lt;protocal&gt; <span style=color:#080;font-style:italic># 过滤连接(dst,src)</span>
</span></span><span style=display:flex><span>ss dst 192.168.1.5
</span></span><span style=display:flex><span>ss dst 192.168.119.113:http 
</span></span><span style=display:flex><span>ss dst 192.168.119.113:smtp 
</span></span><span style=display:flex><span>ss dst 192.168.119.113:443
</span></span></code></pre></td></tr></table></div></div><h3 id=日志分析>日志分析</h3><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#080;font-style:italic># 获得访问前10位的ip地址</span>
</span></span><span style=display:flex><span>cat access.log|awk <span style=color:#b44>&#39;{print $1}&#39;</span>|sort|uniq -c|sort -nr|head -10
</span></span><span style=display:flex><span>cat access.log|awk <span style=color:#b44>&#39;{counts[$(11)]+=1}; END {for(url in counts) print counts[url], url}&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 访问次数最多的文件或页面,取前20</span>
</span></span><span style=display:flex><span>cat access.log|awk <span style=color:#b44>&#39;{print $11}&#39;</span>|sort|uniq -c|sort -nr|head -20
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 列出传输最大的几个exe文件（分析下载站的时候常用）</span>
</span></span><span style=display:flex><span>cat access.log |awk <span style=color:#b44>&#39;($7~/\.exe/){print $10 &#34; &#34; $1 &#34; &#34; $4 &#34; &#34; $7}&#39;</span>|sort -nr|head -20
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 列出输出大于200000byte(约200kb)的exe文件以及对应文件发生次数</span>
</span></span><span style=display:flex><span>cat access.log |awk <span style=color:#b44>&#39;($10 &gt; 200000 &amp;&amp; $7~/\.exe/){print $7}&#39;</span>|sort -n|uniq -c|sort -nr|head -100
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 如果日志最后一列记录的是页面文件传输时间，则有列出到客户端最耗时的页面</span>
</span></span><span style=display:flex><span>cat access.log |awk  <span style=color:#b44>&#39;($7~/\.php/){print $NF &#34; &#34; $1 &#34; &#34; $4 &#34; &#34; $7}&#39;</span>|sort -nr|head -100
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 列出最最耗时的页面(超过60秒的)的以及对应页面发生次数</span>
</span></span><span style=display:flex><span>cat access.log |awk <span style=color:#b44>&#39;($NF &gt; 60 &amp;&amp; $7~/\.php/){print $7}&#39;</span>|sort -n|uniq -c|sort -nr|head -100
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 列出传输时间超过 30 秒的文件</span>
</span></span><span style=display:flex><span>cat access.log |awk <span style=color:#b44>&#39;($NF &gt; 30){print $7}&#39;</span>|sort -n|uniq -c|sort -nr|head -20
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 统计网站流量（G)</span>
</span></span><span style=display:flex><span>cat access.log |awk <span style=color:#b44>&#39;{sum+=$10} END {print sum/1024/1024/1024}&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 统计404的连接</span>
</span></span><span style=display:flex><span>awk <span style=color:#b44>&#39;($9 ~/404/)&#39;</span> access.log | awk <span style=color:#b44>&#39;{print $9,$7}&#39;</span> | sort
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 统计http status.</span>
</span></span><span style=display:flex><span>cat access.log |awk <span style=color:#b44>&#39;{counts[$(9)]+=1}; END {for(code in counts) print code, counts[code]}&#39;</span>
</span></span><span style=display:flex><span>cat access.log |awk <span style=color:#b44>&#39;{print $9}&#39;</span>|sort|uniq -c|sort -rn
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 蜘蛛分析查看是哪些蜘蛛在抓取内容</span>
</span></span><span style=display:flex><span>tcpdump -i eth0 -l -s <span style=color:#666>0</span> -w - dst port <span style=color:#666>80</span> | strings | grep -i user-agent | grep -i -E <span style=color:#b44>&#39;bot|crawler|slurp|spider&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 按域统计流量</span>
</span></span><span style=display:flex><span>zcat squid_access.log.tar.gz| awk <span style=color:#b44>&#39;{print $10,$7}&#39;</span> |awk <span style=color:#b44>&#39;BEGIN{FS=&#34;[ /]&#34;}{trfc[$4]+=$1}END{for(domain in trfc){printf &#34;%s\t%d\n&#34;,domain,trfc[domain]}}&#39;</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=抓包分析>抓包分析</h3><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>tcpdump -i any
</span></span><span style=display:flex><span>tcpdump net 192.168.1.0/24
</span></span><span style=display:flex><span>tcpdump -i eth0 -vnn host 172.16.1.122
</span></span><span style=display:flex><span>tcpdump -i eth0 -vnn net 172.16.1.0/24
</span></span><span style=display:flex><span>tcpdump -i eth0 -vnn portrange 22-50
</span></span><span style=display:flex><span>tcpdump -i eth0 -vnn  udp
</span></span><span style=display:flex><span>tcpdump -i eth0 -vnn icmp
</span></span><span style=display:flex><span>tcpdump -i eth0 -vnn arp
</span></span><span style=display:flex><span>tcpdump -i eth0 -vnn ip
</span></span><span style=display:flex><span>tcpdump -i any -nn <span style=color:#b44>&#34;ip[16] == 10&#34;</span>
</span></span><span style=display:flex><span>tcpdump -i any -nn <span style=color:#b44>&#34;ip[16] == 192 and ip[17] == 168 and ip[18] == 1 and ip[19] &gt; 9 and ip[19] &lt; 101&#34;</span>
</span></span><span style=display:flex><span>tcpdump -i eth0 -vnn src host 172.16.1.122
</span></span><span style=display:flex><span>tcpdump -i eth0 -vnn dst host 172.16.1.122
</span></span><span style=display:flex><span>tcpdump -i eth0 -vnn src port <span style=color:#666>22</span>
</span></span><span style=display:flex><span>tcpdump -i eth0 -vnn src host 172.16.1.253 and dst port <span style=color:#666>22</span>
</span></span><span style=display:flex><span>tcpdump -i eth0 -vnn src host 172.16.1.122 or port <span style=color:#666>22</span>
</span></span><span style=display:flex><span>tcpdump -i eth0 -vnn src host 172.16.1.122 and not port <span style=color:#666>22</span>
</span></span><span style=display:flex><span>tcpdump -i  eth0 -vnn <span style=color:#b44>&#34;src host 172.16.1.59 and dst port 22&#34;</span> or  <span style=color:#b44>&#34; src host 172.16.1.68 and dst port 80 &#34;</span>
</span></span><span style=display:flex><span>tcpdump –i eth0 -vnn -w  /tmp/fill.cap -c <span style=color:#666>100</span>
</span></span><span style=display:flex><span>tcpdump –i eth0 -vnn -r  /tmp/fill.cap tcp
</span></span><span style=display:flex><span>tcpdump –i eth0 -vnn -r  /tmp/fill.cap host  172.16.1.58
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># tcpdump -i eth0 &#34;((tcp) and (port 80) and ((dst host 10.10.1.254) or (dst host 10.10.1.200)))&#34;</span>
</span></span><span style=display:flex><span>tcpdump -i eth0 -vn dst host foo.bar
</span></span><span style=display:flex><span>tcpdump -i eth0 host foo.bar and not port <span style=color:#666>80</span> and not port <span style=color:#666>25</span>
</span></span><span style=display:flex><span>tcpdump -i eth0 <span style=color:#b44>&#34;tcp[(tcp[12]&gt;&gt;2):4] = 0x47455420&#34;</span>
</span></span><span style=display:flex><span>tcpdump -i eth0 <span style=color:#b44>&#34;tcp[20:2]=0x4745 or tcp[20:2]=0x4854&#34;</span>
</span></span><span style=display:flex><span>tcpdump -s <span style=color:#666>0</span> -A <span style=color:#b44>&#34;tcp dst port 80 and tcp[((tcp[12:1] &amp; 0xf0) &gt;&gt; 2):4] = 0x47455420&#34;</span>
</span></span><span style=display:flex><span>tcpdump -s <span style=color:#666>0</span> -A <span style=color:#b44>&#34;tcp dst port 443 and (tcp[((tcp[12:1] &amp; 0xf0) &gt;&gt; 2):4] = 0x504f5354)&#34;</span>
</span></span><span style=display:flex><span>tcpdump -i any -s <span style=color:#666>0</span> -A <span style=color:#b44>&#34;tcp dst port 80 or tcp dst port 443 and tcp[((tcp[12:1] &amp; 0xf0) &gt;&gt; 2):4] = 0x47455420 or tcp[((tcp[12:1] &amp; 0xf0) &gt;&gt; 2):4] = 0x504F5354&#34;</span> and host 192.168.10.1
</span></span><span style=display:flex><span>tcpdump -i any -s <span style=color:#666>0</span> -nnvvvXS -A <span style=color:#b44>&#34;tcp dst port 8000 and tcp[((tcp[12:1] &amp; 0xf0) &gt;&gt; 2):4] = 0x47455420&#34;</span>
</span></span><span style=display:flex><span>tcpdump -i eth0 <span style=color:#b44>&#34;tcp[(tcp[12]&gt;&gt;2):4] = 0x5353482D&#34;</span>
</span></span><span style=display:flex><span>tcpdump -i eth0 <span style=color:#b44>&#34;tcp[((tcp[12:1] &amp; 0xf0) &gt;&gt; 2):4] = 0x48545450 &amp;&amp; tcp[((tcp[12:1] &amp; 0xf0) &gt;&gt; 2) + 4:2] = 0x2f31 &amp;&amp; tcp[((tcp[12:1] &amp; 0xf0) &gt;&gt; 2) + 6:1] = 0x2e&#34;</span>
</span></span><span style=display:flex><span>tcpdump -i eth0 udp dst port <span style=color:#666>53</span>
</span></span><span style=display:flex><span>tcpdump -i eth0 tcp
</span></span><span style=display:flex><span>tcpdump -i eth0 <span style=color:#b44>&#34;ip[2:2] &gt; 600&#34;</span>
</span></span><span style=display:flex><span>tcpdump -i eth0 <span style=color:#b44>&#34;tcp[0:2] &gt; 1024&#34;</span>
</span></span><span style=display:flex><span>tcpdump -i eth0 <span style=color:#b44>&#34;tcp[tcpflags] &amp; (tcp-syn|tcp-ack) != 0&#34;</span>
</span></span><span style=display:flex><span>tcpdump -i any -s <span style=color:#666>0</span> -v -n -l | egrep -i <span style=color:#b44>&#34;POST / | GET / | Host:&#34;</span>
</span></span><span style=display:flex><span>tcpdump -i any -s <span style=color:#666>0</span> -A -n -l | egrep -i <span style=color:#b44>&#34;POST /|pwd=|passwd=|password=|Host:&#34;</span>
</span></span><span style=display:flex><span>tcpdump -i any -nn -A -s0 -l | egrep -i <span style=color:#b44>&#34;Set-Cookie|Host:|Cookie:&#34;</span>
</span></span><span style=display:flex><span>tcpdump -vvAls0 | grep <span style=color:#b44>&#34;User-Agent:&#34;</span>
</span></span><span style=display:flex><span><span style=color:#a2f>time</span> tcpdump -nn -i eth0 <span style=color:#b44>&#34;tcp[tcpflags] = tcp-syn&#34;</span> -c <span style=color:#666>10000</span> &gt; /dev/null
</span></span><span style=display:flex><span>tcpdump -i any -nn -c <span style=color:#666>10000</span> port <span style=color:#666>443</span> &gt; tcpdump.log
</span></span><span style=display:flex><span>cat tcpdump.log | awk <span style=color:#b44>&#34;{print </span><span style=color:#b8860b>$3</span><span style=color:#b44>}&#34;</span> | awk -F <span style=color:#b44>&#34;.&#34;</span> <span style=color:#b44>&#34;{print </span><span style=color:#b8860b>$1</span><span style=color:#b44>&#34;</span>.<span style=color:#b44>&#34;</span><span style=color:#b8860b>$2</span><span style=color:#b44>&#34;</span>.<span style=color:#b44>&#34;</span><span style=color:#b8860b>$3</span><span style=color:#b44>&#34;</span>.<span style=color:#b44>&#34;</span><span style=color:#b8860b>$4</span><span style=color:#b44>}&#34;</span> | sort | uniq -c | sort -rn
</span></span><span style=display:flex><span>nohup tcpdump -i eth0 port <span style=color:#666>22</span> -s0 -G <span style=color:#666>3600</span> -Z root -w ssh22_%Y_%m%d_%H%M_%S.pcap &amp;
</span></span></code></pre></td></tr></table></div></div><h3 id=数据库分析>数据库分析</h3><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#080;font-style:italic># 查看数据库执行的sql</span>
</span></span><span style=display:flex><span>/usr/sbin/tcpdump -i eth0 -s <span style=color:#666>0</span> -l -w - dst port <span style=color:#666>3306</span> | strings | egrep -i <span style=color:#b44>&#39;SELECT|UPDATE|DELETE|INSERT|SET|COMMIT|ROLLBACK|CREATE|DROP|ALTER|CALL&#39;</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=容器分析>容器分析</h3><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#080;font-style:italic># 查看docker信息</span>
</span></span><span style=display:flex><span>docker info
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 查看镜像构建</span>
</span></span><span style=display:flex><span>docker <span style=color:#a2f>history</span> --no-trunc &lt;mid&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 查看容器信息</span>
</span></span><span style=display:flex><span>docker inspect &lt;cid&gt;
</span></span><span style=display:flex><span>docker inspect --format<span style=color:#666>=</span><span style=color:#b44>&#39;{{.LogPath}}&#39;</span> &lt;cid&gt; <span style=color:#080;font-style:italic># 指定查看的内容</span>
</span></span><span style=display:flex><span>docker inspect --format<span style=color:#666>=</span><span style=color:#b44>&#39;{{range .NetworkSettings.Networks}}{{.MacAddress}}{{end}}&#39;</span> &lt;cid&gt; <span style=color:#080;font-style:italic># 指定查看的内容</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 查看容器资源占用</span>
</span></span><span style=display:flex><span>docker top &lt;cid&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 查看容器内进程资源占用</span>
</span></span><span style=display:flex><span>docker stats &lt;cid&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 查看docker资源占用</span>
</span></span><span style=display:flex><span>docker system df -v
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 查看容器内大文件</span>
</span></span><span style=display:flex><span>find /var/lib/docker/overlay2/ -type f -size +1G -print0|xargs -0 du -sh
</span></span></code></pre></td></tr></table></div></div><h3 id=jvm分析>JVM分析</h3><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#080;font-style:italic># 查看当前机器上所有运行的java进程及参数信息</span>
</span></span><span style=display:flex><span>jps -lvm
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 查看指定的jvm进程所有的属性设置和配置参数</span>
</span></span><span style=display:flex><span>jinfo &lt;pid&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 查看某个pid进程对应的应用程序内存占用情况</span>
</span></span><span style=display:flex><span>jmap -heap &lt;pid&gt;                         <span style=color:#080;font-style:italic># 获取堆概要信息</span>
</span></span><span style=display:flex><span>jmap -histo &lt;pid&gt;                        <span style=color:#080;font-style:italic># 打印堆内类实例统计信息</span>
</span></span><span style=display:flex><span>jcmd &lt;pid&gt; -all GC.class_histogram       <span style=color:#080;font-style:italic># 等同上条</span>
</span></span><span style=display:flex><span>jmap -histo:live &lt;pid&gt;                   <span style=color:#080;font-style:italic># 只打印类实例存活对象</span>
</span></span><span style=display:flex><span>jcmd &lt;pid&gt; GC.class_histogram            <span style=color:#080;font-style:italic># 等同上条</span>
</span></span><span style=display:flex><span>jmap -F -dump:format<span style=color:#666>=</span>b,file<span style=color:#666>=</span>&lt;filepath&gt;   <span style=color:#080;font-style:italic># dump堆信息到指定文件</span>
</span></span><span style=display:flex><span>jcmd &lt;pid&gt; GC.heap_dump -all &lt;filepath&gt;  <span style=color:#080;font-style:italic># 等同上条</span>
</span></span><span style=display:flex><span>jmap -dump:live,format<span style=color:#666>=</span>b,file<span style=color:#666>=</span>&lt;filepath&gt; <span style=color:#080;font-style:italic># 只dump存活对象</span>
</span></span><span style=display:flex><span>jcmd &lt;pid&gt; GC.heap_dump &lt;filepath&gt;       <span style=color:#080;font-style:italic># 等同上条</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 查看进程所包含所有线程的Java堆栈信息</span>
</span></span><span style=display:flex><span>jstak -l &lt;pid&gt;  <span style=color:#080;font-style:italic># 打印锁信息</span>
</span></span><span style=display:flex><span>jcmd &lt;pid&gt; Thread.print -l <span style=color:#080;font-style:italic># 等同上条</span>
</span></span><span style=display:flex><span>jstack -F &lt;pid&gt; <span style=color:#080;font-style:italic># 强制打印到标准输出</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 实时监测系统资源占用与jvm运行情况</span>
</span></span><span style=display:flex><span>jstat -class -t &lt;pid&gt; <span style=color:#666>1000</span> <span style=color:#666>5</span>  <span style=color:#080;font-style:italic># 类加载</span>
</span></span><span style=display:flex><span>jstat -gc -t &lt;pid&gt; <span style=color:#666>1000</span> <span style=color:#666>5</span>     <span style=color:#080;font-style:italic># 垃圾回收</span>
</span></span><span style=display:flex><span>jstat -gcutil -t &lt;pid&gt; <span style=color:#666>1000</span> <span style=color:#666>5</span> <span style=color:#080;font-style:italic># 垃圾回收</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 以GUI的方式更直观化呈现jvm进程的实时情况</span>
</span></span><span style=display:flex><span>jconsole
</span></span></code></pre></td></tr></table></div></div><h2 id=运维工具>运维工具</h2><h3 id=ansible>Ansible</h3><p><strong>基于python的无agent自动化运维工具</strong></p><h4 id=基本用法>基本用法</h4><h5 id=安装相关>安装相关</h5><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>yum -y install epel-release
</span></span><span style=display:flex><span>yum list all *ansible*
</span></span><span style=display:flex><span>yum info ansible
</span></span><span style=display:flex><span>yum -y install ansible    
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 使用帮助</span>
</span></span><span style=display:flex><span>ansible-doc -l                <span style=color:#080;font-style:italic># 列出ansible所有的模块</span>
</span></span><span style=display:flex><span>ansible-doc -s MODULE_NAME    <span style=color:#080;font-style:italic># 查看指定模块具体适用</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 免密配置</span>
</span></span><span style=display:flex><span>ssh-keygen -t rsa 
</span></span><span style=display:flex><span>ssh-copy-id -i /root/.ssh/id_rsa.pub root@192.168.10.149
</span></span><span style=display:flex><span>ssh-copy-id -i /root/.ssh/id_rsa.pub root@192.168.10.113
</span></span><span style=display:flex><span>ssh-copy-id -i /root/.ssh/id_rsa.pub root@127.0.0.1
</span></span></code></pre></td></tr></table></div></div><h5 id=配置文件>配置文件</h5><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>/etc/ansible/ansible.cfg    <span style=color:#080;font-style:italic># 主配置文件</span>
</span></span><span style=display:flex><span>/etc/ansible/hosts          <span style=color:#080;font-style:italic># Inventory主机清单(与主配置格式相同)</span>
</span></span><span style=display:flex><span>/usr/bin/ansible-doc        <span style=color:#080;font-style:italic># 帮助文件</span>
</span></span><span style=display:flex><span>/usr/bin/ansible-playbook   <span style=color:#080;font-style:italic># 指定运行任务文件</span>
</span></span></code></pre></td></tr></table></div></div><ul><li><p>ansible.cfg参数</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#080;font-style:italic># 一般连接</span>
</span></span><span style=display:flex><span>ansible_ssh_host     <span style=color:#080;font-style:italic># 用于指定被管理的主机的真实IP</span>
</span></span><span style=display:flex><span>ansible_ssh_port     <span style=color:#080;font-style:italic># 用于指定连接到被管理主机的ssh端口号, 默认是22</span>
</span></span><span style=display:flex><span>ansible_ssh_user     <span style=color:#080;font-style:italic># ssh连接时默认使用的用户名</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 特定ssh连接</span>
</span></span><span style=display:flex><span>ansible_connection     <span style=color:#080;font-style:italic># ssh连接的类型: local, ssh, paramiko, 在ansible 1.2之前默认是paramiko, 后来智能选择, 优先使用基于ControlPersist的ssh</span>
</span></span><span style=display:flex><span>ansible_ssh_pass       <span style=color:#080;font-style:italic># ssh连接时的密码</span>
</span></span><span style=display:flex><span>ansible_ssh_private_key_file  <span style=color:#080;font-style:italic># 秘钥文件路径, 如果不想使用ssh-agent管理秘钥文件时可以使用此选项</span>
</span></span><span style=display:flex><span>ansible_ssh_executable  <span style=color:#080;font-style:italic># 如果ssh指令不在默认路径当中, 可以使用该变量来定义其路径</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 特权升级</span>
</span></span><span style=display:flex><span>ansible_become      <span style=color:#080;font-style:italic># 相当于ansible_sudo或者ansible_su, 允许强制特权升级</span>
</span></span><span style=display:flex><span>ansible_become_user <span style=color:#080;font-style:italic># 通过特权升级到的用户, 相当于ansible_sudo_user或者ansible_su_user</span>
</span></span><span style=display:flex><span>ansible_become_pass <span style=color:#080;font-style:italic># 提升特权时, 如果需要密码的话, 可以通过该变量指定, 相当于ansible_sudo_pass或者ansible_su_pass</span>
</span></span><span style=display:flex><span>ansible_sudo_exec   <span style=color:#080;font-style:italic># 如果sudo命令不在默认路径, 需要指定sudo命令路径</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 远程主机环境参数</span>
</span></span><span style=display:flex><span>ansible_shell_executable       <span style=color:#080;font-style:italic># 设置目标机上使用的shell, 默认为/bin/sh</span>
</span></span><span style=display:flex><span>ansible_python_interpreter     <span style=color:#080;font-style:italic># 用来指定python解释器的路径, 默认为/usr/bin/python同样可以指定ruby 、perl的路径</span>
</span></span><span style=display:flex><span>ansible_*_interpreter          <span style=color:#080;font-style:italic># 其他解释器路径, 用法与ansible_python_interpreter类似, 这里&#34;*&#34;可以是ruby或才perl等其他语言</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p>Inventory主机清单配置</p><ul><li><p>INI格式</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#080;font-style:italic># 给服务器分组, 组名只能用 [a-zA-Z0-9_]</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 直接指定登录凭证</span>
</span></span><span style=display:flex><span><span style=color:#666>[</span>database<span style=color:#666>]</span>
</span></span><span style=display:flex><span>10.1.1.1 <span style=color:#b8860b>ansible_ssh_port</span><span style=color:#666>=</span><span style=color:#666>22</span> <span style=color:#b8860b>ansible_ssh_user</span><span style=color:#666>=</span><span style=color:#b44>&#34;root&#34;</span> <span style=color:#b8860b>ansible_ssh_pass</span><span style=color:#666>=</span><span style=color:#b44>&#34;redhat&#34;</span>
</span></span><span style=display:flex><span>10.1.1.2 <span style=color:#b8860b>ansible_ssh_port</span><span style=color:#666>=</span><span style=color:#666>22</span> <span style=color:#b8860b>ansible_ssh_user</span><span style=color:#666>=</span><span style=color:#b44>&#34;root&#34;</span> <span style=color:#b8860b>ansible_ssh_pass</span><span style=color:#666>=</span><span style=color:#b44>&#34;redhat&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#666>[</span>clusterA<span style=color:#666>]</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 指定一个数字范围</span>
</span></span><span style=display:flex><span>192.168.1.1<span style=color:#666>[</span>01:50<span style=color:#666>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#666>[</span>clusterB<span style=color:#666>]</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 指定一个字母表范围</span>
</span></span><span style=display:flex><span>worker<span style=color:#666>[</span>01:30<span style=color:#666>]</span>.k8s.local
</span></span><span style=display:flex><span>worker-<span style=color:#666>[</span>a:h<span style=color:#666>]</span>.k8s.local
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 主机组嵌套</span>
</span></span><span style=display:flex><span><span style=color:#666>[</span>kubernetes:children<span style=color:#666>]</span>
</span></span><span style=display:flex><span>clusterA
</span></span><span style=display:flex><span>clusterB
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># kubernetes组的公用参数</span>
</span></span><span style=display:flex><span><span style=color:#666>[</span>kubernetes:vars<span style=color:#666>]</span>
</span></span><span style=display:flex><span><span style=color:#b8860b>ntp_server</span><span style=color:#666>=</span>ntp.svc.local
</span></span><span style=display:flex><span><span style=color:#b8860b>proxy</span><span style=color:#666>=</span>proxy.svc.local
</span></span><span style=display:flex><span><span style=color:#b8860b>foo</span><span style=color:#666>=</span>bar                          <span style=color:#080;font-style:italic># 变量名foo, 值bar, 由组内成员共享</span>
</span></span><span style=display:flex><span><span style=color:#b8860b>ansible_connection</span><span style=color:#666>=</span>network_cli   <span style=color:#080;font-style:italic># 2.5版本后推出新的连接方式, 代替provider</span>
</span></span><span style=display:flex><span><span style=color:#b8860b>ansible_network_os</span><span style=color:#666>=</span>ios           <span style=color:#080;font-style:italic># 告知ansible是基于ios的系统</span>
</span></span><span style=display:flex><span><span style=color:#b8860b>ansible_ssh_port</span><span style=color:#666>=</span><span style=color:#666>22</span>              <span style=color:#080;font-style:italic># ssh端口</span>
</span></span><span style=display:flex><span><span style=color:#b8860b>ansible_ssh_user</span><span style=color:#666>=</span>root            <span style=color:#080;font-style:italic># ssh用户</span>
</span></span><span style=display:flex><span><span style=color:#b8860b>ansible_ssh_pass</span><span style=color:#666>=</span><span style=color:#b44>&#34;cisco&#34;</span>         <span style=color:#080;font-style:italic># ssh密码</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#666>[</span>app<span style=color:#666>]</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 给服务器指定别名（git）, 通过关键字参数指定其他参数</span>
</span></span><span style=display:flex><span>git <span style=color:#b8860b>ansible_host</span><span style=color:#666>=</span>git.svc.local <span style=color:#b8860b>ansible_port</span><span style=color:#666>=</span><span style=color:#666>225</span>  <span style=color:#b8860b>ansible_ssh_private_key_file</span><span style=color:#666>=</span>&lt;path/to/git-server-ssh&gt;
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 使用指定的账号密码（危险！）</span>
</span></span><span style=display:flex><span>tester <span style=color:#b8860b>ansible_host</span><span style=color:#666>=</span>tester.svc.local <span style=color:#b8860b>ansible_user</span><span style=color:#666>=</span>root <span style=color:#b8860b>ansible_password</span><span style=color:#666>=</span>xxx
</span></span></code></pre></td></tr></table></div></div></li><li><p>YAML模式</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#00f;font-weight:700>---</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>database</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>hosts</span>:<span style=color:#bbb> </span><span style=color:#666>192.168.1.1</span>[<span style=color:#666>01</span>:<span style=color:#666>50</span>]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>k8s_cluster</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>hosts</span>:<span style=color:#bbb> </span><span style=color:#080;font-style:italic># 没有别名的服务器</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>worker[01:30].k8s.local</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>worker-[a:h].k8s.local</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>vars</span>:<span style=color:#bbb>  </span><span style=color:#080;font-style:italic># 公共的参数</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>ntp_server</span>:<span style=color:#bbb> </span>ntp.svc.local<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>proxy</span>:<span style=color:#bbb> </span>proxy.svc.local<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>hosts</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>git</span>:<span style=color:#bbb>  </span><span style=color:#080;font-style:italic># 服务器别名</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>ansible_host</span>:<span style=color:#bbb> </span>git.svc.local <span style=color:#bbb> </span><span style=color:#080;font-style:italic># 如果未定义, 默认以别名为host.(即git)</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>ansible_port</span>:<span style=color:#bbb> </span><span style=color:#666>225</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>ansible_ssh_private_key_file</span>:<span style=color:#bbb> </span>&lt;path/to/git-server-ssh&gt;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>tester</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>ansible_host</span>:<span style=color:#bbb> </span>tester.svc.local<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>ansible_user</span>:<span style=color:#bbb> </span>root<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>ansible_password</span>:<span style=color:#bbb> </span>xxx <span style=color:#bbb> </span><span style=color:#080;font-style:italic># 危险!尽量不要写明文密码</span><span style=color:#bbb>
</span></span></span></code></pre></td></tr></table></div></div></li></ul></li></ul><h5 id=命令说明>命令说明</h5><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 37
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 38
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 39
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 40
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 41
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 42
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 43
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 44
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 45
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 46
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 47
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 48
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 49
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 50
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 51
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 52
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 53
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 54
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 55
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 56
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 57
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 58
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 59
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 60
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 61
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 62
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 63
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 64
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 65
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 66
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 67
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 68
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 69
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 70
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 71
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 72
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 73
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 74
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 75
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 76
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 77
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 78
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 79
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 80
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 81
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 82
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 83
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 84
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 85
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 86
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 87
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 88
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 89
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 90
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 91
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 92
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 93
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 94
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 95
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 96
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 97
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 98
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 99
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">100
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">101
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">102
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">103
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">104
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">105
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">106
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">107
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">108
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">109
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">110
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">111
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">112
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">113
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">114
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">115
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">116
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">117
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">118
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">119
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">120
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">121
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">122
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">123
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">124
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">125
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">126
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">127
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">128
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">129
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">130
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">131
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">132
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">133
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">134
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">135
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">136
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">137
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">138
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">139
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">140
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">141
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">142
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">143
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">144
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">145
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">146
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">147
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">148
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">149
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">150
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">151
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">152
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">153
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">154
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">155
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">156
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">157
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">158
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">159
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">160
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">161
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">162
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">163
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">164
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">165
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">166
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">167
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">168
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">169
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">170
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>  语法: ansible &lt;host-pattern&gt; <span style=color:#666>[</span>arguments<span style=color:#666>]</span> <span style=color:#666>[</span>-f forks<span style=color:#666>]</span> <span style=color:#666>[</span>-m module_name<span style=color:#666>]</span> <span style=color:#666>[</span>-a args<span style=color:#666>]</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  &lt;host-pattern&gt;  这次命令对哪些主机生效的
</span></span><span style=display:flex><span>    inventory group name
</span></span><span style=display:flex><span>    ip
</span></span><span style=display:flex><span>    all
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  &lt;arguments&gt;
</span></span><span style=display:flex><span>    -a MODULE_ARGS, --args<span style=color:#666>=</span>MODULE_ARGS    
</span></span><span style=display:flex><span>        <span style=color:#080;font-style:italic># module arguments</span>
</span></span><span style=display:flex><span>        <span style=color:#080;font-style:italic># 指定执行模块使用的参数  </span>
</span></span><span style=display:flex><span>    --ask-vault-pass      
</span></span><span style=display:flex><span>        <span style=color:#080;font-style:italic># ask for vault password</span>
</span></span><span style=display:flex><span>        <span style=color:#080;font-style:italic># 加密playbook文件时提示输入密码</span>
</span></span><span style=display:flex><span>    -B SECONDS, --background<span style=color:#666>=</span>SECONDS
</span></span><span style=display:flex><span>        <span style=color:#080;font-style:italic># run asynchronously, failing after X seconds(default=N/A)</span>
</span></span><span style=display:flex><span>        <span style=color:#080;font-style:italic># 后台运行超时时间, 异步运行, X秒之后失败</span>
</span></span><span style=display:flex><span>    -C, --check           
</span></span><span style=display:flex><span>        <span style=color:#080;font-style:italic># don&#39;t make any changes; instead, try to predict some of the changes that may occur</span>
</span></span><span style=display:flex><span>        <span style=color:#080;font-style:italic># 模拟执行, 不会真正在机器上执行(查看执行会产生什么变化)</span>
</span></span><span style=display:flex><span>    -D, --diff            
</span></span><span style=display:flex><span>        <span style=color:#080;font-style:italic># when changing (small) files and templates, show the differences in those files; works great with --check</span>
</span></span><span style=display:flex><span>        <span style=color:#080;font-style:italic># 当更新的文件数及内容较少时, 该选项可显示这些文件不同的地方, 该选项结合-C用会有较好的效果</span>
</span></span><span style=display:flex><span>    -e EXTRA_VARS, --extra-vars<span style=color:#666>=</span>EXTRA_VARS
</span></span><span style=display:flex><span>        <span style=color:#080;font-style:italic># set additional variables as key=value or YAML/JSON</span>
</span></span><span style=display:flex><span>        <span style=color:#080;font-style:italic># 执行命令时添加额外参数变量</span>
</span></span><span style=display:flex><span>    -f FORKS, --forks<span style=color:#666>=</span>FORKS
</span></span><span style=display:flex><span>        <span style=color:#080;font-style:italic># specify number of parallel processes to use(default=5)</span>
</span></span><span style=display:flex><span>        <span style=color:#080;font-style:italic># 并行任务数. FORKS被指定为一个整数, 默认是5</span>
</span></span><span style=display:flex><span>    -h, --help            
</span></span><span style=display:flex><span>        <span style=color:#080;font-style:italic># show this help message and exit</span>
</span></span><span style=display:flex><span>        <span style=color:#080;font-style:italic># 打开帮助文档API</span>
</span></span><span style=display:flex><span>    -i INVENTORY, --inventory-file<span style=color:#666>=</span>INVENTORY
</span></span><span style=display:flex><span>        <span style=color:#080;font-style:italic># specify inventory host path(default=/etc/ansible/hosts) or comma separated host list.</span>
</span></span><span style=display:flex><span>        <span style=color:#080;font-style:italic># 指定要读取的Inventory文件</span>
</span></span><span style=display:flex><span>    -l SUBSET, --limit<span style=color:#666>=</span>SUBSET
</span></span><span style=display:flex><span>        <span style=color:#080;font-style:italic># further limit selected hosts to an additional pattern</span>
</span></span><span style=display:flex><span>        <span style=color:#080;font-style:italic># 限定执行的主机范围</span>
</span></span><span style=display:flex><span>    --list-hosts          
</span></span><span style=display:flex><span>        <span style=color:#080;font-style:italic># outputs a list of matching hosts; does not execute anything else</span>
</span></span><span style=display:flex><span>        <span style=color:#080;font-style:italic># 列出执行匹配到的主机, 但并不会执行</span>
</span></span><span style=display:flex><span>    -m MODULE_NAME, --module-name<span style=color:#666>=</span>MODULE_NAME
</span></span><span style=display:flex><span>        <span style=color:#080;font-style:italic># module name to execute (default=command)</span>
</span></span><span style=display:flex><span>        <span style=color:#080;font-style:italic># 指定执行使用的模块, 默认使用 command</span>
</span></span><span style=display:flex><span>    -M MODULE_PATH, --module-path<span style=color:#666>=</span>MODULE_PATH
</span></span><span style=display:flex><span>        <span style=color:#080;font-style:italic># specify path(s) to module library (default=None)</span>
</span></span><span style=display:flex><span>        <span style=color:#080;font-style:italic># 要执行的模块的路径</span>
</span></span><span style=display:flex><span>    --new-vault-password-file<span style=color:#666>=</span>NEW_VAULT_PASSWORD_FILE
</span></span><span style=display:flex><span>        <span style=color:#080;font-style:italic># new vault password file for rekey</span>
</span></span><span style=display:flex><span>        <span style=color:#080;font-style:italic># 新vault密码文件</span>
</span></span><span style=display:flex><span>    -o, --one-line        
</span></span><span style=display:flex><span>        <span style=color:#080;font-style:italic># condense output</span>
</span></span><span style=display:flex><span>        <span style=color:#080;font-style:italic>#压缩输出, 摘要输出. 尝试一切都在一行上输出</span>
</span></span><span style=display:flex><span>    --output<span style=color:#666>=</span>OUTPUT_FILE  
</span></span><span style=display:flex><span>        <span style=color:#080;font-style:italic>#output file name for encrypt or decrypt; use - for stdout</span>
</span></span><span style=display:flex><span>        <span style=color:#080;font-style:italic># 输出文件</span>
</span></span><span style=display:flex><span>    -P POLL_INTERVAL, --poll<span style=color:#666>=</span>POLL_INTERVAL
</span></span><span style=display:flex><span>        <span style=color:#080;font-style:italic># set the poll interval if using -B (default=15)</span>
</span></span><span style=display:flex><span>        <span style=color:#080;font-style:italic># 设置轮询间隔, 每隔数秒. 需要- B</span>
</span></span><span style=display:flex><span>    --syntax-check        
</span></span><span style=display:flex><span>        <span style=color:#080;font-style:italic># perform a syntax check on the playbook, but do not execute it</span>
</span></span><span style=display:flex><span>        <span style=color:#080;font-style:italic># 检查Playbook中的语法书写</span>
</span></span><span style=display:flex><span>    -t TREE, --tree<span style=color:#666>=</span>TREE  
</span></span><span style=display:flex><span>        <span style=color:#080;font-style:italic># log output to this directory</span>
</span></span><span style=display:flex><span>        <span style=color:#080;font-style:italic># 将日志内容保存在该输出目录,结果保存在一个文件中在每台主机上</span>
</span></span><span style=display:flex><span>    --vault-password-file<span style=color:#666>=</span>VAULT_PASSWORD_FILE
</span></span><span style=display:flex><span>        <span style=color:#080;font-style:italic># vault password file</span>
</span></span><span style=display:flex><span>        <span style=color:#080;font-style:italic># vault密码文件</span>
</span></span><span style=display:flex><span>    -v, --verbose         
</span></span><span style=display:flex><span>        <span style=color:#080;font-style:italic># verbose mode (-vvv for more, -vvvv to enable connection debugging)</span>
</span></span><span style=display:flex><span>        <span style=color:#080;font-style:italic># 执行详细输出</span>
</span></span><span style=display:flex><span>    --version             
</span></span><span style=display:flex><span>        <span style=color:#080;font-style:italic># show program&#39;s version number and exit</span>
</span></span><span style=display:flex><span>        <span style=color:#080;font-style:italic># 显示版本</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    Connection Options:
</span></span><span style=display:flex><span>      control as whom and how to connect to hosts
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>      -k, --ask-pass      
</span></span><span style=display:flex><span>          <span style=color:#080;font-style:italic># ask for connection password</span>
</span></span><span style=display:flex><span>          <span style=color:#080;font-style:italic># 要求输入连接密码</span>
</span></span><span style=display:flex><span>      --private-key<span style=color:#666>=</span>PRIVATE_KEY_FILE, --key-file<span style=color:#666>=</span>PRIVATE_KEY_FILE
</span></span><span style=display:flex><span>          <span style=color:#080;font-style:italic># use this file to authenticate the connection</span>
</span></span><span style=display:flex><span>          <span style=color:#080;font-style:italic># ssh连接私钥文件</span>
</span></span><span style=display:flex><span>      -u REMOTE_USER, --user<span style=color:#666>=</span>REMOTE_USER
</span></span><span style=display:flex><span>          <span style=color:#080;font-style:italic># connect as this user (default=None)</span>
</span></span><span style=display:flex><span>          <span style=color:#080;font-style:italic># 指定远程主机以USERNAME运行命令</span>
</span></span><span style=display:flex><span>      -c CONNECTION, --connection<span style=color:#666>=</span>CONNECTION
</span></span><span style=display:flex><span>          <span style=color:#080;font-style:italic># connection type to use (default=smart)</span>
</span></span><span style=display:flex><span>          <span style=color:#080;font-style:italic># 指定连接方式, 可用选项paramiko (SSH)、ssh、local, local方式常用于crontab和kickstarts</span>
</span></span><span style=display:flex><span>      -T TIMEOUT, --timeout<span style=color:#666>=</span>TIMEOUT
</span></span><span style=display:flex><span>          <span style=color:#080;font-style:italic># override the connection timeout in seconds(default=10)</span>
</span></span><span style=display:flex><span>          <span style=color:#080;font-style:italic># ssh连接超时时间设定, 默认10s</span>
</span></span><span style=display:flex><span>      --ssh-common-args<span style=color:#666>=</span>SSH_COMMON_ARGS
</span></span><span style=display:flex><span>          <span style=color:#080;font-style:italic># specify common arguments to pass to sftp/scp/ssh (e.g.ProxyCommand)</span>
</span></span><span style=display:flex><span>          <span style=color:#080;font-style:italic># ssh通用参数</span>
</span></span><span style=display:flex><span>      --sftp-extra-args<span style=color:#666>=</span>SFTP_EXTRA_ARGS
</span></span><span style=display:flex><span>          <span style=color:#080;font-style:italic># specify extra arguments to pass to sftp only (e.g. -f, -l)</span>
</span></span><span style=display:flex><span>          <span style=color:#080;font-style:italic># sftp额外参数</span>
</span></span><span style=display:flex><span>      --scp-extra-args<span style=color:#666>=</span>SCP_EXTRA_ARGS
</span></span><span style=display:flex><span>          <span style=color:#080;font-style:italic>#specify extra arguments to pass to scp only (e.g. -l)</span>
</span></span><span style=display:flex><span>          <span style=color:#080;font-style:italic># scp额外参数</span>
</span></span><span style=display:flex><span>      --ssh-extra-args<span style=color:#666>=</span>SSH_EXTRA_ARGS
</span></span><span style=display:flex><span>          <span style=color:#080;font-style:italic># specify extra arguments to pass to ssh only (e.g. -R)</span>
</span></span><span style=display:flex><span>          <span style=color:#080;font-style:italic># ssh额外参数</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    Privilege Escalation Options:
</span></span><span style=display:flex><span>      control how and which user you become as on target hosts
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>      -s, --sudo          
</span></span><span style=display:flex><span>          <span style=color:#080;font-style:italic># run operations with sudo (nopasswd) (deprecated, use become)</span>
</span></span><span style=display:flex><span>          <span style=color:#080;font-style:italic># 相当于Linux系统下的sudo命令</span>
</span></span><span style=display:flex><span>      -U SUDO_USER, --sudo-user<span style=color:#666>=</span>SUDO_USER
</span></span><span style=display:flex><span>          <span style=color:#080;font-style:italic># desired sudo user (default=root) (deprecated, use become)</span>
</span></span><span style=display:flex><span>          <span style=color:#080;font-style:italic># 使用sudo, 相当于Linux下的sudo命令</span>
</span></span><span style=display:flex><span>      -S, --su            
</span></span><span style=display:flex><span>          <span style=color:#080;font-style:italic># run operations with su (deprecated, use become)</span>
</span></span><span style=display:flex><span>          <span style=color:#080;font-style:italic># su模式运行(过时, 请使用become)</span>
</span></span><span style=display:flex><span>      -R SU_USER, --su-user<span style=color:#666>=</span>SU_USER
</span></span><span style=display:flex><span>          <span style=color:#080;font-style:italic># run operations with su as this user (default=root) (deprecated, use become)</span>
</span></span><span style=display:flex><span>          <span style=color:#080;font-style:italic># su模式使用的用户(过时, 使用become)</span>
</span></span><span style=display:flex><span>     -b, --become        
</span></span><span style=display:flex><span>          <span style=color:#080;font-style:italic># run operations with become (does not imply password prompting)</span>
</span></span><span style=display:flex><span>          <span style=color:#080;font-style:italic># su模式运行</span>
</span></span><span style=display:flex><span>      --become-method<span style=color:#666>=</span>BECOME_METHOD
</span></span><span style=display:flex><span>          <span style=color:#080;font-style:italic># privilege escalation method to use (default=sudo),valid choices: [ sudo | su | pbrun | pfexec | doas |dzdo | ksu | runas ]</span>
</span></span><span style=display:flex><span>          <span style=color:#080;font-style:italic># su模式方法</span>
</span></span><span style=display:flex><span>      --become-user<span style=color:#666>=</span>BECOME_USER
</span></span><span style=display:flex><span>          <span style=color:#080;font-style:italic># run operations as this user (default=root)</span>
</span></span><span style=display:flex><span>          <span style=color:#080;font-style:italic># su模式使用的用户</span>
</span></span><span style=display:flex><span>      --ask-sudo-pass     
</span></span><span style=display:flex><span>          <span style=color:#080;font-style:italic># ask for sudo password (deprecated, use become)</span>
</span></span><span style=display:flex><span>          <span style=color:#080;font-style:italic># 要求输入sudo密码</span>
</span></span><span style=display:flex><span>      --ask-su-pass       
</span></span><span style=display:flex><span>          <span style=color:#080;font-style:italic># ask for su password (deprecated, use become)</span>
</span></span><span style=display:flex><span>          <span style=color:#080;font-style:italic># 要求输入su密码(过时, 使用become)</span>
</span></span><span style=display:flex><span>      -K, --ask-become-pass
</span></span><span style=display:flex><span>          <span style=color:#080;font-style:italic># ask for privilege escalation password</span>
</span></span><span style=display:flex><span>          <span style=color:#080;font-style:italic># 要求输入su密码</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  &lt;modules&gt;
</span></span><span style=display:flex><span>    ping: 检查指定节点机器是否还能连通
</span></span><span style=display:flex><span>    raw: 执行原始的命令, 而不是通过模块子系统
</span></span><span style=display:flex><span>    yum: RedHat和CentOS的软件包安装和管理工具
</span></span><span style=display:flex><span>    apt: Ubuntu/Debian的软件包安装和管理工具
</span></span><span style=display:flex><span>    pip : 用于管理Python库依赖项, 为了使用pip模块, 必须提供参数name或者requirements
</span></span><span style=display:flex><span>    synchronize: 使用rsync同步文件, 将主控方目录推送到指定节点的目录下
</span></span><span style=display:flex><span>    template: 基于模板方式生成一个文件复制到远程主机进行文档内变量的替换的模块
</span></span><span style=display:flex><span>    copy: 在远程主机执行复制操作文件
</span></span><span style=display:flex><span>    user 与 group: 请求useradd, userdel, usermod, groupadd, groupdel, groupmod
</span></span><span style=display:flex><span>    service 或 systemd: 用于管理远程主机的服务
</span></span><span style=display:flex><span>    get_url: 该模块主要用于从http、ftp、https服务器上下载文件<span style=color:#666>(</span>类似于wget<span style=color:#666>)</span>
</span></span><span style=display:flex><span>    fetch: 它用于从远程机器获取文件, 并将其本地存储在由主机名组织的文件树中
</span></span><span style=display:flex><span>    file: 主要用于远程主机上的文件操作
</span></span><span style=display:flex><span>    lineinfile: 远程主机上的文件编辑模块
</span></span><span style=display:flex><span>    unarchive模块: 用于解压文件
</span></span><span style=display:flex><span>    command: 用于在各被管理节点运行指定的命令, 不支持特殊字符
</span></span><span style=display:flex><span>    shell: 用于在各被管理节点运行指定的命令, 支持特殊字符
</span></span><span style=display:flex><span>    hostname: 修改远程主机名的模块
</span></span><span style=display:flex><span>    script: 在远程主机上执行主控端的脚本, 相当于scp+shell组合
</span></span><span style=display:flex><span>    stat: 获取远程文件的状态信息, 包括atime,ctime,mtime,md5,uid,gid等信息
</span></span><span style=display:flex><span>    cron: 远程主机crontab配置
</span></span><span style=display:flex><span>    mount: 挂载文件系统
</span></span><span style=display:flex><span>    find: 帮助在被管理主机中查找符合条件的文件, 就像 find 命令一样
</span></span><span style=display:flex><span>    selinux: 远程管理受控节点的selinux的模块
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  &lt;samples&gt;
</span></span><span style=display:flex><span>    ansible 192.168.10.113 -m ping
</span></span><span style=display:flex><span>    ansible -i hosts webserver -m <span style=color:#a2f>command</span> -a <span style=color:#b44>&#39;date&#39;</span>
</span></span><span style=display:flex><span>    ansible all -m copy -a <span style=color:#b44>&#39;src=/root/foo dest=/root/bar&#39;</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>常用模块用法</li></ul><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">63
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">64
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">65
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">66
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">67
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">68
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">69
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">70
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">71
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">72
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">73
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">74
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">75
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">76
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">77
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">78
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#a2f>command</span>     命令模块<span style=color:#666>(</span>默认模块<span style=color:#666>)</span>用于在远程主机执行命令, 不能使用变量, 管道等
</span></span><span style=display:flex><span>    <span style=color:#080;font-style:italic># ansible all -a &#39;date&#39;</span>
</span></span><span style=display:flex><span>cron        计划任务    
</span></span><span style=display:flex><span>    month   指定月份
</span></span><span style=display:flex><span>    minute  指定分钟
</span></span><span style=display:flex><span>    job     指定任务
</span></span><span style=display:flex><span>    day     表示那一天
</span></span><span style=display:flex><span>    hour    指定小时
</span></span><span style=display:flex><span>    weekday 表示周几
</span></span><span style=display:flex><span>    state   表示是添加还是删除
</span></span><span style=display:flex><span>        present: 安装
</span></span><span style=display:flex><span>        absent: 移除
</span></span><span style=display:flex><span>    <span style=color:#080;font-style:italic># ansible webserver -m cron -a &#39;minute=&#34;*/10&#34; job=&#34;/bin/echo hello&#34; name=&#34;test cron job&#34;&#39;   #不写默认都是*, 每个任务都必须有一个名字 </span>
</span></span><span style=display:flex><span>    <span style=color:#080;font-style:italic># ansible webserver -a &#39;crontab -l&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#080;font-style:italic># ansible webserver -m cron -a &#39;minute=&#34;*/10&#34; job=&#34;/bin/echo hello&#34; name=&#34;test cron job&#34; state=absent&#39;  #移除任务</span>
</span></span><span style=display:flex><span>user    用户账号管理
</span></span><span style=display:flex><span>    name    用户名
</span></span><span style=display:flex><span>    uid     uid
</span></span><span style=display:flex><span>    state   状态  
</span></span><span style=display:flex><span>    group   属于哪个组
</span></span><span style=display:flex><span>    groups  附加组
</span></span><span style=display:flex><span>    home    家目录
</span></span><span style=display:flex><span>    createhome  是否创建家目录
</span></span><span style=display:flex><span>    comment 注释信息
</span></span><span style=display:flex><span>    system  是否是系统用户
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#080;font-style:italic># ansible all -m user -a &#39;name=&#34;user1&#34;&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#080;font-style:italic># ansible all -m user -a &#39;name=&#34;user1&#34; state=absent&#39;</span>
</span></span><span style=display:flex><span>group   组管理
</span></span><span style=display:flex><span>    gid     gid      
</span></span><span style=display:flex><span>    name    组名               
</span></span><span style=display:flex><span>    state   状态           
</span></span><span style=display:flex><span>    system  是否是系统组
</span></span><span style=display:flex><span>    <span style=color:#080;font-style:italic># ansible webserver -m group -a &#39;name=mysql gid=306 system=yes&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#080;font-style:italic># ansible webserver -m user -a &#39;name=mysql uid=306 system=yes group=mysql&#39;</span>
</span></span><span style=display:flex><span>copy    复制文件<span style=color:#666>(</span>复制本地文件到远程主机的指定位置<span style=color:#666>)</span>
</span></span><span style=display:flex><span>    src     定义本地源文件路径
</span></span><span style=display:flex><span>    dest    定义远程目录文件路径<span style=color:#666>(</span>绝对路径<span style=color:#666>)</span>
</span></span><span style=display:flex><span>    owner   属主
</span></span><span style=display:flex><span>    group   属组
</span></span><span style=display:flex><span>    mode    权限
</span></span><span style=display:flex><span>    content <span style=color:#b8860b>取代src</span><span style=color:#666>=</span>,表示直接用此处的信息生成为文件内容
</span></span><span style=display:flex><span>    <span style=color:#080;font-style:italic># yum -y install libselinux-python</span>
</span></span><span style=display:flex><span>    <span style=color:#080;font-style:italic># ansible all -m copy -a &#39;src=/etc/fstab dest=/tmp/fstab.ansible owner=root mode=640&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#080;font-style:italic># ansible all -m copy -a &#39;content=&#34;hello ansible\nHi ansible&#34; dest=/tmp/test.ansible&#39; </span>
</span></span><span style=display:flex><span>file    设置文件的属性
</span></span><span style=display:flex><span>    path|dest|name  对那个文件做设定
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    创建文件的符号链接: 
</span></span><span style=display:flex><span>        src:     指定源文件
</span></span><span style=display:flex><span>        path:    指明符号链接文件路径
</span></span><span style=display:flex><span>    <span style=color:#080;font-style:italic># ansible all -m file -a &#39;owner=mysql group=mysql mode=644 path=/tmp/fstab.ansible&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#080;font-style:italic># ansible all -m file -a &#39;path=/tmp/fstab.link src=/tmp/fstab.ansible state=link&#39;</span>
</span></span><span style=display:flex><span>ping    测试指定主机是否能连接
</span></span><span style=display:flex><span>    <span style=color:#080;font-style:italic># ansible all -m ping </span>
</span></span><span style=display:flex><span>service 管理服务运行状态
</span></span><span style=display:flex><span>    enabled 是否开机自动启动
</span></span><span style=display:flex><span>    name    指定服务名
</span></span><span style=display:flex><span>    state   指定服务状态
</span></span><span style=display:flex><span>        started     启动服务
</span></span><span style=display:flex><span>        stoped      停止服务
</span></span><span style=display:flex><span>        restarted   重启服务
</span></span><span style=display:flex><span>    arguments   服务的参数
</span></span><span style=display:flex><span>    <span style=color:#080;font-style:italic># ansible webserver -m service -a &#39;enabled=true name=httpd state=started&#39;</span>
</span></span><span style=display:flex><span>shell   在远程主机上运行命令
</span></span><span style=display:flex><span>    尤其是用到管道变量等功能的复杂命令
</span></span><span style=display:flex><span>    <span style=color:#080;font-style:italic># ansible all -m shell -a &#39;echo magedu | passwd --stdin user1&#39;</span>
</span></span><span style=display:flex><span>script  将本地脚本复制到远程主机并运行之
</span></span><span style=display:flex><span>    <span style=color:#080;font-style:italic># ansible all -m script -a &#39;/tmp/test.sh&#39;</span>
</span></span><span style=display:flex><span>yum     安装程序包
</span></span><span style=display:flex><span>    name    程序包名称<span style=color:#666>(</span>不指定版本就安装最新的版本latest<span style=color:#666>)</span>
</span></span><span style=display:flex><span>    state   present,latest表示安装, absent表示卸载
</span></span><span style=display:flex><span>    <span style=color:#080;font-style:italic># ansible webserver -m yum -a &#39;name=httpd&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#080;font-style:italic># ansible all -m yum -a &#39;name=ntpdate&#39;  #默认就是安装</span>
</span></span><span style=display:flex><span>    <span style=color:#080;font-style:italic># ansible all -m yum -a &#39;name=ntpdate state=absent&#39;</span>
</span></span><span style=display:flex><span>setup   收集远程主机的facts
</span></span><span style=display:flex><span>    每个被管理节点在接受并运行管理命令之前, 会将自己主机相关信息, 如操作系统版本, IP地址等报告给远程的ansible主机 
</span></span><span style=display:flex><span>    <span style=color:#080;font-style:italic># ansible all -m setup</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=高级用法>高级用法</h4><h5 id=yaml>yaml</h5><ol><li>YAML介绍</li></ol><p>YAML是一个可读性高的用来表达资料序列的格式. YAML参考了其它多种语言, 包括: XML、C语言、Python、Perl以及电子邮件格式RFC2822等. ClarkEvans在2001年首次发表了这种语言, 另外Ingy dot Net与Oren Ben-Kiki也是这语言的共同设计者</p><p>YAML Ain&rsquo;t Markup Language,即YAML不是XML, 不过, 在开发这种语言时, YAML的意思其实是: &ldquo;Yet Another Markup Language&rdquo;(仍是一种标记语言), 其特性:</p><ul><li>YAML的可读性好</li><li>YAML和脚本语言的交互性好</li><li>YAML使用实现语言的数据类型</li><li>YAML有一个一致的信息模型</li><li>YAML易于实现</li><li>YAML可以基于流来处理</li><li>YAML表达能力强, 扩展性好</li></ul><blockquote><p>更多的内容及规范参见<a href="https://www.oschina.net/action/GoToLink?url=http%3A%2F%2Fwww.yaml.org">http://www.yaml.org</a></p></blockquote><ol start=2><li>YAML语法</li></ol><p>YAML的语法和其他高阶语言类似, 并且可以简单表达清单、散列表、标量等数据结构, 其结构(structure)通过空格来展示, 序列(sequence)里的项用"-&ldquo;来表示, Map里面的键值对用&rdquo;:&ldquo;分割, 下面是一个示例</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>name: john smith
</span></span><span style=display:flex><span>age: 41
</span></span><span style=display:flex><span>gender: male
</span></span><span style=display:flex><span>spouse:
</span></span><span style=display:flex><span>    name:jane smith
</span></span><span style=display:flex><span>    age:37
</span></span><span style=display:flex><span>    gender: female
</span></span><span style=display:flex><span>children:
</span></span><span style=display:flex><span>    -   name:jimmy smith
</span></span><span style=display:flex><span>        age:17
</span></span><span style=display:flex><span>        gender: male
</span></span><span style=display:flex><span>    -   name:jenny smith
</span></span><span style=display:flex><span>        age: 13
</span></span><span style=display:flex><span>        gender: female
</span></span></code></pre></td></tr></table></div></div><p>YAML文件扩展名通常为.yaml, 如example.yaml</p><p><strong>list</strong></p><p>列表的所有元素均使用&rdquo;-&ldquo;打头, 例如:</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span># A list of testy fruits
</span></span><span style=display:flex><span>- Apple
</span></span><span style=display:flex><span>- Orange
</span></span><span style=display:flex><span>- Strawberry
</span></span><span style=display:flex><span>- Mango
</span></span></code></pre></td></tr></table></div></div><p><strong>dictionary</strong></p><p>字典通过key与value进行标识, 例如:</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>---
</span></span><span style=display:flex><span># An employee record
</span></span><span style=display:flex><span>name: Example Developer
</span></span><span style=display:flex><span>job: Developer
</span></span><span style=display:flex><span>skill: Elite
</span></span></code></pre></td></tr></table></div></div><p>也可以将key:value放置于{}中进行表示, 例如:</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>---
</span></span><span style=display:flex><span>#An exmloyee record
</span></span><span style=display:flex><span>{name: Example Developer, job: Developer, skill: Elite}
</span></span></code></pre></td></tr></table></div></div><h5 id=基础元素>基础元素</h5><h6 id=变量>变量</h6><ol><li><p>变量命名</p><p>变量名仅能由字母、数字和下划线组成, 且只能以字母开头</p></li><li><p>facts</p><p>facts是由正在通信的远程目标主机发回的信息, 这些信息被保存在ansible变量中. 要获取指定的远程主机所支持的所有facts, 可使用如下命令进行:</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ansible hostname -m setup
</span></span></code></pre></td></tr></table></div></div></li><li><p>register</p><p>把任务的输出定义为变量, 然后用于其他任务, 实例如下:</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>tasks</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>shell</span>:<span style=color:#bbb> </span>/usr/bin/foo<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>register</span>:<span style=color:#bbb> </span>foo_result<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>ignore_errors</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>True</span><span style=color:#bbb>
</span></span></span></code></pre></td></tr></table></div></div></li><li><p>通过命令行传递变量</p><p>在运行playbook的时候也可以传递一些变量供playbook使用, 示例如下:</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ansible-playbook test.yml --extra-vars <span style=color:#b44>&#34;hosts=www user=mageedu&#34;</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p>通过roles传递变量</p><p>当给一个主机应用角色的时候可以传递变量, 然后在角色内使用这些变量, 示例如下:</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:green;font-weight:700>hosts</span>:<span style=color:#bbb> </span>webserver<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>roles</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- common<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- {<span style=color:green;font-weight:700>role: foo_app_instance, dir: &#39;/web/htdocs/a.com&#39;, port</span>:<span style=color:#bbb> </span><span style=color:#666>8080</span>}<span style=color:#bbb>
</span></span></span></code></pre></td></tr></table></div></div></li></ol><h6 id=inventory>Inventory</h6><p>ansible的主要功用在于批量主机操作, 为了便捷的使用其中的部分主机, 可以在inventory file中将其分组命名, 默认的inventory file为<code>/etc/ansible/hosts</code></p><p>inventory file可以有多个, 且也可以通过Dynamic Inventory来动态生成</p><ol><li><p>inventory文件格式</p><p>inventory文件遵循INI文件风格, 中括号中的字符为组名. 可以将同一个主机同时归并到多个不同的组中；此外, 当如若目标主机使用非默认的SSH端口, 还可以在主机名称之后使用冒号加端口号来表明</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#b44>ntp.magedu.com</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>[webserver]</span>
</span></span><span style=display:flex><span><span style=color:#b44>www1.magedu.com:2222</span>
</span></span><span style=display:flex><span><span style=color:#b44>www2.magedu.com</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>[dbserver]</span>
</span></span><span style=display:flex><span><span style=color:#b44>db1.magedu.com</span>
</span></span><span style=display:flex><span><span style=color:#b44>db2.magedu.com</span>
</span></span><span style=display:flex><span><span style=color:#b44>db3.magedu.com</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#b44>如果主机名遵循相似的命名模式, 还可使用列表的方式标识个主机, 例如: </span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>[webserver]</span>
</span></span><span style=display:flex><span><span style=color:#b44>www[01:50].example.com</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>[databases]</span>
</span></span><span style=display:flex><span><span style=color:#b44>db-[a:f].example.com</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p>主机变量</p><p>可以在inventory中定义主机时为其添加主机变量以便于在playbook中使用, 例如:</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#a2f;font-weight:700>[webserver]</span>
</span></span><span style=display:flex><span><span style=color:#b44>www1.magedu.com http_port</span><span style=color:#666>=</span><span style=color:#b44>80 maxRequestsPerChild=808</span>
</span></span><span style=display:flex><span><span style=color:#b44>www2.magedu.com http_port</span><span style=color:#666>=</span><span style=color:#b44>8080 maxRequestsPerChild=909</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p>组变量</p><p>组变量是指赋予给指定组内所有主机上的在playbook中可用的变量. 例如:</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#a2f;font-weight:700>[webserver]</span>
</span></span><span style=display:flex><span><span style=color:#b44>www1.magedu.com</span>
</span></span><span style=display:flex><span><span style=color:#b44>www2.magedu.com</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>[webserver:vars]</span>
</span></span><span style=display:flex><span><span style=color:#b44>ntp_server</span><span style=color:#666>=</span><span style=color:#b44>ntp.magedu.com</span>
</span></span><span style=display:flex><span><span style=color:#b44>nfs_server</span><span style=color:#666>=</span><span style=color:#b44>nfs.magedu.com</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p>组嵌套</p><p>inventory中, 组还可以包含其它的组, 并且也可以向组中的主机指定变量. 不过, 这些变量只能在ansible-playbook中使用, 而ansible不支持. 例如:</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#a2f;font-weight:700>[apache]</span>
</span></span><span style=display:flex><span><span style=color:#b44>httpd1.magedu.com</span>
</span></span><span style=display:flex><span><span style=color:#b44>httpd2.magedu.com</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>[nginx]</span>
</span></span><span style=display:flex><span><span style=color:#b44>ngx1.magedu.com</span>
</span></span><span style=display:flex><span><span style=color:#b44>ngx2.magedu.com</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#b44>[webserver:children]    #固定格式</span>
</span></span><span style=display:flex><span><span style=color:#b44>apache</span>
</span></span><span style=display:flex><span><span style=color:#b44>nginx</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>[webserver:vars]</span>
</span></span><span style=display:flex><span><span style=color:#b44>ntp_server</span><span style=color:#666>=</span><span style=color:#b44>ntp.magedu.com</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p>inventory参数</p><p>ansible基于ssh连接inventory中指定的远程主机时, 还可以通过参数指定其交互方式, 这些参数如下所示:</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ansible_ssh_host
</span></span><span style=display:flex><span>ansible_ssh_port
</span></span><span style=display:flex><span>ansible_ssh_user
</span></span><span style=display:flex><span>ansible_ssh_pass
</span></span><span style=display:flex><span>ansible_sudo_pass
</span></span><span style=display:flex><span>ansible_connection
</span></span><span style=display:flex><span>ansible_ssh_private_key_file
</span></span><span style=display:flex><span>ansible_shell_type
</span></span><span style=display:flex><span>ansible_python_interpreter
</span></span></code></pre></td></tr></table></div></div></li></ol><h6 id=条件测试>条件测试</h6><p>如果需要根据变量、facts或此前任务的执行结果来做为某task执行与否的前提时要用到条件测试.</p><ol><li><p>when语句</p><p>在task后添加when字句即可使用条件测试；when语句支持jinja2表达式语句, 例如:</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>tasks</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>&#39;shutdown debian flavored system&#34;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>command</span>:<span style=color:#bbb> </span>/sbin/shutdown -h now<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>when</span>:<span style=color:#bbb> </span>ansible_os_family == &#34;Debian&#34;<span style=color:#bbb>
</span></span></span></code></pre></td></tr></table></div></div><p>when语句中还可以使用jinja2的大多"filter&rdquo;,例如果忽略此前某语句的错误并基于其结果(failed或success)运行后面指定的语句, 可使用类似如下形式:</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>tasks</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- command:/bin/false<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>register</span>:<span style=color:#bbb> </span>result<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>ignore_errors</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>True</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>command</span>:<span style=color:#bbb> </span>/bin/something<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>when</span>:<span style=color:#bbb> </span>result|failed<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>command</span>:<span style=color:#bbb> </span>/bin/something_else<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>when</span>:<span style=color:#bbb> </span>result|success<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>command</span>:<span style=color:#bbb> </span>/bin/still/something_else<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>when</span>:<span style=color:#bbb> </span>result|skipped<span style=color:#bbb>
</span></span></span></code></pre></td></tr></table></div></div><p>此外, when语句中还可以使用facts或playbook中定义的变量</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#080;font-style:italic># cat cond.yml </span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>- <span style=color:green;font-weight:700>hosts</span>:<span style=color:#bbb> </span>all<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>remote_user</span>:<span style=color:#bbb> </span>root<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>vars</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>username</span>:<span style=color:#bbb> </span>user10<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>tasks</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>create {{ username }} user<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>user</span>:<span style=color:#bbb> </span>name={{ username }} <span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>when</span>:<span style=color:#bbb> </span>ansible_fqdn == &#34;node1.exercise.com&#34;<span style=color:#bbb>
</span></span></span></code></pre></td></tr></table></div></div></li></ol><h6 id=迭代>迭代</h6><p>当有需要重复性执行的任务时, 可以使用迭代机制. 其使用格式为将需要迭代的内容定义为item变量引用, 并通过with_items语句来指明迭代的元素列表即可. 例如:</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>- name: add server user
</span></span><span style=display:flex><span>  user: name={{ item }} state=persent groups=wheel
</span></span><span style=display:flex><span>  with_items:
</span></span><span style=display:flex><span>    - testuser1
</span></span><span style=display:flex><span>    - testuser2
</span></span></code></pre></td></tr></table></div></div><p>上面语句的功能等同于下面的语句:</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>- name: add user testuser1
</span></span><span style=display:flex><span>  user: name=testuser1 state=present group=wheel
</span></span><span style=display:flex><span>- name: add user testuser2
</span></span><span style=display:flex><span>  user: name=testuser2 state=present group=wheel
</span></span></code></pre></td></tr></table></div></div><p>事实上, with_items中可以使用元素还可为hashes, 例如:</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>- name: add several users
</span></span><span style=display:flex><span>  user: name={{ item.name}} state=present groups={{ item.groups }}
</span></span><span style=display:flex><span>  with_items:
</span></span><span style=display:flex><span>    - { name: &#39;testuser1&#39;, groups: &#39;wheel&#39;}
</span></span><span style=display:flex><span>    - { name: &#39;testuser2&#39;, groups: &#39;root&#39;}
</span></span></code></pre></td></tr></table></div></div><blockquote><p>Ansible的循环机制还有更多的高级功能, 具体请参考官方文档<a href="https://www.oschina.net/action/GoToLink?url=http%3A%2F%2Fdocs.ansible.com%2Fplaybooks_loops.html">http://docs.ansible.com/playbooks_loops.html</a></p></blockquote><h6 id=模板示例>模板示例</h6><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span>#</span> grep <span>&#39;</span>{{<span>&#39;</span> conf<span style=color:#666>/</span>httpd.conf 
</span></span><span style=display:flex><span>MaxClients       {{ maxClients }}
</span></span><span style=display:flex><span>Listen {{ httpd_port }}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span>#</span> cat <span style=color:#666>/</span>etc<span style=color:#666>/</span>ansible<span style=color:#666>/</span>hosts
</span></span><span style=display:flex><span>[webserver]
</span></span><span style=display:flex><span><span style=color:#666>127.0.0.1</span> httpd_port=<span style=color:#666>80</span> maxClients=<span style=color:#666>100</span>
</span></span><span style=display:flex><span><span style=color:#666>192.168.10.149</span> httpd_port=<span style=color:#666>8080</span> maxClients=<span style=color:#666>200</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span>#</span> cat apache.yml 
</span></span><span style=display:flex><span><span style=color:#666>-</span> hosts: webserver
</span></span><span style=display:flex><span>  remote_user: root
</span></span><span style=display:flex><span>  vars:
</span></span><span style=display:flex><span>  <span style=color:#666>-</span> <span style=color:#a2f;font-weight:700>package</span>: httpd
</span></span><span style=display:flex><span>  <span style=color:#666>-</span> service: httpd
</span></span><span style=display:flex><span>  tasks:
</span></span><span style=display:flex><span>  <span style=color:#666>-</span> name: install httpd <span style=color:#a2f;font-weight:700>package</span>
</span></span><span style=display:flex><span>    yum: name={{ <span style=color:#a2f;font-weight:700>package</span> }} state=latest
</span></span><span style=display:flex><span>  <span style=color:#666>-</span> name: install configuration file <span style=color:#a2f;font-weight:700>for</span> httpd
</span></span><span style=display:flex><span>    template: src=<span style=color:#666>/</span>root<span style=color:#666>/</span>conf<span style=color:#666>/</span>httpd.conf dest=<span style=color:#666>/</span>etc<span style=color:#666>/</span>httpd<span style=color:#666>/</span>conf<span style=color:#666>/</span>httpd.conf
</span></span><span style=display:flex><span>    notify: 
</span></span><span style=display:flex><span>    <span style=color:#666>-</span> restart httpd
</span></span><span style=display:flex><span>  <span style=color:#666>-</span> name: start httpd service
</span></span><span style=display:flex><span>    service: enabled=<span style=color:#a2f;font-weight:700>true</span> name={{ service }} state=started
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  handlers:
</span></span><span style=display:flex><span>  <span style=color:#666>-</span> name: restart httpd
</span></span><span style=display:flex><span>    service: name=httpd state=restarted
</span></span></code></pre></td></tr></table></div></div><h5 id=playbook>playbook</h5><p>playbook是由一个或多个"play"组成的列表. play的主要功能在于将事先归并为一组的主机装扮成事先通过ansible中的task定义好的角色. 从根本上来讲, 所有task无非是调用ansible的一个module. 将多个play组织在一个playbook中, 即可以让他们连同起来按事先编排的机制同唱一台大戏</p><h6 id=命令说明-1>命令说明</h6><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#080;font-style:italic># 查看脚本影响到的hosts</span>
</span></span><span style=display:flex><span>ansible-playbook -i inventory/hosts.yml playbook.yml --list-hosts
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 查看输出细节</span>
</span></span><span style=display:flex><span>ansible-playbook playbook.yml  --verbose
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 并行执行脚本</span>
</span></span><span style=display:flex><span>ansible-playbook playbook.yml -f <span style=color:#666>10</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 输入密码</span>
</span></span><span style=display:flex><span>ansible-playbook playbook.yml --ask-become-pass
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># dry-run</span>
</span></span><span style=display:flex><span>ansible-playbook playbook.yml --check
</span></span></code></pre></td></tr></table></div></div><h6 id=组成结构>组成结构</h6><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>inventory       # 以下操作应用的主机
</span></span><span style=display:flex><span>modules         # 调用哪些模块做什么样的操作
</span></span><span style=display:flex><span>ad hoc commands # 在这些主机上运行哪些命令
</span></span><span style=display:flex><span>playbooks   
</span></span><span style=display:flex><span>    tasks       # 任务, 即调用模块完成的某操作
</span></span><span style=display:flex><span>    variable    # 变量
</span></span><span style=display:flex><span>    templates   # 模板
</span></span><span style=display:flex><span>    handlers    # 处理器, 由某事件触发执行的操作
</span></span><span style=display:flex><span>    roles       # 角色
</span></span></code></pre></td></tr></table></div></div><p>示例:</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>- hosts: webserver
</span></span><span style=display:flex><span>  vars:
</span></span><span style=display:flex><span>    http_port: 80
</span></span><span style=display:flex><span>    max_clients: 256
</span></span><span style=display:flex><span>  remote_user: root
</span></span><span style=display:flex><span>  tasks:
</span></span><span style=display:flex><span>  - name: ensure apache is at the latest version
</span></span><span style=display:flex><span>    yum: name=httpd state=latest
</span></span><span style=display:flex><span>  - name: ensure apache is running
</span></span><span style=display:flex><span>    service: name=httpd state=started
</span></span><span style=display:flex><span>  handlers:
</span></span><span style=display:flex><span>    - name: restart apache
</span></span><span style=display:flex><span>      service: name=httpd state=restarted
</span></span></code></pre></td></tr></table></div></div><h6 id=基础组件>基础组件</h6><ol><li><p>Hosts和Users</p><p>playbook中的每一个play的目的都是为了让某个或某些主机以某个指定的用户身份执行任务. hosts用于指定要执行指定任务的主机, 其可以使一个或多个由冒号分隔主机组；remote_user则用于指定远程主机的执行任务的用户</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>- hosts: webserver
</span></span><span style=display:flex><span>  remote_user: root
</span></span></code></pre></td></tr></table></div></div><p>不过, remote_user也可用于各task中, 也可以通过指定其通过sudo的方式在远程主机上执行任务, 其可用于play全局或其任务；此外, 甚至可以在sudo时使用sudo_user指定sudo时切换的用户</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>- hosts: webserver
</span></span><span style=display:flex><span>  remote_user: magedu
</span></span><span style=display:flex><span>  tasks:
</span></span><span style=display:flex><span>   - name: test connection
</span></span><span style=display:flex><span>     ping:
</span></span><span style=display:flex><span>     remote_user: magedu
</span></span><span style=display:flex><span>     sudo: yes
</span></span></code></pre></td></tr></table></div></div></li><li><p>任务列表和action</p><p>play的主题部分是task list. task list中的各任务按次序逐个在hosts中指定的所有主机上执行, 即在所有主机上完成第一个任务后再开始第二个. 在运行自上而下某playbook时, 如果中途发生错误, 所有已执行任务都可能回滚, 在更正playbook后重新执行一次即可</p><p>taks的目的是使用指定的参数执行模块, 而在模块参数中可以使用变量. 模块执行是幂等的. 这意味着多次执行是安全的, 因为其结果均一致</p><p>每个task都应该有其name, 用于playbook的执行结果输出, 建议其内容尽可能清晰地描述任务执行步骤, 如果为提供name, 则action的结果将用于输出</p><p>定义task可以使用"action: module options"或”module: options“的格式推荐使用后者以实现向后兼容. 如果action一行的内容过多, 也中使用在行首使用几个空白字符进行换行</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>tasks:
</span></span><span style=display:flex><span>  - name:make sure apache is running
</span></span><span style=display:flex><span>    service: name=httpd state=started
</span></span></code></pre></td></tr></table></div></div><p>在众多的模块中, 只有command和shell模块仅需要给定一个列表而无需使用"key=value"格式, 例如:</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>tasks:
</span></span><span style=display:flex><span>  - name: disable selinux
</span></span><span style=display:flex><span>    command: /sbin/setenforce 0
</span></span></code></pre></td></tr></table></div></div><p>如果命令或脚本的退出码不为零, 可以使用如下方式替代:</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>tasks:
</span></span><span style=display:flex><span>  - name: run this command and ignore the result
</span></span><span style=display:flex><span>    shell: /usr/bin/somecommand || /bin/true
</span></span></code></pre></td></tr></table></div></div><p>或者使用ignore_errors来忽略错误信息:</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>tasks:
</span></span><span style=display:flex><span>  - name: run this command and ignore the result
</span></span><span style=display:flex><span>    shell: /usr/bin/somecommand
</span></span><span style=display:flex><span>    ignore_errors: True
</span></span></code></pre></td></tr></table></div></div></li><li><p>handlers</p><p>用于当关注的资源发生变化时采取一定的操作</p><p>&ldquo;notify"这个action可用于在每个play的最后被触发, 这样可以避免多次有改变发生时每次都执行执行的操作, 取而代之, 仅在所有的变化发生完成后一次性地执行指定操作, 在notify中列出的操作称为handlers, 也即notify中调用handlers中定义的操作</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>- name: template configuration file
</span></span><span style=display:flex><span>  template: src=template.j2 dest=/etc/foo.conf
</span></span><span style=display:flex><span>  notify:
</span></span><span style=display:flex><span>    - restart memcached
</span></span><span style=display:flex><span>    - restart apache
</span></span></code></pre></td></tr></table></div></div><p>handlers是task列表, 这些task与前述的task并没有本质上的不同</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>handlers: 
</span></span><span style=display:flex><span>  - name: restart memcached
</span></span><span style=display:flex><span>    service: name=memcached state=restarted
</span></span><span style=display:flex><span>  - name: restart apache
</span></span><span style=display:flex><span>    service: name=apache state=restarted
</span></span></code></pre></td></tr></table></div></div></li></ol><h6 id=简单示例>简单示例</h6><ul><li><p>示例1</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span># cat nginx.yml 
</span></span><span style=display:flex><span>- hosts: webserver
</span></span><span style=display:flex><span>  remote_user: root
</span></span><span style=display:flex><span>  tasks:
</span></span><span style=display:flex><span>  - name: create nginxn group
</span></span><span style=display:flex><span>    group: name=nginx system=yes gid=208
</span></span><span style=display:flex><span>  - name: create nginx user
</span></span><span style=display:flex><span>    user: name=nginx uid=208 group=nginx system=yes
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>- hosts: dbserver
</span></span><span style=display:flex><span>  remote_user: root
</span></span><span style=display:flex><span>  tasks:
</span></span><span style=display:flex><span>  - name: copy file to dbserver
</span></span><span style=display:flex><span>    copy: src=/etc/inittab dest=/tmp/inittab.ans
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># ansible-playbook nginx.yml 
</span></span></code></pre></td></tr></table></div></div></li><li><p>示例2</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span># cat apache.yml 
</span></span><span style=display:flex><span>- hosts: webserver
</span></span><span style=display:flex><span>  remote_user: root
</span></span><span style=display:flex><span>  tasks:
</span></span><span style=display:flex><span>  - name: install httpd package
</span></span><span style=display:flex><span>    yum: name=httpd state=latest
</span></span><span style=display:flex><span>  - name: install configuration file for httpd
</span></span><span style=display:flex><span>    copy: src=/root/conf/httpd.conf dest=/etc/httpd/conf/httpd.conf
</span></span><span style=display:flex><span>  - name: start httpd service
</span></span><span style=display:flex><span>    service: enabled=true name=httpd state=started
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># ansible-playbook apache.yml 
</span></span></code></pre></td></tr></table></div></div></li><li><p>示例3</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span># cat apache.yml 
</span></span><span style=display:flex><span>- hosts: webserver
</span></span><span style=display:flex><span>  remote_user: root
</span></span><span style=display:flex><span>  tasks:
</span></span><span style=display:flex><span>  - name: install httpd package
</span></span><span style=display:flex><span>    yum: name=httpd state=latest
</span></span><span style=display:flex><span>  - name: install configuration file for httpd
</span></span><span style=display:flex><span>    copy: src=/root/conf/httpd.conf dest=/etc/httpd/conf/httpd.conf
</span></span><span style=display:flex><span>    notify: 
</span></span><span style=display:flex><span>    - restart httpd
</span></span><span style=display:flex><span>  - name: start httpd service
</span></span><span style=display:flex><span>    service: enabled=true name=httpd state=started
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  handlers:
</span></span><span style=display:flex><span>  - name: restart httpd
</span></span><span style=display:flex><span>    service: name=httpd state=restarted
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>#  ansible-playbook apache.yml 
</span></span></code></pre></td></tr></table></div></div></li><li><p>示例4</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span>#</span> cat apache.yml 
</span></span><span style=display:flex><span><span style=color:#666>-</span> hosts: webserver
</span></span><span style=display:flex><span>  remote_user: root
</span></span><span style=display:flex><span>  vars:
</span></span><span style=display:flex><span>  <span style=color:#666>-</span> <span style=color:#a2f;font-weight:700>package</span>: httpd
</span></span><span style=display:flex><span>  <span style=color:#666>-</span> service: httpd
</span></span><span style=display:flex><span>  tasks:
</span></span><span style=display:flex><span>  <span style=color:#666>-</span> name: install httpd <span style=color:#a2f;font-weight:700>package</span>
</span></span><span style=display:flex><span>    yum: name={{ <span style=color:#a2f;font-weight:700>package</span> }} state=latest
</span></span><span style=display:flex><span>  <span style=color:#666>-</span> name: install configuration file <span style=color:#a2f;font-weight:700>for</span> httpd
</span></span><span style=display:flex><span>    copy: src=<span style=color:#666>/</span>root<span style=color:#666>/</span>conf<span style=color:#666>/</span>httpd.conf dest=<span style=color:#666>/</span>etc<span style=color:#666>/</span>httpd<span style=color:#666>/</span>conf<span style=color:#666>/</span>httpd.conf
</span></span><span style=display:flex><span>    notify: 
</span></span><span style=display:flex><span>    <span style=color:#666>-</span> restart httpd
</span></span><span style=display:flex><span>  <span style=color:#666>-</span> name: start httpd service
</span></span><span style=display:flex><span>    service: enabled=<span style=color:#a2f;font-weight:700>true</span> name={{ service }} state=started
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  handlers:
</span></span><span style=display:flex><span>  <span style=color:#666>-</span> name: restart httpd
</span></span><span style=display:flex><span>    service: name=httpd state=restarted
</span></span></code></pre></td></tr></table></div></div></li><li><p>示例5</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span># cat facts.yml 
</span></span><span style=display:flex><span>- hosts: webserver
</span></span><span style=display:flex><span>  remote_user: root
</span></span><span style=display:flex><span>  tasks:
</span></span><span style=display:flex><span>  - name: copy file
</span></span><span style=display:flex><span>    copy: content=&#34;{{ ansible_all_ipv4_addresses }} &#34; dest=/tmp/vars.ans
</span></span></code></pre></td></tr></table></div></div></li></ul><h6 id=roles>roles</h6><p>ansible自1.2版本引入的新特性, 用于层次性、结构化地组织playbook. roles能够根据层次型结构自动转载变量文件、tasks以及handlers等. 要使用roles只需要在playbook中使用include指令即可. 简单来讲, roles就是通过分别将变量、文件、任务、模板以及处理器放置于单独的目录中, 并可以便捷地include他们的一种机制. 角色一般用于基于主机构建服务的场景中, 但也可以使用于构建守护进程的场景中</p><p>一个roles的案例如下所示:</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>site.yml
</span></span><span style=display:flex><span>webserver.yml
</span></span><span style=display:flex><span>fooserver.yml
</span></span><span style=display:flex><span>roles/
</span></span><span style=display:flex><span>    common/
</span></span><span style=display:flex><span>        files/
</span></span><span style=display:flex><span>        templates/
</span></span><span style=display:flex><span>        tasks/
</span></span><span style=display:flex><span>        handlers/
</span></span><span style=display:flex><span>        vars/
</span></span><span style=display:flex><span>        meta/
</span></span><span style=display:flex><span>    webserver/
</span></span><span style=display:flex><span>        files/
</span></span><span style=display:flex><span>        templates/
</span></span><span style=display:flex><span>        tasks/
</span></span><span style=display:flex><span>        handlers/
</span></span><span style=display:flex><span>        vars/
</span></span><span style=display:flex><span>        meta/
</span></span></code></pre></td></tr></table></div></div><p>而在playbook中, 可以这样使用roles</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>- hosts: webserver
</span></span><span style=display:flex><span>  roles:
</span></span><span style=display:flex><span>    - common  
</span></span><span style=display:flex><span>    - webserver
</span></span></code></pre></td></tr></table></div></div><p>也可以向roles传递参数, 例如:</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>- hosts: webserver
</span></span><span style=display:flex><span>  roles:
</span></span><span style=display:flex><span>    - common
</span></span><span style=display:flex><span>    - { role: foo_app_instance, dir:&#39;/opt/a&#39;,port:5000}
</span></span><span style=display:flex><span>    - { role: foo_app_instance, dir:&#39;/opt/b&#39;,port:5001}
</span></span></code></pre></td></tr></table></div></div><p>甚至也可以条件式地使用roles, 例如:</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>- hosts: webserver
</span></span><span style=display:flex><span>  roles:
</span></span><span style=display:flex><span>    - { role: some_role, when: &#34;ansible_so_family == &#39;RedHat&#34; }  
</span></span></code></pre></td></tr></table></div></div><ol><li><p>创建role的步骤</p><ol><li>创建以roles命名的目录</li><li>在roles目录中分别创建以各角色命名的目录, 如webserver等</li><li>在每个角色命名的目录中分别创建files、handlers、meta、tasks、templates和vars目录；用不到的目录可以创建为空目录, 也可以不创建</li><li>在playbook文件中, 调用各角色</li></ol></li><li><p>role内各目录中可应用的文件</p><ul><li>task目录: 至少应该包含一个为main.yml的文件, 其定义了此角色的任务列表；此文件可以使用include包含其它的位于此目录中的task文件</li><li>file目录: 存放由copy或script等模板块调用的文件</li><li>template目录: template模块会自动在此目录中寻找jinja2模板文件</li><li>handlers目录: 此目录中应当包含一个main.yml文件, 用于定义此角色用到的各handlers, 在handler中使用inclnude包含的其它的handlers文件也应该位于此目录中</li><li>vars目录: 应当包含一个main.yml文件, 用于定义此角色用到的变量</li><li>meta目录: 应当包含一个main.yml文件, 用于定义此角色的特殊设定及其依赖关系ansible1.3及其以后的版本才支持</li><li>default目录: 应当包含一个main.yml文件,用于为当前角色设定默认变量时使用此目录</li></ul><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span># mkdir -pv ansible_playbooks/roles/{webserver,dbserver}/{tasks,files,templates,meta,handlers,vars} 
</span></span><span style=display:flex><span># cp /etc/httpd/conf/httpd.conf files/  
</span></span><span style=display:flex><span># pwd
</span></span><span style=display:flex><span>/root/ansible_playbooks/roles/webserver 
</span></span><span style=display:flex><span># cat tasks/main.yml 
</span></span><span style=display:flex><span>- name: install httpd package
</span></span><span style=display:flex><span>  yum: name=httpd state=present
</span></span><span style=display:flex><span>- name: install configuretion file
</span></span><span style=display:flex><span>  copy: src=httpd.conf dest=/etc/httpd/conf/httpd.conf
</span></span><span style=display:flex><span>  tags:
</span></span><span style=display:flex><span>  - conf
</span></span><span style=display:flex><span>  notify:
</span></span><span style=display:flex><span>  - restart httpd
</span></span><span style=display:flex><span>- name: start httpd
</span></span><span style=display:flex><span>  service: name=httpd state=started
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># cat handlers/main.yml 
</span></span><span style=display:flex><span>- name: restart httpd
</span></span><span style=display:flex><span>  service: name=httpd state=restarted
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># pwd;ls
</span></span><span style=display:flex><span>/root/ansible_playbooks
</span></span><span style=display:flex><span>roles  site.yml 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># cat site.yml 
</span></span><span style=display:flex><span>- hosts: webserver
</span></span><span style=display:flex><span>  remote_user: root
</span></span><span style=display:flex><span>  roles:
</span></span><span style=display:flex><span>  - webserver
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># ansible-playbook site.yml 
</span></span></code></pre></td></tr></table></div></div></li></ol><h6 id=tags>tags</h6><p>tags用于让用户选择运行或跳过playbook中的部分代码. ansible具有幂等性, 因此会自动跳过没有变化的部分, 即便如此, 有些代码为测试其确实没有发生变化的时间依然会非常的长. 此时, 如果确信其没有变化, 就可以通过tags跳过此些代码片段</p><p>tags: 在playbook可以为某个或某些任务定义一个"标签&rdquo;, 在执行此playbook时, 通过为ansible-playbook命令使用&ndash;tags选项能耐实现仅运行指定的tasks而非所有的</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span>#</span> cat apache.yml 
</span></span><span style=display:flex><span><span style=color:#666>-</span> hosts: webserver
</span></span><span style=display:flex><span>  remote_user: root
</span></span><span style=display:flex><span>  vars:
</span></span><span style=display:flex><span>  <span style=color:#666>-</span> <span style=color:#a2f;font-weight:700>package</span>: httpd
</span></span><span style=display:flex><span>  <span style=color:#666>-</span> service: httpd
</span></span><span style=display:flex><span>  tasks:
</span></span><span style=display:flex><span>  <span style=color:#666>-</span> name: install httpd <span style=color:#a2f;font-weight:700>package</span>
</span></span><span style=display:flex><span>    yum: name={{ <span style=color:#a2f;font-weight:700>package</span> }} state=latest
</span></span><span style=display:flex><span>  <span style=color:#666>-</span> name: install configuration file <span style=color:#a2f;font-weight:700>for</span> httpd
</span></span><span style=display:flex><span>    template: src=<span style=color:#666>/</span>root<span style=color:#666>/</span>conf<span style=color:#666>/</span>httpd.conf dest=<span style=color:#666>/</span>etc<span style=color:#666>/</span>httpd<span style=color:#666>/</span>conf<span style=color:#666>/</span>httpd.conf
</span></span><span style=display:flex><span>    tags:
</span></span><span style=display:flex><span>    <span style=color:#666>-</span> conf
</span></span><span style=display:flex><span>    notify: 
</span></span><span style=display:flex><span>    <span style=color:#666>-</span> restart httpd
</span></span><span style=display:flex><span>  <span style=color:#666>-</span> name: start httpd service
</span></span><span style=display:flex><span>    service: enabled=<span style=color:#a2f;font-weight:700>true</span> name={{ service }} state=started
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  handlers:
</span></span><span style=display:flex><span>  <span style=color:#666>-</span> name: restart httpd
</span></span><span style=display:flex><span>    service: name=httpd state=restarted
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span>#</span> ansible<span style=color:#666>-</span>playbook apache.yml <span style=color:#666>--</span>tags=<span>&#39;</span>conf<span>&#39;</span>
</span></span></code></pre></td></tr></table></div></div><blockquote><p>特殊tags: always # 无论如何都会运行</p></blockquote><h6 id=变量-1>变量</h6><ol><li><p>变量的定义方式</p><ul><li><p>通过vars关键字定义</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- name： use vars define invrionmemnt<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>hosts</span>:<span style=color:#bbb> </span>test<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>user</span>:<span style=color:#bbb> </span>ansible<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>vars</span>:<span style=color:#bbb> 
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>http_port</span>:<span style=color:#bbb> </span><span style=color:#666>80</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>server_name</span>:<span style=color:#bbb> </span>localhost<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>conf_file</span>:<span style=color:#bbb> </span>/etc/nginx/conf/default.conf<span style=color:#bbb>
</span></span></span></code></pre></td></tr></table></div></div></li><li><p>通过vars_files关键字引入变量文件</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:green;font-weight:700>hosts</span>:<span style=color:#bbb> </span>all<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>remote_user</span>:<span style=color:#bbb> </span>root<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>vars</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>favcolor</span>:<span style=color:#bbb> </span>blue<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>vars_files</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- vars/external_vars.yml<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- vars/user_vars.yml<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># vars/user_vars.yml示例：</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>users</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>bjones</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>first_name</span>:<span style=color:#bbb> </span>Bob<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>last_name</span>:<span style=color:#bbb> </span>Jones<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>home_dirs</span>:<span style=color:#bbb> </span>/users/bjones<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>acook</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>first_name</span>:<span style=color:#bbb> </span>Anne<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>last_name</span>:<span style=color:#bbb> </span>Cook<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>home_dirs</span>:<span style=color:#bbb> </span>/users/acook<span style=color:#bbb>
</span></span></span></code></pre></td></tr></table></div></div><blockquote><p>变量的定义格式是成键值对出现的, 键值对之间可以嵌套, 最终形成一个大字典</p></blockquote></li><li><p>在playbook中通过host_vars和group_vars目录定义变量</p><p>下面这是一个项目的playbook目录结构. 这个项目中, 包含一个ansible.cfg文件, 一个inventory文件, 一个playbook.yml文件, 一个<code>group_vars</code>目录和一个<code>host_vars</code>目录:</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#080;font-style:italic># tree /etc/ansible/playbooks/project</span>
</span></span><span style=display:flex><span>/etc/ansible/playbooks/project
</span></span><span style=display:flex><span>├── ansible.cfg
</span></span><span style=display:flex><span>├── group_vars
</span></span><span style=display:flex><span>│   ├── datacenter1
</span></span><span style=display:flex><span>│   ├── datacenter2
</span></span><span style=display:flex><span>│   └── datacenters
</span></span><span style=display:flex><span>├── host_vars
</span></span><span style=display:flex><span>│   ├── demo1.example.com
</span></span><span style=display:flex><span>│   ├── demo2.example.com
</span></span><span style=display:flex><span>│   ├── demo3.example.com
</span></span><span style=display:flex><span>│   └── demo4.example.com
</span></span><span style=display:flex><span>├── inventory
</span></span><span style=display:flex><span>└── playbook.yml
</span></span></code></pre></td></tr></table></div></div><p>其中inventory文件的示例如下:</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#a2f;font-weight:700>[datacenter1]</span>
</span></span><span style=display:flex><span><span style=color:#b44>demo1.example.com</span>
</span></span><span style=display:flex><span><span style=color:#b44>demo2.example.com</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>[datacenter2]</span>
</span></span><span style=display:flex><span><span style=color:#b44>demo3.example.com</span>
</span></span><span style=display:flex><span><span style=color:#b44>demo4.example.com</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>[datacenters:children]</span>
</span></span><span style=display:flex><span><span style=color:#b44>datacenter1</span>
</span></span><span style=display:flex><span><span style=color:#b44>datacenter2</span>
</span></span></code></pre></td></tr></table></div></div><p>可以看到group_vars目录中, 定义了三个文件, 分别以inventory文件中的三个主机组命名, 所以这三个文件中定义的就分别是这三个组可以使用的变量</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#080;font-style:italic># cat datacenter1</span>
</span></span><span style=display:flex><span>package: httpd
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># cat datacenter2 </span>
</span></span><span style=display:flex><span>package: apache
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># cat datacenters </span>
</span></span><span style=display:flex><span>package: httpd
</span></span></code></pre></td></tr></table></div></div><p>在host_vars目录中, 定义了三个文件, 分别以inventory文件中的四个主机命名, 所以这四个文件中定义的就分别是这四个主机可以使用的变量</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#080;font-style:italic># cat demo1.example.com </span>
</span></span><span style=display:flex><span>package: httpd
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># cat demo2.example.com </span>
</span></span><span style=display:flex><span>package: apache
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># cat demo3.example.com </span>
</span></span><span style=display:flex><span>package: mariadb-server
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># cat demo4.example.com </span>
</span></span><span style=display:flex><span>package: mysql-server
</span></span></code></pre></td></tr></table></div></div><blockquote><p>需要说明的是, 如果主机组定义的变量与主机冲突, 主机变量优先级最高</p></blockquote></li></ul></li><li><p>注册变量</p><p>在有些时候, 可能需要将某一条任务执行的结果保存下来, 以便在接下的任务中调用或者做些判断. 可以通过register关键字来实现将某一任务结果保存为一个变量</p><p>下面是个简单的例子, 将whoami命令执行的结果注册到变量login：</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>register variables<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>hosts</span>:<span style=color:#bbb> </span>test<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>tasks</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>capture output of whoami command<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>command</span>:<span style=color:#bbb> </span>whoami<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>register</span>:<span style=color:#bbb> </span>login<span style=color:#bbb>
</span></span></span></code></pre></td></tr></table></div></div><p>注册变量的应用场景：</p><ul><li>在一台远端的服务器获取一个目录下的一列表的文件, 然后下载这些文件</li><li>在handler执行之前,发现前面一个task发生了changed,然后执行一个指定的task</li><li>获取远端服务器的ssh key的内容,构建出known_hosts文件</li></ul></li><li><p>通过命令行设置变量</p><p>示例如下:</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#00f;font-weight:700>---</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>- <span style=color:green;font-weight:700>hosts</span>:<span style=color:#bbb> </span><span style=color:#b44>&#39;{{ hosts }}&#39;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>remote_user</span>:<span style=color:#bbb> </span><span style=color:#b44>&#39;{{ user }}&#39;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>tasks</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>     </span>- ...<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>ansible-playbook release.yml --extra-vars &#34;hosts=vipers user=starbuck&#34;<span style=color:#bbb>
</span></span></span></code></pre></td></tr></table></div></div><p>也可以写成类似如下方式:</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>--extra-vars &#39;{&#34;hosts&#34;:&#34;vipers&#34;,&#34;user&#34;:&#34;starbuck&#34;}&#39;<span style=color:#bbb>
</span></span></span></code></pre></td></tr></table></div></div></li><li><p>使用与调试变量</p><p>我们通过以上5种方式在playbook中定义了各种变量. 说到底, 最终的目的, 还是为了方便使用. 下面我们就看一看具体如何使用这些变量</p><ul><li><p>变量的引用</p><p>下面是一个变量的基本使用示例:</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>use vars define variables<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>hosts</span>:<span style=color:#bbb> </span>test<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>vars</span>:<span style=color:#bbb> 
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>http_port</span>:<span style=color:#bbb> </span><span style=color:#666>80</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>server_name</span>:<span style=color:#bbb> </span>localhost<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>conf_file</span>:<span style=color:#bbb> </span>/etc/nginx/conf/default.conf<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>tasks</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>print variables<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>shell</span>:<span style=color:#bbb> </span>echo &#34;{{ http_port }} {{ server_name }} {{ conf_file }}&#34;  &gt; /tmp/text.txt<span style=color:#bbb>
</span></span></span></code></pre></td></tr></table></div></div><p>我们通过<code>vars_files</code>引用了一个文件<code>user_vars.yml</code>, 在该文件中定义了一个稍微复杂的字典变量, 现在我想要获取<code>users</code>中<code>bjones</code>用户的<code>first_name</code>和<code>acook</code>用户的<code>home_dirs</code>, 可以使用如下方法:</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>{{<span style=color:#bbb> </span>users.bjones.first_name }}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>{{<span style=color:#bbb> </span>users.acook.home_dirs }}<span style=color:#bbb>
</span></span></span></code></pre></td></tr></table></div></div><p>或者如下写法:</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>{{<span style=color:#bbb> </span>users[&#39;bjones&#39;][&#39;first_name&#39;] }}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>{{<span style=color:#bbb> </span>users[&#39;acook&#39;][&#39;home_dirs&#39;] }}<span style=color:#bbb>
</span></span></span></code></pre></td></tr></table></div></div></li><li><p>变量的调试输出</p><p>有些时候, 我们在引用变量的时候, 可能需要知道变量中包含哪些信息, 以方便在执行过程中, 对变量做些处理. ansible提供一个debug模块用于调试变量输出:</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>register variables<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>hosts</span>:<span style=color:#bbb> </span>test<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>tasks</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>capture output of whoami command<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>command</span>:<span style=color:#bbb> </span>whoami<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>register</span>:<span style=color:#bbb> </span>login<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>debug</span>:<span style=color:#bbb> </span>var=login<span style=color:#bbb>
</span></span></span></code></pre></td></tr></table></div></div><p>执行后输出如下:</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#080;font-style:italic># ansible-playbook register.yml </span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PLAY <span style=color:#666>[</span>register variables<span style=color:#666>]</span> ***************************************************************************************************************************************************
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#666>[</span>Gathering Facts<span style=color:#666>]</span> ******************************************************************************************************************************************************
</span></span><span style=display:flex><span>ok: <span style=color:#666>[</span>192.168.0.187<span style=color:#666>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#666>[</span>capture output of whoami command<span style=color:#666>]</span> *************************************************************************************************************************************
</span></span><span style=display:flex><span>changed: <span style=color:#666>[</span>192.168.0.187<span style=color:#666>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#666>[</span>debug<span style=color:#666>]</span> ****************************************************************************************************************************************************************
</span></span><span style=display:flex><span>ok: <span style=color:#666>[</span>192.168.0.187<span style=color:#666>]</span> <span style=color:#666>=</span>&gt; <span style=color:#666>{</span>
</span></span><span style=display:flex><span>    <span style=color:#b44>&#34;login&#34;</span>: <span style=color:#666>{</span>
</span></span><span style=display:flex><span>        <span style=color:#b44>&#34;changed&#34;</span>: true,
</span></span><span style=display:flex><span>        <span style=color:#b44>&#34;cmd&#34;</span>: <span style=color:#666>[</span>
</span></span><span style=display:flex><span>            <span style=color:#b44>&#34;whoami&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#666>]</span>,
</span></span><span style=display:flex><span>        <span style=color:#b44>&#34;delta&#34;</span>: <span style=color:#b44>&#34;0:00:00.004279&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#b44>&#34;end&#34;</span>: <span style=color:#b44>&#34;2019-05-24 00:41:43.710398&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#b44>&#34;failed&#34;</span>: false,
</span></span><span style=display:flex><span>        <span style=color:#b44>&#34;rc&#34;</span>: 0,
</span></span><span style=display:flex><span>        <span style=color:#b44>&#34;start&#34;</span>: <span style=color:#b44>&#34;2019-05-24 00:41:43.706119&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#b44>&#34;stderr&#34;</span>: <span style=color:#b44>&#34;&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#b44>&#34;stderr_lines&#34;</span>: <span style=color:#666>[]</span>,
</span></span><span style=display:flex><span>        <span style=color:#b44>&#34;stdout&#34;</span>: <span style=color:#b44>&#34;root&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#b44>&#34;stdout_lines&#34;</span>: <span style=color:#666>[</span>
</span></span><span style=display:flex><span>            <span style=color:#b44>&#34;root&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#666>]</span>
</span></span><span style=display:flex><span>    <span style=color:#666>}</span>
</span></span><span style=display:flex><span><span style=color:#666>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PLAY RECAP ******************************************************************************************************************************************************************
</span></span><span style=display:flex><span>192.168.0.187                : <span style=color:#b8860b>ok</span><span style=color:#666>=</span><span style=color:#666>3</span>    <span style=color:#b8860b>changed</span><span style=color:#666>=</span><span style=color:#666>1</span>    <span style=color:#b8860b>unreachable</span><span style=color:#666>=</span><span style=color:#666>0</span>    <span style=color:#b8860b>failed</span><span style=color:#666>=</span><span style=color:#666>0</span>    <span style=color:#b8860b>skipped</span><span style=color:#666>=</span><span style=color:#666>0</span>    <span style=color:#b8860b>rescued</span><span style=color:#666>=</span><span style=color:#666>0</span>    <span style=color:#b8860b>ignored</span><span style=color:#666>=</span><span style=color:#666>0</span> 
</span></span></code></pre></td></tr></table></div></div><p>关于输出的debug部分重点说明如下:</p><ul><li>login: 变量名, 其值为一个字典</li><li>changed: ansible基于此来判断是否发生了状态改变</li><li>cmd: 被调用的命令</li><li>failed: 是否运行失败</li><li>rc: 返回值, 0代表正常, 非0代表异常</li><li>stderr: 如果出现异常, 会在这里显示错误输出</li><li>stderr_lines: 按行分割的错误输出</li><li>stdout: 如果指令正常运行, 则在这里输出返回结果</li><li>stdout: 按行分割的返回结果</li></ul><blockquote><p>需要说明的是, 通过register注册的变量的结果并不是一成不变的, 在不确定返回值的情况下, 尽量调试看看输出结果</p></blockquote><p>关于debug的更多用法说明:</p><p>调试模块, 用于在调试中输出信息
常用参数:</p><ul><li>msg: 调试输出的消息</li><li>var: 将某个变量传递给debug模块, debug会直接将其打印输出</li><li>verbosity: debug的级别</li></ul><p>示例:</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#080;font-style:italic># Example that prints the loopback address and gateway for each host</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>- <span style=color:green;font-weight:700>debug</span>:<span style=color:#bbb> </span>msg=&#34;System {{ inventory_hostname }} has uuid {{ ansible_product_uuid }}&#34;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>- <span style=color:green;font-weight:700>debug</span>:<span style=color:#bbb> </span>msg=&#34;System {{ inventory_hostname }} has gateway {{ ansible_default_ipv4.gateway }}&#34;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>when</span>:<span style=color:#bbb> </span>ansible_default_ipv4.gateway is defined<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>- <span style=color:green;font-weight:700>shell</span>:<span style=color:#bbb> </span>/usr/bin/uptime<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>register</span>:<span style=color:#bbb> </span>result<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>- <span style=color:green;font-weight:700>debug</span>:<span style=color:#bbb> </span>var=result verbosity=2   <span style=color:#bbb> </span><span style=color:#080;font-style:italic>#直接将上一条指令的结果作为变量传递给var, 由debug打印出result的值</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>Display all variables/facts known for a host<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>debug</span>:<span style=color:#bbb> </span>var=hostvars[inventory_hostname] verbosity=4<span style=color:#bbb>
</span></span></span></code></pre></td></tr></table></div></div></li></ul></li></ol><h4 id=文章推荐>文章推荐</h4><ul><li><a href=https://docs.ansible.com/>官方文档</a></li></ul><h2 id=运维服务>运维服务</h2><h3 id=zookeeper>Zookeeper</h3><p><strong>分布式数据一致性解决方案</strong></p><h4 id=基本概念>基本概念</h4><ul><li><strong>顺序一致性</strong>: 顺序一致性](<a href=https://www.jianshu.com/p/59ea658a1313>https://www.jianshu.com/p/59ea658a1313</a>) 系统中的所有进程, 看到的操作顺序, 都与全局时钟下的顺序一致</li><li><strong>线性一致性</strong>: 除满足顺序一致性外, 还要求任何一次读都能读到某个数据的最近一次写的数据. 顺序一致性和线性一致性都是强一致性, 因果一致性和最终一致性是弱一致性</li><li><strong>Leader</strong>: Leader服务器在整个集群正常运行期间有且仅有一台,集群会通过选举的方式选举出Leader服务器, 由它统一处理集群的事务性请求以及集群内各服务器的调度</li><li><strong>Follower</strong>: 集群中可以有多台Follower服务器, Follower服务器参与Leader选举投票和事务请求(写请求)Proposal的投票, 可以处理客户端非事务请求(读请求), 并会将事务请求(写请求)转发给Leader服务器</li><li><strong>Observer</strong>: 弱化版的Follower, 其像Follower一样能够处理非事务也就是读请求,并转发事务请求给Leader服务器, 但是其不参与任何形式的投票, 不管是Leader选举投票还是事务请求Proposal的投票. 引入这个角色主要是为了在不影响集群事务处理能力的前提下提升集群的非事务处理的吞吐量</li><li><strong>Znode</strong>: Zookeeper将数据存储于内存中,具体而言, Znode是存储数据的最小单元. 而Znode被以层次化的结构进行组织, 形容一棵树. 其对外提供的视图类似于Unix文件系统. 树的根Znode节点相当于Unix文件系统的根路径. 正如Unix中目录下可以有子目录一样, Znode结点下也可以挂载子结点<ul><li>持久结点(PERSISTENT)
最常见的Znode类型, 一旦创建将一直存在于服务端,除非客户端通过删除操作进行删除. 持久结点下可以创建子结点</li><li>持久顺序结点(PERSISTENT_SEQUENTIAL)
在具有持久结点基本特性的基础上,会通过在结点路径后缀一串序号来区分多个子结点创建的先后顺序. 这工作由Zookeeper服务端自动给我们做, 只要在创建Znode时指定结点类型为该类型</li><li>临时结点(EPHEMERAL)
临时结点的生命周期和客户端会话保持一致. 客户端段会话存在的话临时结点也存在, 客户端会话断开则临时结点会自动被服务端删除. 临时结点下不能创建子结点</li><li>临时顺序结点(EPHEMERAL_SEQUENTIAL)
具有临时结点的基本特性, 又有顺序性</li></ul></li></ul><h4 id=架构特性>架构特性</h4><ol><li><p>集群架构</p><p><img src=./hadoop-zk.jpg alt=hadoop-zk></p><p><img src=./Zookeeper%E6%9E%B6%E6%9E%84%E5%9B%BE.jpg alt=Zookeeper架构图></p></li><li><p>数据模型</p><p><img src=./OIP.jpeg alt=OIP></p></li><li><p>请求流</p><p><img src=./zookeeper%E8%AF%B7%E6%B1%82%E6%B5%81.png alt=zookeeper请求流></p><p><img src=./zookeeper-process.jpg alt=zookeeper-process></p><ol><li><p>所有的事务请求都交由集群的Leader服务器来处理, Leader服务器会将一个事务请求转换成一个Proposal(提议), 并为其生成一个全局递增的唯一ID, 这个ID就是事务ID(即ZXID), Leader服务器对Proposal是按其ZXID的先后顺序来进行排序和处理的</p></li><li><p>之后Leader服务器会将Proposal放入每个Follower对应的队列中(Leader会为每个Follower分配一个单独的队列), 并以FIFO的方式发送给Follower服务器</p></li><li><p>Follower服务器接收到事务Proposal后, 首先以事务日志的方式写入本地磁盘, 并且在成功后返回Leader服务器一个ACK响应</p></li><li><p>Leader服务器只要收到过半Follower的ACK响应, 就会广播一个Commit消息给Follower以通知其进行Proposal的提交, 同时Leader自身也会完成Proposal的提交</p></li></ol></li><li><p>读写请求</p><p>Zookeeper数据以Znode为最小单位组成一颗树, 内存中存储了整棵树的全量内容, 包括所有的节点路径、节点数据、ACL信息. Zookeeper会定时将这个数据存储到磁盘上</p><p>Zookeeper的Zab一致性协议实现写操作的线性一致性和读操作的顺序一致性. 整体遵循顺序一致性.</p><p>Zookeeper的所有写操作都通过主节点进行, 从节点复制修改操作, 这样所有节点的更新顺序都和主节点相同, 不会出现某个节点的更新顺序与其它节点不同的情况.</p><p>Zookeeper允许客户端从从节点读取数据, 因此如果客户端在读取过程中连接了不同的节点, 则顺序一致性就得不到保证了.</p></li><li><p>session与监听</p><p>zookeeper会为每个客户端分配一个session, 类似于web服务器一样, 用来标识客户端的身份. Server和客户端都可以主动断开session, session断开后临时ZNode会被删除. 客户端会自动利用其他server重建session.</p><p>Watcher(事件监听器)是Zookeeper提供的一种发布/订阅的机制. Zookeeper允许用户在指定ZNode上注册一些Watcher, 并且在一些特定事件触发的时候, Zookeeper服务端会将事件通知给订阅的客户端. Zookeeper的监听器是一次性的, 触发一次后如果希望继续监听, 需要重新注册Watcher.</p></li><li><p>应用场景</p><p>名字服务, 配置管理, 集群管理, 集群选举, 分布式锁, 队列管理, 消息订阅</p></li></ol><h4 id=配置文件-1>配置文件</h4><ul><li><strong>$ZOOKEEPER_HOME/conf/zoo.cfg</strong>: 核心配置文件</li></ul><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#080;font-style:italic># ZooKeeper中使用的基本时间单元, 以毫秒为单位, 默认值是2000. 它用来调节心跳和超时. 例如默认的会话超时时间是两倍的tickTime</span>
</span></span><span style=display:flex><span><span style=color:#b44>ticketTime</span><span style=color:#666>=</span><span style=color:#b44>2000</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 用于配置允许followers连接并同步到leader的最大时间. 如果ZooKeeper管理的数据量很大的话可以增加这个值. 默认值是10, 即tickTime属性值的10倍</span>
</span></span><span style=display:flex><span><span style=color:#b44>initLimit</span><span style=color:#666>=</span><span style=color:#b44>10</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 用于配置leader和followers间进行心跳检测的最大延迟时间. 如果在设置的时间内followers无法与leader进行通信, 那么followers将会被丢弃. 默认值是5, 即tickTime属性值的5倍</span>
</span></span><span style=display:flex><span><span style=color:#b44>syncLimit</span><span style=color:#666>=</span><span style=color:#b44>5</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 服务器监听客户端连接的端口. 也即客户端尝试连接的端口. 默认值是2181</span>
</span></span><span style=display:flex><span><span style=color:#b44>clientPort</span><span style=color:#666>=</span><span style=color:#b44>2181</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># ZooKeeper用来存储内存数据库快照的目录, 并且除非指定其它目录, 否则数据库更新的事务日志也将会存储在该目录下</span>
</span></span><span style=display:flex><span><span style=color:#b44>dataDir</span><span style=color:#666>=</span><span style=color:#b44>/opt/zookeeper/data</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># Zookeeper用来存储服务日志的目录</span>
</span></span><span style=display:flex><span><span style=color:#b44>dataLogDir</span><span style=color:#666>=</span><span style=color:#b44>/opt/zookeeper/logs</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 在socket级别限制单个客户端与单台服务器之前的并发连接数量, 可以通过IP地址来区分不同的客户端. 它用来防止某种类型的DoS攻击, 包括文件描述符耗尽. 默认值是60. 将其设置为0将完全移除并发连接数的限制</span>
</span></span><span style=display:flex><span><span style=color:#b44>maxClientCnxns</span><span style=color:#666>=</span><span style=color:#b44>0</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 自动清理配置. 配置ZooKeeper在自动清理的时候需要保留的数据文件快照的数量和对应的事务日志文件, 默认值是3</span>
</span></span><span style=display:flex><span><span style=color:#b44>autopurge.snapRetainCount</span><span style=color:#666>=</span><span style=color:#b44>3</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 和参数autopurge.snapRetainCount配套使用, 用于配置ZooKeeper自动清理文件的频率, 默认值是1, 即默认开启自动清理功能, 设置为0则表示禁用自动清理功能</span>
</span></span><span style=display:flex><span><span style=color:#b44>autopurge.purgeInterval</span><span style=color:#666>=</span><span style=color:#b44>1</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># zookeeper server成员列表(地址:内部通信端口:选举端口)</span>
</span></span><span style=display:flex><span><span style=color:#b44>server.1</span><span style=color:#666>=</span><span style=color:#b44>master:2888:3888</span>
</span></span><span style=display:flex><span><span style=color:#b44>server.2</span><span style=color:#666>=</span><span style=color:#b44>slave01:2888:3888</span>
</span></span><span style=display:flex><span><span style=color:#b44>server.3</span><span style=color:#666>=</span><span style=color:#b44>slave02:2888:3888</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=运维命令-1>运维命令</h4><ol><li><p>服务起停</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>zkServer.sh start
</span></span><span style=display:flex><span>zkServer.sh stop
</span></span></code></pre></td></tr></table></div></div></li><li><p>状态查看</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>zkServer.sh status
</span></span></code></pre></td></tr></table></div></div></li><li><p>交互模式</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>zkCli.sh -server localhost:2181 <span style=color:#b44>&lt;&lt; EOF
</span></span></span><span style=display:flex><span><span style=color:#b44>ls        # 查看当前znode数据
</span></span></span><span style=display:flex><span><span style=color:#b44>ls2       # 查看当前znode数据并能看到更新次数等数据
</span></span></span><span style=display:flex><span><span style=color:#b44>create    # 创建一个znode
</span></span></span><span style=display:flex><span><span style=color:#b44>get       # 得到一个znode包含数据和更新次数等数据
</span></span></span><span style=display:flex><span><span style=color:#b44>set       # 修改znode
</span></span></span><span style=display:flex><span><span style=color:#b44>delete    # 删除一个znode
</span></span></span><span style=display:flex><span><span style=color:#b44>quit      # 退出交互模式
</span></span></span><span style=display:flex><span><span style=color:#b44>EOF</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p>输出server相关信息</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#a2f>echo</span> &lt;命令&gt; | nc localhost <span style=color:#666>2181</span>
</span></span></code></pre></td></tr></table></div></div><p>命令列表:</p><table><thead><tr><th>命令</th><th>描述</th></tr></thead><tbody><tr><td>conf</td><td>zk服务配置的详细信息</td></tr><tr><td>stat</td><td>查看服务状态(包括选举信息)</td></tr><tr><td>srvr</td><td>zk服务的详细信息</td></tr><tr><td>cons</td><td>客户端与zk连接的详细信息</td></tr><tr><td>mntr</td><td>zk服务目前的性能状况</td></tr><tr><td>dump</td><td>列出未经处理的会话和临时节点</td></tr><tr><td>envi</td><td>输出关于服务环境的详细信息</td></tr><tr><td>reqs</td><td>列出未经处理的请求</td></tr><tr><td>ruok</td><td>测试服务是否启动</td></tr><tr><td>kill</td><td>关闭服务</td></tr><tr><td>wchs</td><td>watch的简要信息</td></tr><tr><td>wchc</td><td>watch的详细信息. 客户端 -> watch的映射(线上环境要小心使用)</td></tr><tr><td>wchp</td><td>watch的详细信息. znode -> 客户端的映射(线上环境要小心使用)</td></tr></tbody></table></li></ol><h4 id=常用api>常用API</h4><h4 id=相关工具>相关工具</h4><ul><li>性能压测 <a href="https://link.zhihu.com/?target=https%3A//github.com/phunt/zk-smoketest">https://github.com/phunt/zk-smoketest</a></li><li>watch性能压测 <a href="https://link.zhihu.com/?target=https%3A//github.com/kevinlynx/zk-benchmark">https://github.com/kevinlynx/zk-benchmark</a></li><li>性能监控 <a href="https://link.zhihu.com/?target=https%3A//github.com/phunt/zktop">https://github.com/phunt/zktop</a></li><li>cli工具 <a href="https://link.zhihu.com/?target=https%3A//github.com/let-us-go/zkcli">https://github.com/let-us-go/zkcli</a></li><li>抓包工具 <a href="https://link.zhihu.com/?target=https%3A//github.com/pyinx/zk-sniffer">https://github.com/pyinx/zk-sniffer</a></li><li>数据同步 <a href="https://link.zhihu.com/?target=https%3A//github.com/ksprojects/zkcopy">https://github.com/ksprojects/zkcopy</a></li><li>proxy <a href="https://link.zhihu.com/?target=https%3A//github.com/pyinx/zk-proxy">https://github.com/pyinx/zk-proxy</a></li></ul><h4 id=文章推荐-1>文章推荐</h4><ul><li><a href=https://zookeeper.apache.org/doc/r3.7.0/index.html>官方文档</a></li><li><a href="https://link.zhihu.com/?target=https%3A//blog.51cto.com/nileader/1068033">Zookeeper系列文章</a></li><li><a href=https://www.cnblogs.com/takumicx/p/9508706.html>https://www.cnblogs.com/takumicx/p/9508706.html</a></li><li><a href="https://link.zhihu.com/?target=https%3A//yuzhouwan.com/posts/31915/">Zookeeper原理与优化</a></li><li><a href=https://kknews.cc/code/6oeqlnl.html>几句话了解Zookeeper工作原理</a></li></ul><h4 id=排障经验>排障经验</h4><blockquote><ol><li><p>数据大小不超过500M</p><p>风险: 数据过大会导致集群恢复时间过长、GC加重、客户端超时增多</p></li><li><p>单机连接数不超过2w</p><p>风险: 连接数过高会导致集群恢复时间过长(zookeeper在选举之前会主动关闭所有的连接, 如果这时候不断有新的连接进来会导致zookeeper一直在关闭连接, 无法进行选举)</p></li><li><p>watch数不超过100w</p><p>风险: watch数过高会影响集群的写入性能</p></li><li><p>不要维护一个超大集群</p><p>风险: 稳定性风险高、故障影响面大、运维不可控</p></li></ol></blockquote><h3 id=kafka>Kafka</h3><p><strong>分布式流处理系统/消息队列</strong></p><h4 id=基本概念-1>基本概念</h4><ul><li><strong>Broker</strong>: 部署了Kafka实例的服务器节点, 各节点地位相同, 通过metadata API管理Broker之间的负载均衡, 增减集群Broker时需要手动进行分区副本重分配</li><li><strong>Topic</strong>: 区分不同类型信息的主题, 每个主题都是同一类别消息记录(record)的集合</li><li><strong>Partition</strong>: 每个topic可以有一个或多个partition(分区). 分区是在物理层面上的, 不同的分区对应着不同的数据文件. 分区可以分布在不同的服务器(broker)上. 同一主题下的不同分区包含的消息是不同的, 分区在存储层面可以看作一个可追加的日志(Log)文件, 消息在被追加到分区日志文件的时候都会分配一个特定的偏移量(offset). offset是消息在分区中的唯一标识, Kafka通过它来保证消息在分区内的顺序性, 不过offset并不跨越分区, 也就是说, Kafka保证的是分区有序而不是主题有序</li><li><strong>Replica</strong>: 分区引入了多副本(Replica)机制, 通过增加副本数量可以提升容灾能力. 同一分区的不同副本中保存的是相同的消息(在同一时刻, 副本之间并非完全一样), 副本之间是"一主多从"的关系, 其中leader副本负责处理读写请求, follower副本只负责与leader副本的消息同步. 副本处于不同的broker中, 当leader副本出现故障时, 从follower副本中重新选举新的leader副本对外提供服务</li><li><strong>Record</strong>: 实际写入Kafka中并可以被读取的消息记录. 每个record包含了key、value和timestamp</li><li><strong>Producer</strong>: 生产者. 用来向Kafka中发送数据(record), 将消息发送到特定的主题</li><li><strong>Consumer</strong>: 消费者. 用来读取Kafka中的数据(record), 订阅主题并进行消费</li><li><strong>Consumer Group</strong>: 消费者组是逻辑上的订阅者, 一个消费者组可以包含一个或多个消费者, 消费者组内每个消费者负责消费不同分区的数据. 使用多分区+多消费者方式可以极大提高数据下游的处理速度</li><li><strong>Rebalance</strong>: Rebalance本质上是一种协议, 规定了一个Consumer Group下的所有Consumer如何达成一致, 来分配订阅Topic的每个Partition. 分区的分配的过程就叫Rebalance. 当出现Consumer Group成员数发生变更, 订阅Topic数发生变更或订阅Topic的Partiton数发生变更时都会触发Rebalance, Rebalance期间所有Consumer实例都会停止消费, 性能影响较大, 应尽量避免产生Rebalance</li><li><strong>Coordinator</strong>: Coordinator一般指的是运行在每个Broker上的Group Coordinator进程, 每个Broker启动的时候, 都会创建Group Coordinator实例, 用于管理Consumer Group中的各个成员, 主要用于offset位移管理和Rebalance. 一个Coordinator可以同时管理多个消费者组. 此外每个Consumer实例化时, 同时实例化一个Consumer Coordinator对象, 负责同一个消费组下各个消费者和服务端Group Coordinator之前的通信(心跳)</li><li><strong>Zookeeper</strong>: 分布式一致性协调器, 负责集群元数据的管理、控制器的选举等操作</li></ul><h4 id=架构特性-1>架构特性</h4><ol><li><p>集群架构</p><p><img src=./kafka.png alt=kafka></p></li><li><p>数据模型</p><p><img src=./kafka-topic.png alt=kafka-topic></p><p><img src=./kafka-consume.png alt=kafka-consume></p><p><img src=./kafka-partition.png alt=kafka-partition></p><p><img src=./kafka-index.png alt=kafka-index></p></li><li><p>读写请求</p><p>消息数据的读写只发生在Leader上.</p><p>生产者向某Topic写入数据时, 自行决定向Topic下的哪个Partition写入(可以通过算法进行均衡负载), 确定Partition后从集群获取分区Leader, 将消息发送到Leader, 该分区的Follower主动从Leader拉取(pull)消息进行同步. 生产者通过push的方式向Topic下的Partition顺序追加消息数据, 所有分区的数据会顺序持久化到磁盘, 磁盘写入效率高</p><p>消息队列通信的两种模式是<strong>点对点模式</strong>和<strong>发布订阅</strong>模式, kafka采用的是点对点模式. 消费者主动向Kafka集群拉取消息, 消费者自行决定向Topic下的哪个Partition拉取消息(只会向Leader拉取), Kafka不关心消息是否被消费, 消费通过Partition ID和自行维护的偏移量(offset)进行消息消费(消费者的消费offset可以自动或手动提交, 维护在kafka集群的__consumer_offsets Topic中, 早期维护在zookeeper集群中)</p><p>多个消费者可以组成一个消费者组(consumer group), 每个消费者组都有一个组id. 同一个消费组者的消费者可以消费同一Topic下不同分区的数据, 但是不会组内多个消费者消费同一分区的数据</p></li><li><p>复制机制</p><p>Kafka在Partition层面采用副本机制实现数据的高可用, 每个Partition都是一主多从的架构(可配置副本数为零到多), Follower不对外提供服务, 所有的读写都发生在Leader上, Follower拉取Leader的消息数据维护数据一致性. Kafka引入In-sync Replicas(副本同步列表)机制, ISR中的都是与Leader数据同步的副本, 而OSR中的都是尚未与Leader完成数据同步的副本, 当Leader不可用时, 只有ISR中的副本能够被选举为新的Leader(可配置), ISR和OSR中的副本是根据副本的同步状态动态转移的</p><p>Leader接收Producer的消息后, 将消息写入本地Log, 并通知ISR的Follower, ISR的Follower从Leader中pull消息, 写入本地Log后向Leader发送ACK, Leader收到所有ISR中的Follower的ACK后, 增加HW并向Producer发生ACK, 表示消息写入成功. 对于ISR中的Follower的消息复制是同步的, 对于OSR中的Follower的消息复制是异步的</p></li><li><p>存储策略</p><p>Kafka会以顺序写入的方式将消息持久化到本地文件系统中, Kafka会长期保留消息(可以自定义消息有效期), 以便消费者能够重复消费消息. 默认会基于时间和大小自动删除旧数据, Kafka读取特定消息的时间复杂度是O(1), 所以这里删除过期的文件并不会提高Kafka的性能</p><p>Kafka中的Partition是以目录的形式存在于文件系统中的, 目录下会存在多组segment文件, 每组segment包含.log, .index和.timeindex三个文件. log文件就是实际存储消息的地方. 存储在log文件中的消息主要包含消息体、消息大小、offset、压缩类型……等等. index和timeindex文件为索引文件, 用于检索消息</p></li><li><p>应用场景</p><p>日志收集, 消息系统, 流量削峰, 流式处理, 事件源, 运营指标, 活动跟踪</p></li></ol><h4 id=配置文件-2>配置文件</h4><ul><li><p><strong>$ZOOKEEPER_HOME/config/server.properties</strong>: 服务端全局配置</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 37
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 38
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 39
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 40
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 41
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 42
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 43
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 44
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 45
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 46
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 47
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 48
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 49
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 50
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 51
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 52
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 53
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 54
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 55
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 56
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 57
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 58
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 59
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 60
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 61
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 62
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 63
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 64
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 65
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 66
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 67
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 68
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 69
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 70
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 71
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 72
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 73
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 74
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 75
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 76
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 77
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 78
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 79
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 80
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 81
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 82
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 83
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 84
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 85
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 86
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 87
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 88
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 89
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 90
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 91
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 92
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 93
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 94
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 95
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 96
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 97
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 98
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 99
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">100
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">101
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">102
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">103
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">104
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">105
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">106
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">107
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">108
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">109
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">110
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">111
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">112
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">113
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">114
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">115
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">116
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">117
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">118
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">119
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">120
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">121
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">122
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">123
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">124
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">125
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">126
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">127
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">128
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">129
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">130
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">131
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">132
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">133
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">134
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">135
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">136
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">137
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">138
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">139
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">140
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">141
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">142
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">143
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">144
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">145
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">146
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">147
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">148
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">149
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">150
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">151
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">152
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">153
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">154
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">155
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">156
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">157
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">158
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">159
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">160
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">161
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">162
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">163
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">164
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">165
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">166
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">167
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">168
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">169
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">170
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">171
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">172
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">173
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">174
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">175
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">176
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">177
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">178
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-properties data-lang=properties><span style=display:flex><span><span style=color:#080;font-style:italic># 每一个broker在集群中的唯一表示, 要求是正数, kafka及其根据id来识别broker机器.  当该服务器的IP地址发生改变时, broker.id没有变化, 则不会影响consumers的消息情况</span>
</span></span><span style=display:flex><span><span style=color:#b44>broker.id</span> <span style=color:#666>=</span><span style=color:#b44>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># kafka数据的存放地址, 多个地址的话用逗号分割/kafka/kafka-logs-1, /kafka/kafka-logs-2</span>
</span></span><span style=display:flex><span><span style=color:#b44>log.dirs</span><span style=color:#666>=</span><span style=color:#b44>/kafka/kafka-logs</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># broker server服务端口</span>
</span></span><span style=display:flex><span><span style=color:#b44>port</span> <span style=color:#666>=</span><span style=color:#b44>9092</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 表示消息体的最大大小, 单位是字节</span>
</span></span><span style=display:flex><span><span style=color:#b44>message.max.bytes</span> <span style=color:#666>=</span><span style=color:#b44>6525000</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># broker处理消息的最大线程数, 一般情况下不需要去修改</span>
</span></span><span style=display:flex><span><span style=color:#b44>num.network.threads</span> <span style=color:#666>=</span><span style=color:#b44>4</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># broker处理磁盘IO的线程数, 数值应该大于你的硬盘数</span>
</span></span><span style=display:flex><span><span style=color:#b44>num.io.threads</span> <span style=color:#666>=</span><span style=color:#b44>8</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 一些后台任务处理的线程数, 例如过期消息文件的删除等, 一般情况下不需要去做修改</span>
</span></span><span style=display:flex><span><span style=color:#b44>background.threads</span> <span style=color:#666>=</span><span style=color:#b44>4</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 等待IO线程处理的请求队列最大数, 若是等待IO的请求超过这个数值, 那么会停止接受外部消息, 应该是一种自我保护机制</span>
</span></span><span style=display:flex><span><span style=color:#b44>queued.max.requests</span> <span style=color:#666>=</span><span style=color:#b44>500</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># broker的主机地址, 若是设置了, 那么会绑定到这个地址上, 若是没有, 会绑定到所有的接口上, 并将其中之一发送到ZK, 一般不设置</span>
</span></span><span style=display:flex><span><span>host.name</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># socket的发送缓冲区, socket的调优参数SO_SNDBUFF</span>
</span></span><span style=display:flex><span><span style=color:#b44>socket.send.buffer.bytes</span><span style=color:#666>=</span><span style=color:#b44>100*1024</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># socket的接受缓冲区, socket的调优参数SO_RCVBUFF</span>
</span></span><span style=display:flex><span><span style=color:#b44>socket.receive.buffer.bytes</span> <span style=color:#666>=</span><span style=color:#b44>100*1024</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># socket请求的最大数值, 防止serverOOM, message.max.bytes必然要小于socket.request.max.bytes, 会被topic创建时的指定参数覆盖</span>
</span></span><span style=display:flex><span><span style=color:#b44>socket.request.max.bytes</span> <span style=color:#666>=</span><span style=color:#b44>100*1024*1024</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic>##Kafka中log日志的参数配置</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># topic的分区是以一堆segment文件存储的, 这个控制每个segment的大小, 会被topic创建时的指定参数覆盖</span>
</span></span><span style=display:flex><span><span style=color:#b44>log.segment.bytes</span> <span style=color:#666>=</span><span style=color:#b44>1024*1024*1024</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 这个参数会在日志segment没有达到log.segment.bytes设置的大小, 也会强制新建一个segment, 会被 topic创建时的指定参数覆盖</span>
</span></span><span style=display:flex><span><span style=color:#b44>log.roll.hours</span> <span style=color:#666>=</span><span style=color:#b44>24*7</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 日志清理策略选择有: delete和compact主要针对过期数据的处理, 或是日志文件达到限制的额度, 会被 topic创建时的指定参数覆盖</span>
</span></span><span style=display:flex><span><span style=color:#b44>log.cleanup.policy</span> <span style=color:#666>=</span> <span style=color:#b44>delete</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 数据存储的最大时间超过这个时间会根据log.cleanup.policy设置的策略处理数据, 也就是消费端能够多久去消费数据</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># log.retention.bytes和log.retention.minutes任意一个达到要求, 都会执行删除, 会被topic创建时的指定参数覆盖</span>
</span></span><span style=display:flex><span><span style=color:#b44>log.retention.minutes</span><span style=color:#666>=</span><span style=color:#b44>3days</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># topic每个分区的最大文件大小, 一个topic的大小限制 =分区数*log.retention.bytes.  -1没有大小限log.retention.bytes和log.retention.minutes任意一个达到要求, 都会执行删除, 会被topic创建时的指定参数覆盖</span>
</span></span><span style=display:flex><span><span style=color:#b44>log.retention.bytes</span><span style=color:#666>=</span><span style=color:#b44>-1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 文件大小检查的周期时间, 是否触发 log.cleanup.policy中设置的策略</span>
</span></span><span style=display:flex><span><span style=color:#b44>log.retention.check.interval.ms</span><span style=color:#666>=</span><span style=color:#b44>5minutes</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 是否开启日志压缩</span>
</span></span><span style=display:flex><span><span style=color:#b44>log.cleaner.enable</span><span style=color:#666>=</span><span style=color:#b44>false</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 日志压缩运行的线程数</span>
</span></span><span style=display:flex><span><span style=color:#b44>log.cleaner.threads</span> <span style=color:#666>=</span> <span style=color:#b44>2</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 日志压缩时候处理的最大大小</span>
</span></span><span style=display:flex><span><span style=color:#b44>log.cleaner.io.max.bytes.per.second</span><span style=color:#666>=</span><span style=color:#b44>None</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 日志压缩去重时候的缓存空间, 在空间允许的情况下, 越大越好</span>
</span></span><span style=display:flex><span><span style=color:#b44>log.cleaner.dedupe.buffer.size</span><span style=color:#666>=</span><span style=color:#b44>500*1024*1024</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 日志清理时候用到的IO块大小一般不需要修改</span>
</span></span><span style=display:flex><span><span style=color:#b44>log.cleaner.io.buffer.size</span><span style=color:#666>=</span><span style=color:#b44>512*1024</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 检查是否触发日志清理的间隔</span>
</span></span><span style=display:flex><span><span style=color:#b44>log.cleaner.backoff.ms</span> <span style=color:#666>=</span><span style=color:#b44>15000</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 日志清理的频率控制, 越大意味着更高效的清理, 同时会存在一些空间上的浪费, 会被topic创建时的指定参数覆盖</span>
</span></span><span style=display:flex><span><span style=color:#b44>log.cleaner.min.cleanable.ratio</span><span style=color:#666>=</span><span style=color:#b44>0.5</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 对于压缩的日志保留的最长时间, 也是客户端消费消息的最长时间, 同log.retention.minutes的区别在于一个控制未压缩数据, 一个控制压缩后的数据.  会被topic创建时的指定参数覆盖</span>
</span></span><span style=display:flex><span><span style=color:#b44>log.cleaner.delete.retention.ms</span> <span style=color:#666>=</span><span style=color:#b44>1day</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 对于segment日志的索引文件大小限制, 会被topic创建时的指定参数覆盖</span>
</span></span><span style=display:flex><span><span style=color:#b44>log.index.size.max.bytes</span> <span style=color:#666>=</span><span style=color:#b44>10*1024*1024</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 当执行一个fetch操作后, 需要一定的空间来扫描最近的offset大小, 设置越大, 代表扫描速度越快, 但是也更好内存, 一般情况下不需要搭理这个参数</span>
</span></span><span style=display:flex><span><span style=color:#b44>log.index.interval.bytes</span> <span style=color:#666>=</span><span style=color:#b44>4096</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># log文件”sync”到磁盘之前累积的消息条数,因为磁盘IO操作是一个慢操作,但又是一个”数据可靠性&#34;的必要手段,所以此参数的设置,需要在&#34;数据可靠性&#34;与&#34;性能&#34;之间做必要的权衡.如果此值过大,将会导致每次&#34;fsync&#34;的时间较长(IO阻塞),如果此值过小,将会导致&#34;fsync&#34;的次数较多,这也意味着整体的client请求有一定的延迟.物理server故障,将会导致没有fsync的消息丢失</span>
</span></span><span style=display:flex><span><span style=color:#b44>log.flush.interval.messages</span><span style=color:#666>=</span><span style=color:#b44>None</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 检查是否需要固化到硬盘的时间间隔</span>
</span></span><span style=display:flex><span><span style=color:#b44>log.flush.scheduler.interval.ms</span> <span style=color:#666>=</span><span style=color:#b44>3000</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 仅仅通过interval来控制消息的磁盘写入时机,是不足的.此参数用于控制&#34;fsync&#34;的时间间隔,如果消息量始终没有达到阀值,但是离上一次磁盘同步的时间间隔达到阀值,也将触发</span>
</span></span><span style=display:flex><span><span style=color:#b44>log.flush.interval.ms</span> <span style=color:#666>=</span> <span style=color:#b44>None</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 文件在索引中清除后保留的时间一般不需要去修改</span>
</span></span><span style=display:flex><span><span style=color:#b44>log.delete.delay.ms</span> <span style=color:#666>=</span><span style=color:#b44>60000</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 控制上次固化硬盘的时间点, 以便于数据恢复一般不需要去修改</span>
</span></span><span style=display:flex><span><span style=color:#b44>log.flush.offset.checkpoint.interval.ms</span> <span style=color:#666>=</span><span style=color:#b44>60000</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 是否允许自动创建topic, 若是false, 就需要通过命令创建topic</span>
</span></span><span style=display:flex><span><span style=color:#b44>auto.create.topics.enable</span> <span style=color:#666>=</span><span style=color:#b44>true</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># kafka保存消息的副本数</span>
</span></span><span style=display:flex><span><span style=color:#b44>default.replication.factor</span> <span style=color:#666>=</span><span style=color:#b44>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 每个topic的分区个数, 若是在topic创建时候没有指定的话会被topic创建时的指定参数覆盖</span>
</span></span><span style=display:flex><span><span style=color:#b44>num.partitions</span> <span style=color:#666>=</span><span style=color:#b44>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic>## Kafka中leader、replicas参数配置</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># partition leader与replicas之间通讯时,socket的超时时间</span>
</span></span><span style=display:flex><span><span style=color:#b44>controller.socket.timeout.ms</span> <span style=color:#666>=</span><span style=color:#b44>30000</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># partition leader与replicas数据同步时,消息的队列尺寸</span>
</span></span><span style=display:flex><span><span style=color:#b44>controller.message.queue.size</span><span style=color:#666>=</span><span style=color:#b44>10</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># replicas响应partition leader的最长等待时间, 若是超过这个时间, 就将replicas列入ISR(in-sync replicas), 并认为它是死的, 不会再加入管理中</span>
</span></span><span style=display:flex><span><span style=color:#b44>replica.lag.time.max.ms</span> <span style=color:#666>=</span><span style=color:#b44>10000</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 如果follower落后与leader太多,将会认为此follower[或者说partition relicas]已经失效</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 通常,在follower与leader通讯时,因为网络延迟或者链接断开,总会导致replicas中消息同步滞后, 如果消息之后太多,leader将认为此follower网络延迟较大或者消息吞吐能力有限,将会把此replicas迁移到其他follower中. 在broker数量较少,或者网络不足的环境中,建议提高此值</span>
</span></span><span style=display:flex><span><span style=color:#b44>replica.lag.max.messages</span> <span style=color:#666>=</span><span style=color:#b44>4000</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># follower与leader之间的socket超时时间</span>
</span></span><span style=display:flex><span><span style=color:#b44>replica.socket.timeout.ms</span><span style=color:#666>=</span><span style=color:#b44>30*1000</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># leader复制时候的socket缓存大小</span>
</span></span><span style=display:flex><span><span style=color:#b44>replica.socket.receive.buffer.bytes</span><span style=color:#666>=</span><span style=color:#b44>64*1024</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># replicas每次获取数据的最大大小</span>
</span></span><span style=display:flex><span><span style=color:#b44>replica.fetch.max.bytes</span> <span style=color:#666>=</span><span style=color:#b44>1024*1024</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># replicas同leader之间通信的最大等待时间, 失败了会重试</span>
</span></span><span style=display:flex><span><span style=color:#b44>replica.fetch.wait.max.ms</span> <span style=color:#666>=</span><span style=color:#b44>500</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># fetch的最小数据尺寸,如果leader中尚未同步的数据不足此值,将会阻塞,直到满足条件</span>
</span></span><span style=display:flex><span><span style=color:#b44>replica.fetch.min.bytes</span> <span style=color:#666>=</span><span style=color:#b44>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># leader进行复制的线程数, 增大这个数值会增加follower的IO</span>
</span></span><span style=display:flex><span><span style=color:#b44>num.replica.fetchers</span><span style=color:#666>=</span><span style=color:#b44>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 每个replica检查是否将最高水位进行固化的频率</span>
</span></span><span style=display:flex><span><span style=color:#b44>replica.high.watermark.checkpoint.interval.ms</span> <span style=color:#666>=</span><span style=color:#b44>5000</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 是否允许控制器关闭broker ,若是设置为true,会关闭所有在这个broker上的leader, 并转移到其他broker</span>
</span></span><span style=display:flex><span><span style=color:#b44>controlled.shutdown.enable</span> <span style=color:#666>=</span><span style=color:#b44>false</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 控制器关闭的尝试次数</span>
</span></span><span style=display:flex><span><span style=color:#b44>controlled.shutdown.max.retries</span> <span style=color:#666>=</span><span style=color:#b44>3</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 每次关闭尝试的时间间隔</span>
</span></span><span style=display:flex><span><span style=color:#b44>controlled.shutdown.retry.backoff.ms</span> <span style=color:#666>=</span><span style=color:#b44>5000</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># leader的不平衡比例, 若是超过这个数值, 会对分区进行重新的平衡</span>
</span></span><span style=display:flex><span><span style=color:#b44>leader.imbalance.per.broker.percentage</span> <span style=color:#666>=</span><span style=color:#b44>10</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 检查leader是否不平衡的时间间隔</span>
</span></span><span style=display:flex><span><span style=color:#b44>leader.imbalance.check.interval.seconds</span> <span style=color:#666>=</span><span style=color:#b44>300</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 客户端保留offset信息的最大空间大小</span>
</span></span><span style=display:flex><span><span>offset.metadata.max.bytes</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic>## kafka中zookeeper的参数配置</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 必须配置项: : : zookeeper集群的地址, 可以是多个, 多个之间用逗号分割, 一般端口都为2181；hostname1:port1,hostname2:port2,hostname3:port3</span>
</span></span><span style=display:flex><span><span style=color:#b44>zookeeper.connect</span> <span style=color:#666>=</span> <span style=color:#b44>localhost:2181</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># ZooKeeper的最大超时时间, 就是心跳的间隔, 若是没有反映, 那么认为已经死了, 不易过大</span>
</span></span><span style=display:flex><span><span style=color:#b44>zookeeper.session.timeout.ms</span><span style=color:#666>=</span><span style=color:#b44>6000</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># ZooKeeper的连接超时时间</span>
</span></span><span style=display:flex><span><span style=color:#b44>zookeeper.connection.timeout.ms</span> <span style=color:#666>=</span><span style=color:#b44>6000</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># ZooKeeper集群中leader和follower之间的同步时间</span>
</span></span><span style=display:flex><span><span style=color:#b44>zookeeper.sync.time.ms</span> <span style=color:#666>=</span><span style=color:#b44>2000</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p><strong>producer.properties</strong>: 生产者配置文件</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-properties data-lang=properties><span style=display:flex><span><span style=color:#080;font-style:italic># 指定节点列表  </span>
</span></span><span style=display:flex><span><span style=color:#b44>metadata.broker.list</span><span style=color:#666>=</span><span style=color:#b44>kafka1:9092,kafka2:9092,kafka3:9092    </span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 指定分区处理类.  默认kafka.producer.DefaultPartitioner  </span>
</span></span><span style=display:flex><span><span style=color:#b44>partitioner.class</span><span style=color:#666>=</span><span style=color:#b44>kafka.producer.DefaultPartitioner  </span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 是否压缩,0代表不压缩,1代表用gzip压缩,2代表用snappy压缩  </span>
</span></span><span style=display:flex><span><span style=color:#b44>compression.codec</span><span style=color:#666>=</span><span style=color:#b44>0  </span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 指定序列化处理类  </span>
</span></span><span style=display:flex><span><span style=color:#b44>serializer.class</span><span style=color:#666>=</span><span style=color:#b44>kafka.serializer.DefaultEncoder    </span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 如果要压缩消息, 这里指定哪些topic要压缩消息, 默认是empty, 表示不压缩  </span>
</span></span><span style=display:flex><span><span style=color:#b44>compressed.topics</span><span style=color:#666>=</span>  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 设置发送数据是否需要服务端的反馈, 有三个值0, 1, -1  </span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 0:producer不会等待broker发送ack  </span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 1:当leader接收到消息后发送ack  </span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># -1:当所有的follower都同步消息成功后发送ack  </span>
</span></span><span style=display:flex><span><span style=color:#b44>request.required.acks</span><span style=color:#666>=</span><span style=color:#b44>0  </span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 在向producer发送ack之前, broker均需等待的最大时间  </span>
</span></span><span style=display:flex><span><span style=color:#b44>request.timeout.ms</span><span style=color:#666>=</span><span style=color:#b44>10000  </span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># sync同步（默认）, async异步可以提高发送吞吐量  </span>
</span></span><span style=display:flex><span><span style=color:#b44>producer.type</span><span style=color:#666>=</span><span style=color:#b44>async  </span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 在async模式下, 当message缓存超时后, 将会批量发送给broker,默认5000ms  </span>
</span></span><span style=display:flex><span><span style=color:#b44>queue.buffering.max.ms</span><span style=color:#666>=</span><span style=color:#b44>5000  </span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 在async模式下, Producer端允许buffer的最大消息量  </span>
</span></span><span style=display:flex><span><span style=color:#b44>queue.buffering.max.messages</span><span style=color:#666>=</span><span style=color:#b44>20000  </span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 在async模式下, 指定每次批量发送的数据量, 默认200  </span>
</span></span><span style=display:flex><span><span style=color:#b44>batch.num.messages</span><span style=color:#666>=</span><span style=color:#b44>500  </span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 当消息在producer端沉积的条数达到“queue.buffering.max.messages&#34;后  </span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 阻塞一定时间后, 队列仍然没有enqueue（producer仍然没有发送出任何消息）  </span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 此时producer可以继续阻塞, 或者将消息抛弃  </span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># -1: 无阻塞超时限制, 消息不会被抛弃  </span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 0 : 立即清空队列, 消息被抛弃  </span>
</span></span><span style=display:flex><span><span style=color:#b44>queue.enqueue.timeout.ms</span><span style=color:#666>=</span><span style=color:#b44>-1</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p><strong>consumer.properties</strong>: 消费者配置文件</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-properties data-lang=properties><span style=display:flex><span><span style=color:#080;font-style:italic># Consumer归属的组ID, broker是根据group.id来判断是队列模式还是发布订阅模式, 非常重要</span>
</span></span><span style=display:flex><span><span>group.id</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 消费者的ID, 若是没有设置的话, 会自增</span>
</span></span><span style=display:flex><span><span>consumer.id</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 一个用于跟踪调查的ID , 最好同group.id相同</span>
</span></span><span style=display:flex><span><span style=color:#b44>client.id</span> <span style=color:#666>=</span> <span style=color:#b44>group id value</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 对于zookeeper集群的指定, 可以是多个 hostname1:port1,hostname2:port2,hostname3:port3 必须和broker使用同样的zk配置</span>
</span></span><span style=display:flex><span><span style=color:#b44>zookeeper.connect</span><span style=color:#666>=</span><span style=color:#b44>localhost:2182</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># zookeeper的心跳超时时间, 查过这个时间就认为是dead消费者</span>
</span></span><span style=display:flex><span><span style=color:#b44>zookeeper.session.timeout.ms</span> <span style=color:#666>=</span><span style=color:#b44>6000</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># zookeeper的等待连接时间</span>
</span></span><span style=display:flex><span><span style=color:#b44>zookeeper.connection.timeout.ms</span> <span style=color:#666>=</span><span style=color:#b44>6000</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># zookeeper的follower同leader的同步时间</span>
</span></span><span style=display:flex><span><span style=color:#b44>zookeeper.sync.time.ms</span> <span style=color:#666>=</span><span style=color:#b44>2000</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 当zookeeper中没有初始的offset时候的处理方式 .  smallest : 重置为最小值 largest:重置为最大值 anythingelse: 抛出异常</span>
</span></span><span style=display:flex><span><span style=color:#b44>auto.offset.reset</span> <span style=color:#666>=</span> <span style=color:#b44>largest</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># socket的超时时间, 实际的超时时间是: max.fetch.wait + socket.timeout.ms.</span>
</span></span><span style=display:flex><span><span style=color:#b44>socket.timeout.ms</span><span style=color:#666>=</span><span style=color:#b44>30*1000</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># socket的接受缓存空间大小</span>
</span></span><span style=display:flex><span><span style=color:#b44>socket.receive.buffer.bytes</span><span style=color:#666>=</span><span style=color:#b44>64*1024</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic>#从每个分区获取的消息大小限制</span>
</span></span><span style=display:flex><span><span style=color:#b44>fetch.message.max.bytes</span> <span style=color:#666>=</span><span style=color:#b44>1024*1024</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 是否在消费消息后将offset同步到zookeeper, 当Consumer失败后就能从zookeeper获取最新的offset</span>
</span></span><span style=display:flex><span><span style=color:#b44>auto.commit.enable</span> <span style=color:#666>=</span><span style=color:#b44>true </span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 自动提交的时间间隔</span>
</span></span><span style=display:flex><span><span style=color:#b44>auto.commit.interval.ms</span> <span style=color:#666>=</span><span style=color:#b44>60*1000</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 用来处理消费消息的块, 每个块可以等同于fetch.message.max.bytes中数值</span>
</span></span><span style=display:flex><span><span style=color:#b44>queued.max.message.chunks</span> <span style=color:#666>=</span><span style=color:#b44>10</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 当有新的consumer加入到group时,将会reblance,此后将会有partitions的消费端迁移到新</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 的consumer上,如果一个consumer获得了某个partition的消费权限,那么它将会向zk注册</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic>#&#34;Partition Owner registry&#34;节点信息,但是有可能此时旧的consumer尚没有释放此节点,</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 此值用于控制,注册节点的重试次数.</span>
</span></span><span style=display:flex><span><span style=color:#b44>rebalance.max.retries</span> <span style=color:#666>=</span><span style=color:#b44>4</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 每次再平衡的时间间隔</span>
</span></span><span style=display:flex><span><span style=color:#b44>rebalance.backoff.ms</span> <span style=color:#666>=</span><span style=color:#b44>2000</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 每次重新选举leader的时间</span>
</span></span><span style=display:flex><span><span>refresh.leader.backoff.ms</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># server发送到消费端的最小数据, 若是不满足这个数值则会等待, 知道满足数值要求</span>
</span></span><span style=display:flex><span><span style=color:#b44>fetch.min.bytes</span> <span style=color:#666>=</span><span style=color:#b44>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 若是不满足最小大小(fetch.min.bytes)的话, 等待消费端请求的最长等待时间</span>
</span></span><span style=display:flex><span><span style=color:#b44>fetch.wait.max.ms</span> <span style=color:#666>=</span><span style=color:#b44>100</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 指定时间内没有消息到达就抛出异常, 一般不需要改</span>
</span></span><span style=display:flex><span><span style=color:#b44>consumer.timeout.ms</span> <span style=color:#666>=</span> <span style=color:#b44>-1</span>
</span></span></code></pre></td></tr></table></div></div></li></ul><h4 id=运维命令-2>运维命令</h4><blockquote><p>kafka相关运维命令中, 低版本使用<code>--zookeeper localhost:2181</code>的地方在高版本中统一用<code>--bootstrap-server localhost:9092</code>代替</p></blockquote><ol><li><p>服务启停</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#080;font-style:italic># zookeeper启停</span>
</span></span><span style=display:flex><span>sh bin/zookeeper-server-start.sh -daemon config/zookeeper.properties
</span></span><span style=display:flex><span>sh bin/zookeeper-server-stop.sh
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># kafka启停</span>
</span></span><span style=display:flex><span>sh bin/kafka-server-start.sh config/server.properties
</span></span><span style=display:flex><span>sh bin/kafka-server-stop.sh
</span></span></code></pre></td></tr></table></div></div></li><li><p>配置管理</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#080;font-style:italic># 查看配置</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic>## 在zookeeper上查看</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic>## 节点目录一般是 /config/entityType/entityName</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic>## entityType可以是brokers、topics、users、clients</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic>## entityName表示具体的名称, 比如broker的id, topic的名称</span>
</span></span><span style=display:flex><span>sh bin/zookeeper-shell.sh <span style=color:#b44>&lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#b44>  get /kafka/config/brokers/0  # /kafka 是命名空间
</span></span></span><span style=display:flex><span><span style=color:#b44>EOF</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic>## 列出某个entityType的entityName的全部配置项</span>
</span></span><span style=display:flex><span>sh bin/kafka-configs.sh --describe --all --bootstrap-server localhost:9092 --entity-type topics --entity-name <span style=color:#a2f>test</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># broker配置</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic>## 将0号broker的配置 log.cleaner.backoff.ms修改成1000,flush.ms 也修改成1000</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic>## --alter 表示要修改配置项</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic>## --add-config 后面跟着要修改的配置项</span>
</span></span><span style=display:flex><span>sh bin/kafka-configs.sh --alert --bootstrap-server localhost:9092 --entity-type brokers --entity-name <span style=color:#666>0</span> --add-config log.cleaner.backoff.ms<span style=color:#666>=</span>1000,flush.ms<span style=color:#666>=</span><span style=color:#666>1000</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic>## 删除0号broker 对 log.cleaner.backoff.ms的配置</span>
</span></span><span style=display:flex><span>sh bin/kafka-configs.sh --alert --bootstrap-server localhost:9092 --entity-type brokers --entity-name <span style=color:#666>0</span> --delete-config log.cleaner.backoff.ms
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic>## 列出0号broker修改过的配置项</span>
</span></span><span style=display:flex><span>sh bin/kafka-configs.sh --describe --bootstrap-server localhost:9092 --entity-type brokers --entity-name <span style=color:#666>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># topic配置</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic>## 将test这个topic的 delete.retention.ms修改成1000,flush.ms 也修改成1000</span>
</span></span><span style=display:flex><span>sh bin/kafka-configs.sh --alter --bootstrap-server localhost:9092 --entity-type topics --entity-name <span style=color:#a2f>test</span> --add-config delete.retention.ms<span style=color:#666>=</span>1000,flush.ms<span style=color:#666>=</span><span style=color:#666>1000</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic>## 删除test这个topic的 delete.retention.ms和flush.ms配置项</span>
</span></span><span style=display:flex><span>sh bin/kafka-configs.sh --alert --bootstrap-server localhost:9092 --entity-type topics --entity-name <span style=color:#a2f>test</span> --delete-config delete.retention.ms,flush.ms
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic>## 列出test这个topic修改过的配置项</span>
</span></span><span style=display:flex><span>sh bin/kafka-configs.sh --describe --bootstrap-server localhost:9092 --entity-type topics --entity-name <span style=color:#a2f>test</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># client配置</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic>## 设置客户端id为test的producer_byte_rate和consumer_byte_rate为1024</span>
</span></span><span style=display:flex><span>sh bin/kafka-configs.sh --alter --bootstrap-server localhost:9092 --add-config <span style=color:#b44>&#39;producer_byte_rate=1024,consumer_byte_rate=1024&#39;</span> --entity-type clients --entity-name <span style=color:#a2f>test</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p>topic管理</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#080;font-style:italic># 创建topic</span>
</span></span><span style=display:flex><span>sh bin/kafka-topics.sh --create --zookeeper localhost:2181 --replication-factor <span style=color:#666>1</span> --partitions <span style=color:#666>1</span> --topic <span style=color:#a2f>test</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 列出topic</span>
</span></span><span style=display:flex><span>sh bin/kafka-topics.sh --list --zookeeper localhost:2181
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 描述topic信息</span>
</span></span><span style=display:flex><span>sh bin/kafka-topics.sh --describe --zookeeper localhost:2181 --topic <span style=color:#a2f>test</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 修改topic</span>
</span></span><span style=display:flex><span>sh bin/kafka-topics.sh --alert --zookeeper localhost:2181 --topic <span style=color:#a2f>test</span> --partitions <span style=color:#666>2</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 删除topic</span>
</span></span><span style=display:flex><span>sh bin/kafka-topics.sh --delete --zookeeper localhost:2181 --topic <span style=color:#a2f>test</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 查询topic最小偏移量(最大和最小偏移量相减是topic消息总量)</span>
</span></span><span style=display:flex><span>sh bin/kafka-run-class.sh kafka.tools.GetOffsetShell --broker-list localhost:9092 -topic <span style=color:#a2f>test</span> --time -2
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 查询topic最大偏移量</span>
</span></span><span style=display:flex><span>sh bin/kafka-run-class.sh kafka.tools.GetOffsetShell --broker-list localhost:9092 -topic <span style=color:#a2f>test</span> --time -1
</span></span></code></pre></td></tr></table></div></div></li><li><p>消费组管理</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#080;font-style:italic># 查询消费组(使用--bootstrap-server时可能需要--new-consumer参数)</span>
</span></span><span style=display:flex><span>sh bin/kafka-consumer-groups.sh --list --bootstrap-server localhost:9092
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 查询消费组信息</span>
</span></span><span style=display:flex><span>sh bin/kafka-consumer-groups.sh --describe --bootstrap-server localhost:9292 --group grp
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 查看消费组成员信息</span>
</span></span><span style=display:flex><span>sh bin/kafka-consumer-groups.sh --describe --members --bootstrap-server localhost:9092 --group grp --verbose
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 删除消费组</span>
</span></span><span style=display:flex><span>sh bin/kafka-consumer-groups.sh --delete --bootstrap-server localhost:9092  --group grp --group grp1
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 设置消费组的offset为最旧</span>
</span></span><span style=display:flex><span>sh bin/kafka-consumer-groups.sh --reset-offsets --bootstrap-server localhost:9092 --group grp --topic <span style=color:#a2f>test</span> --to-earliest --execute
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 设置消费组的offset为最新</span>
</span></span><span style=display:flex><span>sh bin/kafka-consumer-groups.sh --reset-offsets --bootstrap-server localhost:9092  --group grp --topic <span style=color:#a2f>test</span> --to-latest
</span></span></code></pre></td></tr></table></div></div></li><li><p>消息管理</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#080;font-style:italic># 产生消息</span>
</span></span><span style=display:flex><span>sh bin/kafka-console-producer.sh --broker-list localhost:9092 --topic <span style=color:#a2f>test</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 消费消息</span>
</span></span><span style=display:flex><span>sh bin/kafka-console-consumer.sh --bootstrap-server localhost:9092 --topic <span style=color:#a2f>test</span> --from-beginning
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 查询消费信息</span>
</span></span><span style=display:flex><span>sh bin/kafka-run-class.sh kafka.tools.ConsumerOffsetChecker --zookeeper localhost:2181 --group grp --topic <span style=color:#a2f>test</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 删除消息</span>
</span></span><span style=display:flex><span>sh bin/kafka-delete-records.sh --bootstrap-server localhost:9092 --offset-json-file delete.json
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic>## delete.json</span>
</span></span><span style=display:flex><span><span style=color:#666>{</span>
</span></span><span style=display:flex><span>  <span style=color:#b44>&#34;partitions&#34;</span>: <span style=color:#666>[</span>
</span></span><span style=display:flex><span>    <span style=color:#666>{</span>
</span></span><span style=display:flex><span>      <span style=color:#b44>&#34;topic&#34;</span>: <span style=color:#b44>&#34;test&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#b44>&#34;partition&#34;</span>: 0,
</span></span><span style=display:flex><span>      <span style=color:#b44>&#34;offset&#34;</span>: <span style=color:#666>24</span>
</span></span><span style=display:flex><span>    <span style=color:#666>}</span>
</span></span><span style=display:flex><span>  <span style=color:#666>]</span>,
</span></span><span style=display:flex><span>  <span style=color:#b44>&#34;version&#34;</span>: <span style=color:#666>1</span>
</span></span><span style=display:flex><span><span style=color:#666>}</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p>分区副本重分配</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span>#</span> <span>gen.json</span> <span>(自动重分配gen文件)</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;topics&#34;</span>: [
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:green;font-weight:700>&#34;topic&#34;</span>: <span style=color:#b44>&#34;foo&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  ],
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;version&#34;</span>: <span style=color:#666>1</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span>#</span> <span>assign.json</span> <span>(可通过自动重分配生成)</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;partitions&#34;</span>: [
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:green;font-weight:700>&#34;topic&#34;</span>: <span style=color:#b44>&#34;test&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:green;font-weight:700>&#34;partition&#34;</span>: <span style=color:#666>1</span>,
</span></span><span style=display:flex><span>      <span style=color:green;font-weight:700>&#34;replicas&#34;</span>: [
</span></span><span style=display:flex><span>        <span style=color:#666>1002</span>,
</span></span><span style=display:flex><span>        <span style=color:#666>1003</span>
</span></span><span style=display:flex><span>      ]
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:green;font-weight:700>&#34;topic&#34;</span>: <span style=color:#b44>&#34;test&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:green;font-weight:700>&#34;partition&#34;</span>: <span style=color:#666>2</span>,
</span></span><span style=display:flex><span>      <span style=color:green;font-weight:700>&#34;replicas&#34;</span>: [
</span></span><span style=display:flex><span>        <span style=color:#666>1003</span>,
</span></span><span style=display:flex><span>        <span style=color:#666>1002</span>
</span></span><span style=display:flex><span>      ]
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  ],
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;version&#34;</span>: <span style=color:#666>1</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#080;font-style:italic># 自动生成分区副本重分配文件</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># --generate 表示生成重分配的json文件</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># --topics-to-move-json-file 指定要重分配哪些topic</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># --broker-list 表示要分配到哪些broker上去</span>
</span></span><span style=display:flex><span>sh bin/kafka-reassign-partitions.sh --generate --zookeeper localhost:2181 --topics-to-move-json-file gen.json --broker-list 1001,1002,1003
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 执行分区副本重分配</span>
</span></span><span style=display:flex><span>sh bin/kafka-reassign-partitions.sh --execute --zookeeper localhost:2181 --reassignment-json-file assign.json
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 查看分区副本重分配执行状态</span>
</span></span><span style=display:flex><span>sh bin/kafka-reassign-partitions.sh --verify --zookeeper localhost:2181 --reassignment-json-file assign.json 
</span></span></code></pre></td></tr></table></div></div></li><li><p>其他命令</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#080;font-style:italic># 生产性能测试(acks=-1)</span>
</span></span><span style=display:flex><span>sh bin/kafka-producer-perf-test.sh --broker-list localhost:9092 --batch-size <span style=color:#666>1</span> --message-size <span style=color:#666>1024</span> --messages <span style=color:#666>10000</span> --sync --topics <span style=color:#a2f>test</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 消费性能测试</span>
</span></span><span style=display:flex><span>sh bin/kafka-consumer-perf-test.sh --topic-list localhost:9092 --message-size <span style=color:#666>200</span> --messages <span style=color:#666>50000</span> --topic <span style=color:#a2f>test</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 查看消息元数据</span>
</span></span><span style=display:flex><span>sh bin/kafka-run-class.sh kafka.tools.DumpLogSegments --files /dfs5/kafka/data/secLog-2/00000000000110325000.log --print-data-log --deep-iteration &gt; secLog.log
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 集群镜像</span>
</span></span><span style=display:flex><span>sh bin/kafka-mirror-maker.sh --consumer.config config/consumer.properties --producer.config config/producer.properties --new.consumer -num.streams<span style=color:#666>=</span><span style=color:#666>2</span> --whitelist <span style=color:#b44>&#34;.*&#34;</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 客户端限流</span>
</span></span><span style=display:flex><span>sh bin/kafka-configs.sh --alter --zookeeper localhost:2181 --add-config <span style=color:#b44>&#39;producer_byte_rate=1024,consumer_byte_rate=2048&#39;</span> --entity-name ClientA --entity-type clients
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 用户限流</span>
</span></span><span style=display:flex><span>sh bin/kafka-configs.sh --alert --zookeeper localhost:2181 --add-config <span style=color:#b44>&#39;producer_byte_rate=1024,consumer_byte_rate=2048,request_percentage=200&#39;</span> --entity-type users --entity-name user1
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 查看限流</span>
</span></span><span style=display:flex><span>sh bin/kafka-configs.sh --describe --zookeeper localhost:2181 --entity-type users --entity-name user1 --entity-type clients --entity-name clientA
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 查看broker限流配置</span>
</span></span><span style=display:flex><span>sh bin/kafka-configs.sh --describe --zookeeper localhost:2181 --entity-type brokers
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 查看限流的副本</span>
</span></span><span style=display:flex><span>sh bin/kafka-configs.sh --describe --zookeeper localhost:2181 --entity-type topics
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 查询 __consumer_offsets topic 所有内容</span>
</span></span><span style=display:flex><span>sh bin/kafka-console-consumer.sh --formatter --topic __consumer_offsets --bootstrap-server localhost:9092 <span style=color:#b44>&#34;kafka.coordinator.group.GroupMetadataManager\$OffsetsMessageFormatter&#34;</span> --consumer.config /soft/kafka/config/consumer.properties --from-beginning
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 分区选举</span>
</span></span><span style=display:flex><span>sh bin/kafka-preferred-replica-election.sh --zookeeper localhost:2181 --path-to-json-file prefered.json
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># prefered.json</span>
</span></span><span style=display:flex><span><span style=color:#666>{</span>
</span></span><span style=display:flex><span>  <span style=color:#b44>&#34;partitions&#34;</span>: <span style=color:#666>[</span>
</span></span><span style=display:flex><span>    <span style=color:#666>{</span>
</span></span><span style=display:flex><span>      <span style=color:#b44>&#34;topic&#34;</span>: <span style=color:#b44>&#34;test&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#b44>&#34;partition&#34;</span>: <span style=color:#666>0</span>
</span></span><span style=display:flex><span>    <span style=color:#666>}</span>
</span></span><span style=display:flex><span>  <span style=color:#666>]</span>
</span></span><span style=display:flex><span><span style=color:#666>}</span>
</span></span></code></pre></td></tr></table></div></div></li></ol><h4 id=常用api-1>常用API</h4><h4 id=相关工具-1>相关工具</h4><ul><li>集群管理 <a href=https://github.com/yahoo/CMAK>https://github.com/yahoo/CMAK</a></li><li>kafka客户端 <a href=https://github.com/edenhill/kafkacat>https://github.com/edenhill/kafkacat</a></li><li>kafka运维管理 <a href=https://github.com/goops-top/gokafka>https://github.com/goops-top/gokafka</a></li></ul><h4 id=文章推荐-2>文章推荐</h4><ul><li><a href=https://kafka.apachecn.org/>官方文档</a></li><li><a href=https://blog.51cto.com/9291927/2493953>kafka快速入门系列</a></li><li><a href=https://blog.csdn.net/weichuangxxb/article/details/106983504>kafka常用工具</a></li><li><a href=https://www.cnblogs.com/itlz/p/14292104.html>kafka底层原理剖析</a></li><li><a href=https://www.cnblogs.com/flaming/p/11304278.html>一文看懂kafka消息队列</a></li><li><a href=https://zhuanlan.zhihu.com/p/354772550>kafka消息丢失问题</a></li><li><a href=https://zhuanlan.zhihu.com/p/60288391>消息队列系列</a></li><li><a href=https://cloud.tencent.com/developer/article/1632139>kafka实战宝典</a></li><li><a href=https://github.com/infoslack/awesome-kafka>Awesome Kafka</a></li></ul><h4 id=排障经验-1>排障经验</h4><h3 id=elasticsearch>ElasticSearch</h3><p><strong>分布式搜索分析引擎</strong></p><h4 id=基本概念-2>基本概念</h4><ul><li><strong>NRT</strong>: Near Realtime近实时. 基于es执行搜索和分析可以达到秒级, 但从写入数据到数据可以被搜索到有一个小延迟(大概1秒)</li><li><strong>Cluster</strong>: ElasticSearch集群通过集群名称区分, 默认名称为elasticsearch. ElasticSearch集群是介于p2p和master-slave的自发现分布式系统, 支持高可用性和可扩展性</li><li><strong>Node</strong>: 节点就是ElasticSearch实例, 每个节点都会生成一个随机ID作为节点名称, 节点默认会去加入一个名称为"elasticsearch"的集群(可配置), 若干节点会自动组成集群. 集群中的节点可以有多种角色, 集群会根据节点连通性自动将节点加入集群或从集群删除</li><li><strong>Index</strong>: 索引可以理解为一个数据库(这个索引的概念不同于数据库索引的含义), 是具有相同结构的文档集合, 索引以名称作为标识, 每个集群中都可以有多个索引</li><li><strong>Type</strong>: 类型相当于关系数据库中的表, 每个索引里都可以有一个或多个type, type是index中的一个逻辑数据分类, 一个type下的document, 都有相同的field. type是index和document之间的逻辑细分, 但是实际环境中一个索引下的文档不一定具有相同的结构, 自6.0.0版本开始每个索引下仅允许有一个type(默认为_doc), 7.0.0版本已不建议使用, 8.0.0版本将不再支持</li><li><strong>Document</strong>: 文档相当于关系数据库中表中的行, 它是能够被索引的最小数据单元, 通常是结构化json数据, 同一索引下的文档结构并不要求相同. 文档中除了原始的json数据(_source)外, 还包括一些额外的元数据字段</li><li><strong>Field</strong>: 字段相当于关系数据库中表的字段, 对于结构化的document, 每一层嵌套的key都是一个字段</li><li><strong>Shard</strong>: 分片是对索引数据的切分, ElasticSearch可以将一个索引中的数据切分为多个分片, 分布在多台服务器上存储. 有了shard就可以横向扩展, 存储更多数据, 让搜索和分析等操作分布到多台服务器上去执行, 提升吞吐量和性能. 每个shard都是一个lucene index</li><li><strong>Replica</strong>: 每个分片可以有多个replica副本. replica可以在shard故障时提供备用服务, 保证数据不丢失, 多个replica还可以提升搜索操作的吞吐量和性能. 建立索引时可以指定primary shard主分片数量和replica shard副本分片数量, 主分片后续不允许修改, 但副本分片数量可以随时修改, 一个索引的主分片和副本分片不能存在于同一个节点上. 旧版本默认每个索引5个主分片, 每个主分片1个副本分片, 一共10个shard, 新版本后每个索引默认1个主分片</li><li><strong>Allocation</strong>: 分配是指将分片分配给某个节点的过程, 包括分配主分片或者副本. 如果是副本, 还包含从主分片复制数据的过程. Allocation操作发生在故障恢复, 副本分配, Rebalancing, 节点的新增和删除等场景, master节点的主要职责就是决定分片分配到哪一个节点, 并且做分片的迁移来平衡集群</li><li><strong>Rebalancing</strong>: 再平衡是在集群的不同节点之间移动分片的过程. 默认情况下, Elasticsearch会自动尝试把分片和副本在集群中均衡分布, 也允许用户进行手动再平衡控制</li><li><strong>Lucene</strong>: Lucene是一个开源的全文检索引擎工具包, ElasticSearch是以Lucene为核心的封装</li><li><strong>Analyzer</strong>: ElasticSearch借助各种类型的分词器来对文档内容进行分词处理, 以便于创建倒排索引, 这是搜索的核心. 同时也对搜索内容进行分词处理, 用以在倒排索引中索引文档. ElasticSearch内置一些简单的分词器, 也支持以插件的形式安装外部分词器</li><li><strong>Segment</strong>: lucene内部的数据是由一个个segment组成的, 写入lucene的数据并不直接落盘, 而是先写在内存中, 经过了refresh间隔, lucene才将该时间段写入的全部数据refresh成一个segment, segment多了之后会进行merge成更大的segment. lucene查询时会遍历每个segment完成. 由于lucene写入的数据是在内存中完成, 所以写入效率非常高.</li><li><strong>Translog</strong>: lucene内存写入的特性虽然效率高, 但是也存在丢失数据的风险, 所以ElasticSearch基于此问题实现了translog预写日志机制, translog会在数据写入内存的同时进行落盘, 只有在segment数据落盘后, ElasticSearch才会删除对应的translog</li><li><strong>Term</strong>: term是lucene中索引的最小单位, 某个field对应的内容如果是全文检索类型, 会将内容进行分词, 分词的结果就是由term组成的. 如果是不分词的字段, 那么该字段的内容就是一个term</li><li><strong>InvertedIndex</strong>: 倒排索引是一种反向索引, 实现了term到doc list的映射(doc list即正排数据), 包含单词词典和倒排列表两部分. 区别于正排索引(ForwardIndex), 倒排索引不是通过文档ID去检索内容, 而是根据检索的内容找到对应的文档ID. 倒排索引广泛应用于搜索引擎中</li><li><strong>Docvalues</strong>: ElasticSearch中的列式存储的名称, ElasticSearch除了存储原始存储、倒排索引, 还存储了一份docvalues, 用作分析和排序.</li><li><strong>FullTextSearch</strong>: 为了提高对非结构化数据的检索速度, 将非结构化数据中的一部分信息提取出来, 重新组织, 使其变得有一定结构, 然后对此有一定结构的数据进行搜索. 这部分从非结构化数据中提取出的然后重新组织的信息, 称之为索引. 全文检索是一种先建立索引, 再对索引进行搜索的检索过程.</li></ul><h4 id=架构特性-2>架构特性</h4><ol><li><p>集群架构</p><p><img src=./elasticsearch.png alt=elasticsearch></p><p><img src=./escluster.png alt=escluster></p><p><img src=./esarch.png alt=esarch></p></li><li><p>数据模型</p><p><img src=./esq.png alt=esq></p><p><img src=./esii1.png alt=esii1></p><p><img src=./esii2.png alt=esii2></p><p><img src=./esdata.webp alt=esdata></p></li><li><p>读写请求</p><p>ElasticSearch是一个 P2P 类型(使用 gossip 协议)的分布式系统, 除了集群状态管理以外, 其他所有的请求都可以发送到集群内任意一台节点上, 这个节点可以自己找到需要转发给哪些节点, 并且直接跟这些节点通信</p><p>集群中会有一个master负责当leader进行协调, 当leader宕机的时候会重现选举一个新的master. 宕机节点上如果存在主分片, 则其他正常节点上的副本分片将自动升级为主分片, 宕机节点恢复后, 其上的主分片将自动降级为副本分片</p><p><img src=./esrw.png alt=esrw></p><ul><li><p>数据写入流程:</p><p>ElasticSearch在写入数据的时候, 采用内存buff+文件系统缓存+磁盘三级结构, 确保写入的数据能够近实时的被检索到, 大致过程如下:</p><ol><li>数据首先写入到 <code>Index buffer</code>(内存) 和 <code>Transaction log</code>(落盘) 中, 即便内存数据丢失, 也可读取磁盘中的 <code>Transaction log</code>, 此时数据是检索不到的</li><li>默认 1s 一次的 <code>refresh</code> 操作将 <code>Index buffer</code> 中的数据写入文件系统缓存 <code>segments</code>(os cache), 清空<code>Indexbuffer</code>数据, 此时数据可检索到</li><li>默认每隔30分钟或者<code>Transaction log</code> 满(默认512M)会执行一次的 <code>flush</code> 操作, 首先将commit point写入磁盘文件, 标识这个commit point对应的所有的segment file, 同时强行将os cache中目前所有的数据都fsync到磁盘文件, 同时清空 <code>Transaction log</code>, 重启一个translog, 此时commit操作完成</li><li><code>merge</code> 操作, 定期合并 <code>segment</code></li></ol><p><img src=./espersist.png alt=espersist></p><p>ElasticSearch 中的每个索引操作首先使用路由解析到一个副本组, 通常基于文档ID. 一旦确定了副本组, 操作将在内部转发到组的当前主分片. 主分片负责验证数据格式并将其转发到其他副本</p><p>由于副本可以由主分片异步复制, 所以不需要主副本复制到所有副本. 相反, ElasticSearch 维护一个应该接收操作的副本分片列表. 这个列表称为同步副本, 由主节点维护. 顾名思义, 这些是一组保证处理了所有已向用户确认的索引操作和删除操作的分片副本. 主分片负责维护, 因此必须将所有操作复制到这个集合中的每个副本分片</p><p>主分片遵循以下基本流程:</p><ul><li><p>验证传入操作并在结构无效时拒绝它(例如:插入时字段格式与 mapping 不匹配)</p></li><li><p>在本地执行操作, 即索引或删除相关文档. 将验证字段的内容, 并在需要时拒绝(例如:关键字值太长, 无法在Lucene中进行索引)</p></li><li><p>将操作转发到当前同步复制集中的每个副本分片. 如果有多个副本分片, 则并行执行</p></li><li><p>一旦所有同步复制集的副本分片都成功地执行了操作并响应了主分片, 主副本就会向客户端确认请求成功完成</p></li></ul></li><li><p>数据读取流程:</p><p>ElasticSearch分片使用主备模型. 主备份模型的一个优点是, 主分片和其所有副本分片存有相同的数据. 因此, 一个同步副本就足以满足读请求</p><p>ElasticSearch中的读取可以直接使用 document ID, 也可以是非常复杂的搜索, 包含复杂的聚合, 这个操作会占用大量CPU资源</p><p>当节点接收到读请求时, 该节点负责将其转发给包含相关分片的节点、整合所有分片的返回值并响应客户端(类似于一个MapReduce), 我们将该节点称为请求的协调节点. 基本流程如下:</p><ul><li><p>将读请求解析到相关分片. 由于大多数搜索将被发送到一个或多个索引, 因此它们通常需要从多个分片中读取, 每个分片表示数据的不同子集</p></li><li><p>在分片复制组中选择每个相关分片的活动副本. 这可以是主分片, 也可以是副本分片. 默认情况下, Elasticsearch只是在副本分片之间进行循环</p></li><li><p>将分片级别的读请求发送到所选副本</p></li><li><p>整合结果并做出响应. 在get by ID查找的情况下, 只有一个分片是相关的, 可以跳过这一步</p></li></ul></li></ul></li><li><p>存储结构</p><p>ElasticSearch可通过以下变量配置存储路径:</p><ul><li>path.home: 运行Elasticsearch进程的用户的主目录. 默认为Java系统属性user.dir, 它是进程所有者的默认主目录</li><li>path.conf: 包含配置文件的目录. 这通常通过设置Java系统属性es.config来设置, 因为在找到配置文件之前它必然会被解析</li><li>path.plugins: 子文件夹为Elasticsearch插件的目录. 这里支持Sym-links, 当从同一个可执行文件运行多个Elasticsearch实例时, 可以使用它来有选择地启用/禁用某个Elasticsearch实例的一组插件</li><li>path.logs: 存储生成的日志的位置. 如果其中一个卷的磁盘空间不足, 则将它放在与数据目录不同的卷上可能是有意义的</li><li>path.data: 包含Elasticsearch存储的数据的文件夹的路径</li></ul><p>由于Elasticsearch使用Lucene来处理分片级别的索引和查询, 因此数据目录(path.data)中的文件由Elasticsearch和Lucene写入. 两者的职责都非常明确:</p><ul><li>Lucene负责写和维护Lucene索引文件</li><li>Elasticsearch在Lucene之上写与功能相关的元数据, 例如字段映射, 索引设置和其他集群元数据</li></ul><blockquote><p>ElasticSearch中每一个分片相当于Lucene中的一个索引</p></blockquote><p>数据目录层级结构如下:</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#666>0</span>               <span>#</span> <span>节点编号</span>
</span></span><span style=display:flex><span><span>├──</span> <span>node.lock</span>   <span>#</span> <span>lock文件用于确保一次只能从一个数据目录读取/写入一个ES相关安装信息</span>
</span></span><span style=display:flex><span><span>├──</span> <span>_state</span>      <span>#</span> <span>集群元数据信息目录</span>
</span></span><span style=display:flex><span><span>│</span>   <span>├──</span> <span>global</span><span style=color:#666>-8</span><span>.st</span>  <span>#</span> <span>集群全局元数据</span>
</span></span><span style=display:flex><span><span>│</span>   <span>└──</span> <span>node</span><span style=color:#666>-0</span><span>.st</span>    <span>#</span> <span>节点全局元数据</span>
</span></span><span style=display:flex><span><span>└──</span> <span>indices</span>     <span>#</span> <span>索引目录</span>
</span></span><span style=display:flex><span>    <span>└──</span> <span>RMZHgey</span><span style=color:#666>3</span><span>SpmgtRbaXYY</span><span style=color:#666>4</span><span>Mg</span>    <span>#</span> <span>索引ID为名的索引数据目录</span>
</span></span><span style=display:flex><span>        <span>├──</span> <span>_state</span>                <span>#</span> <span>索引元数据信息目录</span>
</span></span><span style=display:flex><span>        <span>│</span>   <span>└──</span> <span>state</span><span style=color:#666>-2</span><span>.st</span>        <span>#</span> <span>索引元数据</span>
</span></span><span style=display:flex><span>        <span>└──</span> <span style=color:#666>0</span>                     <span>#</span> <span>索引分片编号</span>
</span></span><span style=display:flex><span>            <span>├──</span> <span>_state</span>            <span>#</span> <span>分片元数据信息目录</span>
</span></span><span style=display:flex><span>            <span>│</span>   <span>├──</span> <span>retention-leases</span><span style=color:#666>-0</span><span>.st</span> <span>#</span> <span>分片历史存留期元数据(用于回放)</span>
</span></span><span style=display:flex><span>            <span>│</span>   <span>└──</span> <span>state</span><span style=color:#666>-0</span><span>.st</span>    <span>#</span> <span>分片元数据</span>
</span></span><span style=display:flex><span>            <span>├──</span> <span>translog</span>          <span>#</span> <span>分片事务(预写)日志目录</span>
</span></span><span style=display:flex><span>            <span>│</span>   <span>├──</span> <span>translog</span><span style=color:#666>-5</span><span>.ckp</span>
</span></span><span style=display:flex><span>            <span>│</span>   <span>├──</span> <span>translog</span><span style=color:#666>-5</span><span>.tlog</span>
</span></span><span style=display:flex><span>            <span>│</span>   <span>├──</span> <span>translog</span><span style=color:#666>-6</span><span>.tlog</span> <span>#</span> <span>分片事务日志</span>
</span></span><span style=display:flex><span>            <span>│</span>   <span>└──</span> <span>translog.ckp</span>    <span>#</span> <span>当前检查点</span>
</span></span><span style=display:flex><span>            <span>└──</span> <span>index</span> <span>#</span> <span>分片数据目录,</span> <span>为lucene记录的数据.</span> <span>lucene</span> <span>index相当于es</span> <span>shard</span>
</span></span><span style=display:flex><span>                <span>├──</span> <span>_</span><span style=color:#666>1</span><span>lj.si</span>         <span>#</span> <span>segment元数据</span>
</span></span><span style=display:flex><span>                <span>├──</span> <span>_</span><span style=color:#666>1</span><span>lj.cfs</span>        <span>#</span> <span>segment数据数据量小时的数据内容</span>
</span></span><span style=display:flex><span>                <span>├──</span> <span>_</span><span style=color:#666>1</span><span>lj.cfe</span>        <span>#</span> <span>segment各个文件(以下皆是)在cfs文件中的位置信息</span>
</span></span><span style=display:flex><span>                <span>├──</span> <span>_</span><span style=color:#666>1</span><span>lj.dii</span>        <span>#</span> <span>多维数据,</span> <span>地理位置等信息,</span> <span>用于处理数值型的查询</span>
</span></span><span style=display:flex><span>                <span>├──</span> <span>_</span><span style=color:#666>1</span><span>lj.dim</span>        <span>#</span> <span>多维数据,</span> <span>地理位置等信息,</span> <span>用于处理数值型的查询</span>
</span></span><span style=display:flex><span>                <span>├──</span> <span>_</span><span style=color:#666>1</span><span>lj.fnm</span>        <span>#</span> <span>fields相关信息</span>
</span></span><span style=display:flex><span>                <span>├──</span> <span>_</span><span style=color:#666>1</span><span>lj.fdt</span>        <span>#</span> <span>field数据文件内容</span>
</span></span><span style=display:flex><span>                <span>├──</span> <span>_</span><span style=color:#666>1</span><span>lj.fdx</span>        <span>#</span> <span>field数据文件索引</span>
</span></span><span style=display:flex><span>                <span>├──</span> <span>_</span><span style=color:#666>1</span><span>lj_Lucene</span><span style=color:#666>50</span><span>_</span><span style=color:#666>0</span><span>.doc</span>  <span>#</span> <span>每个term的doc</span> <span>id列表和term在doc中的词频</span>
</span></span><span style=display:flex><span>                <span>├──</span> <span>_</span><span style=color:#666>1</span><span>lj_Lucene</span><span style=color:#666>50</span><span>_</span><span style=color:#666>0</span><span>.tim</span>  <span>#</span> <span>倒排索引元数据信息(term词典)</span>
</span></span><span style=display:flex><span>                <span>├──</span> <span>_</span><span style=color:#666>1</span><span>lj_Lucene</span><span style=color:#666>50</span><span>_</span><span style=color:#666>0</span><span>.tip</span>  <span>#</span> <span>倒排索引数据内容(term索引)</span>
</span></span><span style=display:flex><span>                <span>├──</span> <span>_</span><span style=color:#666>1</span><span>lj_Lucene</span><span style=color:#666>70</span><span>_</span><span style=color:#666>0</span><span>.dvd</span>  <span>#</span> <span>文档正排数据</span>
</span></span><span style=display:flex><span>                <span>├──</span> <span>_</span><span style=color:#666>1</span><span>lj_Lucene</span><span style=color:#666>70</span><span>_</span><span style=color:#666>0</span><span>.dvm</span>  <span>#</span> <span>文档正排元数据</span>
</span></span><span style=display:flex><span>                <span>├──</span> <span>segments_a</span>           <span>#</span> <span>segment检查点信息</span>
</span></span><span style=display:flex><span>                <span>└──</span> <span>write.lock</span>      <span>#</span> <span>写锁防止多个IndexWriters写入同一个文件</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p>节点组件</p><p>每个ElasticSearch节点都包含以下功能组件:</p><table><thead><tr><th>组件</th><th>模块</th><th>描述</th></tr></thead><tbody><tr><td>存储网关</td><td>Gateway</td><td>ES用来存储索引的文件系统. 支持多种类型, 包括本地文件系统(默认), HDFS, S3等</td></tr><tr><td>搜索引擎</td><td>Distributed Lucene Directory</td><td>分布式的lucene搜索引擎框架, 包含Lucene-core</td></tr><tr><td>核心模块</td><td>Index Module</td><td>索引模块. 控制与所有索引全局管理的与索引相关的设置, 而不是在每个索引级别上可配置</td></tr><tr><td></td><td>Search Module</td><td>执行分布式搜索查询并返回与查询匹配的搜索结果</td></tr><tr><td></td><td>Mapping</td><td>映射类似于数据库中的表结构定义schema, 用于定义索引中的字段名, 字段数据类型和字段倒排索引的相关配置, 支持自定义映射和动态映射</td></tr><tr><td>其他模块</td><td>Discovery</td><td>ES的节点发现模块, 不同机器上的ES节点要组成集群需要进行消息通信, 集群内部需要选举master节点, 这些工作都是由Discovery模块完成. 支持多种发现机制, 如 Zen 、EC2、gce、Azure</td></tr><tr><td></td><td>Scripting</td><td>用来支持在查询语句中插入javascript、python等脚本语言, scripting模块负责解析这些脚本, 使用脚本语句性能稍低. 预先定义好脚本内容, 然后在mapping阶段或者search指定需要的脚本, 相对于脚本语句查询来说提高性能</td></tr><tr><td></td><td>3rd Plugins</td><td>支持多种第三方插件</td></tr><tr><td>用户接口</td><td>Transport</td><td>ES的传输模块, 支持多种传输协议, 如 Thrift、memecached、http. 默认使用http</td></tr><tr><td></td><td>JMX</td><td>java的管理框架, 用来管理ES应用</td></tr><tr><td></td><td>Restful API</td><td>通过RESTful接口和ES集群进行交互</td></tr><tr><td></td><td>Java(Netty)</td><td>ES基于Java Netty开源网络框架作为节点之间以及客户端与服务器间TCP和HTTP通信协议的底层实现</td></tr></tbody></table></li><li><p>节点角色</p><p>ElasticSearch中的节点分为多种角色, 除Tribe外, 节点默认拥有下述所有角色(Master</p><p>节点同时只有一个, 但所有节点都可以是Master候选节点).</p><ul><li>Master: Master节点用于管理和控制Elasticsearch集群, 并负责在集群范围内创建删除索引, 跟踪哪些节点是集群的一部分, 并将分片分配给这些节点. 主节点一次处理一个集群状态, 并将状态广播到所有其他节点, 这些节点需要响应并确认主节点的信息. Master节点同一时刻只有一个, 但可以有多个Matesr候选节点(master-eligible)</li><li>Data: Data节点保存数据并执行与数据相关的操作, 如CRUD、搜索和聚合等, 通常中大型集群中Master节点都会设置为非Data节点. Data节点又可以细分为<code>data_content</code>,<code>data_hot</code>, <code>data_warm</code>, <code>data_cold</code>, or <code>data_frozen</code>等角色</li><li>Remote: 能够作为远程客户端的节点</li><li>MachineLearn: 能够处理机器学习相关操作的节点</li><li>Transform: 处理数据转换工作的节点</li><li>Ingest: Ingest节点是预处理节点, 能够在索引操作之前对document进行增强或者丰富的预处理操作, 预处理类似于ETL操作, 该操作发生在bulk和index之前, 通过pipeline和processor的方式实现</li><li>Coordinating: Coordinating节点作为负载路由器, 将传入的请求路由到集群中的不同节点. coordinating节点处理客户端的请求一般分为两个阶段: 第一阶段, 收到客户端的请求并路由到合适的分片(包含请求数据的主分片), 第二阶段对结果做聚合. 所有节点都是coordinating节点且不可关闭</li><li>Tribe: Tribe节点一种特殊的coordinating节点, 它可以连接到多个集群, 并在多个集群上执行搜索或者其他操作, 对于涉及到多个集群之间的查询, 可以使用tribel node的方式, 但是tribel node是以coordinating node的方式加入到各个集群中, master的变更任务必须要等Tribe node的返回, tribe的问题显而易见, 所以elasticsearch在高版本引入了Cross Cluster Search</li></ul></li><li><p>集群健康值</p><p>ElasticSearch以Green, Yellow和Red三个状态标识集群健康程度. 其中Green表示集群中所有的主分片和副本分片都是可用的. Yellow表示集群中所有主分片是可用的, 但存在不可用的副本分片. Red表示集群中存在不可用的主分片.</p><p>由于主分片不可用后副本分片会自动升级为主分片, 因此如果集群状态为Red, 表示保存了某些数据的主分片和副本分片都不存在了, 出现数据缺失. 但Red状态的集群仍然能够提供读写服务, 只是检索到的数据可能是不完整的</p></li><li><p>分词器</p><p>ElasticSearch借助各种类型的分词器来对文档内容进行分词处理, 以便于创建倒排索引, 这是搜索的核心. 同时也对搜索内容进行分词处理, 用以在倒排索引中索引文档</p><ul><li><p>内置分词器</p><ul><li><p>标准分词器(standard analyzer)(默认)</p><p>分析过程: 字符过滤器->字符处理->分词过滤(分词转换)</p><p>说明: 首先是字符过滤器过滤掉特殊符号以及量词(the、an、a等), 进一步将分词小写处理</p></li><li><p>英文分词器(english analyzer)</p><p>分析过程: 字符过滤器->字符处理->分词过滤(分词转换, 词干转化)</p><p>说明: 首先是字符过滤器过滤掉特殊符号以及量词(the、an、a等), 进一步将分词小写处理, 再次进行分词转换, 例如: eating -> eat, 其实它们两是一回事</p></li><li><p>简单分词器(simple analyzer)</p><p>先按照空格分词, 英文大写转小写</p></li><li><p>空格分词器(whitespace analyzer)</p></li></ul><p>先按照空格分词, 英文不做大小写处理</p></li></ul></li></ol><ul><li><p>外部分词器</p><p>ElasticSearch支持以插件的方式安装外部分词器以满足更多复杂的分词需求</p><ul><li><p>中文分词器(ik_maxword)</p><p>会将文本做最细粒度的拆分, 尽可能多的拆分出词语, 例如: 如南京市长江大桥 &ndash;> 南京市/南京/市长/长江大桥/长江/大桥</p></li><li><p>中文分词器(ik_smart)</p><p>会做最粗粒度的拆分, 已被分出的词语将不会再次被其它词语占有, 如南京市长江大桥 &ndash;> 南京市/长江大桥</p></li></ul></li></ul><ol start=9><li><p>分片分配</p><p>Allocation是指将分片分配给某个节点的过程, 包括分配主分片或者副本. 如果是副本, 还包含从主分片复制数据的过程.
Allocation操作发生在故障恢复, 副本分配, Rebalancing, 节点的新增和删除等场景. master节点的主要职责就是决定分片分配到哪一个节点, 并且做分片的迁移来平衡集群.</p><ul><li><p>Shard allocation filters</p><p>allocation filters允许执行分片分配之前, 前置一些filter操作, 可以基于_name, _host_ip, _publish_ip, _ip, _host and _id 等属性.</p><p>例如计划下线一个node, 可以设置不允许给该node分配分片:</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>PUT _cluster/settings
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  &#34;transient&#34; : {
</span></span><span style=display:flex><span>    &#34;cluster.routing.allocation.exclude._ip&#34; : &#34;10.0.0.1&#34;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div></li><li><p>disk-based shard allocation</p><p>es在进行shard allocation的时候, 会充分考虑每一个node的可用磁盘空间, 具体有如下配置:</p><ol><li>cluster.routing.allocation.disk.threshold_enabled: 默认是true, 如果是false会禁用基于disk的考虑</li><li>cluster.routing.allocation.disk.watermark.low: 控制磁盘使用率的低水位, 默认是85%, 如果一个节点的磁盘空间使用率已经超过了85%, 那么就不会分配shard给这个node了</li><li>cluster.routing.allocation.disk.watermark.high: 控制磁盘使用率的高水位, 默认是90%, 如果一个节点的磁盘空间使用率已经超过90%了, 那么就会将这个node上的部分shard移动走</li><li>cluster.info.update.interval: es检查集群中每个node的磁盘使用率的时间间隔, 默认是30s</li><li>cluster.routing.allocation.disk.include_relocations: 默认是true, 意味着es在计算一个node的磁盘使用率的时候, 会考虑正在分配给这个node的shard</li></ol></li></ul></li><li><p>别名系统</p><p>ElasticSearch中可以为索引添加别名, 一个别名可以指向到多个索引中, 同时在添加别名时可以设置筛选条件, 指向一个索引的部分数据, 实现在关系数据库汇总的视图功能. 别名是一个非常实用的功能, 为我们使用索引提供了极大的灵活性, 许多ElasticSearch的API都支持用别名来代替真实索引名. 通过索引我们可以方便的进行以下操作:</p><ul><li>实现正在运行的集群上的一个索引到另一个索引之间的无缝切换. 试想一下这种场景, 由于业务变换, 我们需要将业务数据有索引1变换到新的索引2上, 如果没有别名, 我们必须修改和中断业务系统, 但是有了别名, 只需要修改别名, 令其指向新的索引2即可, 这样的操作可以在用户无任何感知的情况下完成</li><li>使数据检索等操作更加方便. 假设有两个月的日志数据, 分别存放在index_202008和index_202009两个索引中, 没有使用别名进行检索时, 我们需要同时写上两个索引名称进行检索, 使用别名后, 我们可以令别名同时指向这两个索引, 检索时只需要使用这个别名就可以同时在两个索引中进行检索</li><li>为一个索引中的部分数据创建别名. 例如一个索引中存放了一整年的数据, 现在新增一个业务场景, 更多的是对其中某一个月的数据进行检索, 这时我们可以在创建别名时, 通过设置过滤条件filter, 可以单独令别名指向一个月的数据, 使得检索更加高效</li></ul><p>ElasticSearch中别名可以指向一个索引, 也可以同时指向多个索引, 甚至可以通过配合过滤器filter指向索引中部分数据. 别名可以在创建索引时添加, 也可以在索引创建后进行添加. ElasticSearch中提供丰富的API对别名进行管理</p><p>此外, ElasticSearch也支持通过mapping的方式为字段创建别名</p></li><li><p>应用场景</p><p>全文检索, 搜索引擎, 数据分析, 日志存储, 商业智能, 可观察性</p></li></ol><h4 id=配置文件-3>配置文件</h4><ul><li><p><strong>$ES_HOME/config/elasticsearch.yml</strong>: ElasticSearch核心配置文件</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 37
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 38
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 39
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 40
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 41
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 42
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 43
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 44
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 45
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 46
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 47
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 48
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 49
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 50
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 51
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 52
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 53
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 54
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 55
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 56
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 57
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 58
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 59
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 60
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 61
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 62
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 63
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 64
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 65
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 66
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 67
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 68
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 69
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 70
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 71
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 72
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 73
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 74
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 75
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 76
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 77
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 78
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 79
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 80
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 81
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 82
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 83
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 84
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 85
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 86
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 87
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 88
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 89
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 90
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 91
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 92
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 93
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 94
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 95
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 96
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 97
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 98
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 99
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">100
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">101
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">102
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">103
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">104
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">105
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">106
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">107
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">108
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">109
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">110
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">111
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">112
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">113
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">114
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">115
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">116
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">117
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">118
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">119
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">120
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">121
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">122
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">123
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">124
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">125
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">126
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">127
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">128
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">129
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">130
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">131
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">132
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">133
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">134
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">135
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">136
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">137
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">138
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">139
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">140
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">141
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">142
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">143
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">144
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">145
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">146
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">147
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">148
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">149
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">150
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">151
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">152
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">153
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">154
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">155
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">156
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">157
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">158
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">159
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">160
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">161
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">162
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">163
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">164
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">165
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">166
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">167
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">168
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">169
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">170
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">171
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">172
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">173
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">174
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">175
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">176
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">177
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">178
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">179
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">180
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">181
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">182
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">183
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">184
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">185
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">186
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">187
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">188
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">189
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">190
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">191
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">192
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">193
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">194
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">195
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">196
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">197
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">198
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">199
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">200
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">201
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">202
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">203
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">204
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">205
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">206
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">207
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">208
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">209
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">210
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">211
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">212
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">213
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">214
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">215
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">216
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">217
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">218
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">219
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">220
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">221
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">222
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">223
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">224
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">225
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">226
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">227
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">228
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">229
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">230
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">231
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#080;font-style:italic># 配置的集群名称, 默认是elasticsearch, es服务会通过广播方式自动连接在同一网段下的es服务, 通过多播方式进行通信, 同一网段下可以有多个集群, 通过集群名称这个属性来区分不同的集群</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>cluster.name</span>:<span style=color:#bbb> </span>elasticsearch<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># 手动设置初始的集群master候选节点集合</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>cluster.initial_master_nodes</span>:<span style=color:#bbb> </span>[<span style=color:#b44>&#34;node-a&#34;</span>]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># 当前配置所在机器的节点名, 你不设置就默认随机指定一个name列表中名字, 该name列表在es的jar包中config文件夹里name.txt文件中, 其中有很多作者添加的有趣名字.  </span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>node.name</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;node-a&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># 指定该节点是否有资格被选举成为master node(注意这里只是设置成有资格, 不代表该node一定就是master), 默认是true, es是默认集群中的第一台机器为master, 如果这台机挂了就会重新选举master</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>node.master</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># 指定该节点是否存储索引数据, 默认为true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>node.data</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># 设置默认索引主分片个数, 默认为1片</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>index.number_of_shards</span>:<span style=color:#bbb> </span><span style=color:#666>1</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># 设置默认索引副本个数, 默认为1个副本. 如果采用默认设置, 而你集群只配置了一台机器, 那么集群的健康度为yellow, 也就是所有的数据都是可用的, 但是某些复制没有被分配</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># (健康度可用 curl &#39;localhost:9200/_cat/health?v&#39; 查看, 分为绿色、黄色或红色. 绿色代表一切正常, 集群功能齐全, 黄色意味着所有的数据都是可用的, 但是某些复制没有被分配, 红色则代表因为某些原因, 某些数据不可用)</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>index.number_of_replicas</span>:<span style=color:#bbb> </span><span style=color:#666>1</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># 设置配置文件的存储路径, 默认是es根目录下的config文件夹</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>path.conf</span>:<span style=color:#bbb> </span>/path/to/conf<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># 设置索引数据的存储路径, 默认是es根目录下的data文件夹, 可以设置多个存储路径, 用逗号隔开, 例如:</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># path.data: /path/to/data1,/path/to/data2</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>path.data</span>:<span style=color:#bbb> </span>/path/to/data<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># 设置临时文件的存储路径, 默认是es根目录下的work文件夹</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>path.work</span>:<span style=color:#bbb> </span>/path/to/work<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># 设置日志文件的存储路径, 默认是es根目录下的logs文件夹 </span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>path.logs</span>:<span style=color:#bbb> </span>/path/to/logs<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># 设置插件的存放路径, 默认是es根目录下的plugins文件夹,, 插件在es里面普遍使用, 用来增强原系统核心功能</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>path.plugins</span>:<span style=color:#bbb> </span>/path/to/plugins<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># 备份数据的存放路径</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>path.repo</span>:<span style=color:#bbb> </span>/path/to/repo<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># 设置为true来锁住内存不进行swapping. 因为当jvm开始swapping时es的效率会降低, 所以要保证它不swap, 可以把ES_MIN_MEM和ES_MAX_MEM两个环境变量设置成同一个值, 并且保证机器有足够的内存分配给es. 同时也要允许elasticsearch的进程可以锁住内存, linux下启动es之前可以通过`ulimit -l unlimited`命令设置</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># 确保 ES_MIN_MEM 和 ES_MAX_MEM 环境变量设置为相同的值, 以及机器有足够的内存分配给Elasticsearch </span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># 注意: 内存也不是越大越好, 一般64位机器, 最大分配内存别才超过32G</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>bootstrap.mlockall</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># 设置插件作为启动条件, 如果指定的插件没有安装, 则该节点服务不会启动 </span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># plugin.mandatory: mapper-attachments,lang-groovy</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># 设置绑定的ip地址, 可以是ipv4或ipv6的, 默认为0.0.0.0, 绑定这台机器的任何一个ip</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>network.bind_host</span>:<span style=color:#bbb> </span><span style=color:#666>192.168.0.1</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># 设置其它节点和该节点交互的ip地址, 如果不设置它会自动判断, 值必须是个真实的ip地址</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>network.publish_host</span>:<span style=color:#bbb> </span><span style=color:#666>192.168.0.1</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># 这个参数是用来同时设置bind_host和publish_host上面两个参数</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>network.host</span>:<span style=color:#bbb> </span><span style=color:#666>192.168.0.1</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># 设置节点之间交互的tcp端口, 默认是9300</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>transport.tcp.port</span>:<span style=color:#bbb> </span><span style=color:#666>9300</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># 设置是否压缩tcp传输时的数据, 默认为false, 不压缩</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>transport.tcp.compress</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># 是否使用http协议对外提供服务, 默认为true, 开启</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>http.enabled</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># 设置对外服务的http端口, 默认为9200</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>http.port</span>:<span style=color:#bbb> </span><span style=color:#666>9200</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># 设置对外http服务是否允许跨域, 默认为false</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>http.cors.enabled</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># 设置http服务跨域白名单</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>http.cors.allow-origin</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;*&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># 浏览器会发送一个&#34;预检&#34;的OPTIONS请求, 来检查CORS设置. max-age定义应该缓存多长时间的结果. 默认为1728000(20天)</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>http.cors.max-age</span>:<span style=color:#bbb> </span><span style=color:#666>1728000</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># 设置内容的最大容量, 默认100mb</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>http.max_content_length</span>:<span style=color:#bbb> </span>100mb<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># HTTP请求URL的最大长度, 默认4kb</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>http.max_initial_line_length</span>:<span style=color:#bbb> </span><span style=color:#666>4096</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># 请求头的最大大小, 默认8kb</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>http.max_header_size</span>:<span style=color:#bbb> </span><span style=color:#666>8196</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># 是否支持压缩(使用Accept-Encoding), 默认false</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>http.compression</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>false</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># 定义使用的压缩级别, 默认为6</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>http.compression_level</span>:<span style=color:#bbb> </span><span style=color:#666>6</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># 定义了允许的请求方式, 默认允许OPTIONS, HEAD, GET, POST, PUT, DELETE</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>http.cors.allow-methods</span>:<span style=color:#bbb> </span>[<span style=color:#b44>&#34;GET&#34;</span>]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># 定义了允许的请求头信息. 默认允许X-Requested-With, Content-Type, Content-Length</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>http.cors.allow-headers</span>:<span style=color:#bbb> </span>[<span style=color:#b44>&#34;Content-Type&#34;</span>]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># 是否返回设置的Access-Control-Allow-Credentials头信息. 默认为false</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>http.cors.allow-credentials</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>false</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># 是否输出详细的错误信息和堆栈. 默认为true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>http.detailed_errors.enabled</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># 是否启用HTTP管道支持. 默认为true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>http.pipelining</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># 在一个HTTP连接被关闭之前内存队列中允许的最大的事件数量, 默认为10000. 该模块也可使用一些公共的网络配置(见网络设置一节)</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>http.pipelining.max_events</span>:<span style=color:#bbb> </span><span style=color:#666>10000</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># 是否启用x-pack安全验证, 默认为false</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>xpack.security.enabled</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># 免费版本license为basic</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>xpack.license.self_generated.type</span>:<span style=color:#bbb> </span>basic<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># 是否启用http对外服务加密通信, 默认为false</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>xpack.security.http.ssl.enabled</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># 集群对外http服务加密通信验证模式</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>xpack.security.http.ssl.verification_mode</span>:<span style=color:#bbb> </span>certificate<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># 集群对外http服务加密通信凭证文件(p12默认将私钥和证书整合在一起)</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>xpack.security.http.ssl.keystore.path</span>:<span style=color:#bbb> </span>elastic-certificates.p12<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># 集群对外http服务加密通信ca凭证文件(p12默认将私钥和证书整合在一起)</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># http仅作服务端验证所以服务端可以不需要配置ca凭证</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>xpack.security.http.ssl.truststore.path</span>:<span style=color:#bbb> </span>elastic-certificates.p12<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># 集群节点间是否启用加密通信, 默认为false</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>xpack.security.transport.ssl.enabled</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># 集群节点间加密通信验证模式</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>xpack.security.transport.ssl.verification_mode</span>:<span style=color:#bbb> </span>certificate<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># 集群节点间加密通信凭证文件(p12默认将私钥和证书整合在一起)</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>xpack.security.transport.ssl.keystore.path</span>:<span style=color:#bbb> </span>elastic-certificates.p12<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># 集群节点间加密通信ca凭证文件(p12默认将私钥和证书整合在一起)</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># 节点间需要相互验证(所有节点同时是客户端和服务端), 所以需要配置ca凭证</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>xpack.security.transport.ssl.truststore.path</span>:<span style=color:#bbb> </span>elastic-certificates.p12<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># 另一种加密凭证配置方式</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>xpack.security.http.ssl.key</span>:<span style=color:#bbb> </span>certs/node1.key<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>xpack.security.http.ssl.certificate</span>:<span style=color:#bbb> </span>certs/node1.crt<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>xpack.security.http.ssl.certificate_authorities</span>:<span style=color:#bbb> </span>certs/ca.crt<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>xpack.security.transport.ssl.key</span>:<span style=color:#bbb> </span>certs/node1.key<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>xpack.security.transport.ssl.certificate</span>:<span style=color:#bbb> </span>certs/node1.crt<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>xpack.security.transport.ssl.certificate_authorities</span>:<span style=color:#bbb> </span>certs/ca.crt<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># gateway的类型, 默认为local即为本地文件系统, 可以设置为本地文件系统, 分布式文件系统, hadoop的HDFS, 和amazon的s3服务器等</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>gateway.type</span>:<span style=color:#bbb> </span>local<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># 设置集群中N个节点启动时进行数据恢复, 默认为1</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>gateway.recover_after_nodes</span>:<span style=color:#bbb> </span><span style=color:#666>1</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># 设置初始化数据恢复进程的超时时间, 默认是5分钟</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>gateway.recover_after_time</span>:<span style=color:#bbb> </span>5m<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># 设置这个集群中节点的数量, 默认为2, 一旦这N个节点启动, 就会立即进行数据恢复</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>gateway.expected_nodes</span>:<span style=color:#bbb> </span><span style=color:#666>2</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># 初始化数据恢复时, 并发恢复线程的个数, 默认为4</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>cluster.routing.allocation.node_initial_primaries_recoveries</span>:<span style=color:#bbb> </span><span style=color:#666>4</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># 添加删除节点或负载均衡时并发恢复线程的个数, 默认为4</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>cluster.routing.allocation.node_concurrent_recoveries</span>:<span style=color:#bbb> </span><span style=color:#666>4</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># 设置数据恢复时限制的带宽, 如100mb, 默认为0, 即无限制</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>indices.recovery.max_size_per_sec</span>:<span style=color:#bbb> </span><span style=color:#666>0</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># 设置这个参数来限制从其它分片恢复数据时最大同时打开并发流的个数, 默认为5</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>indices.recovery.concurrent_streams</span>:<span style=color:#bbb> </span><span style=color:#666>5</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># 提供集群中其他主机列表以便更快的发现主机, 格式为ip/domain+可选的端口</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>discovery.seed_hosts</span>:<span style=color:#bbb> </span>[<span style=color:#b44>&#34;192.168.0.2:9300&#34;</span>]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># 设置这个参数来保证集群中的节点可以知道其它N个有master资格的节点, 默认为1, 对于大的集群来说, 可以设置大一点的值(2-4)</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>discovery.zen.minimum_master_nodes</span>:<span style=color:#bbb> </span><span style=color:#666>1</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># 设置集群中自动发现其它节点时ping连接超时时间, 默认为3秒, 对于比较差的网络环境可以高点的值来防止自动发现时出错</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>discovery.zen.ping.timeout</span>:<span style=color:#bbb> </span>3s<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># 设置是否打开多播发现节点, 默认是true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>discovery.zen.ping.multicast.enabled</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># 设置集群中master节点的初始列表, 可以通过这些节点来自动发现新加入集群的节点</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>discovery.zen.ping.unicast.hosts</span>:<span style=color:#bbb> </span>[<span style=color:#b44>&#34;host1&#34;</span>,<span style=color:#bbb> </span><span style=color:#b44>&#34;host2:port&#34;</span>,<span style=color:#bbb> </span><span style=color:#b44>&#34;host3[portX-portY]&#34;</span>]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic>############## Memory(重点需要调优的部分) ################ </span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># Cache部分: </span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># es有很多种方式来缓存其内部与索引有关的数据. 其中包括filter cache </span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># filter cache部分: </span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># filter cache是用来缓存filters的结果的. 默认的cache type是node type. node type的机制是所有的索引内部的分片共享filter cache. node type采用的方式是LRU方式, 即:当缓存达到了某个临界值之后, es会将最近没有使用的数据清除出filter cache.使让新的数据进入es</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># 这个临界值的设置方法如下: indices.cache.filter.size 值类型: eg.:512mb 20%. 默认的值是10%</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># out of memory错误避免过于频繁的查询时集群假死 </span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># 1.设置es的缓存类型为Soft Reference, 它的主要特点是据有较强的引用功能. 只有当内存不够的时候, 才进行回收这类内存, 因此在内存足够的时候, 它们通常不被回收. 另外,这些引用对象还能保证在Java抛出OutOfMemory异常之前, 被设置为null. 它可以用于实现一些常用图片的缓存, 实现Cache的功能, 保证最大限度的使用内存而不引起OutOfMemory. 在es的配置文件加上index.cache.field.type: soft即可</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># 2.设置es最大缓存数据条数和缓存失效时间, 通过设置index.cache.field.max_size: 50000来把缓存field的最大值设置为50000, 设置index.cache.field.expire: 10m把过期时间设置成10分钟</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># index.cache.field.max_size: 50000 </span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># index.cache.field.expire: 10m </span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># index.cache.field.type: soft </span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># field data部分&amp;&amp;circuit breaker部分:</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># 用于fielddata缓存的内存数量, 主要用于当使用排序, faceting操作时, elasticsearch会将一些热点数据加载到内存中来提供给客户端访问, 但是这种缓存是比较珍贵的, 所以对它进行合理的设置</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># 可以使用值: eg:50mb 或者 30％(节点 node heap内存量), 默认是: unbounded # indices.fielddata.cache.size: unbounded </span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># field的超时时间. 默认是-1, 可以设置的值类型: 5m #indices.fielddata.cache.expire: -1 </span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># circuit breaker部分: </span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># 断路器是elasticsearch为了防止内存溢出的一种操作, 每一种circuit breaker都可以指定一个内存界限触发此操作, 这种circuit breaker的设定有一个最高级别的设定: indices.breaker.total.limit 默认值是JVM heap的70%. 当内存达到这个数量的时候会触发内存回收</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># 另外还有两组子设置: </span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># indices.breaker.fielddata.limit: 当系统发现fielddata的数量达到一定数量时会触发内存回收. 默认值是JVM heap的70% </span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># indices.breaker.fielddata.overhead: 在系统要加载fielddata时会进行预先估计, 当系统发现要加载进内存的值超过limit * overhead时会进行进行内存回收. 默认是1.03 </span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># indices.breaker.request.limit: 这种断路器是elasticsearch为了防止OOM(内存溢出), 在每次请求数据时设定了一个固定的内存数量. 默认值是40% </span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># indices.breaker.request.overhead: 同上, 也是elasticsearch在发送请求时设定的一个预估系数, 用来防止内存溢出. 默认值是1 </span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># Translog部分: </span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># 每一个分片(shard)都有一个transaction log或者是与它有关的预写日志(write log), 在es进行索引(index)或者删除(delete)操作时会将没有提交的数据记录在translog之中, 当进行flush 操作的时候会将tranlog中的数据发送给Lucene进行相关的操作. 一次flush操作的发生基于如下的几个配置:</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># index.translog.flush_threshold_ops: 当发生多少次操作时进行一次flush. 默认是unlimited </span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># index.translog.flush_threshold_size: 当translog的大小达到此值时会进行一次flush操作. 默认是512mb </span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># index.translog.flush_threshold_period: 在指定的时间间隔内如果没有进行flush操作, 会进行一次强制flush操作. 默认是30m </span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># index.translog.interval: 多少时间间隔内会检查一次translog, 来进行一次flush操作. es会随机的在这个值到这个值的2倍大小之间进行一次操作, 默认是5s </span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># index.gateway.local.sync: 多少时间进行一次的写磁盘操作, 默认是5s </span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#080;font-style:italic># 以上的translog配置都可以通过API进行动态的设置 - See more at: http://bigbo.github.io/pages/2015/04/10/elasticsearch_config/#sthash.AvOSUcQ4.dpuf</span><span style=color:#bbb>
</span></span></span></code></pre></td></tr></table></div></div><blockquote><p>elasticsearch免费版本的license为basic, 只提供一个名为<code>elastic</code>的服务帐号, 密码通过<code>bin/elasticsearch-setup-passwords interactive</code>命令进行交互式的设置</p></blockquote></li><li><p><strong>$ES_HOME/config/jvm.options</strong>: ElasticSearch jvm参数配置文件</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-properties data-lang=properties><span style=display:flex><span><span style=color:#080;font-style:italic># 设置年老代为并发收集. 配置这个以后, -XX:NewRatio=4的配置失效了. 所以, 此时年轻代大小最好用-Xmn设置</span>
</span></span><span style=display:flex><span><span style=color:#b44>-XX</span><span style=color:#666>:</span><span style=color:#b44>+UseConcMarkSweepGC</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic>#表示年老代空间到70%时就开始执行CMS, 确保年老代有足够的空间接纳来自年轻代的对象</span>
</span></span><span style=display:flex><span><span style=color:#b44>-XX</span><span style=color:#666>:</span><span style=color:#b44>CMSInitiatingOccupancyFraction=75</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 使用手动定义初始化定义开始CMS收集, 禁止hostspot自行触发CMS GC</span>
</span></span><span style=display:flex><span><span style=color:#b44>-XX</span><span style=color:#666>:</span><span style=color:#b44>+UseCMSInitiatingOccupancyOnly</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># VM就会先访问所有分配给它的内存, 让操作系统把内存真正的分配给JVM. 后续JVM就可以顺畅的访问内存了</span>
</span></span><span style=display:flex><span><span style=color:#b44>-XX</span><span style=color:#666>:</span><span style=color:#b44>+AlwaysPreTouch</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># server模式运行</span>
</span></span><span style=display:flex><span><span>-server</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 每个线程的堆栈大小1m</span>
</span></span><span style=display:flex><span><span>-Xss1m</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 对于一个Java服务器来说经常要处理一些图形元素, 这些API基本上总是需要运行一个X-server以便能使用AWT. 然而, 运行一个不必要的X-server并不是一种好的网络管理方式. 开启此配置可以禁用X-server</span>
</span></span><span style=display:flex><span><span style=color:#b44>-Djava.awt.headless</span><span style=color:#666>=</span><span style=color:#b44>true</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 编码为utf8编码</span>
</span></span><span style=display:flex><span><span style=color:#b44>-Dfile.encoding</span><span style=color:#666>=</span><span style=color:#b44>UTF-8</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 始终使用提供的JNA与系统之一</span>
</span></span><span style=display:flex><span><span style=color:#b44>-Djna.nosys</span><span style=color:#666>=</span><span style=color:#b44>true</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 处理和存储path规范</span>
</span></span><span style=display:flex><span><span style=color:#b44>-Djdk.io.permissionsUseCanonicalPath</span><span style=color:#666>=</span><span style=color:#b44>true</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 使用Heap堆内存创建ByteBuf</span>
</span></span><span style=display:flex><span><span style=color:#b44>-Dio.netty.noUnsafe</span><span style=color:#666>=</span><span style=color:#b44>true</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 没有密钥集</span>
</span></span><span style=display:flex><span><span style=color:#b44>-Dio.netty.noKeySetOptimization</span><span style=color:#666>=</span><span style=color:#b44>true</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic>#  netty回收配置, 每个线程最大容量</span>
</span></span><span style=display:flex><span><span style=color:#b44>-Dio.netty.recycler.maxCapacityPerThread</span><span style=color:#666>=</span><span style=color:#b44>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># log4j配置, 是否允许关闭hook</span>
</span></span><span style=display:flex><span><span style=color:#b44>-Dlog4j.shutdownHookEnabled</span><span style=color:#666>=</span><span style=color:#b44>false</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 是否禁用jmx</span>
</span></span><span style=display:flex><span><span style=color:#b44>-Dlog4j2.disable.jmx</span><span style=color:#666>=</span><span style=color:#b44>true</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># ConsoleAppender不会尝试在Windows上使用Jansi输出流</span>
</span></span><span style=display:flex><span><span style=color:#b44>-Dlog4j.skipJansi</span><span style=color:#666>=</span><span style=color:#b44>true</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 输出Heap Dump到指定文件</span>
</span></span><span style=display:flex><span><span style=color:#b44>-XX</span><span style=color:#666>:</span><span style=color:#b44>+HeapDumpOnOutOfMemoryError</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 初始堆内存大小</span>
</span></span><span style=display:flex><span><span>-Xmx1g</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 最大堆内存大小</span>
</span></span><span style=display:flex><span><span>-Xms1g</span>
</span></span></code></pre></td></tr></table></div></div><blockquote><ul><li>其他配置通常都使用默认值. 主要是调整JVM堆内存配置, 通常需要保持最大堆(xms)和最小堆(xmx)内存的一致, 默认值是1g</li></ul></blockquote></li></ul><blockquote><ul><li><p>此参数也可以通过环境变量ES_JAVA_OPTS进行指定: ES_JAVA_OPTS="-Xms4g -Xmx4g"</p></li><li><p>最好将堆内存设置为ElasticSearch服务可用内存的一半(但不超过32g, 更多的内存反而影响性能), 剩下的可用内存会被Lucene消耗</p></li><li><p>堆内存和Lucene内存分配原则: 默认各占一半, 堆内存用于数据排序聚合等, 偏数据分析场景, Lucene内存用于分词和检索缓存, 偏全文检索场景. 根据使用场景调整二者内存分配</p></li><li><p>参考文档: <a href=https://www.elastic.co/guide/en/elasticsearch/reference/current/important-settings.html#heap-size-settings>https://www.elastic.co/guide/en/elasticsearch/reference/current/important-settings.html#heap-size-settings</a></p></li></ul></blockquote><ul><li><p><strong>$ES_HOME/config/log4j2.properties</strong>: ElasticSearch日志参数配置文件</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 37
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 38
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 39
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 40
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 41
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 42
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 43
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 44
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 45
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 46
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 47
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 48
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 49
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 50
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 51
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 52
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 53
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 54
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 55
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 56
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 57
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 58
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 59
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 60
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 61
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 62
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 63
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 64
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 65
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 66
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 67
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 68
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 69
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 70
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 71
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 72
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 73
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 74
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 75
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 76
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 77
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 78
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 79
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 80
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 81
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 82
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 83
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 84
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 85
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 86
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 87
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 88
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 89
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 90
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 91
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 92
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 93
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 94
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 95
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 96
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 97
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 98
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 99
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">100
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">101
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">102
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">103
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">104
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">105
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">106
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">107
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">108
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">109
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">110
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">111
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">112
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">113
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">114
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">115
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">116
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">117
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">118
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">119
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">120
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">121
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">122
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">123
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">124
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">125
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">126
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">127
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">128
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">129
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">130
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">131
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">132
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">133
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">134
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">135
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">136
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">137
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">138
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">139
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-properties data-lang=properties><span style=display:flex><span><span style=color:#b44>status</span> <span style=color:#666>=</span> <span style=color:#b44>error</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># log action execution errors for easier debugging</span>
</span></span><span style=display:flex><span><span style=color:#b44>logger.action.name</span> <span style=color:#666>=</span> <span style=color:#b44>org.elasticsearch.action</span>
</span></span><span style=display:flex><span><span style=color:#b44>logger.action.level</span> <span style=color:#666>=</span> <span style=color:#b44>debug</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#b44>appender.console.type</span> <span style=color:#666>=</span> <span style=color:#b44>Console</span>
</span></span><span style=display:flex><span><span style=color:#b44>appender.console.name</span> <span style=color:#666>=</span> <span style=color:#b44>console</span>
</span></span><span style=display:flex><span><span style=color:#b44>appender.console.layout.type</span> <span style=color:#666>=</span> <span style=color:#b44>PatternLayout</span>
</span></span><span style=display:flex><span><span style=color:#b44>appender.console.layout.pattern</span> <span style=color:#666>=</span> <span style=color:#b44>%d{ISO8601} %p [%t] %c - %m%n</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 配置 RollingFile 附加器</span>
</span></span><span style=display:flex><span><span style=color:#b44>appender.rolling.type</span> <span style=color:#666>=</span> <span style=color:#b44>RollingFile</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 集群日志的 appender 标签名称</span>
</span></span><span style=display:flex><span><span style=color:#b44>appender.rolling.name</span> <span style=color:#666>=</span> <span style=color:#b44>rolling</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 日志输出路径: /home/es/logs/es/XX[集群名称]-cluster.log （路径从 elasticsearch.yml 配置文件中获取）</span>
</span></span><span style=display:flex><span><span style=color:#b44>appender.rolling.fileName</span> <span style=color:#666>=</span> <span style=color:#b44>${sys:es.logs.base_path}${sys:file.separator}${sys:es.logs.cluster_name}-cluster.log</span>
</span></span><span style=display:flex><span><span style=color:#b44>appender.rolling.layout.type</span> <span style=color:#666>=</span> <span style=color:#b44>PatternLayout</span>
</span></span><span style=display:flex><span><span style=color:#b44>appender.rolling.layout.pattern</span> <span style=color:#666>=</span> <span style=color:#b44>%d{ISO8601} %p [%t] %c:%M:%L - %m%n</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 将日志滚动到 /home/es/logs/es/XX[集群名称]-yyyy-MM-dd-%i.log</span>
</span></span><span style=display:flex><span><span style=color:#b44>appender.rolling.filePattern</span> <span style=color:#666>=</span> <span style=color:#b44>${sys:es.logs.base_path}${sys:file.separator}${sys:es.logs.cluster_name}-%d{yyyy-MM-dd}-%i.log</span>
</span></span><span style=display:flex><span><span style=color:#b44>appender.rolling.policies.type</span> <span style=color:#666>=</span> <span style=color:#b44>Policies</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 使用基于时间的滚动策略</span>
</span></span><span style=display:flex><span><span style=color:#b44>appender.rolling.policies.time.type</span> <span style=color:#666>=</span> <span style=color:#b44>TimeBasedTriggeringPolicy</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 每天滚动日志</span>
</span></span><span style=display:flex><span><span style=color:#b44>appender.rolling.policies.time.interval</span> <span style=color:#666>=</span> <span style=color:#b44>1</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 在天数边界上对齐滚动（而不是每24h滚动一次）</span>
</span></span><span style=display:flex><span><span style=color:#b44>appender.rolling.policies.time.modulate</span> <span style=color:#666>=</span> <span style=color:#b44>true</span>
</span></span><span style=display:flex><span><span style=color:#b44>appender.rolling.policies.size.type</span> <span style=color:#666>=</span> <span style=color:#b44>SizeBasedTriggeringPolicy</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 日志文件每达到 1GB 大小进行一次滚动</span>
</span></span><span style=display:flex><span><span style=color:#b44>appender.rolling.policies.size.size</span> <span style=color:#666>=</span> <span style=color:#b44>1GB</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 当天日志文件最多保留 3 个</span>
</span></span><span style=display:flex><span><span style=color:#b44>appender.rolling.strategy.max</span> <span style=color:#666>=</span> <span style=color:#b44>3</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 配置 DefaultRolloverStrategy </span>
</span></span><span style=display:flex><span><span style=color:#b44>appender.rolling.strategy.type</span> <span style=color:#666>=</span> <span style=color:#b44>DefaultRolloverStrategy</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 配置 Delete 用于处理翻转操作</span>
</span></span><span style=display:flex><span><span style=color:#b44>appender.rolling.strategy.action.type</span> <span style=color:#666>=</span> <span style=color:#b44>Delete</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># ES日志基本路径</span>
</span></span><span style=display:flex><span><span style=color:#b44>appender.rolling.strategy.action.basepath</span> <span style=color:#666>=</span> <span style=color:#b44>${sys:es.logs.base_path}</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 如果超过指定天数的文件, 则仅删除5天以上的文件</span>
</span></span><span style=display:flex><span><span style=color:#b44>appender.rolling.strategy.action.condition.type</span> <span style=color:#666>=</span> <span style=color:#b44>IfFileName</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 从与 glob 匹配的基本路径中删除文件 ${sys:es.logs.cluster_name}-*；这是日志文件滚动到的位置；仅删除滚动的es集群日志, 而不删除其他日志时才需要这样做</span>
</span></span><span style=display:flex><span><span style=color:#b44>appender.rolling.strategy.action.condition.glob</span> <span style=color:#666>=</span> <span style=color:#b44>${sys:es.logs.cluster_name}-*</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 处理过渡时适用的条件</span>
</span></span><span style=display:flex><span><span style=color:#b44>appender.rolling.strategy.action.condition.nested_condition.type</span> <span style=color:#666>=</span> <span style=color:#b44>IfLastModified</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 日志保留5天</span>
</span></span><span style=display:flex><span><span style=color:#b44>appender.rolling.strategy.action.condition.nested_condition.age</span> <span style=color:#666>=</span> <span style=color:#b44>5D</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 日志级别</span>
</span></span><span style=display:flex><span><span style=color:#b44>rootLogger.level</span> <span style=color:#666>=</span> <span style=color:#b44>info</span>
</span></span><span style=display:flex><span><span style=color:#b44>rootLogger.appenderRef.console.ref</span> <span style=color:#666>=</span> <span style=color:#b44>console</span>
</span></span><span style=display:flex><span><span style=color:#b44>rootLogger.appenderRef.rolling.ref</span> <span style=color:#666>=</span> <span style=color:#b44>rolling</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 可以加载多个配置文件（在这种情况下, 它们将被合并）, 只要它们被命名 log4j2.properties 并将 Elasticsearch config 目录作为祖先即可</span>
</span></span><span style=display:flex><span><span style=color:#b44>appender.deprecation_rolling.type</span> <span style=color:#666>=</span> <span style=color:#b44>RollingFile</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># deprecation 日志的 appender 标签名称</span>
</span></span><span style=display:flex><span><span style=color:#b44>appender.deprecation_rolling.name</span> <span style=color:#666>=</span> <span style=color:#b44>deprecation_rolling</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># deprecation 日志路径和日志格式</span>
</span></span><span style=display:flex><span><span style=color:#b44>appender.deprecation_rolling.fileName</span> <span style=color:#666>=</span> <span style=color:#b44>${sys:es.logs.base_path}${sys:file.separator}${sys:es.logs.cluster_name}_deprecation.log</span>
</span></span><span style=display:flex><span><span style=color:#b44>appender.deprecation_rolling.layout.type</span> <span style=color:#666>=</span> <span style=color:#b44>PatternLayout</span>
</span></span><span style=display:flex><span><span style=color:#b44>appender.deprecation_rolling.layout.pattern</span> <span style=color:#666>=</span> <span style=color:#b44>%d{ISO8601} %p [%t] %c:%M:%L - %m%n</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># If you append .gz or .zip to appender.rolling.filePattern, then the logs will be compressed as they are rolled.</span>
</span></span><span style=display:flex><span><span style=color:#b44>appender.deprecation_rolling.filePattern</span> <span style=color:#666>=</span> <span style=color:#b44>${sys:es.logs.base_path}${sys:file.separator}${sys:es.logs.cluster_name}_deprecation-%d{yyyy-MM-dd}-%i.log.gz</span>
</span></span><span style=display:flex><span><span style=color:#b44>appender.deprecation_rolling.policies.type</span> <span style=color:#666>=</span> <span style=color:#b44>Policies</span>
</span></span><span style=display:flex><span><span style=color:#b44>appender.deprecation_rolling.policies.size.type</span> <span style=color:#666>=</span> <span style=color:#b44>SizeBasedTriggeringPolicy</span>
</span></span><span style=display:flex><span><span style=color:#b44>appender.deprecation_rolling.policies.size.size</span> <span style=color:#666>=</span> <span style=color:#b44>1GB</span>
</span></span><span style=display:flex><span><span style=color:#b44>appender.deprecation_rolling.strategy.max</span> <span style=color:#666>=</span> <span style=color:#b44>3</span>
</span></span><span style=display:flex><span><span style=color:#b44>appender.deprecation_rolling.strategy.type</span> <span style=color:#666>=</span> <span style=color:#b44>DefaultRolloverStrategy</span>
</span></span><span style=display:flex><span><span style=color:#b44>appender.deprecation_rolling.strategy.action.type</span> <span style=color:#666>=</span> <span style=color:#b44>Delete</span>
</span></span><span style=display:flex><span><span style=color:#b44>appender.deprecation_rolling.strategy.action.basepath</span> <span style=color:#666>=</span> <span style=color:#b44>${sys:es.logs.base_path}</span>
</span></span><span style=display:flex><span><span style=color:#b44>appender.deprecation_rolling.strategy.action.condition.type</span> <span style=color:#666>=</span> <span style=color:#b44>IfFileName</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 从与 glob 匹配的基本路径中删除文件 ${sys:es.logs.cluster_name}_deprecation-*；</span>
</span></span><span style=display:flex><span><span style=color:#b44>appender.deprecation_rolling.strategy.action.condition.glob</span> <span style=color:#666>=</span> <span style=color:#b44>${sys:es.logs.cluster_name}_deprecation-*</span>
</span></span><span style=display:flex><span><span style=color:#b44>appender.deprecation_rolling.strategy.action.condition.nested_condition.type</span> <span style=color:#666>=</span> <span style=color:#b44>IfLastModified</span>
</span></span><span style=display:flex><span><span style=color:#b44>appender.deprecation_rolling.strategy.action.condition.nested_condition.age</span> <span style=color:#666>=</span> <span style=color:#b44>5D</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#b44>logger.deprecation.name</span> <span style=color:#666>=</span> <span style=color:#b44>org.elasticsearch.deprecation</span>
</span></span><span style=display:flex><span><span style=color:#b44>logger.deprecation.level</span> <span style=color:#666>=</span> <span style=color:#b44>warn</span>
</span></span><span style=display:flex><span><span style=color:#b44>logger.deprecation.appenderRef.deprecation_rolling.ref</span> <span style=color:#666>=</span> <span style=color:#b44>deprecation_rolling</span>
</span></span><span style=display:flex><span><span style=color:#b44>logger.deprecation.additivity</span> <span style=color:#666>=</span> <span style=color:#b44>false</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#b44>appender.index_search_slowlog_rolling.type</span> <span style=color:#666>=</span> <span style=color:#b44>RollingFile</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># index_search_slowlog 查询慢日志的 appender 标签名称</span>
</span></span><span style=display:flex><span><span style=color:#b44>appender.index_search_slowlog_rolling.name</span> <span style=color:#666>=</span> <span style=color:#b44>index_search_slowlog_rolling</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># index_search_slowlog 查询慢日志路径和日志格式</span>
</span></span><span style=display:flex><span><span style=color:#b44>appender.index_search_slowlog_rolling.fileName</span> <span style=color:#666>=</span> <span style=color:#b44>${sys:es.logs.base_path}${sys:file.separator}${sys:es.logs.cluster_name}_index_search_slowlog.log</span>
</span></span><span style=display:flex><span><span style=color:#b44>appender.index_search_slowlog_rolling.layout.type</span> <span style=color:#666>=</span> <span style=color:#b44>PatternLayout</span>
</span></span><span style=display:flex><span><span style=color:#b44>appender.index_search_slowlog_rolling.layout.pattern</span> <span style=color:#666>=</span> <span style=color:#b44>%d{ISO8601} %p [%t] %c:%M:%L - %m%n</span>
</span></span><span style=display:flex><span><span style=color:#b44>appender.index_search_slowlog_rolling.filePattern</span> <span style=color:#666>=</span> <span style=color:#b44>${sys:es.logs.base_path}${sys:file.separator}${sys:es.logs.cluster_name}_index_search_slowlog-%d{yyyy-MM-dd}-%i.log</span>
</span></span><span style=display:flex><span><span style=color:#b44>appender.index_search_slowlog_rolling.policies.type</span> <span style=color:#666>=</span> <span style=color:#b44>Policies</span>
</span></span><span style=display:flex><span><span style=color:#b44>appender.index_search_slowlog_rolling.policies.time.type</span> <span style=color:#666>=</span> <span style=color:#b44>TimeBasedTriggeringPolicy</span>
</span></span><span style=display:flex><span><span style=color:#b44>appender.index_search_slowlog_rolling.policies.time.interval</span> <span style=color:#666>=</span> <span style=color:#b44>1</span>
</span></span><span style=display:flex><span><span style=color:#b44>appender.index_search_slowlog_rolling.policies.time.modulate</span> <span style=color:#666>=</span> <span style=color:#b44>true</span>
</span></span><span style=display:flex><span><span style=color:#b44>appender.index_search_slowlog_rolling.strategy.max</span> <span style=color:#666>=</span> <span style=color:#b44>3</span>
</span></span><span style=display:flex><span><span style=color:#b44>appender.index_search_slowlog_rolling.policies.size.type</span> <span style=color:#666>=</span> <span style=color:#b44>SizeBasedTriggeringPolicy</span>
</span></span><span style=display:flex><span><span style=color:#b44>appender.index_search_slowlog_rolling.policies.size.size</span> <span style=color:#666>=</span> <span style=color:#b44>1GB</span>
</span></span><span style=display:flex><span><span style=color:#b44>appender.index_search_slowlog_rolling.strategy.type</span> <span style=color:#666>=</span> <span style=color:#b44>DefaultRolloverStrategy</span>
</span></span><span style=display:flex><span><span style=color:#b44>appender.index_search_slowlog_rolling.strategy.action.type</span> <span style=color:#666>=</span> <span style=color:#b44>Delete</span>
</span></span><span style=display:flex><span><span style=color:#b44>appender.index_search_slowlog_rolling.strategy.action.basepath</span> <span style=color:#666>=</span> <span style=color:#b44>${sys:es.logs.base_path}</span>
</span></span><span style=display:flex><span><span style=color:#b44>appender.index_search_slowlog_rolling.strategy.action.condition.type</span> <span style=color:#666>=</span> <span style=color:#b44>IfFileName</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 从与 glob 匹配的基本路径中删除文件 ${sys:es.logs.cluster_name}_index_search_slowlog-*</span>
</span></span><span style=display:flex><span><span style=color:#b44>appender.index_search_slowlog_rolling.strategy.action.condition.glob</span> <span style=color:#666>=</span> <span style=color:#b44>${sys:es.logs.cluster_name}_index_search_slowlog-*</span>
</span></span><span style=display:flex><span><span style=color:#b44>appender.index_search_slowlog_rolling.strategy.action.condition.nested_condition.type</span> <span style=color:#666>=</span> <span style=color:#b44>IfLastModified</span>
</span></span><span style=display:flex><span><span style=color:#b44>appender.index_search_slowlog_rolling.strategy.action.condition.nested_condition.age</span> <span style=color:#666>=</span> <span style=color:#b44>5D</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#b44>logger.index_search_slowlog_rolling.name</span> <span style=color:#666>=</span> <span style=color:#b44>index.search.slowlog</span>
</span></span><span style=display:flex><span><span style=color:#b44>logger.index_search_slowlog_rolling.level</span> <span style=color:#666>=</span> <span style=color:#b44>trace</span>
</span></span><span style=display:flex><span><span style=color:#b44>logger.index_search_slowlog_rolling.appenderRef.index_search_slowlog_rolling.ref</span> <span style=color:#666>=</span> <span style=color:#b44>index_search_slowlog_rolling</span>
</span></span><span style=display:flex><span><span style=color:#b44>logger.index_search_slowlog_rolling.additivity</span> <span style=color:#666>=</span> <span style=color:#b44>false</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#b44>appender.index_indexing_slowlog_rolling.type</span> <span style=color:#666>=</span> <span style=color:#b44>RollingFile</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># index_indexing_slowlog 写入慢日志的 appender 标签名称</span>
</span></span><span style=display:flex><span><span style=color:#b44>appender.index_indexing_slowlog_rolling.name</span> <span style=color:#666>=</span> <span style=color:#b44>index_indexing_slowlog_rolling</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># index_indexing_slowlog 写入慢日志路径和日志格式</span>
</span></span><span style=display:flex><span><span style=color:#b44>appender.index_indexing_slowlog_rolling.fileName</span> <span style=color:#666>=</span> <span style=color:#b44>${sys:es.logs.base_path}${sys:file.separator}${sys:es.logs.cluster_name}_index_indexing_slowlog.log</span>
</span></span><span style=display:flex><span><span style=color:#b44>appender.index_indexing_slowlog_rolling.layout.type</span> <span style=color:#666>=</span> <span style=color:#b44>PatternLayout</span>
</span></span><span style=display:flex><span><span style=color:#b44>appender.index_indexing_slowlog_rolling.layout.pattern</span> <span style=color:#666>=</span> <span style=color:#b44>%d{ISO8601} %p [%t] %c:%M:%L - %m%n</span>
</span></span><span style=display:flex><span><span style=color:#b44>appender.index_indexing_slowlog_rolling.filePattern</span> <span style=color:#666>=</span> <span style=color:#b44>${sys:es.logs.base_path}${sys:file.separator}${sys:es.logs.cluster_name}_index_indexing_slowlog-%d{yyyy-MM-dd}-%i.log</span>
</span></span><span style=display:flex><span><span style=color:#b44>appender.index_indexing_slowlog_rolling.policies.type</span> <span style=color:#666>=</span> <span style=color:#b44>Policies</span>
</span></span><span style=display:flex><span><span style=color:#b44>appender.index_indexing_slowlog_rolling.policies.time.type</span> <span style=color:#666>=</span> <span style=color:#b44>TimeBasedTriggeringPolicy</span>
</span></span><span style=display:flex><span><span style=color:#b44>appender.index_indexing_slowlog_rolling.policies.time.interval</span> <span style=color:#666>=</span> <span style=color:#b44>1</span>
</span></span><span style=display:flex><span><span style=color:#b44>appender.index_indexing_slowlog_rolling.policies.time.modulate</span> <span style=color:#666>=</span> <span style=color:#b44>true</span>
</span></span><span style=display:flex><span><span style=color:#b44>appender.index_indexing_slowlog_rolling.strategy.type</span> <span style=color:#666>=</span> <span style=color:#b44>DefaultRolloverStrategy</span>
</span></span><span style=display:flex><span><span style=color:#b44>appender.index_indexing_slowlog_rolling.strategy.max</span> <span style=color:#666>=</span> <span style=color:#b44>3</span>
</span></span><span style=display:flex><span><span style=color:#b44>appender.index_indexing_slowlog_rolling.policies.size.type</span> <span style=color:#666>=</span> <span style=color:#b44>SizeBasedTriggeringPolicy</span>
</span></span><span style=display:flex><span><span style=color:#b44>appender.index_indexing_slowlog_rolling.policies.size.size</span> <span style=color:#666>=</span> <span style=color:#b44>1GB</span>
</span></span><span style=display:flex><span><span style=color:#b44>appender.index_indexing_slowlog_rolling.strategy.type</span> <span style=color:#666>=</span> <span style=color:#b44>DefaultRolloverStrategy</span>
</span></span><span style=display:flex><span><span style=color:#b44>appender.index_indexing_slowlog_rolling.strategy.action.type</span> <span style=color:#666>=</span> <span style=color:#b44>Delete</span>
</span></span><span style=display:flex><span><span style=color:#b44>appender.index_indexing_slowlog_rolling.strategy.action.basepath</span> <span style=color:#666>=</span> <span style=color:#b44>${sys:es.logs.base_path}</span>
</span></span><span style=display:flex><span><span style=color:#b44>appender.index_indexing_slowlog_rolling.strategy.action.condition.type</span> <span style=color:#666>=</span> <span style=color:#b44>IfFileName</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 从与 glob 匹配的基本路径中删除文件 ${sys:es.logs.cluster_name}_index_indexing_slowlog-*</span>
</span></span><span style=display:flex><span><span style=color:#b44>appender.index_indexing_slowlog_rolling.strategy.action.condition.glob</span> <span style=color:#666>=</span> <span style=color:#b44>${sys:es.logs.cluster_name}_index_indexing_slowlog-*</span>
</span></span><span style=display:flex><span><span style=color:#b44>appender.index_indexing_slowlog_rolling.strategy.action.condition.nested_condition.type</span> <span style=color:#666>=</span> <span style=color:#b44>IfLastModified</span>
</span></span><span style=display:flex><span><span style=color:#b44>appender.index_indexing_slowlog_rolling.strategy.action.condition.nested_condition.age</span> <span style=color:#666>=</span> <span style=color:#b44>5D</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#b44>logger.index_indexing_slowlog.name</span> <span style=color:#666>=</span> <span style=color:#b44>index.indexing.slowlog.index</span>
</span></span><span style=display:flex><span><span style=color:#b44>logger.index_indexing_slowlog.level</span> <span style=color:#666>=</span> <span style=color:#b44>trace</span>
</span></span><span style=display:flex><span><span style=color:#b44>logger.index_indexing_slowlog.appenderRef.index_indexing_slowlog_rolling.ref</span> <span style=color:#666>=</span> <span style=color:#b44>index_indexing_slowlog_rolling</span>
</span></span><span style=display:flex><span><span style=color:#b44>logger.index_indexing_slowlog.additivity</span> <span style=color:#666>=</span> <span style=color:#b44>false</span>
</span></span></code></pre></td></tr></table></div></div><blockquote><p>日志配置通常不需要调整</p></blockquote></li></ul><h4 id=运维命令-3>运维命令</h4><ol><li><p>集群启停</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/elasticsearch -d <span style=color:#080;font-style:italic># 启动</span>
</span></span><span style=display:flex><span><span style=color:#a2f>kill</span> -9 <span style=color:#a2f;font-weight:700>$(</span>ps aux|grep elastic|awk <span style=color:#b44>&#39;{print $2}&#39;</span><span style=color:#a2f;font-weight:700>)</span> <span style=color:#080;font-style:italic># 关闭</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p>密码重置</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/elasticsearch-setup-passwords interactive
</span></span></code></pre></td></tr></table></div></div></li><li><p>凭证管理</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#080;font-style:italic># 创建ca凭证</span>
</span></span><span style=display:flex><span>bin/elasticsearch-certutil ca --days <span style=color:#666>3660</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 创建cert凭证</span>
</span></span><span style=display:flex><span>bin/elasticsearch-certutil cert --ca elastic-stack-ca.p12 --ip <span style=color:#666>{</span>ip<span style=color:#666>}</span>,127.0.0.1 --out config/certs/cert.p12 --days <span style=color:#666>3660</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 创建凭证库</span>
</span></span><span style=display:flex><span>bin/elasticsearch-keystore create
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 设置cert pkcs12凭证密码</span>
</span></span><span style=display:flex><span>bin/elasticsearch-keystore add xpack.security.transport.ssl.keystore.secure_password
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 设置ca pkcs12凭证密码</span>
</span></span><span style=display:flex><span>bin/elasticsearch-keystore add xpack.security.transport.ssl.truststore.secure_password
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 查看密钥库凭证</span>
</span></span><span style=display:flex><span>bin/elasticsearch-keystore list
</span></span></code></pre></td></tr></table></div></div><blockquote><p>凭证批量生成</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/elasticsearch-certgen -in instances.yml
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:green;font-weight:700>instances</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;node1&#34;</span><span style=color:#bbb> 
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>ip</span>:<span style=color:#bbb> 
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:#b44>&#34;192.0.2.1&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>dns</span>:<span style=color:#bbb> 
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:#b44>&#34;node1.mydomain.com&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;node2&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>ip</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:#b44>&#34;192.0.2.2&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:#b44>&#34;198.51.100.1&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;node3&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;node4&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>dns</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:#b44>&#34;node4.mydomain.com&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>- <span style=color:#b44>&#34;node4.internal&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;CN=node5,OU=IT,DC=mydomain,DC=com&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>filename</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;node5&#34;</span><span style=color:#bbb>
</span></span></span></code></pre></td></tr></table></div></div></blockquote></li><li><p>插件管理</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#080;font-style:italic># 插件安装</span>
</span></span><span style=display:flex><span>bin/elasticsearch-plugin install <span style=color:#666>{</span>plugin_name<span style=color:#666>}</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 插件查看</span>
</span></span><span style=display:flex><span>bin/elasticsearch-plugin list
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 插件卸载</span>
</span></span><span style=display:flex><span>bin/elasticsearch-plugin remove <span style=color:#666>{</span>plugin_name<span style=color:#666>}</span>
</span></span></code></pre></td></tr></table></div></div><blockquote><p>elasticsearch常用插件:</p><ul><li>elasticsearch-head: 集群管理工具</li><li>bigdesk: 集群监控工具</li><li>kopf: 集群资源查看和查询工具</li></ul><p>kibana常用插件:</p><ul><li>conveyor: 图形化数据导入工具</li><li>kibana_markdown_doc_view: Kibana文档查看强化插件</li><li>indices_view: index查看插件</li><li>sentinl: 告警插件</li></ul></blockquote></li></ol><h4 id=常用api-2>常用API</h4><ol><li><p>查看集群状态</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span>GET</span> <span>/_cluster/health?v</span>
</span></span><span style=display:flex><span><span>GET</span> <span>/_cat/health</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p>查看集群统计信息</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span>GET</span> <span>/_cluster/stats?pretty</span>
</span></span><span style=display:flex><span><span>GET</span> <span>/_cluster/state/</span>{<span>obj</span>}
</span></span><span style=display:flex><span><span>GET</span> <span>/_nodes/stats/</span>{<span>obj</span>}<span>?pretty</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p>查看可用API</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span>GET</span> <span>/_cat</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p>查看指定对象信息</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span>GET</span> <span>/_cat/nodes?v</span>               <span>#</span> <span>查看节点</span>
</span></span><span style=display:flex><span><span>GET</span> <span>/_cat/tasks</span>                 <span>#</span> <span>查看任务</span>
</span></span><span style=display:flex><span><span>GET</span> <span>/_cat/allocation</span>            <span>#</span> <span>查看分片分配</span>
</span></span><span style=display:flex><span><span>GET</span> <span>/_cat/plugins</span>               <span>#</span> <span>查看已安装的插件</span>
</span></span><span style=display:flex><span><span>GET</span> <span>/_cat/indices/</span>{<span>index</span>}       <span>#</span> <span>查看(指定)索引</span>
</span></span><span style=display:flex><span><span>GET</span> <span>/_cat/shards/</span>{<span>index</span>}        <span>#</span> <span>查看(指定索引的)分片</span>
</span></span><span style=display:flex><span><span>GET</span> <span>/_cat/aliases/</span>{<span>aliase</span>}      <span>#</span> <span>查看(指定)索引别名</span>
</span></span><span style=display:flex><span><span>GET</span> <span>/_cat/segments/</span>{<span>index</span>}      <span>#</span> <span>查看(指定索引的)segments</span>
</span></span><span style=display:flex><span><span>GET</span> <span>/_cat/count/</span>{<span>index</span>}         <span>#</span> <span>查看(指定索引的)文档总数</span>
</span></span><span style=display:flex><span><span>GET</span> <span>/_cat/fielddata/</span>{<span>field</span>}     <span>#</span> <span>查看(指定)字段</span>
</span></span><span style=display:flex><span><span>GET</span> <span>/_cat/recovery/</span>{<span>index</span>}      <span>#</span> <span>查看(指定索引的)恢复</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p>索引操作</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span>#</span> <span>创建索引</span>
</span></span><span style=display:flex><span><span>PUT</span> <span>/</span>{<span>index</span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span>#</span> <span>查看索引</span>
</span></span><span style=display:flex><span><span>GET</span> <span>/</span>{<span>index</span>}
</span></span><span style=display:flex><span><span>GET</span> <span>/_cat/indices?v&amp;health=yellow&amp;s=docs.count:desc</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span>#</span> <span>查看每个索引包含的type</span>
</span></span><span style=display:flex><span><span>GET</span> <span>/_mapping?pretty</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span>#</span> <span>删除索引</span>
</span></span><span style=display:flex><span><span>DELETE</span> <span>/</span>{<span>index</span>}
</span></span><span style=display:flex><span><span>DELETE</span> <span>/_all</span>
</span></span><span style=display:flex><span><span>DELETE</span> <span>/*</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span>#</span> <span>打开/关闭索引</span>
</span></span><span style=display:flex><span><span>POST</span> <span>/</span>{<span>index</span>}<span>/_open</span>
</span></span><span style=display:flex><span><span>POST</span> <span>/</span>{<span>index</span>}<span>/_close</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p>文档操作</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">63
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">64
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span>#</span> <span>创建/更新文档</span>
</span></span><span style=display:flex><span><span>PUT</span> <span>/</span>{<span>index</span>}<span>/</span>{<span>type</span>}<span>/</span>{<span>doc_id</span>}
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;foo&#34;</span>: <span style=color:#b44>&#34;bar&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span>POST</span> <span>/</span>{<span>index</span>}<span>/</span>{<span>type</span>}<span>/</span>{<span>doc_id</span>}<span>/_update</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;foo&#34;</span>: <span style=color:#b44>&#34;bar&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span>#</span> <span>删除文档</span>
</span></span><span style=display:flex><span><span>DELETE</span> <span>/</span>{<span>index</span>}<span>/</span>{<span>type</span>}<span>/</span>{<span>doc_id</span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span>#</span> <span>查看文档</span>
</span></span><span style=display:flex><span><span>GET</span> <span>/</span>{<span>index</span>}<span>/</span>{<span>type</span>}<span>/</span>{<span>doc_id</span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span>#</span> <span>检索文档</span>
</span></span><span style=display:flex><span><span>GET</span> <span>/_search</span>                 <span>#</span> <span>检索所有文档</span>
</span></span><span style=display:flex><span><span>GET</span> <span>/_all/</span>{<span>type</span>}<span>/_search</span>     <span>#</span> <span>检索指定类型的文档</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;query&#34;</span>: {<span style=color:green;font-weight:700>&#34;match&#34;</span>: { <span style=color:green;font-weight:700>&#34;foo&#34;</span>: <span style=color:#b44>&#34;bar&#34;</span>}}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span>GET</span> <span>/</span>{<span>index</span>}<span>/_search?pretty</span>  <span>#</span> <span>检索指定索引的文档</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;_source&#34;</span>:[<span style=color:#b44>&#34;name&#34;</span>,<span style=color:#b44>&#34;age&#34;</span>],  <span>#</span> <span>指定返回字段</span>
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;query&#34;</span>: {<span style=color:green;font-weight:700>&#34;match_all&#34;</span>: {}}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span>GET</span> <span>/</span>{<span>index</span>}<span>/_search?pretty</span>  <span>#</span> <span>条件检索</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span> <span style=color:green;font-weight:700>&#34;query&#34;</span>: {
</span></span><span style=display:flex><span>     <span style=color:green;font-weight:700>&#34;bool&#34;</span>: {
</span></span><span style=display:flex><span>         <span style=color:green;font-weight:700>&#34;must&#34;</span>:[            <span>#</span> <span>条件</span> <span>and:</span> <span>must</span>, <span>or:</span> <span>should</span>
</span></span><span style=display:flex><span>             {<span style=color:green;font-weight:700>&#34;match&#34;</span>:{<span style=color:green;font-weight:700>&#34;name&#34;</span>:<span style=color:#b44>&#34;hello&#34;</span>}},
</span></span><span style=display:flex><span>             {<span style=color:green;font-weight:700>&#34;match&#34;</span>:{<span style=color:green;font-weight:700>&#34;name&#34;</span>:<span style=color:#b44>&#34;world&#34;</span>}}
</span></span><span style=display:flex><span>          ]
</span></span><span style=display:flex><span>       },
</span></span><span style=display:flex><span>      <span style=color:green;font-weight:700>&#34;sort&#34;</span>: {              <span>#</span> <span>排序</span>
</span></span><span style=display:flex><span>          <span style=color:green;font-weight:700>&#34;timestamp&#34;</span>: {
</span></span><span style=display:flex><span>              <span style=color:green;font-weight:700>&#34;order&#34;</span>: <span style=color:#b44>&#34;desc&#34;</span>
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span>GET</span> <span>/</span>{<span>index</span>}<span>/_search?pretty</span>  <span>#</span> <span>聚合检索</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;aggs&#34;</span>: {
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&#34;avg_age&#34;</span>: {
</span></span><span style=display:flex><span>            <span style=color:green;font-weight:700>&#34;avg&#34;</span>: {
</span></span><span style=display:flex><span>                <span style=color:green;font-weight:700>&#34;field&#34;</span>: <span style=color:#b44>&#34;age&#34;</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span>#</span> <span>查询文档数量</span>
</span></span><span style=display:flex><span><span>GET</span> <span>/_all/_count</span>
</span></span><span style=display:flex><span><span>GET</span> <span>/</span>{<span>index</span>}<span>/</span>{<span>type</span>}<span>/_count</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;query&#34;</span>: {<span style=color:green;font-weight:700>&#34;match_all&#34;</span>: {}}
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div></li><li><p>别名操作</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span>#</span> <span>查看别名</span>
</span></span><span style=display:flex><span><span>GET</span> <span>/_alias/</span>{<span>alias</span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span>#</span> <span>指定索引(过滤)添加别名</span>
</span></span><span style=display:flex><span><span>PUT</span> <span>/</span>{<span>index</span>}<span>/_alias/</span>{<span>alias</span>}
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;filter&#34;</span>: {
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&#34;term&#34;</span>: {
</span></span><span style=display:flex><span>            <span style=color:green;font-weight:700>&#34;foo&#34;</span>: <span style=color:#b44>&#34;bar&#34;</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span>#</span> <span>为同一索引添加多个别名</span>
</span></span><span style=display:flex><span><span>POST</span> <span>/_aliases</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>   <span style=color:green;font-weight:700>&#34;actions&#34;</span>: [
</span></span><span style=display:flex><span>        {<span style=color:green;font-weight:700>&#34;add&#34;</span>: {<span style=color:green;font-weight:700>&#34;index&#34;</span>: <span style=color:#b44>&#34;index1&#34;</span>, <span style=color:green;font-weight:700>&#34;alias&#34;</span>: <span style=color:#b44>&#34;index_alias1&#34;</span>}},
</span></span><span style=display:flex><span>        {<span style=color:green;font-weight:700>&#34;add&#34;</span>: {<span style=color:green;font-weight:700>&#34;index&#34;</span>: <span style=color:#b44>&#34;index1&#34;</span>, <span style=color:green;font-weight:700>&#34;alias&#34;</span>: <span style=color:#b44>&#34;index_alias2&#34;</span>}}
</span></span><span style=display:flex><span>    ] 
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span>#</span> <span>为多个索引添加同一别名</span>
</span></span><span style=display:flex><span><span>POST</span> <span>/_aliases</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>   <span style=color:green;font-weight:700>&#34;actions&#34;</span>: [
</span></span><span style=display:flex><span>        {<span style=color:green;font-weight:700>&#34;add&#34;</span>: {<span style=color:green;font-weight:700>&#34;indices&#34;</span>: [<span style=color:#b44>&#34;index1&#34;</span>, <span style=color:#b44>&#34;index2&#34;</span>, <span style=color:#b44>&#34;idx*&#34;</span>], <span style=color:green;font-weight:700>&#34;alias&#34;</span>: <span style=color:#b44>&#34;index_alias&#34;</span>}}
</span></span><span style=display:flex><span>    ] 
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span>#</span> <span>删除别名</span>
</span></span><span style=display:flex><span><span>POST</span> <span>/_aliases</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;actions&#34;</span>: [
</span></span><span style=display:flex><span>        {<span style=color:green;font-weight:700>&#34;remove&#34;</span>: {<span style=color:green;font-weight:700>&#34;index&#34;</span>: <span style=color:#b44>&#34;index1&#34;</span>, <span style=color:green;font-weight:700>&#34;alias&#34;</span>: <span style=color:#b44>&#34;index_alias&#34;</span>}}
</span></span><span style=display:flex><span>    ]
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span>#</span> <span>别名重新绑定</span>
</span></span><span style=display:flex><span><span>POST</span> <span>/_aliases</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;actions&#34;</span> : [
</span></span><span style=display:flex><span>        { <span style=color:green;font-weight:700>&#34;remove&#34;</span> : { <span style=color:green;font-weight:700>&#34;index&#34;</span> : <span style=color:#b44>&#34;index1&#34;</span>, <span style=color:green;font-weight:700>&#34;alias&#34;</span> : <span style=color:#b44>&#34;index_alias&#34;</span> } },
</span></span><span style=display:flex><span>        { <span style=color:green;font-weight:700>&#34;add&#34;</span> : { <span style=color:green;font-weight:700>&#34;index&#34;</span> : <span style=color:#b44>&#34;index2&#34;</span>, <span style=color:green;font-weight:700>&#34;alias&#34;</span> : <span style=color:#b44>&#34;index_alias&#34;</span> } }
</span></span><span style=display:flex><span>    ]
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span>#</span> <span>创建字段别名</span>
</span></span><span style=display:flex><span><span>PUT</span> <span>/</span>{<span>index</span>}
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;mappings&#34;</span>: {
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&#34;properties&#34;</span>: {
</span></span><span style=display:flex><span>            <span style=color:green;font-weight:700>&#34;username&#34;</span>: {
</span></span><span style=display:flex><span>                <span style=color:green;font-weight:700>&#34;type&#34;</span>:<span style=color:#b44>&#34;keyword&#34;</span>
</span></span><span style=display:flex><span>            },
</span></span><span style=display:flex><span>            <span style=color:green;font-weight:700>&#34;uname&#34;</span>: {
</span></span><span style=display:flex><span>                <span style=color:green;font-weight:700>&#34;type&#34;</span>: <span style=color:#b44>&#34;alias&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:green;font-weight:700>&#34;path&#34;</span>: <span style=color:#b44>&#34;username&#34;</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div></li><li><p>用户管理</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span>#</span> <span>basic</span> <span>license仅允许一个elastic用户</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span>#</span> <span>添加用户</span>
</span></span><span style=display:flex><span><span>POST</span> <span>/_xpack/security/user/</span>{<span>user</span>}
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;password&#34;</span> : <span style=color:#b44>&#34;my_user@123&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;roles&#34;</span> : [ <span style=color:#b44>&#34;superuser&#34;</span>, <span style=color:#b44>&#34;other_role1&#34;</span> ]
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span>#</span> <span>查看用户</span>
</span></span><span style=display:flex><span><span>GET</span> <span>/_xpack/security/user/</span>{<span>user</span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span>#</span> <span>修改密码</span>
</span></span><span style=display:flex><span><span>PUT</span> <span>/_xpack/security/user/</span>{<span>user</span>}<span>/_password</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;password&#34;</span>: <span style=color:#b44>&#34;q5f2qNfUJQyvZPIz57MZ&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span>#</span> <span>启用/禁用用户</span>
</span></span><span style=display:flex><span><span>PUT</span> <span>/_xpack/security/user/</span>{<span>user</span>}<span>/_enable</span>
</span></span><span style=display:flex><span><span>PUT</span> <span>/_xpack/security/user/</span>{<span>user</span>}<span>/_disable</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span>#</span> <span>删除用户</span>
</span></span><span style=display:flex><span><span>DELETE</span> <span>/_xpack/security/user/</span>{<span>user</span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span>#</span> <span>特权查询</span>
</span></span><span style=display:flex><span><span>GET</span> <span>_xpack/security/user/_has_privileges</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;cluster&#34;</span>: [ <span style=color:#b44>&#34;monitor&#34;</span>, <span style=color:#b44>&#34;manage&#34;</span> ],
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;index&#34;</span> : [
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:green;font-weight:700>&#34;names&#34;</span>: [ <span style=color:#b44>&#34;suppliers&#34;</span>, <span style=color:#b44>&#34;products&#34;</span> ],
</span></span><span style=display:flex><span>      <span style=color:green;font-weight:700>&#34;privileges&#34;</span>: [ <span style=color:#b44>&#34;read&#34;</span> ]
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:green;font-weight:700>&#34;names&#34;</span>: [ <span style=color:#b44>&#34;inventory&#34;</span> ],
</span></span><span style=display:flex><span>      <span style=color:green;font-weight:700>&#34;privileges&#34;</span> : [ <span style=color:#b44>&#34;read&#34;</span>, <span style=color:#b44>&#34;write&#34;</span> ]
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  ]
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div></li><li><p>节点分片移动</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span>POST</span> <span>/_cluster/reroute</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;commands&#34;</span>: [
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:green;font-weight:700>&#34;move&#34;</span>: {
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&#34;index&#34;</span>: <span style=color:#b44>&#34;indexname&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&#34;shard&#34;</span>: <span style=color:#666>1</span>,
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&#34;from_node&#34;</span>: <span style=color:#b44>&#34;nodename&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&#34;to_node&#34;</span>: <span style=color:#b44>&#34;nodename&#34;</span>
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  ]
</span></span><span style=display:flex><span>} 
</span></span></code></pre></td></tr></table></div></div></li><li><p>节点优雅下线</p></li></ol><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span>PUT</span> <span>/_cluster/settings</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;transient&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;cluster.routing.allocation.exclude._ip&#34;</span>: <span style=color:#b44>&#34;122.5.3.55&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><ol start=11><li><p>索引数据强制刷新</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span>POST</span> <span>/_flush</span>
</span></span><span style=display:flex><span><span>POST</span> <span>/_flush/synced</span> <span>#</span> <span>将废弃</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p>更新集群设置</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span>PUT</span> <span>/_cluster/settings</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;transient&#34;</span>: {
</span></span><span style=display:flex><span>    <span>#</span> <span>更改并发分片数量以平衡集群</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;cluster.routing.allocation.cluster_concurrent_rebalance&#34;</span>: <span style=color:#666>2</span>,
</span></span><span style=display:flex><span>    <span>#</span> <span>更改每个节点同时恢复的分片数量</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;cluster.routing.allocation.node_concurrent_recoveries&#34;</span>: <span style=color:#666>6</span>,
</span></span><span style=display:flex><span>    <span>#</span> <span>调整恢复速度</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;indices.recovery.max_bytes_per_sec&#34;</span>: <span style=color:#b44>&#34;80mb&#34;</span>, 
</span></span><span style=display:flex><span>    <span>#</span> <span>调整断路器</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;indices.breaker.total.limit&#34;</span>: <span style=color:#b44>&#34;40%&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div></li><li><p>清除节点缓存</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span>POST</span> <span>/_cache/clear</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p>索引数据迁移</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span>POST</span> <span>_reindex</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;source&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;index&#34;</span>: <span style=color:#b44>&#34;my-index-000001&#34;</span>
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;dest&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;index&#34;</span>: <span style=color:#b44>&#34;my-new-index-000001&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div></li><li><p>集群数据备份恢复</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span>#</span> <span>创建备份仓库</span>
</span></span><span style=display:flex><span><span>PUT</span> <span>/_snapshot/</span>{<span>backup_repo</span>}
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;type&#34;</span>: <span style=color:#b44>&#34;fs&#34;</span>, 
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;settings&#34;</span>: {
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&#34;location&#34;</span>: <span style=color:#b44>&#34;/path/to/repo&#34;</span>,  <span>#</span> <span>与path.repo相同</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&#34;max_snapshot_bytes_per_sec&#34;</span> : <span style=color:#b44>&#34;50mb&#34;</span>, <span>#</span> <span>数据从es到备份仓库的写入速度上限</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&#34;max_restore_bytes_per_sec&#34;</span> : <span style=color:#b44>&#34;50mb&#34;</span>   <span>#</span> <span>数据从备份仓库到es的写入速度上限</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span>#</span> <span>查看备份仓库</span>
</span></span><span style=display:flex><span><span>GET</span> <span>/_snapshot/</span>{<span>backup_repo</span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span>#</span> <span>备份所有打开的索引的数据到指定快照</span>
</span></span><span style=display:flex><span><span>PUT</span> <span>_snapshot/</span>{<span>backup_repo</span>}<span>/</span>{<span>snapshot_name</span>}<span>?wait_for_completion=</span><span style=color:#a2f;font-weight:700>true</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span>#</span> <span>备份指定数据到快照</span>
</span></span><span style=display:flex><span><span>PUT</span> <span>/_snapshot/</span>{<span>backup_repo</span>}<span>/</span>{<span>snapshot_name</span>}<span>?wait_for_completion=</span><span style=color:#a2f;font-weight:700>true</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;indices&#34;</span>: <span style=color:#b44>&#34;hamlet_*&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;ignore_unavailable&#34;</span>: <span style=color:#a2f;font-weight:700>true</span>,
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;include_global_state&#34;</span>: <span style=color:#a2f;font-weight:700>false</span>,
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;metadata&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;taken_by&#34;</span>: <span style=color:#b44>&#34;mingyi&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;taken_because&#34;</span>: <span style=color:#b44>&#34;backup before upgrading&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span>#</span> <span>列出快照信息(监控进度)</span>
</span></span><span style=display:flex><span><span>GET</span> <span>_snapshot/</span>{<span>backup_repo</span>}<span>/</span>{<span>snapshot_name</span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span>#</span> <span>监控快照进度</span>
</span></span><span style=display:flex><span><span>GET</span> <span>_snapshot/</span>{<span>backup_repo</span>}<span>/</span>{<span>snapshot_name</span>}<span>/_status</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span>#</span> <span>删除或取消快照</span>
</span></span><span style=display:flex><span><span>DELETE</span> <span>_snapshot/</span>{<span>backup_repo</span>}<span>/</span>{<span>snapshot_name</span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span>#</span> <span>从快照恢复(可选择只恢复指定索引)</span>
</span></span><span style=display:flex><span><span>POST</span> <span>/_snapshot/</span>{<span>backup_repo</span>}<span>/</span>{<span>snapshot_name</span>}<span>/_restore</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;indices&#34;</span>: <span style=color:#b44>&#34;index_1&#34;</span>, 
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;rename_pattern&#34;</span>: <span style=color:#b44>&#34;index_(.+)&#34;</span>, 
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;rename_replacement&#34;</span>: <span style=color:#b44>&#34;restored_index_$1&#34;</span> 
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span>#</span> <span>查看指定索引的恢复状态</span>
</span></span><span style=display:flex><span><span>GET</span> <span>/</span>{<span>index</span>}<span>/_recovery</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span>#</span> <span>取消恢复(删除正在恢复的索引)</span>
</span></span><span style=display:flex><span><span>DELETE</span> <span>/</span>{<span>index</span>}
</span></span></code></pre></td></tr></table></div></div></li><li><p>查看出现问题的索引或分片</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span>GET</span> <span>/_cluster/health?level=indices</span>
</span></span><span style=display:flex><span><span>GET</span> <span>/_cat/indices?v&amp;health=red</span>
</span></span><span style=display:flex><span><span>GET</span> <span>/_cluster/health?level=shards</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p>查看问题分析</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>GET /_cluster/allocation/explain
</span></span></code></pre></td></tr></table></div></div><blockquote><p>分片分配状态:</p><ul><li>INDEX_CREATED: Unassigned as a result of an API creation of an index</li><li>CLUSTER_RECOVERED: Unassigned as a result of a full cluster recovery</li><li>INDEX_REOPENED: Unassigned as a result of opening a closed index</li><li>DANGLING_INDEX_IMPORTED: Unassigned as a result of importing a dangling index</li><li>NEW_INDEX_RESTORED: Unassigned as a result of restoring into a new index</li><li>EXISTING_INDEX_RESTORED: Unassigned as a result of restoring into a closed index</li><li>REPLICA_ADDED: Unassigned as a result of explicit addition of a replica</li><li>ALLOCATION_FAILED: Unassigned as a result of a failed allocation of the shard</li><li>NODE_LEFT: Unassigned as a result of the node hosting it leaving the cluster</li><li>REROUTE_CANCELLED: Unassigned as a result of explicit cancel reroute command</li><li>REINITIALIZED: When a shard moves from started back to initializing, for example, with shadow replicas</li><li>REALLOCATED_REPLICA: A better replica location is identified and causes the existing replica allocation to be cancelled</li></ul></blockquote></li></ol><h4 id=相关工具-2>相关工具</h4><ul><li>集群管理 <a href=http://mobz.github.io/elasticsearch-head>http://mobz.github.io/elasticsearch-head</a></li><li>集群管理 <a href=https://www.elastic.co/products/kibana>https://www.elastic.co/products/kibana</a></li><li>集群管理 <a href=https://github.com/royrusso/elasticsearch-HQ>https://github.com/royrusso/elasticsearch-HQ</a></li><li>集群监控 <a href=https://github.com/lmenezes/cerebro>https://github.com/lmenezes/cerebro</a></li><li>集群安全 <a href=https://www.elastic.co/downloads/x-pack>https://www.elastic.co/downloads/x-pack</a></li><li>数据可视化 <a href=https://grafana.com/grafana>https://grafana.com/grafana</a></li><li>数据迁移 <a href=https://github.com/medcl/elasticsearch-migration>https://github.com/medcl/elasticsearch-migration</a></li><li>数据导出 <a href=https://github.com/mallocator/Elasticsearch-Exporter>https://github.com/mallocator/Elasticsearch-Exporter</a></li><li>数据备份 <a href=https://github.com/taskrabbit/elasticsearch-dump>https://github.com/taskrabbit/elasticsearch-dump</a></li><li>数据保存期限 <a href=https://pypi.python.org/pypi/elasticsearch-curator>https://pypi.python.org/pypi/elasticsearch-curator</a></li><li>类SQL查询 <a href=https://github.com/NLPchina/elasticsearch-sql>https://github.com/NLPchina/elasticsearch-sql</a></li><li>SQL转DSL <a href=https://github.com/360EntSecGroup-Skylar/ElasticHD>https://github.com/360EntSecGroup-Skylar/ElasticHD</a></li><li>监控告警 <a href=http://elastalert.readthedocs.org/>http://elastalert.readthedocs.org/</a></li></ul><h4 id=文章推荐-3>文章推荐</h4><ul><li><a href=https://www.elastic.co/guide/en/elasticsearch/reference/current/index.html>官方文档</a></li><li><a href=https://www.cnblogs.com/xiaobai1226/p/7652093.html>Lucene介绍与入门</a></li><li><a href=https://www.shenyanchao.cn/blog/2018/12/04/lucene-index-files/>Lucene索引过程&索引文件格式详解</a></li><li><a href=https://www.elastic.co/cn/blog/every-shard-deserves-a-home>Every shard deserves a home</a></li><li><a href=https://foreversunyao.github.io/2018/01/databaseelasticsearch>ElasticSearch简介</a></li><li><a href=https://segmentfault.com/a/1190000023187342>ElasticSearch分词与查询</a></li><li><a href=https://www.jianshu.com/p/5b88e95a9e80>ElasticSearch架构原理</a></li><li><a href=https://elasticsearch.cn/article/6178>ElasticSearch中数据是如何存储的</a></li><li><a href=https://www.elastic.co/cn/blog/configuring-ssl-tls-and-https-to-secure-elasticsearch-kibana-beats-and-logstash>ElasticSearch安全配置</a></li><li><a href=https://www.cnblogs.com/Don/p/11912872.html>ElasticSearch内存配置优化</a></li><li><a href=https://blog.csdn.net/rickyit/article/details/53895060>JVM调优总结</a></li><li><a href=https://www.cnblogs.com/kevingrace/p/10682264.html>ElasticSearch最佳运维总结</a></li><li><a href=https://github.com/dzharii/awesome-elasticsearch>Awesome ElasticSearch</a></li></ul><h4 id=排障经验-2>排障经验</h4><h3 id=prometheus>Prometheus</h3><h3 id=grafana>Grafana</h3><h3 id=loki>Loki</h3><h3 id=redis>Redis</h3><p><strong>基于内存的KV数据库</strong></p><h4 id=基本概念-3>基本概念</h4><ul><li><strong>KV数据库</strong>: KV数据库即Key-Value数据库(键值数据库)，与关系数据库不同，它使用简单的键值方法来存储数据。键值数据库将数据存储为键值对集合，其中键作为唯一标识符。键和值都可以是从简单对象到复杂复合对象的任何内容。键值数据库是高度可分区的，并且允许以其他类型的数据库无法实现的规模进行水平扩展。</li><li><strong>数据库</strong>: Redis是一个Key-Value存储系统，其数据库的概念与MySQL等数据库不大一样，Redis中的数据库更像是一个命名空间，Redis默认支持16个数据库(可修改），库名以db0，db1，&mldr;，db15命名且不可修改，如不指定则默认使用db0数据库。不同的库中的数据是相互独立的，但所有库都共用一套访问密码。Redis集群模式仅支持db0数据库。</li><li><strong>实例</strong>: Redis分为服务端redis-server和客户端redis-cli，其中客户端为命令行工具，用于连接服务端，服务端则是Redis的核心。一个运行的Redis服务端进程就是一个实例(或称为一个节点)，每个实例支持多个数据库。</li><li><strong>集群</strong>: Redis支持多种集群方式，多个Redis实例可以组成集群，集群是为了解决Redis的高可用、故障转移和高性能等需求的。集群方式不同则Redis实例的角色也不一样，实例可能作为另一个实例的副本，也可能作为其他实例的一个分片。</li><li><strong>副本</strong>: Redis通过副本机制实现高可用，多个Redis实例之间形成主从关系，由master实例向slave实例同步数据实现数据的多副本和一致性</li><li><strong>分区/分片</strong>: 分区即是分片，Redis通过分区/分片（partiton/shard）机制实现扩展能力和性能的提升，每一个Redis分片就是一个Redis实例，Redis分片就是把数据分割到多个 Redis 实例的处理过程，因此每个 Redis 实例只保存 key 的一个子集，Redis支持范围法分片和哈希法分片。</li><li><strong>哨兵</strong>: Redis实例可以以哨兵(Sentinel)模式运行，哨兵实例不存储数据，而是监控主从实例是否正常运行，并自主实例出现故障时自动将从实例切换为主实例，保证集群的可用性。哨兵机制实现了Redis集群的自动故障转移。</li><li><strong>Cluster</strong>: Redis支持3种集群方式，其中主从同步集群实现多副本高可用，哨兵模式支持自动故障转移，但对于海量数据和高性能的场景，则需要利用分片技术，而Redis Cluster则是基于分片技术的集群模式。</li><li><strong>gossip</strong>: gossip又称流言协议，是一种实现分布式系统内消息扩散的通信协议，分布式系统中的各节点以广播的方式将消息扩散到其他节点，实现系统中各节点数据的最终一致性。Redis Cluster集群中使用此协议实现各分片的数据交换和消息通信。</li><li><strong>一致性哈希</strong>: 实现分片时，一般通过哈希法将key哈希后对分片数量取模从而决定该key的数据映射到哪个实例上，但直接进行哈希映射会出现一旦分片发生增减时，分片数量发生变化，所有的映射都将失效。而一致性哈希算法则对2^32取模，值范围被抽象为圆环，并将所有分片映射到圆环上特定的点上，一旦key被映射到某个点，则顺时针寻找其后的第一个分片，从而完成到分片的映射且当ff怕数量变化时也不会影响其他分片上key的映射，此外为了保证key的均匀分布，一般还会引入虚拟节点机制。</li><li><strong>哈希槽</strong>: Redis的Cluster进行哈希映射时，选择了类似一致性哈希的哈希槽算法，该算法对2^14取模，形成16384个哈希槽，这些槽分配到不同的分片上，每个分片上都维护完整的哈希槽映射信息，当出现分片增减时，哈希槽位将进行重新分片(reshard)，将槽位和对应的数据转移到其他分片上。哈希槽相比一致性哈希，算法更加简单，维护更加灵活。</li><li><strong>主观下线/客观下线</strong>: Redis Sentinel集群的Sentinel节点之间或Sentinel节点到主从节点之间会发送心跳消息以确认节点是否存活，Cluster集群主分片节点间同样会发送心跳消息(PING -> PONG)，如果某个节点在规定的时间内未收到某个节点返回的心跳消息，则会认为该节点主观下线。如果quorum个哨兵或主分片节点(半数+1)均将某个节点标记为主观下线，则该节点被判定为客观下线。主观下线适用于主从节点，但客观下线仅适用于主节点，因为从节点下线不对集群本身状态产生影响，但主节点的下线将导致主节点的重新选举。</li><li><strong>持久化</strong>:Redis是基于内存的数据库，所有的数据均存在于内存中，但由于内存具有易失性，因此Redis提供了RDB和AOF两种持久化机制将内存数据持久化到磁盘中。</li><li><strong>RDB</strong>: RDB是一种Redis持久化机制，可理解为某个时刻的Redis内存中的数据快照，通过加载RDB文件中的内容实现内存数据的恢复。</li><li><strong>AOF</strong>: AOF是一种Redis持久化机制，AOF文件中保存的是所有记录了所有修改内存数据的指令的集合，通过回放AOF文件中的指令实现内存数据的恢复。</li><li><strong>数据类型</strong>: Redis作为Key-Value数据库，其Key仅支持字符串一种类型，但Value支持多种类型，基础的Value类型有String、List、Hash、Set和ZSet，此外还有一些不常用的Bitmap、HyperLogLog、GEO、Stream的数据类型。各种数据类型均有其合适的应用场景。Redis中String类型的概念包括integer、float和string。</li></ul><h4 id=架构特性-3>架构特性</h4><ol><li><p>集群架构</p><ul><li><p>主从同步</p><p>Redis主从同步集群中将Redis节点划分为master和slave节点，形成一主多从，slave对外提供读操作，而master负责写操作，形成一个读写分离的架构。master节点会主动向slave节点同步数据，同步过程分为同步和命令传播两个步骤：</p><ol><li>slave节点向master节点发送sync命令</li><li>master收到sync命令之后会执行bgsave命令，Redis会fork出一个子进程在后台生成RDB文件，同时将同步过程中的写命令记录到缓冲区中</li><li>文件生成后，master会把RDB文件发送给slave，从服务器接收到RDB文件会将其载入内存</li><li>然后master将记录在缓冲区的所有写命令发送给slave，slave对这些命令进行重放，将其数据库的状态更新至和master一致</li></ol><p>Redis2.8版本之后，使用psync命令代替了sync命令，实现通过主从双方共同维护的offset完成主从之间数据的增量同步。</p><p>主从同步模式实现了高可用和读写分离，但当主节点故障后，无法自动产生新的主节点，集群需要人工干预才能重新提供服务。</p><p><img src=redis-replica.jpg alt=redis-replica></p></li><li><p>Sentinel</p><p>Redis哨兵集群是在主从同步集群的基础上，额外分配哨兵节点，由哨兵节点监控主从集群中各节点的状态，并在主节点故障后自动从从节点中选举新的主节点，此外，哨兵节点还负责向管理员或其他应用报告集群状态，以及给客户端提供最新的master地址。</p><p>哨兵节点之间本身也组成一个分布式集群，用于进行集群决策，如决定新的主节点等，哨兵执行故障转移需要大部分哨兵节点同意才行，哨兵节点会利用Redis的发布订阅机制自动发现主从集群中的其他节点和其他哨兵节点。哨兵节点发现主从同步集群的主节点下线后，会询问其他哨兵节点，当大部分哨兵节点都将主节点标记为下线后，主节点客观下线，哨兵节点之间通过选举算法选出leader哨兵，执行故障转移操作，产生新的主节点。</p><ol><li>启动并初始化Sentinel节点，并获取主从节点信息</li><li>Sentinel节点向主从节点发送消息并接收来自主从节点的频道信息</li><li>Sentinel节点检测主观下线和客观下线状态</li><li>选举Leader Sentinel节点执行故障转移</li><li>执行故障转移，在已下线的主节点的下属从节点中选举一个作为新的主节点，将所有从节点改为复制新主节点，将已下线主节点设置为新主节点的从节点</li></ol><p>哨兵模式在主从同步的基础上，解决了自动故障转移的问题，但哨兵节点本身不能保存数据，且存在主节点单点写入和节点扩容困难的问题，难以应对海量数据Redis集群的需求。</p><p><img src=redis-sentinel.jpg alt=redis-sentinel></p></li><li><p>Cluster</p><p>Cluster集群模式是一个多主集群，多个主节点维护不同分片的数据，构成一个分布式集群，由于每个主节点都只维护集群中的部分数据，因此为了应对主节点故障，每个主节点都至少需要挂载一个从节点，作为主节点的数据备份，主节点故障时会被提升为新的主节点。但集群中的读写操作均在主节点上完成。</p><p>Cluster集群中主节点之间通过gossip协议实现消息通信和数据交换，采用类似与哨兵模式的方式实现自动故障转移，客户端连接集群中任意主节点即可，无需中间代理层。</p><p>Cluster集群采用哈希槽算法进行数据分片，增减节点需要对哈希槽进行重分配。</p><p>Cluster集群模式同时满足高可用，读写分离，故障转移和横向扩展等需求，是比较理想的集群模式，但不支持多数据库。</p><p><img src=redis-cluster.png alt=redis-cluster></p></li></ul></li><li><p>数据类型</p><p>Redis为C语言开发，针对其支持的几种类型作了底层数据结构的优化，以保证对各数据类型操作的搞性能。几种基础数据类型的底层数据结构对应关系如下：</p><ul><li><p>String：String类型的内部编码有3种：int、raw和embstr，其中int用于保存整型int和长整型long，后两者为redis定义的简单动态字符串结构（SDS），用于保存字符串类型，浮点数在底层被转换为字符串值，然后再对应到这3种编码规则。</p><p><img src=./redis-string.webp alt=redis-string></p><p><img src=./redis-string-int.webp alt=redis-string-int></p><p><img src=./redis-string-embstr.webp alt=redis-string-embstr></p><p><img src=./redis-string-raw.webp alt=redis-string-raw></p></li><li><p>List：List类型保存数组，可实现简单的消息队列。List类型底层数据结构在3.2版本之前由双向链表或压缩链表实现。之后则统一由quicklist实现。</p><p><img src=./redis-list.webp alt=redis-string></p><p><img src=./redis-list-linklist.png alt=redis-list-linklist></p><p><img src=./redis-list-quicklist.png alt=redis-list-quicklist></p></li><li><p>Hash：Hash类型是一个键值对集合，其底层数据结构是由压缩列表或哈希表(字典)实现的。在7.0版本之后压缩列表已经废弃，交由listpack数据结构实现。</p><p><img src=redis-hash.webp alt=redis-hash></p><p><img src=redis-hash-ziplist.png alt=redis-hash-ziplist></p><p><img src=redis-hash-dict.jpg alt=redis-hash-dict></p></li><li><p>Set：Set类型是一个无序并唯一的键值集合，它的存储顺序不会按照插入的先后顺序进行存储，其底层数据结构是由哈希表或整数集合实现的。</p><p><img src=redis-set.webp alt=redis-set></p><p>![redis-set-intset ](redis-set-intset .png)</p></li><li><p>ZSet： ZSet类型相比于Set类型多了一个排序属性score(分值)，对于有序集合 ZSet 来说，每个存储元素相当于有两个值组成的，一个是有序结合的元素值，一个是排序值。其底层数据结构是由压缩列表或跳表实现的。在7.0版本之后压缩列表已经废弃，交由listpack数据结构实现。</p><p><img src=redis-zset.webp alt=redis-zset></p><p><img src=redis-zset-skiplist.png alt=redis-zset-skiplist></p><p><img src=redis-zset-listpack.png alt=redis-zset-listpack></p></li><li><p>Bitmap：Bitmap类型即位图类型，是一串连续的二进制数组（0和1），可以通过偏移量（offset）定位元素。Bitmap通过最小的单位bit来进行0|1的设置，表示某个元素的值或者状态，时间复杂度为O(1)。Bitmap本身是用String类型作为底层数据结构实现的一种统计二值状态的数据类型。</p><p><img src=redis-bitmap.png alt=redis-bitmap></p></li><li><p>HyperLogLog：HyperLogLog类型是Redis2.8.9 版本新增的数据类型，是一种用于统计基数的数据集合类型，基数统计就是指统计一个集合中不重复的元素个数。HyperLogLog提供低内存消耗下不精确的去重计数，其统计规则是基于概率完成的，不是非常准确，标准误算率是 0.81%。</p><p><img src=redis-hyperloglog.jpg alt=redis-hyperloglog></p></li><li><p>GEO：GEO类型是Redis 3.2版本新增的数据类型，主要用于存储地理位置信息，并对存储的信息进行操作。其本身并没有设计新的底层数据结构，而是直接使用了 Sorted Set 集合类型。</p></li><li><p>Stream：Stream类型是Redis 5.0版本新增加的数据类型，是专门为消息队列设计的数据类型。其底层数据结构为RaxTree。Stream 保存的消息数据，按照 key-value 形式来看的话，消息 ID 就相当于 key，而消息内容相当于是 value。也就是说，Stream 会使用 Radix Tree 来保存消息 ID，然后将消息内容保存在 listpack 中，并作为消息 ID 的 value，用 raxNode 的 value 指针指向对应的 listpack。</p><p><img src=redis-stream.jpg alt=redis-stream></p></li></ul><p>整体的数据类型与数据结构对应关系如下：</p><p><img src=./redis-datastruct.png alt=redis-datastruct></p><p>Redis 五种数据类型的应用场景：</p><ul><li>String：缓存对象、常规计数、分布式锁、共享session信息等</li><li>List：消息队列（有两个问题：1. 生产者需要自行实现全局唯一 ID；2. 不能以消费组形式消费数据）等</li><li>Hash：缓存对象、购物车等</li><li>Set：聚合计算（并集、交集、差集）场景，比如点赞、共同关注、抽奖活动等</li><li>Zset：排序场景，比如排行榜、电话和姓名排序等</li></ul><p>Redis 后续版本又支持四种数据类型，它们的应用场景如下：</p><ul><li>BitMap（2.2 版新增）：二值状态统计的场景，比如签到、判断用户登陆状态、连续签到用户总数等</li><li>HyperLogLog（2.8 版新增）：海量数据基数统计的场景，比如百万级网页 UV 计数等</li><li>GEO（3.2 版新增）：存储地理位置信息的场景，比如滴滴叫车</li><li>Stream（5.0 版新增）：消息队列，相比于基于 List 类型实现的消息队列，有这两个特有的特性：自动生成全局唯一消息ID，支持以消费组形式消费数据</li></ul><p>针对 Redis 是否适合做消息队列，关键看你的业务场景：</p><ul><li>如果你的业务场景足够简单，对于数据丢失不敏感，而且消息积压概率比较小的情况下，把 Redis 当作队列是完全可以的</li><li>如果你的业务有海量消息，消息积压的概率比较大，并且不能接受数据丢失，那么还是用专业的消息队列中间件吧</li></ul></li><li><p>持久化</p><ul><li><p>RDB</p><p>在Redis中生成RDB快照的方式有两种，一种是使用save指令，另一种是bgsave指令，但是底层实现上，其调用的是同一个函数，叫rdbsave，只是其调用的方式不同而已。save指令生成RDB快照过程中会阻塞Redis主进程，直至快照文件生成，而bgsave指令会fork出一个子进程，由fork出来的子进程调用rdbsave，父进程会继续响应来自客户端的读写请求，子进程完成RDB文件生成之后会给父进程发送信号，通知父进程保存完成。</p><p>RDB支持灵活的备份配置策略，非常适合作冷备份，且数据恢复速度快。但如果内存数据量太大，使用RDB进行备份可能会占用大量服务器资源，也可能会发生很多的也异常中断，造成整个Redis停止响应几百毫秒，此外其备份时间长，存在备份过程中断电而备份失败的风险，也无法对备份过程中新增的数据进行备份。</p><p><img src=redis-rdb.jpg alt=redis-rdb></p></li><li><p>AOF</p><p>AOF备份的是Redis指令(也称为AOF日志)，Redis不断将写指令以特定的协议格式记录到AOF文件在内存的写缓冲区aof_buf中，Redis进程中的ServerCron函数会定期调用flushAppendOnlyFile函数，该函数会调用write函数将aof_buf中的数据写入os cache中，而操作系统会根据自身策略，调用fsync或sdatasync将os cache中的数据写入磁盘。</p><p>AOF支持always、everysec和no三种落盘策略，always策略下每个命令都会写入aof_buff并同步到磁盘，everysec策略下每秒钟回同步一次数据到磁盘，no策略下则不关心落盘事件，而是完全交由操作系统决定。</p><p>AOF由于记录的是每个写操作的指令，因此文件会较大，且越来越大，为应对此问题，Redis新增了重写机制，当AOF文件的大小超过所设定的阈值时，Redis就会启动AOF文件的内容压缩，只保留可以恢复数据的最小指令集。可以使用命令 bgrewriteaof 来重写。AOF 文件重写并不是对原文件进行重新整理，而是直接读取服务器现有的键值对，然后用一条命令去代替之前记录这个键值对的多条命令，生成一个新的文件后去替换原来的 AOF 文件，重写操作也是fork子进程异步执行的。</p><p><img src=redis-aof-rewrite.png alt=redis-aof-rewrite></p><p>AOF能够频繁地进行数据备份，最大限度避免数据丢失，且可灵活调整备份频率，对Redis性能影响小，但此方式备份文件较大，且恢复过程较RDB慢不少。</p><p><img src=redis-aof.png alt=redis-aof></p></li><li><p>RDB+AOF</p><p>在Redis4.0之后，Redis新增了RDB-AOF混合持久化方式，这种方式结合了RDB和AOF的优点，既能快速加载又能避免丢失过多的数据，通过设置aof-use-rdb-preamble为yes后即可开启，当开启混合持久化时，主进程先fork出子进程将现有内存副本全量以RDB方式写入AOF文件中，然后将缓冲区中的增量命令以AOF方式写入AOF文件中，写入完成后通知主进程更新相关信息，并将新的含有 RDB和AOF两种格式的AOF文件替换旧的AOF文件。简单来说：混合持久化方式产生的文件一部分是RDB格式，一部分是AOF格式，这种方式无法兼容Redis4.0之前版本的备份文件。</p></li><li><p>持久化总结</p><p>redis提供几种持久化机制：</p><p>a). RDB持久化</p><p>工作方式 ：根据时间的间隔将redis中数据快照（dump）到dump.rdb文件</p><p>优势 ：备份恢复简单。RDB通过子进程完成持久化工作，相对比AOF启动效率高</p><p>劣势 ：服务器故障会丢失几分钟内的数据</p><p>b). AOF持久化</p><p>工作方式 ：以日志的形式记录所有更新操作到AOF日志文件，在redis服务重新启动时会读取该日志文 件来重新构建数据库，以保证启动后数据完整性。</p><p>优势 ：AOF提供两种同步机制，一个是fsync always每次有数据变化就同步到日志文件和fsync everysec每秒同步一次到日志文件，最大限度保证数据完整性。</p><p>劣势：日志文件相对RDB快照文件要大的多</p><p>AOF日志重写功能 ：AOF日志文件过大，redis会自动重写AOF日志，append模式不断的将更新记录写入到老日志文件中，同时redis还会创建一个新的日志文件用于追加后续的记录。</p><p>c). 同时应用AOF和RDB</p><p>对于数据安全性高的场景，可同时使用AOF和RDB，这样会降低性能。</p><p>d). 无持久化</p><p>禁用redis服务持久化功能。</p></li></ul></li><li><p>发布订阅与stream</p><p><strong>发布订阅</strong></p><p>Redis能够通过List列表数据类型配合lpush和rpop操作实现消息队列，但是却很难执行消息多播功能，为此Redis单独添加了发布订阅模块实现消息队列的多播。</p><p>在发布订阅模式中，Redis引入频道channel的概念关联生产者和消费者，消费者除了可以订阅频道channel外，还可以通过模式匹配pattern一次性订阅多个频道，这两种订阅方式分别称为频道订阅和模式订阅。生产者向频道发送的消息同时也会被发送到该频道匹配的模式中。</p><p><img src=redis-pubsub-channel.png alt=redis-pubsub-channel></p><p><img src=redis-pubsub-pattern.png alt=redis-pubsub-pattern></p><p>订阅频道的原理是Redis服务端在内存中维护着一个<strong>pubsub_channels</strong>频道的字典，字典中key为频道的名称，耳每个value都是一个包含订阅了该频道的消费者的链表。</p><p><img src=redis-pubsub-channel-struct.png alt=redis-pubsub-channel-struct></p><p>订阅模式的原理是Redis服务端同时在内存中维护一个<strong>pubsub_patterns</strong>模式的链表，链表中每一项都是一个客户端和模式的组合。</p><p><img src=redis-pubsub-pattern-struct.png alt=redis-pubsub-pattern-struct></p><p>Redis的发布订阅机制虽然满足多播消息队列的需求，但其缺点也很明显，它没有ack机制，无法确保消息的正确发送和接收，且消息一旦消费失败就不能再次被消费，不能保证数据连续性，此外，发布订阅机制中的消息队列不会持久化到磁盘，一旦Redis故障消息都将丢失。</p><p><strong>Stream</strong></p><p>为了解决发布订阅机制存在的问题，Redis推出了更为强大的Stream数据类型。Redis Stream从概念上来说，就像是一个 仅追加内容的 消息链表，把所有加入的消息都一个一个串起来，每个消息都有一个唯一的 ID 和内容，这很简单，让它复杂的是从 Kafka 借鉴的另一种概念：消费者组(Consumer Group)(思路一致，实现不同)：</p><p><a href=https://upload-images.jianshu.io/upload_images/7896890-b9d8afde068a165f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240><img src=https://upload-images.jianshu.io/upload_images/7896890-b9d8afde068a165f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240 alt=img></a></p><p>这是一个典型的 Stream结构。每个 Stream 都有唯一的名称，它就是 Redis 的<code>key</code>，在我们首次使用<code>xadd</code>指令追加消息时自动创建。Stream相关概念解释如下：</p><ul><li>Consumer Group：消费者组，可以简单看成记录流状态的一种数据结构。消费者既可以选择使用<code>XREAD</code>命令进行 独立消费，也可以多个消费者同时加入一个消费者组进行组内消费。同一个消费者组内的消费者共享所有的Stream信息，同一条消息只会有一个消费者消费到，这样就可以应用在分布式的应用场景中来保证消息的唯一性。</li><li>last_delivered_id：用来表示消费者组消费在Stream 消费位置的游标信息。每个消费者组都有一个Stream内唯一的名称，消费者组不会自动创建，需要使用<code>XGROUP CREATE</code>指令来显式创建，并且需要指定从哪一个消息 ID 开始消费，用来初始化<code>last_delivered_id</code>这个变量。</li><li>pending_ids：每个消费者内部都有的一个状态变量，用来表示已经被客户端获取，但是还没有 ack的消息。记录的目的是为了保证客户端至少消费了消息一次，而不会在网络传输的中途丢失而没有对消息进行处理。如果客户端没有 ack，那么这个变量里面的消息 ID 就会越来越多，一旦某个消息被 ack，它就会对应开始减少。这个变量也被 Redis 官方称为PEL(Pending Entries List)。</li></ul></li></ol><h4 id=配置文件-4>配置文件</h4><ul><li><p><strong>/etc/redis.conf</strong>: Redis主配置文件</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 37
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 38
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 39
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 40
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 41
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 42
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 43
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 44
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 45
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 46
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 47
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 48
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 49
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 50
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 51
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 52
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 53
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 54
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 55
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 56
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 57
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 58
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 59
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 60
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 61
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 62
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 63
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 64
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 65
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 66
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 67
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 68
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 69
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 70
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 71
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 72
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 73
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 74
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 75
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 76
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 77
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 78
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 79
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 80
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 81
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 82
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 83
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 84
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 85
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 86
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 87
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 88
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 89
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 90
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 91
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 92
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 93
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 94
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 95
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 96
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 97
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 98
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 99
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">100
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">101
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">102
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">103
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">104
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">105
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">106
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">107
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">108
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">109
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">110
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">111
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">112
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">113
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">114
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">115
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">116
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">117
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">118
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">119
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">120
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">121
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">122
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">123
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">124
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">125
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">126
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">127
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">128
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">129
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">130
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">131
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">132
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">133
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">134
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">135
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">136
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">137
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">138
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">139
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">140
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">141
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">142
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">143
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">144
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">145
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">146
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">147
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">148
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">149
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">150
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">151
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">152
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">153
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">154
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">155
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">156
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">157
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">158
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">159
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">160
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">161
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">162
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">163
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">164
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">165
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">166
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">167
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">168
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">169
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">170
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">171
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">172
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">173
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">174
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">175
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">176
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">177
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">178
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">179
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">180
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">181
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">182
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">183
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">184
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">185
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">186
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">187
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">188
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">189
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">190
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">191
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">192
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">193
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">194
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">195
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">196
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">197
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">198
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">199
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">200
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">201
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">202
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">203
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">204
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">205
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">206
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">207
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">208
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">209
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">210
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">211
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">212
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">213
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">214
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">215
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">216
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">217
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">218
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">219
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">220
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">221
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">222
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">223
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">224
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">225
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">226
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">227
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">228
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">229
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">230
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">231
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">232
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">233
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">234
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">235
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">236
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">237
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">238
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">239
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">240
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">241
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">242
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">243
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">244
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">245
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">246
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">247
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">248
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">249
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">250
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">251
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">252
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">253
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">254
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">255
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">256
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">257
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">258
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">259
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">260
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">261
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">262
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">263
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">264
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">265
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">266
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">267
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">268
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">269
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">270
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">271
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">272
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">273
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">274
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">275
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-properties data-lang=properties><span style=display:flex><span><span style=color:#080;font-style:italic># 是否以后台进程运行</span>
</span></span><span style=display:flex><span><span style=color:#b44>daemonize</span> <span style=color:#b44>yes </span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># pid文件位置</span>
</span></span><span style=display:flex><span><span style=color:#b44>pidfile</span> <span style=color:#b44>/var/run/redis/redis-server.pid    </span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 监听端口</span>
</span></span><span style=display:flex><span><span style=color:#b44>port</span> <span style=color:#b44>6379</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 绑定地址，如需远程连接，设置0.0.0.0</span>
</span></span><span style=display:flex><span><span style=color:#b44>bind</span> <span style=color:#b44>127.0.0.1   </span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 连接超时时间，单位秒</span>
</span></span><span style=display:flex><span><span style=color:#b44>timeout</span> <span style=color:#b44>300 </span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 设置redis公开哪个IP给访问者(在nat网络环境下使用)</span>
</span></span><span style=display:flex><span><span style=color:#b44>cluster-announce-ip</span> <span style=color:#b44>&#34;192.168.0.8&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 日志级别，分别有：</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># debug ：适用于开发和测试</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># verbose ：更详细信息</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># notice ：适用于生产环境</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># warning ：只记录警告或错误信息</span>
</span></span><span style=display:flex><span><span style=color:#b44>loglevel</span> <span style=color:#b44>notice  </span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 日志文件位置</span>
</span></span><span style=display:flex><span><span style=color:#b44>logfile</span> <span style=color:#b44>/var/log/redis/redis-server.log   </span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 是否将日志输出到系统日志</span>
</span></span><span style=display:flex><span><span style=color:#b44>syslog-enabled</span> <span style=color:#b44>no    </span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic>#设置数据库数量，默认数据库为0</span>
</span></span><span style=display:flex><span><span style=color:#b44>databases</span> <span style=color:#b44>16</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic>############### RDB持久化 ###############</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 在900s（15m）之后，至少有1个key发生变化，则快照</span>
</span></span><span style=display:flex><span><span style=color:#b44>save</span> <span style=color:#b44>900 1    </span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 在300s（5m）之后，至少有10个key发生变化，则快照</span>
</span></span><span style=display:flex><span><span style=color:#b44>save</span> <span style=color:#b44>300 10   </span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 在60s（1m）之后，至少有1000个key发生变化，则快照</span>
</span></span><span style=display:flex><span><span style=color:#b44>save</span> <span style=color:#b44>60 10000  </span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># dump时是否压缩数据</span>
</span></span><span style=display:flex><span><span style=color:#b44>rdbcompression</span> <span style=color:#b44>yes   </span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 本地数据库的磁盘中的文件名</span>
</span></span><span style=display:flex><span><span style=color:#b44>dbfilename</span> <span style=color:#b44>dump.rdb</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 数据库(dump.rdb)文件存放目录</span>
</span></span><span style=display:flex><span><span style=color:#b44>dir</span> <span style=color:#b44>/var/lib/redis  </span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 从版本RDB版本5开始，一个CRC64的校验就被放在了文件末尾。</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 这会让格式更加耐攻击，但是当存储或者加载rbd文件的时候会有一个10%左右的性能下降，  </span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 所以，为了达到性能的最大化，你可以关掉这个配置项。  </span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 没有校验的RDB文件会有一个0校验位，来告诉加载代码跳过校验检查。  </span>
</span></span><span style=display:flex><span><span style=color:#b44>rdbchecksum</span> <span style=color:#b44>yes</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 如果配置 yes 当后台持久化失败，Redis会停止接受更新操作。如果持久化进程再次工作则会恢复允许更新操作</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 如果配置 no 当后台持久化失败，Redis更新操作仍然继续处理</span>
</span></span><span style=display:flex><span><span style=color:#b44>stop-writes-on-bgsave-error</span> <span style=color:#b44>yes</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic>############### AOF持久化 ###############</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># AOF持久化，是否记录更新操作日志，默认redis是异步(快照)把数据写入本地磁盘</span>
</span></span><span style=display:flex><span><span style=color:#b44>appendonly</span> <span style=color:#b44>yes   </span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 指定AOF日志文件名</span>
</span></span><span style=display:flex><span><span style=color:#b44>appendfilename</span> <span style=color:#b44>appendonly.aof  </span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># AOF持久化三种同步策略：</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># appendfsync always    #每次有数据发生变化时都会写入appendonly.aof</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># appendfsync everysec  #默认方式，每秒同步一次到appendonly.aof</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># appendfsync no        #不同步，数据不会持久化</span>
</span></span><span style=display:flex><span><span style=color:#b44>appendfsync</span> <span style=color:#b44>everysec</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 当AOF日志文件即将增长到指定百分比时，redis通过调用BGREWRITEAOF是否自动重写AOF日志文件</span>
</span></span><span style=display:flex><span><span style=color:#b44>no-appendfsync-on-rewrite</span> <span style=color:#b44>no</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 当AOF文件大小超过上次rewrite后的100%(一倍)并且文件大于64M时触发rewrite</span>
</span></span><span style=display:flex><span><span style=color:#b44>auto-aof-rewrite-percentage</span> <span style=color:#b44>100</span>
</span></span><span style=display:flex><span><span style=color:#b44>auto-aof-rewrite-min-size</span> <span style=color:#b44>64mb</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># redis在恢复时忽略最后一条可能存在问题的指令，默认值yes。在aof写入时突然断电可能会出现指令写错(写了一半)，这种情况下yes会log并继续，而no会直接恢复失败</span>
</span></span><span style=display:flex><span><span style=color:#b44>aof-load-truncated</span> <span style=color:#b44>yes</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 是否启用rdb+aof混合持久化</span>
</span></span><span style=display:flex><span><span style=color:#b44>aof-use-rdb-preamble</span> <span style=color:#b44>no</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic>############### 安全 ###############</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 配置redis连接认证密码</span>
</span></span><span style=display:flex><span><span style=color:#b44>requirepass</span> <span style=color:#b44>foobared</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 保护模式是一个避免你在互联网(外网)访问redis的机制，默认开启</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 当启用保护模式，而且没有密码时，服务器只接受来自IPv4地址(127.0.0.1)、IPv6地址(::1)或Unix套接字本地连接(没密码+保护模式启动=本地访问)</span>
</span></span><span style=display:flex><span><span style=color:#b44>protected-mode</span> <span style=color:#b44>yes</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic>#将危险的命令重命名或者禁用</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic>#例如禁用FLUSHALL</span>
</span></span><span style=display:flex><span><span style=color:#b44>rename-command</span> <span style=color:#b44>FLUSHALL &#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic>#重命名FLUSHDB，重命名后必须用新命令来操作，否则服务器会报错 unknown command</span>
</span></span><span style=display:flex><span><span style=color:#b44>rename-command</span> <span style=color:#b44>FLUSHDB  qf69aZbLAX3cf3ednHM3SOlbpH71yEXLAX3cf3e</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic>############### 限制 ###############</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 为了防止某个脚本执行时间过长导致Redis无法提供服务(比如陷入死循环),Redis提供了lua-time-limit参数限制脚本的最长运行时间，默认为5秒钟。当脚本运行时间超过这一限制后，Redis将开始接受其他命令但不会执行(以确保脚本的原子性，因为此时脚本并没有被终止),而是会返回&#34;BUSY&#34;错误</span>
</span></span><span style=display:flex><span><span style=color:#b44>lua-time-limit</span> <span style=color:#b44>5000</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 设置最大连接数，0为不限制</span>
</span></span><span style=display:flex><span><span style=color:#b44>maxclients</span> <span style=color:#b44>128</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 内存清理策略，如果达到此值，将采取以下动作：</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># volatile-lru     #默认策略，只对设置过期时间的key进行LRU算法删除</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># allkeys-lru      #删除不经常使用的key</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># volatile-random  #随机删除即将过期的key</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># allkeys-random   #随机删除一个key</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># volatile-ttl     #删除即将过期的key</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># noeviction       #不过期，写操作返回报错</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 允许使用的最大内存(需要配合maxmemory-policy使用),设置为0表示不限制</span>
</span></span><span style=display:flex><span><span style=color:#b44>maxmemory</span> <span style=color:#b44>&lt;bytes&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 如果达到maxmemory值，采用此策略</span>
</span></span><span style=display:flex><span><span style=color:#b44>maxmemory-policy</span> <span style=color:#b44>volatile-lru</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 默认随机选择3个key，从中淘汰最不经常用的</span>
</span></span><span style=display:flex><span><span style=color:#b44>maxmemory-samples</span> <span style=color:#b44>3   </span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic>################ 慢查询 ################</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 单位为微秒，当命令执行时间超过该值则会被redis记录为慢查询</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 配置为负数则禁用慢查询日志</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 配置为0则记录所有命令</span>
</span></span><span style=display:flex><span><span style=color:#b44>slowlog-log-slower-than</span> <span style=color:#b44>10000</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 设置慢查询日志的长度，如果已满则会删掉最旧的保留最新的</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 可以用命令 SLOWLOG RESET 来释放内存</span>
</span></span><span style=display:flex><span><span style=color:#b44>slowlog-max-len</span> <span style=color:#b44>128</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic>############### 主从复制 ###############</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 主从复制使用，用于本机redis作为slave去连接主redis</span>
</span></span><span style=display:flex><span><span style=color:#b44>slaveof</span> <span style=color:#b44>&lt;masterip&gt; &lt;masterport&gt;  </span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 当master设置密码认证，slave用此选项指定master认证密码</span>
</span></span><span style=display:flex><span><span style=color:#b44>masterauth</span> <span style=color:#b44>&lt;master-password&gt;  </span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 作为从服务器，默认情况下是只读的(yes),可以修改成no用于写(不建议)</span>
</span></span><span style=display:flex><span><span style=color:#b44>slave-read-only</span> <span style=color:#b44>yes</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 当slave与master之间的连接断开或slave正在与master进行数据同步时，如果有slave请求，当设置为yes时，slave仍然响应请求，此时可能有问题，如果设置no时，slave会返回&#34;SYNC with master in progress&#34;错误信息。但INFO和SLAVEOF命令除外。</span>
</span></span><span style=display:flex><span><span style=color:#b44>slave-serve-stale-data</span> <span style=color:#b44>yes   </span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># Redis部署为Replication模式后，slave会以预定周期（默认10s）发PING包给master，该配置可以更改这个默认周期</span>
</span></span><span style=display:flex><span><span style=color:#b44>repl-ping-slave-period</span> <span style=color:#b44>10</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 有2种情况的超时均由该配置指定：1) Bulk transfer I/O timeout; 2) master data or ping response timeout。</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 需要特别注意的是：若修改默认值，则用户输入的值必须大于repl-ping-slave-period的配置值，否则在主从链路延时较高时，会频繁timeout。</span>
</span></span><span style=display:flex><span><span style=color:#b44>repl-timeout</span> <span style=color:#b44>30</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 当配置yes时会禁用NO_DELAY，TCP协议栈会合并小包统一发送，这样可以减少主从节点间的包数量并节省带宽，但会增加数据同步到slave的时间</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 当配置no时启用NO_DELAY，TCP协议栈不会延迟小包的发送时机，这样数据同步的延时会减少，会消耗更多带宽</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 在带宽充足的情况下建议配置为no，以降低同步时延</span>
</span></span><span style=display:flex><span><span style=color:#b44>repl-disable-tcp-nodelay</span> <span style=color:#b44>no</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 存在多个slave的情况下，当master宕机时Redis seninel将选拔priority值最小的slave提升为master</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 如果该配置为 0 则永远不会被sentinel提升为master</span>
</span></span><span style=display:flex><span><span style=color:#b44>slave-priority</span> <span style=color:#b44>4</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic>############# Cluster模式 #############</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 开启集群模式</span>
</span></span><span style=display:flex><span><span style=color:#b44>cluster-enabled</span> <span style=color:#b44>yes</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 集群的配置文件存放路径</span>
</span></span><span style=display:flex><span><span style=color:#b44>cluster-config-file</span> <span style=color:#b44>&#34;nodes.conf&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 集群的超时时间</span>
</span></span><span style=display:flex><span><span style=color:#b44>cluster-node-timeout</span> <span style=color:#b44>5000</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic>############# Sentinel模式 #############</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># master数据库的ip与端口号，当master发生变化时sentinel会自动修改该配置</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 末尾的2代表执行故障恢复操作前至少需要几个哨兵节点同意，一般设置为N/2+1(N为哨兵总数)</span>
</span></span><span style=display:flex><span><span style=color:#b44>sentinel</span> <span style=color:#b44>monitor redis-master 192.168.1.51 7000 2</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 指定了 Sentinel 认为服务器已经断线所需的毫秒数</span>
</span></span><span style=display:flex><span><span style=color:#b44>sentinel</span> <span style=color:#b44>down-after-milliseconds redis-master 5000</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 等待该配置内的时间后master还没有恢复响应，则sentinel会排除掉故障的实例，一段时间后再探测如果已恢复则把之前故障的master作为slave处理</span>
</span></span><span style=display:flex><span><span style=color:#b44>sentinel</span> <span style=color:#b44>failover-timeout redis-master 900000</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 选项指定了在执行故障转移时， 最多可以有多少个从服务器同时对新的主服务器进行同步， 这个数字越小， 完成故障转移所需的时间就越长。</span>
</span></span><span style=display:flex><span><span style=color:#b44>sentinel</span> <span style=color:#b44>parallel-syncs redis-master 2</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># master的访问密码</span>
</span></span><span style=display:flex><span><span style=color:#b44>sentinel</span> <span style=color:#b44>auth-pass redis-master 123456</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic>############### 虚拟内存 ###############</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 是否启用虚拟内存机制，虚拟内存机将数据分页存放，把很少访问的页放到swap上，内存占用多，最好关闭虚拟内存</span>
</span></span><span style=display:flex><span><span style=color:#b44>vm-enabled</span> <span style=color:#b44>no      </span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 虚拟内存文件位置</span>
</span></span><span style=display:flex><span><span style=color:#b44>vm-swap-file</span> <span style=color:#b44>/var/lib/redis/redis.swap   </span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># redis使用的最大内存上限，保护redis不会因过多使用物理内存影响性能</span>
</span></span><span style=display:flex><span><span style=color:#b44>vm-max-memory</span> <span style=color:#b44>0    </span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 每个页面的大小为32字节</span>
</span></span><span style=display:flex><span><span style=color:#b44>vm-page-size</span> <span style=color:#b44>32    </span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 设置swap文件中页面数量</span>
</span></span><span style=display:flex><span><span style=color:#b44>vm-pages</span> <span style=color:#b44>134217728  </span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 访问swap文件的线程数</span>
</span></span><span style=display:flex><span><span style=color:#b44>vm-max-threads</span> <span style=color:#b44>4    </span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic>############## 缓冲区 ###############</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># redis为了解决输出缓冲区消息大量堆积的隐患，设置了一些保护机制，主要采用两种限制措施</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 大小限制: 当某一客户端缓冲区超过设定值后直接关闭连接；</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 持续性限制: 当某一客户端缓冲区持续一段时间占用过大空间时关闭连接。</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 缓冲区配置项格式如下：</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># client-output-buffer-limit &lt;class&gt; &lt;hard limit&gt; &lt;soft limit&gt; &lt;soft seconds&gt;</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 具体参数含义如下：</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># class: 客户端种类，normal、slave、pubsub。</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># mormal: 普通的客户端</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># slave: 从库的复制客户端</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># pub/sub: 发布与订阅的客户端的</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># hard limit: 缓冲区大小的硬限制。</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># soft limit: 缓冲区大小的软限制。</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># soft seconds: 缓冲区大小达到了（超过）soft limit值的持续时间，单位秒。</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#b44>client-output-buffer-limit</span> <span style=color:#b44>normal 0 0 0</span>
</span></span><span style=display:flex><span><span style=color:#b44>client-output-buffer-limit</span> <span style=color:#b44>replica 256mb 64mb 60</span>
</span></span><span style=display:flex><span><span style=color:#b44>client-output-buffer-limit</span> <span style=color:#b44>pubsub 32mb 8mb 60</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># master与slave作psync同步时，master会维护一个FIFO复制缓冲区</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 复制缓冲区大小</span>
</span></span><span style=display:flex><span><span style=color:#b44>repl-backlog-size</span> <span style=color:#b44>1mb</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 当master不再与任何slave保持连接时，复制缓冲区可能被清空</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># repl-backlog-ttl 用于配置从断开连接到清空缓冲区间隔的秒数</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 0 表示永不清除缓冲区</span>
</span></span><span style=display:flex><span><span style=color:#b44>repl-backlog-ttl</span> <span style=color:#b44>3600</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic>############### 高级配置 ###############</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 哈希表中元素（条目）总个数不超过设定数量时，采用线性紧凑格式存储来节省空间</span>
</span></span><span style=display:flex><span><span style=color:#b44>hash-max-zipmap-entries</span> <span style=color:#b44>512   </span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 哈希表中每个value的长度不超过多少字节时，采用线性紧凑格式存储来节省空间</span>
</span></span><span style=display:flex><span><span style=color:#b44>hash-max-zipmap-value</span> <span style=color:#b44>64     </span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># list数据类型多少节点以下会采用去指针的紧凑存储格式</span>
</span></span><span style=display:flex><span><span style=color:#b44>list-max-ziplist-entries</span> <span style=color:#b44>512  </span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># list数据类型节点值大小小于多少字节会采用紧凑存储格式</span>
</span></span><span style=display:flex><span><span style=color:#b44>list-max-ziplist-value</span> <span style=color:#b44>64    </span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># set数据类型内部数据如果全部是数值型，且包含多少节点以下会采用紧凑格式存储</span>
</span></span><span style=display:flex><span><span style=color:#b44>set-max-intset-entries</span> <span style=color:#b44>512  </span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 有序序列也可以用一种特别的编码方式来处理，可节省大量空间。这种编码只适合长度和元素都符合下面限制的有序序列：</span>
</span></span><span style=display:flex><span><span style=color:#b44>zset-max-ziplist-entries</span> <span style=color:#b44>128</span>
</span></span><span style=display:flex><span><span style=color:#b44>zset-max-ziplist-value</span> <span style=color:#b44>64</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 是否激活重置哈希</span>
</span></span><span style=display:flex><span><span style=color:#b44>activerehashing</span> <span style=color:#b44>yes        </span>
</span></span></code></pre></td></tr></table></div></div></li></ul><h4 id=运维命令-4>运维命令</h4><ol><li><p>服务启停</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#080;font-style:italic># redis服务端启停</span>
</span></span><span style=display:flex><span>./redis-server    <span style=color:#080;font-style:italic># 前台进程，配置daemonize yes后可后台常驻</span>
</span></span><span style=display:flex><span>./redis-server &amp;  <span style=color:#080;font-style:italic># 后台进程</span>
</span></span><span style=display:flex><span>./redis-server --sentinel  <span style=color:#080;font-style:italic># 哨兵模式启动</span>
</span></span><span style=display:flex><span>./redis-server ./redis.conf --daemonize yes --port <span style=color:#666>1123</span>  <span style=color:#080;font-style:italic># 指定配置文件并后台启动且端口是1123</span>
</span></span><span style=display:flex><span><span style=color:#a2f>kill</span> <span style=color:#a2f;font-weight:700>$(</span>ps -ef|grep redis-server|grep -v grep|awk <span style=color:#b44>&#39;{print $2}&#39;</span><span style=color:#a2f;font-weight:700>)</span> <span style=color:#080;font-style:italic>#杀死redis进程</span>
</span></span><span style=display:flex><span>./redis-cli shutdown  <span style=color:#080;font-style:italic># 通过客户端停止服务端</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># redis客户端</span>
</span></span><span style=display:flex><span>./redis-cli ping                  <span style=color:#080;font-style:italic># 直接执行redis命令</span>
</span></span><span style=display:flex><span>./redis-cli -a <span style=color:#b44>&#39;password&#39;</span> ping    <span style=color:#080;font-style:italic># 密码验证</span>
</span></span><span style=display:flex><span>./redis-cli -h 127.0.0.1 -p <span style=color:#666>6379</span>  <span style=color:#080;font-style:italic># 进入交互模式</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p>交互模式</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 37
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 38
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 39
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 40
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 41
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 42
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 43
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 44
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 45
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 46
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 47
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 48
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 49
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 50
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 51
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 52
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 53
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 54
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 55
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 56
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 57
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 58
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 59
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 60
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 61
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 62
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 63
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 64
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 65
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 66
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 67
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 68
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 69
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 70
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 71
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 72
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 73
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 74
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 75
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 76
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 77
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 78
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 79
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 80
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 81
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 82
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 83
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 84
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 85
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 86
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 87
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 88
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 89
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 90
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 91
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 92
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 93
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 94
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 95
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 96
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 97
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 98
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 99
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">100
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">101
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">102
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">103
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">104
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">105
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">106
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">107
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">108
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">109
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">110
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">111
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">112
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">113
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">114
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">115
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">116
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">117
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">118
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">119
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">120
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">121
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">122
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">123
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">124
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">125
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">126
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">127
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">128
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">129
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">130
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">131
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">132
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">133
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">134
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">135
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">136
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">137
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">138
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">139
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">140
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">141
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">142
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">143
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">144
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">145
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">146
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">147
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">148
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">149
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">150
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">151
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">152
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">153
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">154
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">155
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">156
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">157
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">158
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">159
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">160
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">161
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">162
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>redis-cli <span style=color:#b44>&lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#b44>交互式命令(不区分大小写)
</span></span></span><span style=display:flex><span><span style=color:#b44>EOF</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 显示帮助</span>
</span></span><span style=display:flex><span>&gt; HELP
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 显示命令的帮助</span>
</span></span><span style=display:flex><span>&gt; COMMAND                   <span style=color:#080;font-style:italic># 反正所有命令的帮助</span>
</span></span><span style=display:flex><span>&gt; COMMAND COUNT             <span style=color:#080;font-style:italic># 返回服务器支持的命令的个数</span>
</span></span><span style=display:flex><span>&gt; COMMAND INFO &lt;commands&gt;   <span style=color:#080;font-style:italic># 返回指定命令的帮助</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 显示命令参数中的key</span>
</span></span><span style=display:flex><span>&gt; COMMAND GETKEYS &lt;command&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 检查到服务端的连接状态</span>
</span></span><span style=display:flex><span>&gt; PING
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 回显消息</span>
</span></span><span style=display:flex><span>&gt; ECHO &lt;message&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 查看当前服务器时间</span>
</span></span><span style=display:flex><span>&gt; TIME
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 显示当前实例所属角色</span>
</span></span><span style=display:flex><span>&gt; ROLE
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 调试</span>
</span></span><span style=display:flex><span>&gt; DEBUG OBJECT &lt;key&gt;   <span style=color:#080;font-style:italic># 返回key的调试信息</span>
</span></span><span style=display:flex><span>&gt; DEBUG SEGFAULT       <span style=color:#080;font-style:italic># 让redis服务崩溃</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 关闭redis</span>
</span></span><span style=display:flex><span>&gt; SHUTDOWN             <span style=color:#080;font-style:italic># 数据会同步到磁盘</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 关闭连接</span>
</span></span><span style=display:flex><span>&gt; QUIT
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 查看配置</span>
</span></span><span style=display:flex><span>&gt; CONFIG GET 配置项名称       <span style=color:#080;font-style:italic># 查看单个配置</span>
</span></span><span style=display:flex><span>&gt; CONFIG GET *               <span style=color:#080;font-style:italic># 查看所有配置</span>
</span></span><span style=display:flex><span>例: CONFIG GET requirepass   <span style=color:#080;font-style:italic># 获取密码</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 更新配置</span>
</span></span><span style=display:flex><span>&gt; CONFIG SET 配置项名称 配置项参数值   <span style=color:#080;font-style:italic># 更新配置项</span>
</span></span><span style=display:flex><span>&gt; CONFIG REWRITE                     <span style=color:#080;font-style:italic># 配置更新持久化到配置文件</span>
</span></span><span style=display:flex><span>&gt; CONFIG RESETSTAT                   <span style=color:#080;font-style:italic># 重置info命令中的某些统计数据</span>
</span></span><span style=display:flex><span>例: CONFIG SET requirepass <span style=color:#b44>&#34;&#34;</span>        <span style=color:#080;font-style:italic># 取消密码</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 显示redis服务器统计信息</span>
</span></span><span style=display:flex><span>&gt; INFO <span style=color:#666>[</span>section<span style=color:#666>]</span>      <span style=color:#080;font-style:italic># Server Cluster Clients CPU Memory Stats Persistence Replication</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 客户端</span>
</span></span><span style=display:flex><span>&gt; CLIENT LIST             <span style=color:#080;font-style:italic># 显示所有客户端连接</span>
</span></span><span style=display:flex><span>&gt; CLIENT GETNAME          <span style=color:#080;font-style:italic># 获取连接名称</span>
</span></span><span style=display:flex><span>&gt; CLIENT SETNAME &lt;name&gt;   <span style=color:#080;font-style:italic># 设置当前连接名称</span>
</span></span><span style=display:flex><span>&gt; CLIENT PAUSE &lt;timeout&gt;  <span style=color:#080;font-style:italic># 在指定时间内终止运行来自客户端的命令</span>
</span></span><span style=display:flex><span>&gt; CLIENT KILL &lt;ip:port&gt;   <span style=color:#080;font-style:italic># 关闭指定客户端</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 实时打印redis服务端接收的指令</span>
</span></span><span style=display:flex><span>&gt; MONITOR
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 密码认证</span>
</span></span><span style=display:flex><span>&gt; AUTH &lt;passwd&gt;        <span style=color:#080;font-style:italic># 进行密码认证</span>
</span></span><span style=display:flex><span>&gt; REQUIREPASS &lt;passwd&gt; <span style=color:#080;font-style:italic># 设置认证密码</span>
</span></span><span style=display:flex><span>&gt; MASTERAUTH           <span style=color:#080;font-style:italic># 设置master的认证密码</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 慢日志</span>
</span></span><span style=display:flex><span>&gt; SLOWLOG RESET        <span style=color:#080;font-style:italic># 重置慢日志记录</span>
</span></span><span style=display:flex><span>&gt; SLOWLOG GET &lt;int&gt;    <span style=color:#080;font-style:italic># 查询前N条慢日志内容</span>
</span></span><span style=display:flex><span>&gt; SLOWLOG LEN          <span style=color:#080;font-style:italic># 查询慢日志条数</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 数据库</span>
</span></span><span style=display:flex><span>&gt; SELECT &lt;int&gt;         <span style=color:#080;font-style:italic># 选择编号为N的数据库</span>
</span></span><span style=display:flex><span>&gt; DBSIZE               <span style=color:#080;font-style:italic># 查询当前库键总数</span>
</span></span><span style=display:flex><span>&gt; KEYS &lt;pattern&gt;       <span style=color:#080;font-style:italic># 查询匹配的所有key</span>
</span></span><span style=display:flex><span>&gt; KEYS *               <span style=color:#080;font-style:italic># 查询当前库所有key</span>
</span></span><span style=display:flex><span>&gt; EXISTS &lt;key&gt;         <span style=color:#080;font-style:italic># 确认key是否存在</span>
</span></span><span style=display:flex><span>&gt; DEL &lt;key&gt;            <span style=color:#080;font-style:italic># 删除一个key</span>
</span></span><span style=display:flex><span>&gt; TYPE &lt;key&gt;           <span style=color:#080;font-style:italic># 查看key的值类型</span>
</span></span><span style=display:flex><span>&gt; RENAME &lt;key&gt; &lt;newkey&gt;# 重命名key
</span></span><span style=display:flex><span>&gt; RENAMENX &lt;key&gt; &lt;newkey&gt;  <span style=color:#080;font-style:italic># 被重命名的新名称不存在的时候才有效</span>
</span></span><span style=display:flex><span>&gt; MOVE &lt;key&gt; &lt;dbindex&gt; <span style=color:#080;font-style:italic># 将当前库中的key移动到指定库中</span>
</span></span><span style=display:flex><span>&gt; RANDOMKEY            <span style=color:#080;font-style:italic># 随机返回一个key</span>
</span></span><span style=display:flex><span>&gt; FLUSHDB              <span style=color:#080;font-style:italic># 清空当前库所有key</span>
</span></span><span style=display:flex><span>&gt; FLUSHALL             <span style=color:#080;font-style:italic># 清空所有库所有key</span>
</span></span><span style=display:flex><span>&gt; DUMP &lt;key&gt;           <span style=color:#080;font-style:italic># 迁出指定key(value采用rdb格式序列化)</span>
</span></span><span style=display:flex><span>&gt; RESTORE &lt;key&gt; &lt;ttl&gt; &lt;serialized-value&gt; <span style=color:#666>[</span>replace<span style=color:#666>]</span> <span style=color:#080;font-style:italic># 迁入指定key</span>
</span></span><span style=display:flex><span>&gt; MIGRATE &lt;host&gt; &lt;port&gt; &lt;key&gt; <span style=color:#666>[</span> key ......<span style=color:#666>]</span> &lt;dest-db&gt; &lt;timeout&gt; <span style=color:#666>[</span>replace<span style=color:#666>]</span> <span style=color:#080;font-style:italic># migrate整合数据迁移</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 事务</span>
</span></span><span style=display:flex><span>&gt; MULTI                <span style=color:#080;font-style:italic># 标记一个事务块的开始</span>
</span></span><span style=display:flex><span>&gt; DISCARD              <span style=color:#080;font-style:italic># 取消事务，放弃执行事务块内的所有命令</span>
</span></span><span style=display:flex><span>&gt; EXEC                 <span style=color:#080;font-style:italic># 执行所有事务块内的命令</span>
</span></span><span style=display:flex><span>&gt; WATCH &lt;keys&gt;         <span style=color:#080;font-style:italic># 监视一个(或多个)key,如果在事务执行之前这个(或这些)key被其他命令所改动，那么事务将被打断</span>
</span></span><span style=display:flex><span>&gt; UNWATCH              <span style=color:#080;font-style:italic># 取消WATCH命令对所有key的监视</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 脚本</span>
</span></span><span style=display:flex><span>&gt; EVAL &lt;script&gt; &lt;numkeys&gt; <span style=color:#666>[</span>keys<span style=color:#666>]</span> <span style=color:#666>[</span>args<span style=color:#666>]</span>         <span style=color:#080;font-style:italic># 执行Lua脚本</span>
</span></span><span style=display:flex><span>&gt; EVALSHA &lt;sha1&gt; &lt;numkeys&gt; <span style=color:#666>[</span>keys<span style=color:#666>]</span> <span style=color:#666>[</span>args<span style=color:#666>]</span>        <span style=color:#080;font-style:italic># 执行Lua脚本</span>
</span></span><span style=display:flex><span>&gt; SCRIPT EXISTS &lt;scripts&gt;                       <span style=color:#080;font-style:italic># 查看指定的脚本是否已经被保存在缓存当中</span>
</span></span><span style=display:flex><span>&gt; SCRIPT FLUSH                                  <span style=color:#080;font-style:italic># 从脚本缓存中移除所有脚本</span>
</span></span><span style=display:flex><span>&gt; SCRIPT KILL                                   <span style=color:#080;font-style:italic># 杀死当前正在运行的Lua脚本</span>
</span></span><span style=display:flex><span>&gt; SCRIPT LOAD &lt;script&gt;                          <span style=color:#080;font-style:italic># 将脚本添加到脚本缓存中但并不立即执行这个脚本</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 持久化</span>
</span></span><span style=display:flex><span>&gt; SAVE                 <span style=color:#080;font-style:italic># 将数据以rdb快照方式同步保存到磁盘</span>
</span></span><span style=display:flex><span>&gt; BGSAVE               <span style=color:#080;font-style:italic># 将数据以rdb快照方式异步保存到磁盘</span>
</span></span><span style=display:flex><span>&gt; LASTSAVE             <span style=color:#080;font-style:italic># 返回上次成功将数据rdb快照保存到磁盘的Unix时间戳</span>
</span></span><span style=display:flex><span>&gt; BGREWRITEAOF         <span style=color:#080;font-style:italic># 手动触发aof日志重写</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 主备</span>
</span></span><span style=display:flex><span>&gt; SLAVEOF              <span style=color:#080;font-style:italic># 将当前实例作为某个示例的slave</span>
</span></span><span style=display:flex><span>&gt; SLAVEOF no one       <span style=color:#080;font-style:italic># 将当前实例提升为master</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># sentinel</span>
</span></span><span style=display:flex><span>&gt; INFO                              <span style=color:#080;font-style:italic># 哨兵集群信息</span>
</span></span><span style=display:flex><span>&gt; SENTINEL MASTERS                  <span style=color:#080;font-style:italic># 列出所有被监视的主服务器，以及这些主服务器的当前状态</span>
</span></span><span style=display:flex><span>&gt; SENTINEL SLAVES &lt;master-name&gt;     <span style=color:#080;font-style:italic># 列出指定主redis的从节点状态情况</span>
</span></span><span style=display:flex><span>&gt; SENTINEL SENTINELS &lt;master-name&gt;  <span style=color:#080;font-style:italic># 列出指定主redis的监控哨兵信息，不包含他自己</span>
</span></span><span style=display:flex><span>&gt; SENTINEL GET-MASTER-ADDR-BY-NAME &lt;master-name&gt;  <span style=color:#080;font-style:italic># 返回给定名字的主服务器的 IP 地址和端口号</span>
</span></span><span style=display:flex><span>&gt; SENTINEL &lt;master-name&gt;            <span style=color:#080;font-style:italic># 重置所有名字和给定模式pattern相匹配的主服务器。重置操作清除主服务器目前的所有状态，包括正在执行中的故障转移，并移除目前已经发现和关联的主服务器的所有从服务器和sentinel</span>
</span></span><span style=display:flex><span>&gt; SENTINEL FAILOVER &lt;master-name&gt;   <span style=color:#080;font-style:italic># 当主服务器失效时 在不询问其他sentinel意见的情况下，强制开始一次自动故障迁移，但是它会给其他sentinel发送一个最新的配置，其他sentinel会根据这个配置进行更新</span>
</span></span><span style=display:flex><span>&gt; SENTINEL CKQUORUM &lt;master-name&gt;   <span style=color:#080;font-style:italic># 检查当前在线的哨兵节点。如果一共有5个节点，设置4票，但检查后只有3节点在线，那一直无法进行监控切换</span>
</span></span><span style=display:flex><span>&gt; SENTINEL REMOVE &lt;master name&gt;     <span style=color:#080;font-style:italic># 取消当前哨兵对某主节点的监控</span>
</span></span><span style=display:flex><span>&gt; SENTINEL FLUSHCONFIG              <span style=color:#080;font-style:italic># 将配置强制刷新到本地文件</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># cluster</span>
</span></span><span style=display:flex><span>&gt; CLUSTER INFO         <span style=color:#080;font-style:italic># 查看集群状态数据</span>
</span></span><span style=display:flex><span>&gt; CLUSTER NODES        <span style=color:#080;font-style:italic># 查看集群节点信息</span>
</span></span><span style=display:flex><span>&gt; CLUSTER FORGET &lt;nodeid&gt;    <span style=color:#080;font-style:italic># 将节点从集群移除</span>
</span></span><span style=display:flex><span>&gt; CLUSTER MEET &lt;ip&gt; &lt;port&gt;   <span style=color:#080;font-style:italic># 将节点加入集群</span>
</span></span><span style=display:flex><span>&gt; CLUSTER REPLICATE &lt;nodeid&gt; <span style=color:#080;font-style:italic># 将当前节点设置为指定节点的slave节点</span>
</span></span><span style=display:flex><span>&gt; CLUSTER SAVECONFIG         <span style=color:#080;font-style:italic># 将节点的配置文件持久化到磁盘 </span>
</span></span><span style=display:flex><span>&gt; CLUSTER ADDSLOTS &lt;slots&gt;   <span style=color:#080;font-style:italic># 将一个或多个slot槽指派给当前节点</span>
</span></span><span style=display:flex><span>&gt; CLUSTER DELSLOTS &lt;slots&gt;   <span style=color:#080;font-style:italic># 移除一个或多个槽对当前节点的指派</span>
</span></span><span style=display:flex><span>&gt; CLUSTER FLUSHSLOTS         <span style=color:#080;font-style:italic># 移除指派给当前节点的所有槽，让当前节点变成一个没有指派任何槽的节点</span>
</span></span><span style=display:flex><span>&gt; CLUSTER SETSLOT &lt;slot&gt; node &lt;nodeid&gt; <span style=color:#080;font-style:italic># 将槽指派给指定的节点，如果槽已经指派给另一个节点，那么先让另一个节点删除该槽，然后再进行指派</span>
</span></span><span style=display:flex><span>&gt; CLUSTER SETSLOT &lt;slot&gt; MIGRATING &lt;nodeid&gt;  <span style=color:#080;font-style:italic># 将本节点的槽迁移到指定的节点中</span>
</span></span><span style=display:flex><span>&gt; CLUSTER SETSLOT &lt;slot&gt; IMPORTING &lt;nodeid&gt;  <span style=color:#080;font-style:italic># 从指定的节点中导入槽到本节点</span>
</span></span><span style=display:flex><span>&gt; CLUSTER SETSLOT &lt;slot&gt; STABLE              <span style=color:#080;font-style:italic># 取消对槽的导入或者迁移</span>
</span></span><span style=display:flex><span>&gt; CLUSTER KEYSLOT &lt;key&gt;                      <span style=color:#080;font-style:italic># 计算键应该被放置在哪个槽上</span>
</span></span><span style=display:flex><span>&gt; CLUSTER COUNTKEYSINSLOT &lt;slot&gt;             <span style=color:#080;font-style:italic># 返回槽目前包含的键值对数量</span>
</span></span><span style=display:flex><span>&gt; CLUSTER GETKEYSINSLOT &lt;slot&gt; &lt;count&gt;       <span style=color:#080;font-style:italic># 返回指定槽中指定个数的键</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 键值过期</span>
</span></span><span style=display:flex><span>&gt; EXPIRE &lt;key&gt; &lt;seconds&gt;                   <span style=color:#080;font-style:italic># 设置key在n秒后过期</span>
</span></span><span style=display:flex><span>&gt; PEXPIRE &lt;key&gt; &lt;milliseconds&gt;             <span style=color:#080;font-style:italic># 设置key在n毫秒后过期</span>
</span></span><span style=display:flex><span>&gt; EXPIREAT &lt;key&gt; &lt;timestamp&gt;               <span style=color:#080;font-style:italic># 设置key在某个时间戳(精确到秒)之后过期</span>
</span></span><span style=display:flex><span>&gt; PEXPIREAT &lt;key&gt; &lt;millisecondsTimestamp&gt;  <span style=color:#080;font-style:italic># 设置key在某个时间戳(精确到毫秒)之后过期</span>
</span></span><span style=display:flex><span>&gt; TTL &lt;key&gt;                                <span style=color:#080;font-style:italic># 以秒为单位获取key的剩余时间</span>
</span></span><span style=display:flex><span>&gt; PTTL &lt;key&gt;                               <span style=color:#080;font-style:italic># 以毫秒为单位获取key的剩余时间</span>
</span></span><span style=display:flex><span>&gt; PERSIST &lt;key&gt;                            <span style=color:#080;font-style:italic># 将有过期时间的key转换为无过期的key</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 发布订阅</span>
</span></span><span style=display:flex><span>&gt; SUBSCRIBE &lt;channels&gt;                     <span style=color:#080;font-style:italic># 订阅给定的一个或多个频道</span>
</span></span><span style=display:flex><span>&gt; PSUBSCRIBE &lt;patterns&gt;                    <span style=color:#080;font-style:italic># 订阅一个或多个符合给定模式的频道</span>
</span></span><span style=display:flex><span>&gt; UNSUBSCRIBE &lt;channels&gt;                   <span style=color:#080;font-style:italic># 指示客户端退订给定的频道</span>
</span></span><span style=display:flex><span>&gt; PUNSUBSCRIBE &lt;patterns&gt;                  <span style=color:#080;font-style:italic># 指示客户端退订所有给定模式的频道</span>
</span></span><span style=display:flex><span>&gt; PUBLISH &lt;channel&gt; &lt;message&gt;              <span style=color:#080;font-style:italic># 将信息发送到指定的频道</span>
</span></span><span style=display:flex><span>&gt; PUBSUB CHANNELS &lt;patterns&gt;               <span style=color:#080;font-style:italic># 列出当前的活跃频道</span>
</span></span><span style=display:flex><span>&gt; PUBSUB NUMSUB &lt;channels&gt;                 <span style=color:#080;font-style:italic># 返回给定频道的订阅者数量</span>
</span></span><span style=display:flex><span>&gt; PUBSUB NUMPAT                            <span style=color:#080;font-style:italic># 返回客户端订阅的所有模式的数量总和</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p>数据类型</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 37
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 38
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 39
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 40
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 41
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 42
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 43
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 44
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 45
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 46
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 47
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 48
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 49
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 50
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 51
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 52
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 53
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 54
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 55
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 56
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 57
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 58
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 59
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 60
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 61
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 62
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 63
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 64
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 65
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 66
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 67
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 68
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 69
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 70
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 71
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 72
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 73
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 74
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 75
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 76
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 77
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 78
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 79
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 80
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 81
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 82
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 83
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 84
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 85
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 86
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 87
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 88
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 89
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 90
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 91
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 92
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 93
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 94
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 95
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 96
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 97
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 98
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 99
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">100
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">101
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">102
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">103
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">104
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">105
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">106
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">107
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">108
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">109
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">110
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">111
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">112
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">113
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">114
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">115
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">116
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">117
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">118
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">119
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">120
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">121
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">122
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">123
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">124
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">125
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">126
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">127
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">128
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">129
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">130
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">131
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">132
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">133
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">134
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">135
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#080;font-style:italic>################## String ##################</span>
</span></span><span style=display:flex><span>String<span style=color:#666>(</span>字符串<span style=color:#666>)</span>:
</span></span><span style=display:flex><span>    <span style=color:#666>(</span>1<span style=color:#666>)</span> SET    :是定义值的时候用的
</span></span><span style=display:flex><span>    <span style=color:#666>(</span>2<span style=color:#666>)</span> GET    :获取键的值时候用的
</span></span><span style=display:flex><span>    <span style=color:#666>(</span>3<span style=color:#666>)</span> EXISTS :判断键是否存在
</span></span><span style=display:flex><span>    <span style=color:#666>(</span>4<span style=color:#666>)</span> INCR   :整数+1
</span></span><span style=display:flex><span>    <span style=color:#666>(</span>5<span style=color:#666>)</span> DECR   :整数减-1
</span></span><span style=display:flex><span>127.0.0.1:6379&gt; HELP SET                 <span style=color:#080;font-style:italic>#查看SET的用法</span>
</span></span><span style=display:flex><span>127.0.0.1:6379&gt; SET name <span style=color:#a2f>test</span>            <span style=color:#080;font-style:italic>#定义一个键名为name,而name对应的值为test</span>
</span></span><span style=display:flex><span>OK
</span></span><span style=display:flex><span>127.0.0.1:6379&gt; GET name                 <span style=color:#080;font-style:italic>#可以换取name这个键的值</span>
</span></span><span style=display:flex><span><span style=color:#b44>&#34;test&#34;</span>
</span></span><span style=display:flex><span>127.0.0.1:6379&gt; SET name centos          <span style=color:#080;font-style:italic>#如果再次定义的话,新的值就会覆盖旧的值,所以同一个名称空间中键不允许重复</span>
</span></span><span style=display:flex><span>OK
</span></span><span style=display:flex><span>127.0.0.1:6379&gt; GET name
</span></span><span style=display:flex><span><span style=color:#b44>&#34;centos&#34;</span>
</span></span><span style=display:flex><span>127.0.0.1:6379&gt; APPEND name rhel         <span style=color:#080;font-style:italic>#追加新的值到name键中</span>
</span></span><span style=display:flex><span><span style=color:#666>(</span>integer<span style=color:#666>)</span> <span style=color:#666>10</span>                             <span style=color:#080;font-style:italic>#显示了追加后的name键对应值的字符串长度</span>
</span></span><span style=display:flex><span>127.0.0.1:6379&gt; GET name
</span></span><span style=display:flex><span><span style=color:#b44>&#34;centosrhel&#34;</span>
</span></span><span style=display:flex><span>127.0.0.1:6379&gt; STRLEN name              <span style=color:#080;font-style:italic>#手动获取name键对应值的字符串长度</span>
</span></span><span style=display:flex><span><span style=color:#666>(</span>integer<span style=color:#666>)</span> <span style=color:#666>10</span>
</span></span><span style=display:flex><span>127.0.0.1:6379&gt; SET count <span style=color:#666>0</span>              <span style=color:#080;font-style:italic>#定义名为count的键,值为0</span>
</span></span><span style=display:flex><span>OK
</span></span><span style=display:flex><span>127.0.0.1:6379&gt; INCR count               <span style=color:#080;font-style:italic>#使count的值加1,执行一次加一次1,你可以多执行几次再看看值,此处就不再重复演示</span>
</span></span><span style=display:flex><span><span style=color:#666>(</span>integer<span style=color:#666>)</span> <span style=color:#666>1</span>
</span></span><span style=display:flex><span>127.0.0.1:6379&gt; DECR count               <span style=color:#080;font-style:italic>#使count的值减1,执行一次减一次1,也会达到负数,多执行几次看一下</span>
</span></span><span style=display:flex><span><span style=color:#666>(</span>integer<span style=color:#666>)</span> <span style=color:#666>2</span>                              <span style=color:#080;font-style:italic>#我上面执行了三遍INCR所以执行一次DECR就是2,在执行就是1,在执行就是0</span>
</span></span><span style=display:flex><span>127.0.0.1:6379&gt; SET name centos NX       <span style=color:#080;font-style:italic>#执行会失败,NX的意思是当键中没有值的时候才会设定键,否则不会设定</span>
</span></span><span style=display:flex><span><span style=color:#666>(</span>nil<span style=color:#666>)</span>
</span></span><span style=display:flex><span>127.0.0.1:6379&gt; SET name2 centos XX      <span style=color:#080;font-style:italic>#执行会失败,XX的意思就是当键中有值的时候才会设定键,否则不会设定</span>
</span></span><span style=display:flex><span><span style=color:#666>(</span>nil<span style=color:#666>)</span>
</span></span><span style=display:flex><span>127.0.0.1:6379&gt; SET name centos XX EX <span style=color:#666>10</span> <span style=color:#080;font-style:italic>#表示name键有值的时候才会赋值,并且赋值完成后过10秒后自动过期</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic>################## List ##################</span>
</span></span><span style=display:flex><span>List<span style=color:#666>(</span>列表<span style=color:#666>)</span>:
</span></span><span style=display:flex><span>    <span style=color:#666>(</span>1<span style=color:#666>)</span> RPUSH  :从右侧添加一个值到列表中
</span></span><span style=display:flex><span>    <span style=color:#666>(</span>2<span style=color:#666>)</span> LPUSH  :从左侧添加一个值到列表中
</span></span><span style=display:flex><span>    <span style=color:#666>(</span>3<span style=color:#666>)</span> LPOP   :从左侧逐一删除值
</span></span><span style=display:flex><span>    <span style=color:#666>(</span>4<span style=color:#666>)</span> RPOP   :从右侧逐一删除值
</span></span><span style=display:flex><span>    <span style=color:#666>(</span>5<span style=color:#666>)</span> LINDEX :指明索引位置并且获取值
</span></span><span style=display:flex><span>    <span style=color:#666>(</span>6<span style=color:#666>)</span> LSET   :修改列表中的值
</span></span><span style=display:flex><span>127.0.0.1:6379&gt; HELP @list               <span style=color:#080;font-style:italic>#查看list数组中的相关帮助</span>
</span></span><span style=display:flex><span>127.0.0.1:6379&gt; LPUSH l1 mon             <span style=color:#080;font-style:italic>#从左侧生成一个名为l1的列表</span>
</span></span><span style=display:flex><span><span style=color:#666>(</span>integer<span style=color:#666>)</span> <span style=color:#666>1</span>
</span></span><span style=display:flex><span>127.0.0.1:6379&gt; LINDEX l1 <span style=color:#666>0</span>              <span style=color:#080;font-style:italic>#查看名为l1的列表,并且指定第一个值的位置</span>
</span></span><span style=display:flex><span><span style=color:#b44>&#34;mon&#34;</span>
</span></span><span style=display:flex><span>127.0.0.1:6379&gt; LPUSH l1 sun             <span style=color:#080;font-style:italic>#从左侧新添加一个值为sun到l1列表中</span>
</span></span><span style=display:flex><span><span style=color:#666>(</span>integer<span style=color:#666>)</span> <span style=color:#666>2</span>
</span></span><span style=display:flex><span>127.0.0.1:6379&gt; LINDEX l1 <span style=color:#666>1</span>              <span style=color:#080;font-style:italic>#此时原本在0这个位置的mon位置就会变成了1,因为前面挤了一个sun</span>
</span></span><span style=display:flex><span><span style=color:#b44>&#34;mon&#34;</span>
</span></span><span style=display:flex><span>127.0.0.1:6379&gt; LINDEX l1 <span style=color:#666>0</span>              <span style=color:#080;font-style:italic>#获取的就是sun的值,因为从左侧新添加的,所以第一个必定是新添加的值</span>
</span></span><span style=display:flex><span><span style=color:#b44>&#34;sun&#34;</span>
</span></span><span style=display:flex><span>127.0.0.1:6379&gt; RPUSH l1 tue             <span style=color:#080;font-style:italic>#从右侧新添加一个值为tue到l1列表中</span>
</span></span><span style=display:flex><span><span style=color:#666>(</span>integer<span style=color:#666>)</span> <span style=color:#666>3</span>
</span></span><span style=display:flex><span>127.0.0.1:6379&gt; LINDEX l1 <span style=color:#666>2</span>              <span style=color:#080;font-style:italic>#查看到的结果就是tue,因为从左侧添加,则0必定是新添加的值,而从右侧添加,则最后一个值必定是新添加的值</span>
</span></span><span style=display:flex><span><span style=color:#b44>&#34;tue&#34;</span>
</span></span><span style=display:flex><span>127.0.0.1:6379&gt; LSET l1 <span style=color:#666>1</span> fri            <span style=color:#080;font-style:italic>#修改l1列表中位置在1上的值为fri,那么原本在1上面的mon就会被替换为fri</span>
</span></span><span style=display:flex><span>OK
</span></span><span style=display:flex><span>127.0.0.1:6379&gt; RPOP l1                  <span style=color:#080;font-style:italic>#删除从右侧开始的第一个值,执行后会删除tue</span>
</span></span><span style=display:flex><span><span style=color:#b44>&#34;tue&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic>################## Hash ##################</span>
</span></span><span style=display:flex><span>Hash<span style=color:#666>(</span>哈希<span style=color:#666>)</span>:
</span></span><span style=display:flex><span>    <span style=color:#666>(</span>1<span style=color:#666>)</span> HSET     :定义一个hash
</span></span><span style=display:flex><span>    <span style=color:#666>(</span>2<span style=color:#666>)</span> HGET     :获取键中子键对应的值
</span></span><span style=display:flex><span>    <span style=color:#666>(</span>3<span style=color:#666>)</span> HDEL     :删除键中子键
</span></span><span style=display:flex><span>    <span style=color:#666>(</span>4<span style=color:#666>)</span> HKEYS    :获取h1键中所有的子键名称
</span></span><span style=display:flex><span>    <span style=color:#666>(</span>5<span style=color:#666>)</span> HVALES   :获取h1键中所有子键对应的值
</span></span><span style=display:flex><span>    <span style=color:#666>(</span>6<span style=color:#666>)</span> HLEN     :获取h1键中拥有的hash个数
</span></span><span style=display:flex><span>127.0.0.1:6379&gt; HELP @hash                            <span style=color:#080;font-style:italic>#查看Hash数组的相关帮助</span>
</span></span><span style=display:flex><span>127.0.0.1:6379&gt; HSET h1 a mon                         <span style=color:#080;font-style:italic>#创建一个h1键,定义当中有名为a对应mon的hash</span>
</span></span><span style=display:flex><span><span style=color:#666>(</span>integer<span style=color:#666>)</span> <span style=color:#666>1</span>
</span></span><span style=display:flex><span>127.0.0.1:6379&gt; HGET h1 a                             <span style=color:#080;font-style:italic>#获取h1键中a对应的值,定义的时候对应的是什么这里显示就会是什么</span>
</span></span><span style=display:flex><span><span style=color:#b44>&#34;mon&#34;</span>
</span></span><span style=display:flex><span>127.0.0.1:6379&gt; HSET h1 b tue                         <span style=color:#080;font-style:italic>#在h1键中重新添加一个名为b对应tue的hash</span>
</span></span><span style=display:flex><span><span style=color:#666>(</span>integer<span style=color:#666>)</span> <span style=color:#666>1</span>
</span></span><span style=display:flex><span>127.0.0.1:6379&gt; HDEL h1 b                             <span style=color:#080;font-style:italic>#删除某一个键下的子键对应的值</span>
</span></span><span style=display:flex><span><span style=color:#b44>&#34;tue&#34;</span>
</span></span><span style=display:flex><span>127.0.0.1:6379&gt; HKEYS h1                              <span style=color:#080;font-style:italic>#能够获取h1键中所有的子键名称</span>
</span></span><span style=display:flex><span>1<span style=color:#666>)</span> <span style=color:#b44>&#34;a&#34;</span> 
</span></span><span style=display:flex><span>127.0.0.1:6379&gt; HVALS h1                              <span style=color:#080;font-style:italic>#能够获取h1键中所有的子键对应的值</span>
</span></span><span style=display:flex><span>1<span style=color:#666>)</span> <span style=color:#b44>&#34;mon&#34;</span>
</span></span><span style=display:flex><span>127.0.0.1:6379&gt; HLEN h1                               <span style=color:#080;font-style:italic>#获取h1键中拥有的hash个数</span>
</span></span><span style=display:flex><span><span style=color:#666>(</span>integer<span style=color:#666>)</span> <span style=color:#666>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic>################## Set ##################</span>
</span></span><span style=display:flex><span>Set<span style=color:#666>(</span>集合<span style=color:#666>)</span>:
</span></span><span style=display:flex><span>    <span style=color:#666>(</span>1<span style=color:#666>)</span> SADD     :创建新的集合
</span></span><span style=display:flex><span>    <span style=color:#666>(</span>2<span style=color:#666>)</span> SINTER   :求两个集合的交集
</span></span><span style=display:flex><span>    <span style=color:#666>(</span>3<span style=color:#666>)</span> SUNION   :求两个集合的并集,就是两个集合中都存在的,并且打印出来一份
</span></span><span style=display:flex><span>    <span style=color:#666>(</span>4<span style=color:#666>)</span> SISMEMBER:判断集合中指定的元素是否存在
</span></span><span style=display:flex><span>    <span style=color:#666>(</span>5<span style=color:#666>)</span> SPOP     :从集合中随机删除一个元素
</span></span><span style=display:flex><span>127.0.0.1:6379&gt; HELP @set                              <span style=color:#080;font-style:italic>#查看set数组中的相关帮助</span>
</span></span><span style=display:flex><span>127.0.0.1:6379&gt; SADD v1 mon tue wen thu fri sat sun    <span style=color:#080;font-style:italic>#创建一个名为v1的集合,并且包含的内容为&#34;mon,tue,wen...sun&#34;</span>
</span></span><span style=display:flex><span><span style=color:#666>(</span>integer<span style=color:#666>)</span> <span style=color:#666>7</span>
</span></span><span style=display:flex><span>127.0.0.1:6379&gt; SADD v2 tue thu day                    <span style=color:#080;font-style:italic>#创建一个名为v2的集合,并且包含的内容为&#34;tue,thu,day&#34;</span>
</span></span><span style=display:flex><span><span style=color:#666>(</span>integer<span style=color:#666>)</span> <span style=color:#666>3</span>
</span></span><span style=display:flex><span>127.0.0.1:6379&gt; SINTER v1 v2                           <span style=color:#080;font-style:italic>#对比两个集合中是否存在交集</span>
</span></span><span style=display:flex><span>1<span style=color:#666>)</span> <span style=color:#b44>&#34;thu&#34;</span>                                               <span style=color:#080;font-style:italic>#如果两个集合中有相同的值,那么会显示在屏幕上</span>
</span></span><span style=display:flex><span>2<span style=color:#666>)</span> <span style=color:#b44>&#34;tue&#34;</span>
</span></span><span style=display:flex><span>127.0.0.1:6379&gt; SUNION v1 v2                           <span style=color:#080;font-style:italic>#对比两个集合中的并集</span>
</span></span><span style=display:flex><span>1<span style=color:#666>)</span> <span style=color:#b44>&#34;sun&#34;</span>
</span></span><span style=display:flex><span>2<span style=color:#666>)</span> <span style=color:#b44>&#34;mon&#34;</span>
</span></span><span style=display:flex><span>3<span style=color:#666>)</span> <span style=color:#b44>&#34;tue&#34;</span>
</span></span><span style=display:flex><span>4<span style=color:#666>)</span> <span style=color:#b44>&#34;thu&#34;</span>
</span></span><span style=display:flex><span>5<span style=color:#666>)</span> <span style=color:#b44>&#34;wed&#34;</span>
</span></span><span style=display:flex><span>6<span style=color:#666>)</span> <span style=color:#b44>&#34;fri&#34;</span>
</span></span><span style=display:flex><span>7<span style=color:#666>)</span> <span style=color:#b44>&#34;sat&#34;</span>                                               <span style=color:#080;font-style:italic>#这个值只在v1中,但是还是打印出来了,就是v1中存在的打印出来</span>
</span></span><span style=display:flex><span>8<span style=color:#666>)</span> <span style=color:#b44>&#34;day&#34;</span>                                               <span style=color:#080;font-style:italic>#这个值只在v2中,但是还是打印出来了,就是v2中存在的也打印出来</span>
</span></span><span style=display:flex><span>127.0.0.1:6379&gt; SPOP v1                                <span style=color:#080;font-style:italic>#删除并弹出v1中的其中一个值,这个值是随机的</span>
</span></span><span style=display:flex><span><span style=color:#b44>&#34;wed&#34;</span>
</span></span><span style=display:flex><span>127.0.0.1:6379&gt; SISMEMBER v1 wed                       <span style=color:#080;font-style:italic>#判断集合中的wed是否还是一个元素</span>
</span></span><span style=display:flex><span><span style=color:#666>(</span>integer<span style=color:#666>)</span> <span style=color:#666>0</span>                                            <span style=color:#080;font-style:italic>#因为上面SPOP随机在v1中删除了一个元素,所以此时判断则为0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic>################## ZSet ##################</span>
</span></span><span style=display:flex><span>ZSet<span style=color:#666>(</span>有序集合<span style=color:#666>)</span>:
</span></span><span style=display:flex><span>    <span style=color:#666>(</span>1<span style=color:#666>)</span> ZADD     :添加一个有序集合
</span></span><span style=display:flex><span>    <span style=color:#666>(</span>2<span style=color:#666>)</span> ZCARD    :查看有序集合的元素个数
</span></span><span style=display:flex><span>    <span style=color:#666>(</span>3<span style=color:#666>)</span> ZRANK    :查看指定元素对应的SCORE号
</span></span><span style=display:flex><span>    <span style=color:#666>(</span>4<span style=color:#666>)</span> ZRANGE   :按照内置索引显示从<span style=color:#b44>&#34;min-max&#34;</span>之间的索引
</span></span><span style=display:flex><span>127.0.0.1:6379&gt; HELP @sorted_set                                <span style=color:#080;font-style:italic>#查看sorted_set中的相关帮助</span>
</span></span><span style=display:flex><span>127.0.0.1:6379&gt; ZADD weekday1 <span style=color:#666>1</span> mon <span style=color:#666>2</span> tue <span style=color:#666>3</span> wed                 <span style=color:#080;font-style:italic>#添加名为weekday1的集合,值用(1,2,3)来指定SCORE,SCORE后面跟值</span>
</span></span><span style=display:flex><span><span style=color:#666>(</span>integer<span style=color:#666>)</span> <span style=color:#666>3</span>
</span></span><span style=display:flex><span>127.0.0.1:6379&gt; ZCARD weekday1                                  <span style=color:#080;font-style:italic>#获取有序集合的元素个数</span>
</span></span><span style=display:flex><span><span style=color:#666>(</span>integer<span style=color:#666>)</span> <span style=color:#666>3</span>
</span></span><span style=display:flex><span>127.0.0.1:6379&gt; ZRANK weekday1 tue                              <span style=color:#080;font-style:italic>#查看weekday1中tue元素对应的索引号</span>
</span></span><span style=display:flex><span><span style=color:#666>(</span>integer<span style=color:#666>)</span> <span style=color:#666>1</span>
</span></span><span style=display:flex><span>127.0.0.1:6379&gt; ZRANK weekday1 mon                              <span style=color:#080;font-style:italic>#SCORE数字大小决定了你的排序(因为我们有内置索引),如果从1开始定义,那么1对应的mon就会是0</span>
</span></span><span style=display:flex><span><span style=color:#666>(</span>integer<span style=color:#666>)</span> <span style=color:#666>0</span>
</span></span><span style=display:flex><span>127.0.0.1:6379&gt; ZSCORE weekday1 tue                             <span style=color:#080;font-style:italic>#根据元素来获取SCORE</span>
</span></span><span style=display:flex><span><span style=color:#b44>&#34;2&#34;</span>
</span></span><span style=display:flex><span>127.0.0.1:6379&gt; ZRANGE weekday1 <span style=color:#666>0</span> <span style=color:#666>1</span>                             <span style=color:#080;font-style:italic>#显示weekday1中按照内置索引从0到1之间的所有元素</span>
</span></span><span style=display:flex><span>0<span style=color:#666>)</span><span style=color:#b44>&#34;mon&#34;</span>
</span></span><span style=display:flex><span>1<span style=color:#666>)</span><span style=color:#b44>&#34;tue&#34;</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p>持久化管理</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#080;font-style:italic># AOF日志文件出错后修复方法</span>
</span></span><span style=display:flex><span>redis-check-aof --fix appendonly.aof  <span style=color:#080;font-style:italic># --fix参数为修复日志文件，不加则对日志检查</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 不重启redis从RDB持久化切换到AOF持久化</span>
</span></span><span style=display:flex><span>redis-cli&gt; CONFIG SET appendonly yes      <span style=color:#080;font-style:italic># 启用AOF</span>
</span></span><span style=display:flex><span>redis-cli&gt; CONFIG SET save <span style=color:#b44>&#34;&#34;</span>         <span style=color:#080;font-style:italic># 关闭RDB</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p>Cluster集群</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#080;font-style:italic># 查询cluster集群状态</span>
</span></span><span style=display:flex><span>./redis-cli cluster info
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>cluster_state:ok        <span style=color:#080;font-style:italic># ok: 集群可正常接受查询请求；fail：至少有一个哈希槽未被绑定或集群处于错误状态</span>
</span></span><span style=display:flex><span>cluster_slots_assigned:16384  <span style=color:#080;font-style:italic># 已分配到集群节点的哈希槽数量</span>
</span></span><span style=display:flex><span>cluster_slots_ok:16384  <span style=color:#080;font-style:italic># 哈希槽状态不是FAIL和PFAIL的数量</span>
</span></span><span style=display:flex><span>cluster_slots_pfail:0   <span style=color:#080;font-style:italic># 哈希槽状态是PFAIL的数量(临时错误状态，当前不能和节点交互)</span>
</span></span><span style=display:flex><span>cluster_slots_fail:0    <span style=color:#080;font-style:italic># 哈希槽状态是FAIL的数量(错误状态，集群节点无法提供查询服务)</span>
</span></span><span style=display:flex><span>cluster_known_nodes:6   <span style=color:#080;font-style:italic># 群中节点数量，包括处于握手状态还没有成为集群正式成员的节点</span>
</span></span><span style=display:flex><span>cluster_size:3          <span style=color:#080;font-style:italic># 至少包含一个哈希槽且能够提供服务的master节点数量</span>
</span></span><span style=display:flex><span>cluster_current_epoch:6 <span style=color:#080;font-style:italic># 集群本地Current Epoch变量的值</span>
</span></span><span style=display:flex><span>cluster_my_epoch:1      <span style=color:#080;font-style:italic># 当前正在使用的节点的Config Epoch值</span>
</span></span><span style=display:flex><span>cluster_stats_messages_ping_sent:243      <span style=color:#080;font-style:italic># 通过node-to-node二进制总线发送的消息数量</span>
</span></span><span style=display:flex><span>cluster_stats_messages_pong_sent:235
</span></span><span style=display:flex><span>cluster_stats_messages_sent:478
</span></span><span style=display:flex><span>cluster_stats_messages_ping_received:230  <span style=color:#080;font-style:italic># 通过node-to-node二进制总线接收的消息数量</span>
</span></span><span style=display:flex><span>cluster_stats_messages_pong_received:243
</span></span><span style=display:flex><span>cluster_stats_messages_meet_received:5
</span></span><span style=display:flex><span>cluster_stats_messages_received:478
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 查看集群节点信息</span>
</span></span><span style=display:flex><span>./redis-cli cluster nodes
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ID							IP:PORT			  FLAGS MASTER							 PING-SENT	PONG-RECV CONFIG-EPOCH LINK-STATE SLOT
</span></span><span style=display:flex><span>0f972c205a469c25aad28790dfdc43989b5dcca3 127.0.0.1:7003@17003 slave 4e0062198602ae83f8981b1da12b37017ac7d1d0 <span style=color:#666>0</span> <span style=color:#666>1592989019686</span> <span style=color:#666>4</span> connected
</span></span><span style=display:flex><span>b6b367d00e42026e0edc0e7725695a1dddc385ed 127.0.0.1:7000@17000 myself,master - <span style=color:#666>0</span> <span style=color:#666>1592989017000</span> <span style=color:#666>1</span> connected 0-5460
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ID: 节点ID,是一个40字节的随机字符串，这个值在节点启动的时候创建，并且永远不会改变（除非使用CLUSTER RESET HARD命令）。
</span></span><span style=display:flex><span>IP:PORT: 客户端与节点通信使用的地址.
</span></span><span style=display:flex><span>FLAGS: 逗号分割的标记位，可能的值有: myself, master, slave, fail?, fail, handshake, noaddr, noflags
</span></span><span style=display:flex><span>MASTER: 如果节点是slave，并且已知master节点，则这里列出master节点ID,否则的话这里列出”-“。
</span></span><span style=display:flex><span>PING-SENT: 最近一次发送ping的时间，这个时间是一个unix毫秒时间戳，0代表没有发送过.
</span></span><span style=display:flex><span>PONG-RECV: 最近一次收到pong的时间，使用unix时间戳表示.
</span></span><span style=display:flex><span>CONFIG-EPOCH: 节点的epoch值（or of the current master <span style=color:#a2f;font-weight:700>if</span> the node is a slave）。每当节点发生失败切换时，都会创建一个新的，独特的，递增的epoch。如果多个节点竞争同一个哈希槽时，epoch值更高的节点会抢夺到。
</span></span><span style=display:flex><span>LINK-STATE: node-to-node集群总线使用的链接的状态，我们使用这个链接与集群中其他节点进行通信.值可以是 connected 和 disconnected.
</span></span><span style=display:flex><span>SLOT: 哈希槽值或者一个哈希槽范围. 从第9个参数开始，后面最多可能有16384个 数<span style=color:#666>(</span>limit never reached<span style=color:#666>)</span>。代表当前节点可以提供服务的所有哈希槽值。如果只是一个值,那就是只有一个槽会被使用。如果是一个范围，这个值表示为起始槽-结束槽，节点将处理包括起始槽和结束槽在内的所有哈希槽。
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>各flags的含义
</span></span><span style=display:flex><span>myself: 当前连接的节点.
</span></span><span style=display:flex><span>master: 节点是master.
</span></span><span style=display:flex><span>slave: 节点是slave.
</span></span><span style=display:flex><span>fail?: 节点处于PFAIL 状态。 当前节点无法联系，但逻辑上是可达的 <span style=color:#666>(</span>非 FAIL 状态<span style=color:#666>)</span>.
</span></span><span style=display:flex><span>fail: 节点处于FAIL 状态. 大部分节点都无法与其取得联系将会将改节点由 PFAIL 状态升级至FAIL状态。
</span></span><span style=display:flex><span>handshake: 还未取得信任的节点，当前正在与其进行握手.
</span></span><span style=display:flex><span>noaddr: 没有地址的节点（No address known <span style=color:#a2f;font-weight:700>for</span> this node）.
</span></span><span style=display:flex><span>noflags: 连个标记都没有（No flags at all）
</span></span></code></pre></td></tr></table></div></div></li><li><p>性能测试</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#080;font-style:italic># redis性能测试是通过同时执行多个命令实现的</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># redis自带redis-benchmark命令用于性能测试，该命令是在redis的目录下执行的，而不是redis客户端的内部指令</span>
</span></span><span style=display:flex><span>./redis-benchmark -n <span style=color:#666>10000</span>  -q
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># redis-benchmark参数：</span>
</span></span><span style=display:flex><span>-h: 指定服务器主机名,默认127.0.0.1
</span></span><span style=display:flex><span>-p: 指定服务器端口,默认6379
</span></span><span style=display:flex><span>-s: 指定服务器socket
</span></span><span style=display:flex><span>-c: 指定并发连接数,默认50
</span></span><span style=display:flex><span>-n: 指定请求数,默认10000
</span></span><span style=display:flex><span>-d: 以字节的形式指定SET/GET值的数据大小,默认2
</span></span><span style=display:flex><span>-k: 是否保持连接,0每次重连接,1保持连接,默认1
</span></span><span style=display:flex><span>-r: SET/GET/INCR使用随机key,SADD使用随机值
</span></span><span style=display:flex><span>-P: 通过管道传输&lt;numreq&gt;请求,默认1
</span></span><span style=display:flex><span>-q: 强制退出redis,仅显示query/sec值
</span></span><span style=display:flex><span>-l: 生成循环,永久执行测试
</span></span><span style=display:flex><span>-t: 仅运行以逗号分隔的测试命令列表
</span></span><span style=display:flex><span>-I: idle模式,仅打开N个idle连接并等待
</span></span><span style=display:flex><span>--csv: 以csv格式输出
</span></span></code></pre></td></tr></table></div></div></li></ol><h4 id=常用api-3>常用API</h4><h4 id=相关工具-3>相关工具</h4><h4 id=文章推荐-4>文章推荐</h4><ul><li><a href=https://www.jianshu.com/p/4163916a2a8a>一致性哈希与哈希槽对比</a></li><li><a href=https://www.cnblogs.com/hunternet/p/9957913.html>Redis数据结构-简单动态字符串SDS</a></li><li><a href=https://www.cnblogs.com/hunternet/p/11306690.html>Redis数据结构-压缩列表</a></li><li><a href=https://www.cnblogs.com/hunternet/p/9967279.html>Redis数据结构-链表</a></li><li><a href=https://www.cnblogs.com/hunternet/p/9989771.html>Redis数据结构-字典</a></li><li><a href=https://www.cnblogs.com/hunternet/p/12624691.html>Redis数据结构-quicklist</a></li><li><a href=https://www.cnblogs.com/hunternet/p/11268067.html>Redis数据结构-整数集合</a></li><li><a href=https://www.cnblogs.com/hunternet/p/11248192.html>Redis数据结构-跳表</a></li><li><a href=https://mp.weixin.qq.com/s/AvPoG8ZZM8v9lKLyuSYnHQ>Redis对象-HyperLogLog</a></li><li><a href=https://www.cnblogs.com/detectiveHLH/p/13852896.html>Redis基础-剖析基础数据结构及其用法</a></li><li><a href=https://www.cnblogs.com/detectiveHLH/p/13952320.html>Redis基础-了解Redis是如何做数据持久化的</a></li><li><a href=https://www.cnblogs.com/detectiveHLH/p/14066562.html>跟随杠精的视角一起来了解Redis的主从复制</a></li><li><a href=https://www.cnblogs.com/detectiveHLH/p/14107016.html>Redis Sentinel-深入浅出原理和实践</a></li><li><a href=https://www.cnblogs.com/detectiveHLH/p/14154665.html>深度图解Redis Cluster原理</a></li><li><a href=https://www.cnblogs.com/xiaolincoding/p/16370783.html>细说Redis九种数据类型和应用场景</a></li><li><a href=https://www.cnblogs.com/wmyskxz/p/12499532.html>Redis发布/订阅与Stream</a></li><li><a href=https://cloud.tencent.com/developer/article/1604780>Redis Cluster集群扩容缩容原理及实战</a></li></ul><h4 id=排障经验-3>排障经验</h4><h3 id=mysql>MySQL</h3><h3 id=postgresql>PostgreSQL</h3><h3 id=mongodb>MongoDB</h3><h3 id=etcd>Etcd</h3><h3 id=kubernetes>Kubernetes</h3><h3 id=harbor>Harbor</h3><h3 id=kerberos>Kerberos</h3><p><strong>基于加密票证的网络身份认证协议</strong></p><h4 id=基本概念-4>基本概念</h4><ul><li><strong>Kerberos</strong>: Kerberos源于古希腊神话中守护地狱之门的三头犬Cerberus, 是一种认证协议, 其核心技术是对称加密和第三方认证中心. Kerberos仅作认证之用, 并不支持权限控制, 其定位与TLS有部分相似. 基于Kerberos协议实现的网络身份认证系统也被称为Kerberos, 这些系统通常包含KDC, Server和Client三个部分</li><li><strong>KDC</strong>: KDC全称Key Distribution Center, 即密钥分发中心, 是Kerberos的核心, 包含Account Database, Authentication Service和Ticket Granting Service三大组件, 负责对Client身份的存储校验和票证的分发, 在Windows域环境中个, KDC的角色由Domain Controller(DC)来担当</li><li><strong>Server</strong>: Server是被访问的网络对象, 通常是服务器或者提供某种服务的应用程序, 也称作Service</li><li><strong>Client</strong>: Client是发出访问请求的网络对象, 通常是客户端应用程序, Server访问其他Server时也是Client</li><li><strong>AD</strong>: AD全称Account Database, 也称Kerberos Database, 是存储Client及其密码的数据库. AD类似于SAM的数据库, 存储所有Client的白名单, 只有处于白名单中的Client才可以成功申请Ticket Granting Ticket(TGT)</li><li><strong>AS</strong>: AS全称Authentication Service, 即身份验证服务, 负责根据AD和Client传入的密钥验证Client身份并发放Ticket Granting Ticket(TGT)</li><li><strong>TGS</strong>: TGS全称Ticket Granting Service, 即票证授权服务, 它通过验证Ticket Granting Ticket(TGT)与Authenticator, 为Client发放Server Ticket</li><li><strong>Ticket</strong>: Ticket即票证(票据), 是网络对象(即KDC, Client和Server)之间相互访问的凭证, 凭证是对服务的主体名称、用户的主体名称、用户主机的ip地址、时间标记、会话密钥、定义票证生命周期的时间戳等信息的加密, 凭证接受者解密凭证后可据此判断请求者是否合法</li><li><strong>TGT</strong>: TGT全称Ticket Granting Ticket, 即票证授予票证, 也就是入场券, 通过入场券能够获得Server Ticket</li><li><strong>Principal</strong>: principal即主体, 是Kerberos体系中的用户名, 用于标识Client或Server的身份. Principal主要由三部分组成: primary, instance(可选)和realm. 包含instance的principal一般会作为server端的principal, 如NameNode, HiverServer2, Presto Coordinator等; 不含有instance的principal, 一般会作为Client的principal, 用于身份认证</li><li><strong>Realm</strong>: realm表示包含KDC和若干Client与Service的网络域, 可以认为是命名空间, Kerberos服务端KDC可以管理多个realm, 不同realm之间的Client Principal不通用</li><li><strong>Authenticator</strong>: authenticator即验证者, 是Server用于验证Client主体的信息. 验证者包含Client的主体名称、时间标记和其他数据. 与票证不同, Authenticator只能使用一次, 通常在请求访问Server时使用</li><li><strong>Password</strong>: password就是Principal的密码, 与Master Key对应, password可被存储在keytab文件中</li><li><strong>Credential</strong>: credential是"证明某个人确定是他自己/某一种行为的确可以发生"的凭据. 在不同的使用场景下, credential的具体含义也略有不同: 对于某个principal个体而言, 他的credential就是他的password; 在kerberos认证的环节中, credential就意味着各种各样的ticket</li><li><strong>Keytab</strong>: keytab即密码本, 是包含多个Principal及其密码的文件(kerberos使用对称加密, 密码可等同于密钥). keytab文件对于每个host是唯一的, 因为key中包含hostname, Client和Server可以利用该文件进行非交互式的身份认证, 因此keytab文件应当妥善保存</li><li><strong>Master Key</strong>: master key即长期密钥, 是被hash加密的Principal密码</li><li><strong>Session Key</strong>: session key即短期会话密钥, 仅在一段时间内有效</li></ul><h4 id=架构特性-4>架构特性</h4><ol><li><p>集群架构</p><p><img src=./kerberos-arch.jpg alt=kerberos-arch></p><p><img src=./kerberos-arch1.webp alt=kerberos-arch1></p></li><li><p>认证原理</p><p>kerberos认证整个流程的基本前提:</p><ul><li>Kerberos基于Ticket实现身份认证, 而非密码. 如果Client无法利用本地密钥解密出KDC返回的加密Ticket, 认证将无法通过</li><li>Client将依次与Authentication Service, Ticket Granting Service以及目标Server/Service进行交互, 共三次交互</li><li>Client与其他组件交互时, 都将获取到两条信息, 其中一条可以通过本地密钥解密出, 另外一条将无法解密出</li><li>Client想要访问的目标Server, 将不会直接与KDC交互, 而是通过能否正确解密出Client的请求来进行认证</li><li>KDC的Account Database包含有所有principal对应的密码, 包括Client和Server的</li><li>Kerberos中信息加密方式一般是对称加密(可配置成非对称加密)</li></ul><p>Kerberos的认证流程可分为三个阶段:</p><ol><li><p>Client与Authentication Service</p><ul><li>Client通过<code>kinit PRINCIPAL</code>或其他方式, 将ClientID, 目标ServerID, 网络地址)可能是多个机器的IP地址列表, 如果想在任何机器上使用, 则可能为空), 以及TGT有效期的寿命等信息发送给Authentication Service</li><li>Authentication Service将检查客户端ID是否在KDC Account Database中. 如果Authentication Service检查操作没有异常, 那么KDC将随机生成一个 key, 用于客户端与 Ticket Granting Service(TGS) 通信. 这个Key, 一般被称为 TGS Session Key. 随后 Authentication Service将发送两条信息给Client. 其中一条信息被称为TGT(也就是入场券), 由TGS的密钥加密, Client无法解密, 包含ClientID, TGS Session Key等信息. 另一条信息由Client密钥加密, Client可以正常解密, 包含目标ServerID, TGS Session Key等信息</li><li>Client利用本地的密钥解密出第二条信息, 如果本地密钥无法解密出信息, 那么认证失败</li></ul><p><img src=./kerberos-step1.jpg alt=kerberos-step1></p></li><li><p>Client与Ticket Granting Service</p><p>Client完成与Authentication Service的通信后, 就得到了TGT(入场券), 由于本地没有TGS的密钥, 导致无法解密出其数据)与TGS Session Key</p><ul><li><p>将Authentication Service发送过来的TGT(由TGS密钥加密)和包含自身信息的Authenticator(由TGS Session Key加密)转发给Ticket Granting Service(TGS)</p></li><li><p>Ticket Granting Service(TGS)将利用自身的密钥从TGT(入场券)中解密出TGS Session Key, 然后利用TGS Session Key从Authenticator中解密出Client的信息</p></li><li><p>Ticket Granting Service(TGS)解密出所有信息后, 将进行身份检查, 进行认证:</p><ul><li>将ClientID与TGT(入场券)的ClientID进行比较</li><li>比较来自Authenticator的时间戳和TGT(入场券)的时间戳(典型的Kerberos系统的时间差容忍度是2分钟, 但也可以另行配置)</li><li>检查TGT(入场券)是否过期</li><li>检查Authenticator是否已经在Ticket Granting Service(TGS)的缓存中(为了避免重放攻击)</li></ul><p>当所有检查都通过后, Ticket Granting Service(TGS)随机生成一个Key用于后续Client与 目标Server交互时进行通信加密使用, 即Server Session Key. 同样地, TGS将发送两条信息给Client: 其中一条是 Server Ticket, 由目标Server的密钥进行加密; 另一条则由TGS Session Key加密, 包含了客户端信息与时间戳</p></li><li><p>Client将利用TGS Session Key解密出其中一条信息, 另一条信息由于是由目标Server加密, 无法解密</p></li></ul><p><img src=./kerberos-step2.jpg alt=kerberos-step2></p></li><li><p>Client与目标Server</p><p>Client完成与Ticket Granting Service的通信后, 就有了Server Ticket(由于本地没有目标Server的密钥, 导致无法解密出其数据)与Server Session Key</p><ul><li>将TGS发送过来的Server Ticket(由目标Server的密钥加密)和包含自身信息的Authenticator(由Server Session Key加密)转发给目标Server</li><li>目标Server首先利用自身的密钥解密出Server Ticket的信息, 得到Server Session Key; 随后利用Server Session Key解密出Client的Authenticator信息</li><li>信息解密完成后, 目标Server同样需要做一些信息检查:<ul><li>将Authenticator中的ClientID与Server Ticket中的ClientID进行比较</li><li>比较来自Authenticator的时间戳和Server Ticket的时间戳(典型的Kerberos系统对时间差容忍度是 2 分钟, 但也可以另行配置)</li><li>检查Ticket是否过期</li><li>检查Authenticator是否已经在目标Server的缓存中(为了避免重播攻击)</li></ul></li></ul><p>至此, 所有的认证过程通过, Client与远程Server完成了身份认证, 可以进行后续的信息通信</p><p><img src=./kerberos-step3.jpg alt=kerberos-step3></p></li></ol></li><li><p>Kerberos与TLS</p><p>Kerberos和TLS都具有身份认证的作用, 但二者的实现机制和侧重点截然不同.</p><ul><li>Kerberos专注于身份认证, 认证完成后的Client与Server的通信并不要求数据加密; TLS兼顾身份认证和加密通信</li><li>Kerberos使用的加密技术为对称加密(可配置为非对称); TLS在身份认证和密钥协商阶段使用非对称加密, 在加密通信阶段则使用的是对称加密</li><li>Kerberos依赖第三方的认证中心KDC进行用户密钥的分发和认证; TLS利用非对称密钥和数字证书机制, 只需要虚拟的根证书颁发机构的CA证书, 无需依赖单独的认证服务, 当然如果需要, 也可以使用单独的证书管理服务进行证书的签发</li><li>Kerberos是双向认证的, Client和Server相互验证; TLS可配置为单向验证Server或双向验证</li><li>Kerberos的认证需要Client和Server保留各自的keytab并配置KDC信息; TLS单向认证只要求Client持有CA证书, Server持有自身的证书和私钥, 双向验证要求Client和Server均持有CA证书和各自的证书和私钥</li><li>Kerberos是高性能的, 一旦Client获得过访问某个Server的Ticket, 该Server就能根据这个Ticket实现对Client的验证, 而无须KDC的再次参与; TLS也是高性能的, 只在Client和Server连接建立阶段需要进行身份验证和密钥协商, 后续通信只需要使用对称密钥进行加解密</li></ul><p><img src=./kerberos-process.png alt=kerberos-process></p></li></ol><p><img src=./tls-process.png alt=tls-process></p><ol start=3><li><p>Kerberos高级用法</p><ul><li>Kerberos可以配置主从高可用, 借助kpropd实现主KDC到备KDC数据的定时同步, 但无法做到自动切换</li><li>Kerberos可以结合KeepAlived+Rsync实现可自动切换的高可以, KeepAlived负责进行主从切换, Rsync负责主备数据同步</li><li>Kerberos可与LDAP结合, 将LDAP配置为Kerberos的帐号数据库(kdb5_ldap_util), 由LDAP提供帐号管理, Kerberos负责服务认证</li><li>基于Hadoop的大数据生态圈软件基本都支持Kerberos认证, 可通过配置大数据各组件启用Kerberos实现统一认证</li><li>Kerberos不提供细粒度权限控制, 可通过与Ranger结合, 由Ranger通过各种插件实现大数据组件的权限控制, Ranger后端对接Kerberos实现用户认证</li></ul><p><img src=./kerberos-ha.png alt=kerberos-ha></p><p><img src=./kerberos-ss.webp alt=kerberos-ss></p></li><li><p>Hadoop启用Kerberos的Docker镜像</p><ul><li><p>Hadoop Base Dockfile:</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">63
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">64
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">65
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">66
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">67
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">68
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">69
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">70
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">71
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">72
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">73
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">74
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">75
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">76
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">77
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">78
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">79
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">80
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">81
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">82
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">83
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">84
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">85
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">86
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#a2f;font-weight:700>FROM</span><span style=color:#b44> centos:7</span><span>
</span></span></span><span style=display:flex><span><span>
</span></span></span><span style=display:flex><span><span></span><span style=color:#a2f;font-weight:700>ARG</span> <span style=color:#b8860b>HADOOP_DOWNLOAD</span><span style=color:#666>=</span>https://mirrors.tuna.tsinghua.edu.cn/apache/hadoop/common/hadoop-3.2.1/hadoop-3.2.1.tar.gz <span>
</span></span></span><span style=display:flex><span><span></span><span style=color:#a2f;font-weight:700>ARG</span> <span style=color:#b8860b>HADOOP_GROUP</span><span style=color:#666>=</span>hadoop
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>ARG</span> <span style=color:#b8860b>HADOOP_VERSION</span><span style=color:#666>=</span><span style=color:#666>3</span>.2.1<span>
</span></span></span><span style=display:flex><span><span>
</span></span></span><span style=display:flex><span><span></span><span style=color:#a2f;font-weight:700>ENV</span> JAVA_HOME /usr/lib/jvm/jre-1.8.0-openjdk<span>
</span></span></span><span style=display:flex><span><span></span><span style=color:#a2f;font-weight:700>ENV</span> HADOOP_HOME /opt/hadoop-<span style=color:#b8860b>$HADOOP_VERSION</span><span>
</span></span></span><span style=display:flex><span><span></span><span style=color:#a2f;font-weight:700>ENV</span> HADOOP_USER_HDFS hdfs<span>
</span></span></span><span style=display:flex><span><span></span><span style=color:#a2f;font-weight:700>ENV</span> HADOOP_USER_YARN yarn<span>
</span></span></span><span style=display:flex><span><span></span><span style=color:#a2f;font-weight:700>ENV</span> HADOOP_USER_MAPRED mapred<span>
</span></span></span><span style=display:flex><span><span>
</span></span></span><span style=display:flex><span><span></span><span style=color:#a2f;font-weight:700>RUN</span>    yum -y update <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>	<span style=color:#666>&amp;&amp;</span> yum install -y wget openssl net-tools <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>	<span style=color:#666>&amp;&amp;</span> yum install -y openssh-server openssh-clients <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>	<span style=color:#666>&amp;&amp;</span> yum install -y krb5-workstation <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>	<span style=color:#666>&amp;&amp;</span> yum install -y java-1.8.0-openjdk <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>	<span style=color:#666>&amp;&amp;</span> groupadd -g <span style=color:#666>1001</span> <span style=color:#b8860b>$HADOOP_GROUP</span> <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>	<span style=color:#666>&amp;&amp;</span> useradd -d /home/<span style=color:#b8860b>$HADOOP_USER_HDFS</span> -m -u <span style=color:#666>1001</span> -g <span style=color:#b8860b>$HADOOP_GROUP</span> -s /bin/bash -p <span style=color:#b8860b>$HADOOP_USER_HDFS</span> <span style=color:#b8860b>$HADOOP_USER_HDFS</span> <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>	<span style=color:#666>&amp;&amp;</span> useradd -d /home/<span style=color:#b8860b>$HADOOP_USER_YARN</span> -m -u <span style=color:#666>1002</span> -g <span style=color:#b8860b>$HADOOP_GROUP</span> -s /bin/bash -p <span style=color:#b8860b>$HADOOP_USER_YARN</span> <span style=color:#b8860b>$HADOOP_USER_YARN</span> <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>	<span style=color:#666>&amp;&amp;</span> useradd -d /home/<span style=color:#b8860b>$HADOOP_USER_MAPRED</span> -m -u <span style=color:#666>1003</span> -g <span style=color:#b8860b>$HADOOP_GROUP</span> -s /bin/bash -p <span style=color:#b8860b>$HADOOP_USER_MAPRED</span> <span style=color:#b8860b>$HADOOP_USER_MAPRED</span> <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>	<span style=color:#666>&amp;&amp;</span> <span style=color:#a2f>echo</span> <span style=color:#b44>&#39;export JAVA_HOME=/usr/lib/jvm/jre-1.8.0-openjdk&#39;</span> &gt; /etc/profile.d/hadoop.sh  <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>	<span style=color:#666>&amp;&amp;</span> <span style=color:#a2f>echo</span> <span style=color:#b44>&#39;export HDFS_NAMENODE_USER=$HADOOP_USER_HDFS&#39;</span> &gt;&gt; /etc/profile.d/hadoop.sh <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>	<span style=color:#666>&amp;&amp;</span> <span style=color:#a2f>echo</span> <span style=color:#b44>&#39;export HDFS_DATANODE_USER=$HADOOP_USER_HDFS&#39;</span> &gt;&gt; /etc/profile.d/hadoop.sh <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>	<span style=color:#666>&amp;&amp;</span> <span style=color:#a2f>echo</span> <span style=color:#b44>&#39;export HDFS_SECONDARYNAMENODE_USER=$HADOOP_USER_HDFS&#39;</span> &gt;&gt; /etc/profile.d/hadoop.sh <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>	<span style=color:#666>&amp;&amp;</span> <span style=color:#a2f>source</span> /etc/profile.d/hadoop.sh <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span><span style=color:#080;font-style:italic># config kerberos </span><span>
</span></span></span><span style=display:flex><span><span></span>	<span style=color:#666>&amp;&amp;</span> sed -i <span style=color:#b44>&#39;s/EXAMPLE.COM/DEV/&#39;</span> /etc/krb5.conf <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>	<span style=color:#666>&amp;&amp;</span> sed -i <span style=color:#b44>&#39;s/example.com/dev/&#39;</span> /etc/krb5.conf <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>	<span style=color:#666>&amp;&amp;</span> sed -i <span style=color:#b44>&#39;/default_realm/s/^#//&#39;</span> /etc/krb5.conf <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>	<span style=color:#666>&amp;&amp;</span> sed -i <span style=color:#b44>&#39;/DEV/s/^#//&#39;</span> /etc/krb5.conf <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>	<span style=color:#666>&amp;&amp;</span> sed -i <span style=color:#b44>&#39;/dev/s/^#//&#39;</span> /etc/krb5.conf <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>	<span style=color:#666>&amp;&amp;</span> sed -i <span style=color:#b44>&#39;/ }/s/^#//&#39;</span> /etc/krb5.conf <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>	<span style=color:#666>&amp;&amp;</span> sed -i <span style=color:#b44>&#39;/default_ccache_name/s/^ /# /&#39;</span> /etc/krb5.conf <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span><span style=color:#080;font-style:italic># config ssh</span><span>
</span></span></span><span style=display:flex><span><span></span>	<span style=color:#666>&amp;&amp;</span> ssh-keygen -t rsa -P <span style=color:#b44>&#39;&#39;</span> -f /etc/ssh/ssh_host_rsa_key <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>	<span style=color:#666>&amp;&amp;</span> ssh-keygen -t rsa -P <span style=color:#b44>&#39;&#39;</span> -f /etc/ssh/ssh_host_ecdsa_key <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>	<span style=color:#666>&amp;&amp;</span> ssh-keygen -t rsa -P <span style=color:#b44>&#39;&#39;</span> -f /etc/ssh/ssh_host_ed25519_key <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>	<span style=color:#666>&amp;&amp;</span> su - <span style=color:#b8860b>$HADOOP_USER_HDFS</span> -c <span style=color:#b44>&#34;ssh-keygen -t rsa -P &#39;&#39; -f /home/</span><span style=color:#b8860b>$HADOOP_USER_HDFS</span><span style=color:#b44>/.ssh/id_rsa&#34;</span> <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>	<span style=color:#666>&amp;&amp;</span> su - <span style=color:#b8860b>$HADOOP_USER_YARN</span> -c <span style=color:#b44>&#34;ssh-keygen -t rsa -P &#39;&#39; -f /home/</span><span style=color:#b8860b>$HADOOP_USER_YARN</span><span style=color:#b44>/.ssh/id_rsa&#34;</span> <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>	<span style=color:#666>&amp;&amp;</span> su - <span style=color:#b8860b>$HADOOP_USER_MAPRED</span> -c <span style=color:#b44>&#34;ssh-keygen -t rsa -P &#39;&#39; -f /home/</span><span style=color:#b8860b>$HADOOP_USER_MAPRED</span><span style=color:#b44>/.ssh/id_rsa&#34;</span> <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>	<span style=color:#666>&amp;&amp;</span> cp /home/<span style=color:#b8860b>$HADOOP_USER_HDFS</span>/.ssh/id_rsa.pub  /home/<span style=color:#b8860b>$HADOOP_USER_HDFS</span>/.ssh/authorized_keys <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>	<span style=color:#666>&amp;&amp;</span> cp /home/<span style=color:#b8860b>$HADOOP_USER_YARN</span>/.ssh/id_rsa.pub  /home/<span style=color:#b8860b>$HADOOP_USER_YARN</span>/.ssh/authorized_keys <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>	<span style=color:#666>&amp;&amp;</span> cp /home/<span style=color:#b8860b>$HADOOP_USER_MAPRED</span>/.ssh/id_rsa.pub  /home/<span style=color:#b8860b>$HADOOP_USER_MAPRED</span>/.ssh/authorized_keys <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>	<span style=color:#666>&amp;&amp;</span> <span style=color:#a2f>echo</span> <span style=color:#b44>&#39;StrictHostKeyChecking no&#39;</span> &gt;&gt; /etc/ssh/ssh_config <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span><span style=color:#080;font-style:italic># ADD   hadoop-3.2.1.tar.gz  /opt/</span><span>
</span></span></span><span style=display:flex><span><span></span><span style=color:#080;font-style:italic># config hadoop</span><span>
</span></span></span><span style=display:flex><span><span></span>	<span style=color:#666>&amp;&amp;</span> wget -P /tmp  <span style=color:#b8860b>$HADOOP_DOWNLOAD</span> <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>	<span style=color:#666>&amp;&amp;</span> tar -zxvf /tmp/hadoop-3.2.1.tar.gz -C /opt/ <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>	<span style=color:#666>&amp;&amp;</span> chown -R <span style=color:#b8860b>$HADOOP_USER_HDFS</span>:<span style=color:#b8860b>$HADOOP_GROUP</span> <span style=color:#b8860b>$HADOOP_HOME</span> <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>	<span style=color:#666>&amp;&amp;</span> mkdir /mnt/data <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>	<span style=color:#666>&amp;&amp;</span> chown <span style=color:#b8860b>$HADOOP_USER_HDFS</span>:<span style=color:#b8860b>$HADOOP_GROUP</span> /mnt/data <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>	<span style=color:#666>&amp;&amp;</span> mkdir /mnt/name <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>	<span style=color:#666>&amp;&amp;</span> chown <span style=color:#b8860b>$HADOOP_USER_HDFS</span>:<span style=color:#b8860b>$HADOOP_GROUP</span> /mnt/name <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>	<span style=color:#666>&amp;&amp;</span> <span style=color:#a2f>echo</span> <span style=color:#a2f>export</span> <span style=color:#b8860b>JAVA_HOME</span><span style=color:#666>=</span><span style=color:#b8860b>$JAVA_HOME</span> &gt;&gt; <span style=color:#b8860b>$HADOOP_HOME</span>/etc/hadoop/hadoop-env.sh <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>	<span style=color:#666>&amp;&amp;</span> <span style=color:#a2f>echo</span> <span style=color:#a2f>export</span> <span style=color:#b8860b>HDFS_NAMENODE_USER</span><span style=color:#666>=</span><span style=color:#b8860b>$HADOOP_USER_HDFS</span> &gt;&gt; <span style=color:#b8860b>$HADOOP_HOME</span>/etc/hadoop/hadoop-env.sh <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>	<span style=color:#666>&amp;&amp;</span> <span style=color:#a2f>echo</span> <span style=color:#a2f>export</span> <span style=color:#b8860b>HDFS_DATANODE_USER</span><span style=color:#666>=</span><span style=color:#b8860b>$HADOOP_USER_HDFS</span> &gt;&gt; <span style=color:#b8860b>$HADOOP_HOME</span>/etc/hadoop/hadoop-env.sh <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>	<span style=color:#666>&amp;&amp;</span> <span style=color:#a2f>echo</span> <span style=color:#a2f>export</span> <span style=color:#b8860b>HDFS_SECONDARYNAMENODE_USER</span><span style=color:#666>=</span><span style=color:#b8860b>$HADOOP_USER_HDFS</span> &gt;&gt; <span style=color:#b8860b>$HADOOP_HOME</span>/etc/hadoop/hadoop-env.sh <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span><span style=color:#080;font-style:italic># core-site.xml</span><span>
</span></span></span><span style=display:flex><span><span></span>	<span style=color:#666>&amp;&amp;</span> sed -i <span style=color:#b44>&#39;19a\  &lt;property&gt;&lt;name&gt;hadoop.security.authentication&lt;/name&gt;&lt;value&gt;kerberos&lt;/value&gt;&lt;/property&gt;&#39;</span> <span style=color:#b8860b>$HADOOP_HOME</span>/etc/hadoop/core-site.xml <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>	<span style=color:#666>&amp;&amp;</span> sed -i <span style=color:#b44>&#39;19a\  &lt;property&gt;&lt;name&gt;hadoop.security.authorization&lt;/name&gt;&lt;value&gt;true&lt;/value&gt;&lt;/property&gt;&#39;</span> <span style=color:#b8860b>$HADOOP_HOME</span>/etc/hadoop/core-site.xml <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>	<span style=color:#666>&amp;&amp;</span> sed -i <span style=color:#b44>&#39;19a\  &lt;property&gt;&lt;name&gt;hadoop.tmp.dir&lt;/name&gt;&lt;value&gt;/tmp&lt;/value&gt;&lt;/property&gt;&#39;</span> <span style=color:#b8860b>$HADOOP_HOME</span>/etc/hadoop/core-site.xml <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>	<span style=color:#666>&amp;&amp;</span> sed -i <span style=color:#b44>&#39;19a\  &lt;property&gt;&lt;name&gt;fs.defaultFS&lt;/name&gt;&lt;value&gt;hdfs://master.dev:9000&lt;/value&gt;&lt;/property&gt;&#39;</span> <span style=color:#b8860b>$HADOOP_HOME</span>/etc/hadoop/core-site.xml <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>	<span style=color:#666>&amp;&amp;</span> sed -i <span style=color:#b44>&#39;19a\  &lt;property&gt;&lt;name&gt;hadoop.security.auth_to_local&lt;/name&gt;&lt;value&gt;RULE:[2:$1](namenode)s/.*/hdfs/ RULE:[2:$1](secondary)s/.*/hdfs/ RULE:[2:$1](datanode)s/.*/hdfs/ RULE:[2:$1](http)s/.*/hdfs/ RULE:[2:$1](resourcemanager)s/.*/yarn/ RULE:[2:$1](nodemanager)s/.*/yarn/ RULE:[2:$1](jobhistory)s/.*/mapred/ &lt;/value&gt;&lt;/property&gt;&#39;</span> <span style=color:#b8860b>$HADOOP_HOME</span>/etc/hadoop/core-site.xml <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span><span style=color:#080;font-style:italic># yarn-site.xml</span><span>
</span></span></span><span style=display:flex><span><span></span>	<span style=color:#666>&amp;&amp;</span> sed -i <span style=color:#b44>&#39;15a\  &lt;property&gt;&lt;name&gt;yarn.nodemanager.keytab&lt;/name&gt;&lt;value&gt;/mnt/keytab/hadoop.keytab&lt;/value&gt;&lt;/property&gt;&#39;</span> <span style=color:#b8860b>$HADOOP_HOME</span>/etc/hadoop/yarn-site.xml <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>	<span style=color:#666>&amp;&amp;</span> sed -i <span style=color:#b44>&#39;15a\  &lt;property&gt;&lt;name&gt;yarn.nodemanager.principal&lt;/name&gt;&lt;value&gt;nodemanager/slave.dev@DEV&lt;/value&gt;&lt;/property&gt;&#39;</span> <span style=color:#b8860b>$HADOOP_HOME</span>/etc/hadoop/yarn-site.xml <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>	<span style=color:#666>&amp;&amp;</span> sed -i <span style=color:#b44>&#39;15a\  &lt;property&gt;&lt;name&gt;yarn.resourcemanager.keytab&lt;/name&gt;&lt;value&gt;/mnt/keytab/hadoop.keytab&lt;/value&gt;&lt;/property&gt;&#39;</span> <span style=color:#b8860b>$HADOOP_HOME</span>/etc/hadoop/yarn-site.xml <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>	<span style=color:#666>&amp;&amp;</span> sed -i <span style=color:#b44>&#39;15a\  &lt;property&gt;&lt;name&gt;yarn.resourcemanager.principal&lt;/name&gt;&lt;value&gt;resourcemanager/master.dev@DEV&lt;/value&gt;&lt;/property&gt;&#39;</span> <span style=color:#b8860b>$HADOOP_HOME</span>/etc/hadoop/yarn-site.xml <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>	<span style=color:#666>&amp;&amp;</span> sed -i <span style=color:#b44>&#39;15a\  &lt;property&gt;&lt;name&gt;yarn.resourcemanager.hostname&lt;/name&gt;&lt;value&gt;master.dev&lt;/value&gt;&lt;/property&gt;&#39;</span> <span style=color:#b8860b>$HADOOP_HOME</span>/etc/hadoop/yarn-site.xml <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span><span style=color:#080;font-style:italic># ssl</span><span>
</span></span></span><span style=display:flex><span><span></span>	<span style=color:#666>&amp;&amp;</span> cp <span style=color:#b8860b>$HADOOP_HOME</span>/etc/hadoop/ssl-client.xml.example <span style=color:#b8860b>$HADOOP_HOME</span>/etc/hadoop/ssl-client.xml <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>	<span style=color:#666>&amp;&amp;</span> sed -i <span style=color:#b44>&#39;23c &lt;value&gt;/mnt/keytab/truststore.jks&lt;/value&gt;&#39;</span> <span style=color:#b8860b>$HADOOP_HOME</span>/etc/hadoop/ssl-client.xml <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>	<span style=color:#666>&amp;&amp;</span> sed -i <span style=color:#b44>&#39;31c &lt;value&gt;123456&lt;/value&gt;&#39;</span> <span style=color:#b8860b>$HADOOP_HOME</span>/etc/hadoop/ssl-client.xml <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>	<span style=color:#666>&amp;&amp;</span> sed -i <span style=color:#b44>&#39;53c &lt;value&gt;/mnt/keytab/keystore.jks&lt;/value&gt;&#39;</span> <span style=color:#b8860b>$HADOOP_HOME</span>/etc/hadoop/ssl-client.xml <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>	<span style=color:#666>&amp;&amp;</span> sed -i <span style=color:#b44>&#39;61c &lt;value&gt;123456&lt;/value&gt;&#39;</span> <span style=color:#b8860b>$HADOOP_HOME</span>/etc/hadoop/ssl-client.xml <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>	<span style=color:#666>&amp;&amp;</span> sed -i <span style=color:#b44>&#39;68c &lt;value&gt;123456&lt;/value&gt;&#39;</span> <span style=color:#b8860b>$HADOOP_HOME</span>/etc/hadoop/ssl-client.xml <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>	<span style=color:#666>&amp;&amp;</span> cp <span style=color:#b8860b>$HADOOP_HOME</span>/etc/hadoop/ssl-server.xml.example <span style=color:#b8860b>$HADOOP_HOME</span>/etc/hadoop/ssl-server.xml <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>	<span style=color:#666>&amp;&amp;</span> sed -i <span style=color:#b44>&#39;23c &lt;value&gt;/mnt/keytab/truststore.jks&lt;/value&gt;&#39;</span> <span style=color:#b8860b>$HADOOP_HOME</span>/etc/hadoop/ssl-server.xml <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>	<span style=color:#666>&amp;&amp;</span> sed -i <span style=color:#b44>&#39;30c &lt;value&gt;123456&lt;/value&gt;&#39;</span> <span style=color:#b8860b>$HADOOP_HOME</span>/etc/hadoop/ssl-server.xml <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>	<span style=color:#666>&amp;&amp;</span> sed -i <span style=color:#b44>&#39;52c &lt;value&gt;/mnt/keytab/keystore.jks&lt;/value&gt;&#39;</span> <span style=color:#b8860b>$HADOOP_HOME</span>/etc/hadoop/ssl-server.xml <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>	<span style=color:#666>&amp;&amp;</span> sed -i <span style=color:#b44>&#39;59c &lt;value&gt;123456&lt;/value&gt;&#39;</span> <span style=color:#b8860b>$HADOOP_HOME</span>/etc/hadoop/ssl-server.xml <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>	<span style=color:#666>&amp;&amp;</span> sed -i <span style=color:#b44>&#39;66c &lt;value&gt;123456&lt;/value&gt;&#39;</span> <span style=color:#b8860b>$HADOOP_HOME</span>/etc/hadoop/ssl-server.xml <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span><span style=color:#080;font-style:italic># config startup script</span><span>
</span></span></span><span style=display:flex><span><span></span>	<span style=color:#666>&amp;&amp;</span> <span style=color:#a2f>echo</span> <span style=color:#b44>&#39;/usr/sbin/sshd -D &amp;&#39;</span> &gt; /opt/startup.sh <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>	<span style=color:#666>&amp;&amp;</span> chmod +x /opt/startup.sh<span>
</span></span></span></code></pre></td></tr></table></div></div></li><li><p>Hadoop Master Dockerfile:</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#a2f;font-weight:700>FROM</span><span style=color:#b44> hadoop</span><span>
</span></span></span><span style=display:flex><span><span>
</span></span></span><span style=display:flex><span><span></span><span style=color:#a2f;font-weight:700>ARG</span> <span style=color:#b8860b>HADOOP_VERSION</span><span style=color:#666>=</span><span style=color:#666>3</span>.2.1<span>
</span></span></span><span style=display:flex><span><span></span><span style=color:#a2f;font-weight:700>ENV</span> HADOOP_HOME /opt/hadoop-<span style=color:#b8860b>$HADOOP_VERSION</span><span>
</span></span></span><span style=display:flex><span><span></span><span style=color:#a2f;font-weight:700>ENV</span> HADOOP_USER_HDFS hdfs<span>
</span></span></span><span style=display:flex><span><span>
</span></span></span><span style=display:flex><span><span></span><span style=color:#a2f;font-weight:700>RUN</span>	   sed -i <span style=color:#b44>&#39;19a\  &lt;property&gt;&lt;name&gt;dfs.http.policy&lt;/name&gt;&lt;value&gt;HTTPS_ONLY&lt;/value&gt;&lt;/property&gt;&#39;</span> <span style=color:#b8860b>$HADOOP_HOME</span>/etc/hadoop/hdfs-site.xml <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>	<span style=color:#666>&amp;&amp;</span> sed -i <span style=color:#b44>&#39;19a\  &lt;property&gt;&lt;name&gt;dfs.web.authentication.kerberos.principal&lt;/name&gt;&lt;value&gt;http/master.dev@DEV&lt;/value&gt;&lt;/property&gt;&#39;</span> <span style=color:#b8860b>$HADOOP_HOME</span>/etc/hadoop/hdfs-site.xml <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>	<span style=color:#666>&amp;&amp;</span> sed -i <span style=color:#b44>&#39;19a\  &lt;property&gt;&lt;name&gt;dfs.web.authentication.kerberos.keytab&lt;/name&gt;&lt;value&gt;/mnt/keytab/hadoop.keytab&lt;/value&gt;&lt;/property&gt;&#39;</span> <span style=color:#b8860b>$HADOOP_HOME</span>/etc/hadoop/hdfs-site.xml <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>	<span style=color:#666>&amp;&amp;</span> sed -i <span style=color:#b44>&#39;19a\  &lt;property&gt;&lt;name&gt;dfs.webhdfs.enabled&lt;/name&gt;&lt;value&gt;true&lt;/value&gt;&lt;/property&gt;&#39;</span> <span style=color:#b8860b>$HADOOP_HOME</span>/etc/hadoop/hdfs-site.xml <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>	<span style=color:#666>&amp;&amp;</span> sed -i <span style=color:#b44>&#39;19a\  &lt;property&gt;&lt;name&gt;dfs.web.authentication.kerberos.principal&lt;/name&gt;&lt;value&gt;http/master.dev@DEV&lt;/value&gt;&lt;/property&gt;&#39;</span> <span style=color:#b8860b>$HADOOP_HOME</span>/etc/hadoop/hdfs-site.xml <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>	<span style=color:#666>&amp;&amp;</span> sed -i <span style=color:#b44>&#39;19a\  &lt;property&gt;&lt;name&gt;dfs.web.authentication.kerberos.keytab&lt;/name&gt;&lt;value&gt;/mnt/keytab/hadoop.keytab&lt;/value&gt;&lt;/property&gt;&#39;</span> <span style=color:#b8860b>$HADOOP_HOME</span>/etc/hadoop/hdfs-site.xml <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>	<span style=color:#666>&amp;&amp;</span> sed -i <span style=color:#b44>&#39;19a\  &lt;property&gt;&lt;name&gt;dfs.web.authentication.kerberos.keytab&lt;/name&gt;&lt;value&gt;/mnt/keytab/hadoop.keytab&lt;/value&gt;&lt;/property&gt;&#39;</span> <span style=color:#b8860b>$HADOOP_HOME</span>/etc/hadoop/hdfs-site.xml <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>	<span style=color:#666>&amp;&amp;</span> sed -i <span style=color:#b44>&#39;19a\  &lt;property&gt;&lt;name&gt;dfs.web.authentication.kerberos.principal&lt;/name&gt;&lt;value&gt;http/master.dev@DEV&lt;/value&gt;&lt;/property&gt;&#39;</span> <span style=color:#b8860b>$HADOOP_HOME</span>/etc/hadoop/hdfs-site.xml <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>	<span style=color:#666>&amp;&amp;</span> sed -i <span style=color:#b44>&#39;19a\  &lt;property&gt;&lt;name&gt;dfs.datanode.keytab.file&lt;/name&gt;&lt;value&gt;/mnt/keytab/hadoop.keytab&lt;/value&gt;&lt;/property&gt;&#39;</span> <span style=color:#b8860b>$HADOOP_HOME</span>/etc/hadoop/hdfs-site.xml <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>	<span style=color:#666>&amp;&amp;</span> sed -i <span style=color:#b44>&#39;19a\  &lt;property&gt;&lt;name&gt;dfs.datanode.kerberos.https.principal&lt;/name&gt;&lt;value&gt;http/slave.dev@DEV&lt;/value&gt;&lt;/property&gt;&#39;</span> <span style=color:#b8860b>$HADOOP_HOME</span>/etc/hadoop/hdfs-site.xml <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>	<span style=color:#666>&amp;&amp;</span> sed -i <span style=color:#b44>&#39;19a\  &lt;property&gt;&lt;name&gt;dfs.datanode.kerberos.principal&lt;/name&gt;&lt;value&gt;datanode/slave.dev@DEV&lt;/value&gt;&lt;/property&gt;&#39;</span> <span style=color:#b8860b>$HADOOP_HOME</span>/etc/hadoop/hdfs-site.xml <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>	<span style=color:#666>&amp;&amp;</span> sed -i <span style=color:#b44>&#39;19a\  &lt;property&gt;&lt;name&gt;dfs.datanode.data.dir&lt;/name&gt;&lt;value&gt;file:/mnt/data/&lt;/value&gt;&lt;/property&gt;&#39;</span> <span style=color:#b8860b>$HADOOP_HOME</span>/etc/hadoop/hdfs-site.xml <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>	<span style=color:#666>&amp;&amp;</span> sed -i <span style=color:#b44>&#39;19a\  &lt;property&gt;&lt;name&gt;dfs.secondary.namenode.keytab.file&lt;/name&gt;&lt;value&gt;/mnt/keytab/hadoop.keytab&lt;/value&gt;&lt;/property&gt;&#39;</span> <span style=color:#b8860b>$HADOOP_HOME</span>/etc/hadoop/hdfs-site.xml <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>	<span style=color:#666>&amp;&amp;</span> sed -i <span style=color:#b44>&#39;19a\  &lt;property&gt;&lt;name&gt;dfs.secondary.namenode.kerberos.principal&lt;/name&gt;&lt;value&gt;secondary/master.dev@DEV&lt;/value&gt;&lt;/property&gt;&#39;</span> <span style=color:#b8860b>$HADOOP_HOME</span>/etc/hadoop/hdfs-site.xml <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>	<span style=color:#666>&amp;&amp;</span> sed -i <span style=color:#b44>&#39;19a\  &lt;property&gt;&lt;name&gt;dfs.namenode.keytab.file&lt;/name&gt;&lt;value&gt;/mnt/keytab/hadoop.keytab&lt;/value&gt;&lt;/property&gt;&#39;</span> <span style=color:#b8860b>$HADOOP_HOME</span>/etc/hadoop/hdfs-site.xml <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>	<span style=color:#666>&amp;&amp;</span> sed -i <span style=color:#b44>&#39;19a\  &lt;property&gt;&lt;name&gt;dfs.namenode.kerberos.https.principal&lt;/name&gt;&lt;value&gt;http/master.dev@DEV&lt;/value&gt;&lt;/property&gt;&#39;</span> <span style=color:#b8860b>$HADOOP_HOME</span>/etc/hadoop/hdfs-site.xml <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>	<span style=color:#666>&amp;&amp;</span> sed -i <span style=color:#b44>&#39;19a\  &lt;property&gt;&lt;name&gt;dfs.namenode.kerberos.principal&lt;/name&gt;&lt;value&gt;namenode/master.dev@DEV&lt;/value&gt;&lt;/property&gt;&#39;</span> <span style=color:#b8860b>$HADOOP_HOME</span>/etc/hadoop/hdfs-site.xml <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>	<span style=color:#666>&amp;&amp;</span> sed -i <span style=color:#b44>&#39;19a\  &lt;property&gt;&lt;name&gt;dfs.namenode.name.dir&lt;/name&gt;&lt;value&gt;file:/mnt/name/&lt;/value&gt;&lt;/property&gt;&#39;</span> <span style=color:#b8860b>$HADOOP_HOME</span>/etc/hadoop/hdfs-site.xml <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>	<span style=color:#666>&amp;&amp;</span> sed -i <span style=color:#b44>&#39;19a\  &lt;property&gt;&lt;name&gt;dfs.permissions.supergroup&lt;/name&gt;&lt;value&gt;hadoop&lt;/value&gt;&lt;/property&gt;&#39;</span> <span style=color:#b8860b>$HADOOP_HOME</span>/etc/hadoop/hdfs-site.xml <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>	<span style=color:#666>&amp;&amp;</span> sed -i <span style=color:#b44>&#39;19a\  &lt;property&gt;&lt;name&gt;dfs.block.access.token.enable&lt;/name&gt;&lt;value&gt;true&lt;/value&gt;&lt;/property&gt;&#39;</span> <span style=color:#b8860b>$HADOOP_HOME</span>/etc/hadoop/hdfs-site.xml <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>	<span style=color:#666>&amp;&amp;</span> sed -i <span style=color:#b44>&#39;19a\  &lt;property&gt;&lt;name&gt;dfs.replication&lt;/name&gt;&lt;value&gt;3&lt;/value&gt;&lt;/property&gt;&#39;</span> <span style=color:#b8860b>$HADOOP_HOME</span>/etc/hadoop/hdfs-site.xml <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>	<span style=color:#666>&amp;&amp;</span> <span style=color:#a2f>printf</span> <span style=color:#b44>&#34;slave1.dev\nslave2.dev\nslave3.dev\nslave4.dev\n&#34;</span> &gt; <span style=color:#b8860b>$HADOOP_HOME</span>/etc/hadoop/workers <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>	<span style=color:#666>&amp;&amp;</span> <span style=color:#a2f>echo</span> <span style=color:#b44>&#39;su - $HADOOP_USER_HDFS -c &#34;$HADOOP_HOME/bin/hdfs namenode -format&#34;&#39;</span> &gt;&gt; /opt/startup.sh <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>	<span style=color:#666>&amp;&amp;</span> <span style=color:#a2f>echo</span> <span style=color:#b44>&#39;su - $HADOOP_USER_HDFS -c $HADOOP_HOME/sbin/start-dfs.sh&#39;</span> &gt;&gt; /opt/startup.sh <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>	<span style=color:#666>&amp;&amp;</span> <span style=color:#a2f>echo</span> <span style=color:#b44>&#39;/bin/sh -c &#34;while true; do sleep 60; done&#34;&#39;</span> &gt;&gt; /opt/startup.sh<span>
</span></span></span><span style=display:flex><span><span>
</span></span></span><span style=display:flex><span><span></span><span style=color:#a2f;font-weight:700>EXPOSE</span><span style=color:#b44> 8088</span><span>
</span></span></span><span style=display:flex><span><span></span><span style=color:#a2f;font-weight:700>EXPOSE</span><span style=color:#b44> 9871</span><span>
</span></span></span><span style=display:flex><span><span>
</span></span></span><span style=display:flex><span><span></span><span style=color:#a2f;font-weight:700>CMD</span> /opt/startup.sh<span>
</span></span></span></code></pre></td></tr></table></div></div></li><li><p>Hadoop Slave Dockerfile:</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#a2f;font-weight:700>FROM</span><span style=color:#b44> hadoop</span><span>
</span></span></span><span style=display:flex><span><span>
</span></span></span><span style=display:flex><span><span></span><span style=color:#a2f;font-weight:700>RUN</span>	   sed -i <span style=color:#b44>&#39;19a\  &lt;property&gt;&lt;name&gt;dfs.data.transfer.protection&lt;/name&gt;&lt;value&gt;integrity&lt;/value&gt;&lt;/property&gt;&#39;</span> <span style=color:#b8860b>$HADOOP_HOME</span>/etc/hadoop/hdfs-site.xml <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>	<span style=color:#666>&amp;&amp;</span> sed -i <span style=color:#b44>&#39;19a\  &lt;property&gt;&lt;name&gt;dfs.http.policy&lt;/name&gt;&lt;value&gt;HTTPS_ONLY&lt;/value&gt;&lt;/property&gt;&#39;</span> <span style=color:#b8860b>$HADOOP_HOME</span>/etc/hadoop/hdfs-site.xml <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>	<span style=color:#666>&amp;&amp;</span> sed -i <span style=color:#b44>&#39;19a\  &lt;property&gt;&lt;name&gt;dfs.web.authentication.kerberos.keytab&lt;/name&gt;&lt;value&gt;/mnt/keytab/hadoop.keytab&lt;/value&gt;&lt;/property&gt;&#39;</span> <span style=color:#b8860b>$HADOOP_HOME</span>/etc/hadoop/hdfs-site.xml <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>	<span style=color:#666>&amp;&amp;</span> sed -i <span style=color:#b44>&#39;19a\  &lt;property&gt;&lt;name&gt;dfs.web.authentication.kerberos.principal&lt;/name&gt;&lt;value&gt;http/slave.dev@DEV&lt;/value&gt;&lt;/property&gt;&#39;</span> <span style=color:#b8860b>$HADOOP_HOME</span>/etc/hadoop/hdfs-site.xml <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>	<span style=color:#666>&amp;&amp;</span> sed -i <span style=color:#b44>&#39;19a\  &lt;property&gt;&lt;name&gt;dfs.datanode.keytab.file&lt;/name&gt;&lt;value&gt;/mnt/keytab/hadoop.keytab&lt;/value&gt;&lt;/property&gt;&#39;</span> <span style=color:#b8860b>$HADOOP_HOME</span>/etc/hadoop/hdfs-site.xml <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>	<span style=color:#666>&amp;&amp;</span> sed -i <span style=color:#b44>&#39;19a\  &lt;property&gt;&lt;name&gt;dfs.datanode.kerberos.https.principal&lt;/name&gt;&lt;value&gt;http/slave.dev@DEV&lt;/value&gt;&lt;/property&gt;&#39;</span> <span style=color:#b8860b>$HADOOP_HOME</span>/etc/hadoop/hdfs-site.xml <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>	<span style=color:#666>&amp;&amp;</span> sed -i <span style=color:#b44>&#39;19a\  &lt;property&gt;&lt;name&gt;dfs.datanode.kerberos.principal&lt;/name&gt;&lt;value&gt;datanode/slave.dev@DEV&lt;/value&gt;&lt;/property&gt;&#39;</span> <span style=color:#b8860b>$HADOOP_HOME</span>/etc/hadoop/hdfs-site.xml <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>	<span style=color:#666>&amp;&amp;</span> sed -i <span style=color:#b44>&#39;19a\  &lt;property&gt;&lt;name&gt;dfs.datanode.data.dir&lt;/name&gt;&lt;value&gt;file:/mnt/data/&lt;/value&gt;&lt;/property&gt;&#39;</span> <span style=color:#b8860b>$HADOOP_HOME</span>/etc/hadoop/hdfs-site.xml <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>	<span style=color:#666>&amp;&amp;</span> sed -i <span style=color:#b44>&#39;19a\  &lt;property&gt;&lt;name&gt;dfs.block.access.token.enable&lt;/name&gt;&lt;value&gt;true&lt;/value&gt;&lt;/property&gt;&#39;</span> <span style=color:#b8860b>$HADOOP_HOME</span>/etc/hadoop/hdfs-site.xml <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>	<span style=color:#666>&amp;&amp;</span> sed -i <span style=color:#b44>&#39;19a\  &lt;property&gt;&lt;name&gt;dfs.replication&lt;/name&gt;&lt;value&gt;3&lt;/value&gt;&lt;/property&gt;&#39;</span> <span style=color:#b8860b>$HADOOP_HOME</span>/etc/hadoop/hdfs-site.xml<span>
</span></span></span><span style=display:flex><span><span>
</span></span></span><span style=display:flex><span><span></span><span style=color:#a2f;font-weight:700>EXPOSE</span><span style=color:#b44> 9865</span><span>
</span></span></span><span style=display:flex><span><span>
</span></span></span><span style=display:flex><span><span></span><span style=color:#a2f;font-weight:700>CMD</span> /usr/sbin/sshd -D <span>
</span></span></span></code></pre></td></tr></table></div></div></li></ul><p>使用docker-compose build 构建完成后, 要先启动slave节点, 然后启动master节点(需要启动多少个slave节点, 就执行多少次启动slave命令):</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker-compose build
</span></span><span style=display:flex><span>docker run --network br0 --ip 192.168.1.5 -p53:53 -p123:123 --hostname gate --name gate -d gate 
</span></span><span style=display:flex><span>docker run --network br0 --ip 192.168.1.7 -p88:88 -p750:750 --hostname kerberose --dns 192.168.1.5 --name kerberos -v keytab:/mnt/keytab -d kerberos 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>docker run --network br0 --ip 192.168.1.21 -p 9865:9865 --hostname slave1 --dns 192.168.1.5 --name slave1 -v keytab:/mnt/keytab:ro -d slave 
</span></span><span style=display:flex><span>docker run --network br0 --ip 192.168.1.22 -p 9866:9865 --hostname slave2 --dns 192.168.1.5 --name slave2 -v keytab:/mnt/keytab:ro -d slave
</span></span><span style=display:flex><span>docker run --network br0 --ip 192.168.1.23 -p 9867:9865 --hostname slave3 --dns 192.168.1.5 --name slave3 -v keytab:/mnt/keytab:ro -d slave
</span></span><span style=display:flex><span>docker run --network br0 --ip 192.168.1.24 -p 9868:9865 --hostname slave4 --dns 192.168.1.5 --name slave4 -v keytab:/mnt/keytab:ro -d slave
</span></span><span style=display:flex><span>docker run --network br0 --ip 192.168.1.25 -p 9869:9865 --hostname slave5 --dns 192.168.1.5 --name slave5 -v keytab:/mnt/keytab:ro -d slave
</span></span><span style=display:flex><span>docker run --network br0 --ip 192.168.1.26 -p 9870:9865 --hostname slave6 --dns 192.168.1.5 --name slave6 -v keytab:/mnt/keytab:ro -d slave
</span></span><span style=display:flex><span>docker run --network br0 --ip 192.168.1.10 -p 9871:9871 -p 8088:8088 --hostname master --dns 192.168.1.5 --name master -v keytab:/mnt/keytab:ro -d master
</span></span></code></pre></td></tr></table></div></div></li></ol><h4 id=配置文件-5>配置文件</h4><h4 id=运维命令-5>运维命令</h4><h4 id=常用api-4>常用API</h4><h4 id=相关工具-4>相关工具</h4><h4 id=文章推荐-5>文章推荐</h4><ul><li><a href=https://web.mit.edu/kerberos/krb5-latest/doc/>官方文档</a></li><li><a href=https://ieevee.com/tech/2016/06/07/kerberos-1.html>Kerberos系列</a></li><li><a href=https://www.cnblogs.com/wukenaihe/p/3732141.html>Kerberos简介</a></li><li><a href=https://zhuanlan.zhihu.com/p/266491528>一文搞定Kerberos</a></li><li><a href=https://juejin.cn/post/6930499445117812743>Kerberos配置</a></li><li><a href=https://www.cnblogs.com/panpanwelcome/p/13601987.html>Kerberos认证原理</a></li><li><a href=https://blog.csdn.net/sinat_28007043/article/details/107351525>Kerberos基本原理与安装部署</a></li><li><a href=https://segmentfault.com/a/1190000021494676>HTTPS详解</a></li><li><a href="https://www.javaxks.com/?p=43534">Kerberos高可用配置</a></li><li><a href=https://www.w3xue.com/exp/article/201811/6876.html>基于Kerberos的大数据安全解决方案</a></li><li><a href=https://www.cnblogs.com/zhaojonjon/p/5967281.html>Kerberos整合LDAP</a></li><li><a href=https://blog.51cto.com/u_10788142/2167923>Kerberos+LDAP集成</a></li><li><a href=https://lizhiyong2000.github.io/2019/10/10/Hadoop%E9%9B%86%E7%BE%A4%E5%BC%80%E5%90%AFKerberos%E5%B9%B6%E9%9B%86%E6%88%90Ranger/>Hadoop集群开启kerberos并集成Ranger</a></li></ul><h4 id=排障经验-4>排障经验</h4><h3 id=hdfs>HDFS</h3><p><strong>Hadoop生态分布式文件系统</strong></p><h4 id=基本概念-5>基本概念</h4><ul><li><strong>HDFS</strong>: HDFS全称Hadoop Distributed File System, 是一个可扩展、容错、高性能的分布式文件系统, 异步复制, 一次写入多次读取. 是Hadoop核心组件之一, 负责Hadoop大数据存储</li><li><strong>NameNode</strong>: 名字节点是HDFS中的元数据节点, 负责管理整个文件系统的命名空间, 节点信息, 文件信息和数据分块映射等元数据信息. NameNode是客户端访问HDFS的入口. 在Hadoop 2.0版本的HA方案中, NameNode分为Active NameNode和Standby NameNode, 二者维护相同的元数据, 但只有Active NameNode提供服务, 当其故障时Standby NameNode会自动切换为Active NameNode. 在Hadoop 2.0版本的Federation联邦方案中, 多个NameNode可共同提供服务, 每个NameNode负责不同的命名空间</li><li><strong>Second NameNode</strong>: Second NameNode是NameNode的辅助节点(并不是NameNode的备机), 它定期从NameNode拉取fsimage和editlog文件, 并对两个文件进行合并, 形成新的fsimage文件并传回NameNode, 从而减轻NameNode压力, 辅助NameNode快速恢复, 可以认为是NameNode的检查点节点. 在Hadoop 1.0版中, NameNode存在单点问题, Second NameNode也不能解决此问题. 在Hadoop 2.0版本中, HDFS的高可用得到改善, 官方提供了基于QJM/NFS共享存储和ZookeeperFailoverController的HA主备机制(Active NameNode和Standby NameNode), 还提供了用于横向扩展的NameNode Federatoin联邦机制, Second NameNode不再需要了</li><li><strong>DataNode</strong>: 负责数据块的实际存储和读写工作, 并汇报存储信息给NameNode</li><li><strong>Block</strong>: 客户端向HDFS写入数据的时候, 会将数据拆分为固定大小的Block, Block 默认是64MB(HDFS2.0改成了128MB), 根据NameNode返回的DataNode列表, 客户端选择一个DataNode并向其发送写入请求, Block写入完成后会被后续DataNode流式转发实现多副本存储, 实现数据的高可用, 默认的副本数是3</li></ul><h4 id=架构特性-5>架构特性</h4><ol><li><p>集群架构</p><p><img src=./hdfs-arch1.png alt=hdfs-arch1></p><p><img src=./hdfs-arch.png alt=hdfs-arch></p></li><li><p>NameNode元数据高可用</p><p>HDFS文件系统的元数据保存在NameNode中, 这些元数据包括:</p><ul><li>目录树结构</li><li>文件到数据库 Block 的映射关系</li><li>Block 副本及其存储位置等管理数据</li><li>DataNode 的状态监控, 两者通过段时间间隔的心跳来传递管理信息和数据信息, 通过这种方式的信息传递, NameNode 可以获知每个 DataNode 保存的 Block 信息、DataNode 的健康状况、命令 DataNode 启动停止等(如果发现某个 DataNode 节点故障, NameNode 会将其负责的 block 在其他 DataNode 上进行备份)</li></ul><p>这些信息全量存在于内存中, 除此之外, NameNode还会在磁盘中持久化保存两个文件:</p><ul><li>fsimage: 内存命名空间元数据在磁盘上的镜像文件, 即元数据快照</li><li>editlog: 各种元数据操作的 write-ahead-log 预写日志文件. 在操作体现到内存数据变化前首先会将操作记入 editlog 中, 以防止数据丢失</li></ul><p>这两个文件相结合就可以构造出完整的内存元数据内容</p><p>NameNode启动时会合并这两个文件将HDFS元数据写入内存中, NameNode运行过程中会不断向editlog中追加元数据操作记录, 只有在NameNode重启时, editlog才会合并到fsimage文件中, 从而得到一个最新的元数据快照. 但由于NameNode通常是很少重启的, 因此editlog文件会变得很大, 对该文件的管理成为问题, 此外editlog中的操作记录太多会导致NameNode重启后需要花费很长时间完成fsimage文件的合并.</p><p>为了解决fsimage和editlog合并的问题, Hadoop 1.0版本中引入了Second NameNode, 它会定期查询NameNode上的editlog, 将editlog中的改动合并到本地的fsimage中, 形成新的元数据快照, 然后将新的fsimage推送到NameNode中, NameNode收到新的fsimage后更新本地fsimage文件并重置editlog文件</p><p><img src=./hdfs-snn.jpg alt=hdfs-snn></p><p>但NameNode依然存在单点故障问题. 一方面如果 NameNode 宕机, 数据读写都会受到影响, HDFS 整体将变得不可用. 另一方面随着集群规模的扩大, 会导致整个集群管理的文件数目达到上限, 因为 NameNode 要管理整个集群 block 元信息、数据目录信息等. 为了解决这两个问题, Hadoop 2.0版本提供了一套统一的解决方案:</p><ul><li>NameNode High Availability: NameNode主备高可用, 解决单点问题</li><li>NameNode Federation: NameNode联邦集群, 解决横向扩展问题</li></ul><blockquote><p><strong>NameNode High Availability</strong></p><p>Hadoop2.0的HA机制有两个NameNode, 一个是Active状态, 另一个是Standby状态. 两者的状态可以切换, 但同时最多只有1个是Active状态. 只有Active Namenode提供对外的服务. Active NameNode和Standby NameNode之间通过NFS或者QJM(JournalNode)来同步数据</p><p>Active NameNode会把最近的操作记录写到本地的editlog文件中, 并传输到NFS或者QJM JN中. Standby NameNode定期的检查, 从NFS或者JN把最近的editlog文件读过来, 然后把editlog文件和fsimage文件合并成一个新的fsimage, 合并完成之后会通知Active NameNode获取这个新fsimage. Active NameNode获得这个新的fsimage文件之后, 替换原来旧的fsimage文件并重置本地的editlog文件</p><p>Active NameNode和Standby NameNode之间通过Zookeeper集群和独立运行于NameNode节点上的ZookeeperFailoverController(ZKFC)进程实现故障自动切换. ZKFC监听所负责的NameNode的状态并在Zookeeper集群注册选举信息(选举锁争抢), 当ZKFC获得或失去选举锁时, 会向所负责的NameNode发送Active或Standby命令实现NameNode的主从自动切换</p><p>这样, 保持了Active NameNode和Standby NameNode的数据实时同步, Standby NameNode可以随时切换成Active NameNode. 而且还保持了原来Hadoop1.0的SecondaryNameNode/CheckpointNode/BackupNode的功能: 合并editlog文件和fsimage文件, 使fsimage文件一直保持更新. 所以启动了hadoop2.0的HA机制之后, SecondaryNameNode/CheckpointNode/BackupNode就不需要了</p><p><img src=./hdfs-ha.png alt=hdfs-ha></p><p><strong>NameNode Federation</strong></p><p>Hadoop 2.0提供的联邦机制解决了命名空间和性能可扩展性差和隔离性差的问题, 其核心思想是将一个大的 namespace 划分多个子 namespace, 并且每个 namespace 分别由单独的 NameNode 负责, 这些 NameNode 之间互相独立, 互不影响, 不需要做任何协调工作(类似集群拆分, 分库架构), 集群的所有 DataNode 会被多个 NameNode 共享</p><p>每个子 namespace 和 DataNode 之间会由数据块管理层作为中介建立映射关系, 数据块管理层由若干数据块池(Pool)构成, 每个数据块只会唯一属于某个固定的数据块池, 而一个子 namespace 可以对应多个数据块池. 每个 DataNode 需要向集群中所有的 NameNode 注册, 且周期性地向所有 NameNode 发送心跳和块报告, 并执行来自所有 NameNode 的命令</p><ol><li>一个 block pool 由属于同一个 namespace 的数据块组成, 每个 DataNode 可能会存储集群中所有 block pool 的数据块</li><li>每个 block pool 内部自治, 也就是说各自管理各自的 block, 不会与其他 block pool 交流, 如果一个 NameNode 挂掉了, 不会影响其他 NameNode</li><li>某个 NameNode 上的 namespace 和它对应的 block pool 一起被称为 namespace volume, 它是管理的基本单位. 当一个 NameNode/namespace 被删除后, 其所有 DataNode 上对应的 block pool 也会被删除, 当集群升级时, 每个 namespace volume 可以作为一个基本单元进行升级</li></ol><p><img src=./hdfs-federation.jpg alt=hdfs-federation></p></blockquote></li><li><p>磁盘平衡</p><p>DataNode 将数据块存储到本地文件系统目录中, 具体的目录可以通过配置 hdfs-site.xml 里面的 dfs.datanode.data.dir 参数. 在典型的安装配置中, 一般都会配置多个目录, 并且把这些目录分别配置到不同的设备上, 比如分别配置到不同的HDD(HDD的全称是Hard Disk Drive)和SSD(全称Solid State Drives, 即固态硬盘)上</p><p>当往HDFS上写入新的数据块时, DataNode 将会使用volume选择策略来为这个块选择存储的位置. 目前Hadoop支持两种volume选择策略: round-robin 和 available space(详情参见: HDFS-1804), 我们可以通过 dfs.datanode.fsdataset.volume.choosing.policy 参数来设置.
循环(round-robin)策略将新块均匀分布在可用磁盘上, 而可用空间( available-space )策略优先将数据写入具有最大可用空间的磁盘(按百分比计算)</p><p><img src=./hdfs-vol.jpg alt=hdfs-vol></p><p>默认情况下, DataNode 是使用基于round-robin策略来写入新数据块. 然而在一个长时间运行的集群中, 由于大规模文件删除或者通过往 DataNode 中添加新的磁盘会导致不同磁盘存储的数据很不均衡. 即使你使用的是基于可用空间的策略, 卷(volume)不平衡仍可导致较低效率的磁盘I/O. 比如所有新增的数据块都会往新增的磁盘上写, 在此期间, 其他的磁盘会处于空闲状态, 这样新的磁盘将会是整个系统的瓶颈</p><p>DiskBalancer是一个命令行工具, 可以在DataNode的所有磁盘上均匀分配数据. 此工具与Balancer不同, 后者负责集群范围的数据平衡. 由于多种原因, 数据在节点上的磁盘之间可能存在不均匀的扩散. 这可能是由于大量写入和删除或由于磁盘更换造成的. 此工具针对给定的DataNode运行, 并将块从一个磁盘移动到另一个磁盘</p></li><li><p>读写请求</p><p>客户端向HDFS发起数据读写请求时, 都需要首先访问NameNode获取相应的DataNode列表, 然后直接请求DataNode以进行实际的数据读写. 由于HDFS中所有文件的元数据信息都存在于NameNode中, 因此不存在读写不一致的问题</p><ul><li><p>数据写入</p><p><img src=./hdfs-write.png alt=hdfs-write></p><ol><li>客户端通过调用创建新文件的DistributedFileSystem对象的create()方法来启动写操作</li><li>DistributedFileSystem对象使用RPC调用连接到NameNode并启动新文件创建. 此文件创建操作不会将任何块与该文件关联. NameNode负责验证文件(正在创建)尚不存在, 并且客户端具有创建新文件的正确权限. 如果文件已经存在或客户端没有足够的权限来创建新文件, 则向客户端抛出IOException异常. 否则操作将成功, 并且NameNode将创建该文件的新记录</li><li>NameNode创建文件新记录后, 将向客户端返回FSDataOutputStream类型的对象. 客户端通过它调用数据写入方法将数据写入HDFS</li><li>FSDataOutputStream包含DFSOutputStream对象, 该对象负责与DataNodes和NameNode的通信. 在客户端继续写入数据的同时, DFSOutputStream继续使用此数据创建数据包. 这些数据包入队到称为DataQueue的队列中</li><li>名为DataStreamer的组件使用此DataQueue, DataStreamer还要求NameNode分配新块, 从而选择要用于复制的所需DataNode</li><li>DataStreamer创建由所有需要写入该块数据的DataNode组成的Pipeline(DataNode数量取决于Block设置的副本数), 开始进行数据写入</li><li>DataStreamer将数据包写入管道中的第一个DataNode中</li><li>管道中的每个DataNode都存储它接收到的数据包, 并将其转发到管道中的第二个DataNode</li><li>DFSOutputStream维护另一个队列Ack Queue, 以存储正在等待来自DataNode的确认的数据包</li><li>一旦从管道中的所有DataNode接收到队列中数据包的确认, 便将其从Ack Queue中删除. 如果任何DataNode发生故障, 则使用来自此队列的数据包来重新启动该操作</li><li>客户端完成写入数据后, 它将调用close()方法. 对close()的调用导致将剩余的数据包刷新到管道中, 然后等待确认</li><li>客户端收到最终确认后, 将与NameNode联系, 以告知其文件写入操作已完成</li></ol></li><li><p>数据读取</p><p><img src=./hdfs-read.png alt=hdfs-read></p><ol><li>客户端通过调用 FileSystem对象的open()方法来启动读取请求 , 它是DistributedFileSystem类型的对象</li><li>该对象使用RPC连接到NameNode并获取文件块位置等元数据信息</li><li>NameNode响应该元数据请求, 向客户端返回具有该块的副本的数据节点的地址</li><li>客户端接收到DataNodes的地址后, 会将FSDataInputStream类型的对象返回给客户端. FSDataInputStream包含 DFSInputStream, 它负责与DataNode和NameNode的交互. 客户端调用read()方法,实现DFSInputStream与文件的第一个块的第一个DataNode建立连接</li><li>数据以流的形式读取, 客户端反复调用read()方法. 重复此读操作直到它到达块的末尾, 完成块的读取</li><li>一旦完成一个块的读取, DFSInputStream将关闭连接并继续查找下一个块的下一个DataNode, 再次对数据进行流式读取</li><li>客户端完成读取后, 将调用close()方法关闭连接</li></ol></li></ul></li><li><p>应用场景</p><p>海量数据存储、大文件存储、流式文件访问、大数据批处理</p></li></ol><h4 id=配置文件-6>配置文件</h4><ul><li><p><strong>$HADOOP_HOME/etc/hadoop/hdfs-site.xml</strong>: hadoop中hdfs配置文件. <a href=http://hadoop.apache.org/docs/r3.3.0/hadoop-project-dist/hadoop-hdfs/hdfs-default.xml>default</a></p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:green;font-weight:700>&lt;configuration&gt;</span>
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>&lt;property&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&lt;name&gt;</span>dfs.namenode.datanode.registration.ip-hostname-check<span style=color:green;font-weight:700>&lt;/name&gt;</span>		           <span style=color:green;font-weight:700>&lt;value&gt;</span>false<span style=color:green;font-weight:700>&lt;/value&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&lt;description&gt;</span>datanode地址是主机名并可成功进行dns解析<span style=color:green;font-weight:700>&lt;/description&gt;</span>
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>&lt;/property&gt;</span>
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>&lt;property&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&lt;name&gt;</span>dfs.webhdfs.enabled<span style=color:green;font-weight:700>&lt;/name&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&lt;value&gt;</span>true<span style=color:green;font-weight:700>&lt;/value&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&lt;description&gt;</span>启用webhdfs通过http restful api读写hdfs<span style=color:green;font-weight:700>&lt;/description&gt;</span>
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>&lt;/property&gt;</span>
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>&lt;property&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&lt;name&gt;</span>dfs.permissions.enabled<span style=color:green;font-weight:700>&lt;/name&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&lt;value&gt;</span>false<span style=color:green;font-weight:700>&lt;/value&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&lt;description&gt;</span>是否启用权限控制<span style=color:green;font-weight:700>&lt;/description&gt;</span>
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>&lt;/property&gt;</span>
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>&lt;property&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&lt;name&gt;</span>dfs.namenode.name.dir<span style=color:green;font-weight:700>&lt;/name&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&lt;value&gt;</span>file:///hadoop/dfs/name<span style=color:green;font-weight:700>&lt;/value&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&lt;description&gt;</span>namenode元数据存储路径<span style=color:green;font-weight:700>&lt;/description&gt;</span>
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>&lt;/property&gt;</span>
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>&lt;property&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&lt;name&gt;</span>dfs.datanode.data.dir<span style=color:green;font-weight:700>&lt;/name&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&lt;value&gt;</span>file:///hadoop/dfs/data<span style=color:green;font-weight:700>&lt;/value&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&lt;description&gt;</span>datanode数据存储路径<span style=color:green;font-weight:700>&lt;/description&gt;</span>
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>&lt;/property&gt;</span>
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>&lt;property&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&lt;name&gt;</span>dfs.namenode.rpc-bind-host<span style=color:green;font-weight:700>&lt;/name&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&lt;value&gt;</span>0.0.0.0<span style=color:green;font-weight:700>&lt;/value&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&lt;description&gt;</span>namenode rpc通信绑定地址<span style=color:green;font-weight:700>&lt;/description&gt;</span>
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>&lt;/property&gt;</span>
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>&lt;property&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&lt;name&gt;</span>dfs.namenode.http-bind-host<span style=color:green;font-weight:700>&lt;/name&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&lt;value&gt;</span>0.0.0.0<span style=color:green;font-weight:700>&lt;/value&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&lt;description&gt;</span>namenode http服务绑定地址<span style=color:green;font-weight:700>&lt;/description&gt;</span>
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>&lt;/property&gt;</span>
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>&lt;property&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&lt;name&gt;</span>dfs.namenode.https-bind-host<span style=color:green;font-weight:700>&lt;/name&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&lt;value&gt;</span>0.0.0.0<span style=color:green;font-weight:700>&lt;/value&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&lt;description&gt;</span>namenode https服务绑定地址<span style=color:green;font-weight:700>&lt;/description&gt;</span>
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>&lt;/property&gt;</span>
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>&lt;property&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&lt;name&gt;</span>dfs.client.use.datanode.hostname<span style=color:green;font-weight:700>&lt;/name&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&lt;value&gt;</span>true<span style=color:green;font-weight:700>&lt;/value&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&lt;description&gt;</span>客户端使用datanode主机名进行请求<span style=color:green;font-weight:700>&lt;/description&gt;</span>
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>&lt;/property&gt;</span>
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>&lt;property&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&lt;name&gt;</span>dfs.datanode.use.datanode.hostname<span style=color:green;font-weight:700>&lt;/name&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&lt;value&gt;</span>true<span style=color:green;font-weight:700>&lt;/value&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&lt;description&gt;</span>datanode使用datanode主机名进行请求<span style=color:green;font-weight:700>&lt;/description&gt;</span>
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>&lt;/property&gt;</span>
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>&lt;/configuration&gt;</span>
</span></span></code></pre></td></tr></table></div></div></li></ul><h4 id=运维命令-6>运维命令</h4><ol><li><p>节点启停</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#080;font-style:italic># 运行指定类型的节点</span>
</span></span><span style=display:flex><span>bin/hdfs &lt;nodetype&gt; <span style=color:#080;font-style:italic># 可选类型: namenode, secondarynamenode, journalnode, zkfc, datanode, dfsadmin, haadmin, fsck, balancer</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 停止服务使用ps命令找到进程id后使用kill命令杀死</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p>状态检查</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#080;font-style:italic># 命令帮助</span>
</span></span><span style=display:flex><span>bin/hadoop -usage
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># hdfs健康状态报告</span>
</span></span><span style=display:flex><span>bin/hadoop dfsadmin -report
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># namenode节点状态</span>
</span></span><span style=display:flex><span>bin/hadoop haadmin -getServiceState &lt;namenode&gt;
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 安全模式(只读)</span>
</span></span><span style=display:flex><span>bin/hdfs dfsadmin -safemode get
</span></span><span style=display:flex><span>bin/hdfs dfsadmin -safemode enter
</span></span><span style=display:flex><span>bin/hdfs dfsadmin -safemode leave
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 目录统计信息</span>
</span></span><span style=display:flex><span>bin/hdfs dfsadmin -metasave &lt;path&gt;
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 目录可用空间统计</span>
</span></span><span style=display:flex><span>bin/hadoop fs -df -h &lt;path&gt;
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 目录大小统计</span>
</span></span><span style=display:flex><span>bin/hadoop fs -du -s -h &lt;path&gt;
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 目录文件数量和大小统计</span>
</span></span><span style=display:flex><span>bin/hadoop fs -count &lt;path&gt;
</span></span></code></pre></td></tr></table></div></div></li><li><p>节点扩缩容</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#080;font-style:italic># 仅datanode</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 扩容</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic>## 先复制已存在的datanode上的配置文件和包</span>
</span></span><span style=display:flex><span>sbin/hadoop-daemon.sh start datanode
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 缩容</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic>## 先在namenode中将datanode加入dfs.hosts.exclude黑名单</span>
</span></span><span style=display:flex><span>bin/hadoop dfsadmin -refreshNodes
</span></span></code></pre></td></tr></table></div></div></li><li><p>文件操作</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#080;font-style:italic># bin/hadoop fs命令和bin/hdfs dfs命令多数情况下功能和参数相同</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># bin/hdfs dfs命令只能进行hdfs文件系统相关操作</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 目录创建</span>
</span></span><span style=display:flex><span>bin/hadoop fs -mkdir &lt;path&gt;   <span style=color:#080;font-style:italic># 如: /hdfs/data</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 列出目录下的文件</span>
</span></span><span style=display:flex><span>bin/hadoop fs -ls -R &lt;path&gt;
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 文件上传</span>
</span></span><span style=display:flex><span>bin/hadoop fs -copyFromLocal &lt;localpath&gt; &lt;path&gt;
</span></span><span style=display:flex><span>bin/hadoop fs -put &lt;localpath&gt; &lt;path&gt;
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 文件内容追加</span>
</span></span><span style=display:flex><span>bin/hadoop fs -appendToFile &lt;localpath&gt; &lt;path&gt;
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 文件下载</span>
</span></span><span style=display:flex><span>bin/hadoop fs -copyToLocal &lt;localpath&gt; &lt;path&gt;
</span></span><span style=display:flex><span>bin/hadoop fs -get &lt;localpath&gt; &lt;path&gt;
</span></span><span style=display:flex><span>bin/hadoop fs -getmerge &lt;path&gt;/log.* log.sum  <span style=color:#080;font-style:italic># 合并下载</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 文件在hdfs中复制/移动</span>
</span></span><span style=display:flex><span>bin/hadoop fs -cp &lt;path1&gt; &lt;path2&gt;
</span></span><span style=display:flex><span>bin/hadoop fs -mv &lt;path1&gt; &lt;path2&gt;
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 文件/目录(递归)删除</span>
</span></span><span style=display:flex><span>bin/hadoop fs -rm -r &lt;path&gt;
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 文件内容查看</span>
</span></span><span style=display:flex><span>bin/hadoop fs -cat &lt;filepath&gt;
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 显示文件末尾</span>
</span></span><span style=display:flex><span>bin/hadoop fs -tail &lt;filepath&gt;
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 以字符形式打印文件内容</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 文件内容查看</span>
</span></span><span style=display:flex><span>bin/hadoop fs -text &lt;filepath&gt;
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 文件信息查看与健康状态检查</span>
</span></span><span style=display:flex><span>bin/hadoop fsck -files -blocks -locations &lt;filepath&gt;
</span></span></code></pre></td></tr></table></div></div></li><li><p>权限控制</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#080;font-style:italic># 启用权限控制功能dfs.namenode.acls.enabled: true</span>
</span></span><span style=display:flex><span>bin/hdfs dfs -setfacl -m user:tom:rw- &lt;path&gt;
</span></span><span style=display:flex><span>bin/hdfs dfs -setfacl -m group:team:r-- &lt;path&gt;
</span></span></code></pre></td></tr></table></div></div></li><li><p>快照管理</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#080;font-style:italic># 快照是只读的, 位置为&lt;path&gt;/.snapshot/&lt;snapshotName&gt;</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 允许目录生成快照</span>
</span></span><span style=display:flex><span>bin/hdfs dfsadmin -allowSnapshot &lt;path&gt;
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 禁止目录生成快照</span>
</span></span><span style=display:flex><span>bin/hdfs dfsadmin -disallowSnapShot &lt;path&gt;
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 列出所有可快照的目录</span>
</span></span><span style=display:flex><span>bin/hdfs lsSnapshottableDir
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 创建快照</span>
</span></span><span style=display:flex><span>bin/hdfs dfs -createSnapshot &lt;path&gt; &lt;snapshotName&gt;
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 重命名快照</span>
</span></span><span style=display:flex><span>bin/hdfs dfs -renameSnapshot &lt;path&gt; &lt;oldSnapshotName&gt;  &lt;newSnapshotName&gt;
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 删除快照</span>
</span></span><span style=display:flex><span>bin/hdfs dfs -deleteSnapshot &lt;path&gt; &lt;snapshotName&gt;
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 对比快照</span>
</span></span><span style=display:flex><span>bin/hdfs snapshotDiff &lt;path&gt; &lt;fromSnapshotName&gt; &lt;toSnapshotName&gt;
</span></span></code></pre></td></tr></table></div></div></li><li><p>元数据查看</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#080;font-style:italic># 查看namenode列表</span>
</span></span><span style=display:flex><span>bin/hdfs getconf -namenodes
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 查看secondary namenode列表</span>
</span></span><span style=display:flex><span>bin/hdfs getconf -secondaryNameNodes
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 查看backupnode列表</span>
</span></span><span style=display:flex><span>bin/hdfs getconf -backupNodes
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 查看journalnode列表</span>
</span></span><span style=display:flex><span>bin/hdfs getconf -journalNodes
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 查看允许加入集群的datanode白名单</span>
</span></span><span style=display:flex><span>bin/hdfs getconf -includeFile
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 查看不允许加入集群的datanode黑名单</span>
</span></span><span style=display:flex><span>bin/hdfs getconf -excludeFile
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 查看namenode rpc地址</span>
</span></span><span style=display:flex><span>bin/hdfs getconf -nnRpcAddresses
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 查看配置文件中指定的key</span>
</span></span><span style=display:flex><span>bin/hdfs getconf -confKey &lt;key&gt;
</span></span></code></pre></td></tr></table></div></div></li><li><p>数据均衡分布</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sbin/start-balancer.sh -threshold &lt;percentage of disk capacity&gt;
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># percentage of disk capacity:</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># HDFS达到平衡状态的磁盘使用率偏差值</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 值越低各节点越平衡, 但消耗时间也更长</span>
</span></span><span style=display:flex><span>bin/hdfs dfsadmin -setBalancerBandwidth <span style=color:#666>67108864</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p>目录配额设置</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#080;font-style:italic># 容量配额</span>
</span></span><span style=display:flex><span>bin/hadoop dfsadmin -setSpaceQuota 1t &lt;path&gt;
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 目录和文件数配额</span>
</span></span><span style=display:flex><span>bin/hadoop dfsadmin -setQuota <span style=color:#666>10000</span> &lt;path&gt;
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 清空配额</span>
</span></span><span style=display:flex><span>bin/hadoop dfsadmin -clrSpaceQuota &lt;path&gt;
</span></span></code></pre></td></tr></table></div></div></li><li><p>其他命令</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#080;font-style:italic># 检查本地安装的压缩库</span>
</span></span><span style=display:flex><span>bin/hadoop checknative
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 格式化namenode</span>
</span></span><span style=display:flex><span>bin/hdfs namenode
</span></span><span style=display:flex><span>bin/hadoop namenode -format
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 查看hadoop fsimage文件</span>
</span></span><span style=display:flex><span>bin/hdfs oiv -i ./hadoop/dfs/name/current/fsimage_0000000000000000767 -o output.xml -p XML
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 查看hadoop editlog文件</span>
</span></span><span style=display:flex><span>hdfs oev -i ./hadoop/dfs/name/current/edits_0000000000000001007-0000000000000001008 -o output.xml -p XML
</span></span></code></pre></td></tr></table></div></div></li></ol><h4 id=常用api-5>常用API</h4><p>hdfs默认开启web api, 请求格式如:</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -i <span style=color:#b44>&#34;http://&lt;HOST&gt;:&lt;PORT&gt;/webhdfs/v1/&lt;PATH&gt;?OP=...&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p>可选OP和其他参数参考<a href=https://hadoop.apache.org/docs/current/hadoop-project-dist/hadoop-hdfs/WebHDFS.html>官方文档</a></p><h4 id=相关工具-5>相关工具</h4><h4 id=文章推荐-6>文章推荐</h4><ul><li><a href=http://hadoop.apache.org/docs/current/>官方文档</a></li><li><a href=https://matt33.com/2018/07/15/hdfs-architecture-learn/>HDFS架构</a></li><li><a href=https://data-flair.training/blogs/hadoop-hdfs-tutorial/>HDFS Tutorial</a></li><li><a href=https://blog.csdn.net/qq_27384769/article/details/80325967>HDFS架构与运维</a></li><li><a href=https://data-flair.training/blogs/hadoop-hdfs-disk-balancer/>HDFS Disk Balancer</a></li></ul><h4 id=排障经验-5>排障经验</h4><h3 id=mapreduce>MapReduce</h3><p><strong>Hadoop生态大规模数据集分布式并行计算框架</strong></p><h4 id=基本概念-6>基本概念</h4><ul><li><strong>MapReduce</strong>: mapreduce上一种分而治之的编程模型, 包含map(映射)和 reduce(归约)过程. Hadoop基于此模型实现了一套分布式计算框架, 也称为MapReduce, 是Hadoop核心组件之一, 负责在 HDFS 上进行计算. MapReduce核心功能是将用户编写的业务逻辑代码和自带默认组件整合成一个完整的分布式运算程序, 并发运行在一个 hadoop 集群上</li><li><strong>Map</strong>: 映射阶段负责将复杂的任务分解为若干简单的任务处理, 将输入的KV数据进行处理后产生新的KV数据. 多个Mapper可以启动新的maptask进程并行处理各自的map任务. map任务运行的节点会优先选择在所需数据所在的节点</li><li><strong>Reduce</strong>: 归约阶段负责对map阶段的结果进行汇总, Map阶段并行计算输出的汇总前的KV数据经由Reducer汇总后产生新的KV数据, 多个Reducer可以启动新的reducetask进程并行执行, 但Reduce阶段必须在Map阶段完成之后进行. reduce任务需要先将所要处理的数据拉取到执行reduce任务的节点</li><li><strong>Shuffle</strong>: 混排描述的上数据从Map端到Reduce端的过程, 每一个map任务的输出是独立和分散的, 因此必须有一个中间过程将所有map任务的输出整合为可供reduce任务使用的输入, 这个过程是横跨Map阶段和Reduce阶段的, 这个过程是由框架自行处理的</li><li><strong>Task</strong>: 任务是Map阶段或Reduce阶段具体完成map处理逻辑或reduce处理逻辑的进程. 由于Task有可能执行失败, 或者Hadoop有推测执行的机制, 一个Task可能被执行多次, 每一次的执行就是一个task attempt</li><li><strong>Job</strong>: 作业是指一个完整的计算工作, 包含MapReduce的全流程内容, 由Map阶段和Reduce阶段的各个任务(Task)组成. 在Hadoop的YARN管理体系中, 作业就是其中的Application的概念, 也就是运行在集群中的完成整个计算工作的程序</li></ul><h4 id=架构特性-6>架构特性</h4><ol><li><p>集群架构</p><p><img src=./mapreduce-arch1.jpg alt=mapreduce-arch1></p><p><img src=./mapreduce-arch2.jpg alt=mapreduce-arch2></p></li><li><p>MapReduce阶段工作</p><p>MapReduce整体分为Map阶段和Reduce阶段, 在这两个阶段中, 又分别包含对Map的输出处理和Reduce的输入处理, 这些处理称为Shuffle混排, Shuffle大致分为排序(sort)、溢写(spill)、合并(merge)、拉取拷贝(fetch copy)、合并排序(merge sort)几个过程, 其核心作用就是对key进行全局聚合</p><p><img src=./mapreduce-phase.jpeg alt=mapreduce-phase></p><p><img src=./mapreduce-sample.webp alt=mapreduce-sample></p><ul><li><p>Map阶段</p><p>MapReduce中的每个map任务可以细分4个阶段: record reader、mapper、combiner和partitioner. map任务的输出被称为中间键和中间值, 会被发送到reducer做后续处理</p><ul><li>record reader: record reader通过输入格式将输入split解析成记录. record reader的目的只是将输入数据解析成记录, 但不负责解析记录本身. 它将数据转化为键/值(key/value)对的形式, 并传递给mapper处理. 通常键是数据在文件中的位置, 值是组成记录的数据块</li><li>map: 在mapper中, 用户定义的map代码通过处理record reader解析的每个键/值对来产生0个或多个新的键/值对结果. 键/值的选择对MapReduce作业的完成效率来说非常重要. 键是数据在reducer中处理时被分组的依据, 值是reducer需要分析的数据</li><li>combiner: combiner是一个可选的本地reducer, 可以在map阶段聚合数据. combiner通过执行用户指定的来自mapper的中间键对map的中间结果做单个map范围内的聚合. 例如, 一个聚合的计数是每个部分计数的总和, 用户可以先将每个中间结果取和, 再将中间结果的和相加, 从而得到最终结果. 在很多情况下, 这样可以明显地减少通过网络传输的数据量. 通过combiner可以产生特别大的性能提升, 并且没有副作用, 因此combiner的应用非常广泛</li><li>partitioner: partitioner的作用是将mapper(如果使用了combiner的话就是combiner)输出的键/值对拆分为分片(shard), 每个reducer对应一个分片. 默认情况下, partitioner先计算目标的散列值(通常为md5值), 然后通过reducer个数执行取模运算key.hashCode()%(reducer的个数). 这种方式不仅能够随机地将整个键空间平均分发给每个reducer, 同时也能确保不同mapper产生的相同键能被分发至同一个reducer. 用户可以定制partitioner的默认行为, 并可以使用更高级的模式, 如排序. 当然, 一般情况下是不需要改写partitioner的. 对于每个map任务, 其分好区的数据最终会写入本地文件系统, 等待其各自的reducer拉取</li></ul><p><img src=./mapreduce-map.jpg alt=mapreduce-map></p></li><li><p>Reduce阶段</p><p>MapReduce中的reduce任务可以分为3个阶段: shuffle、reduce和record write</p><p>map任务运行的节点会优先选择在数据所在的节点, 因此一般可以通过在本地机器上进行计算来减少数据的网络传输</p><ul><li>shuffle: reduce任务开始于shuffle这一步骤(此shuffle仅指Reduce端的shuffle部分). 该步骤主要是将所有partitioner写入的输出文件拉取到运行reducer的本地机器上, 然后将这些数据按照键排序并写到一个较大的数据列表中. 排序的目的是将相同键的记录聚合在一起, 这样其所对应的值就可以很方便地在reduce任务中进行迭代处理. 这个过程完全不可定制, 而且是由框架自动处理的. 开发人员只能通过自定义Comparator对象来确定键如何排序和分组</li><li>reduce: reducer将已经分好组的数据作为输入, 并依次为每个键对应分组执行reduce函数. reduce函数的输入是键以及包含与该键对应的所有值的迭代器. 这些数据可以被聚合、过滤或以多种方式合并. 当reduce函数执行完毕后, 会将0个或多个键/值对发送到最后的处理步骤&ndash;输出格式. 和map函数一样, 因为reduce函数是业务处理逻辑的核心部分, 所以不同作业的reduce函数也是不相同的</li><li>record write: record write获取reduce函数输出的最终键/值对, 并通过输出格式将它写入到输出文件中. 每条记录的键和值默认通过tab分隔, 不同记录通过换行符分隔. 虽然一般情况下可以通过自定义实现非常多的输出格式, 但是不管什么格式, 最终的结果都将写到HDFS上</li></ul><p><img src=./mapreduce-reduce.jpg alt=mapreduce-reduce></p></li></ul><blockquote><p><strong>Shuffle</strong>各阶段</p><ol><li><p>Map端sort(排序)</p><p>Map端的输出数据, 先写环形缓存区kvbuffer, 当环形缓冲区到达一个阀值(可以通过配置文件设置, 默认80), 便要开始溢写, 但溢写之前会有一个sort操作, 这个sort操作先把Kvbuffer中的数据按照partition值和key两个关键字来排序, 移动的只是索引数据, 排序结果是Kvmeta中数据按照partition为单位聚集在一起, 同一partition内的按照key有序</p></li><li><p>spill(溢写)</p><p>当排序完成, 便开始把数据刷到磁盘, 刷磁盘的过程以分区为单位. 一个分区写完, 写下一个分区, 分区内数据有序, 最终实际上会多次溢写, 然后生成多个文件</p></li><li><p>merge(合并)</p><p>spill会生成多个小文件, 对于Reduce端拉取数据是相当低效的, 那么这时候就有了merge的过程, 合并的过程也是同分片的合并成一个片段(segment), 最终所有的segment组装成一个最终文件, 那么合并过程就完成了</p></li><li><p>Reduce端fetch copy(拉取拷贝)</p><p>Reduce任务通过向各个Map任务拉取对应分片. 这个过程都是以Http协议完成, 每个Map节点都会启动一个常驻的HTTP server服务, Reduce节点会请求这个Http Server拉取数据, 这个过程完全通过网络传输, 所以是一个非常重量级的操作</p></li><li><p>merge sort(合并排序)</p><p>Reduce端拉取到各个Map节点对应分片的数据之后, 会进行再次排序, 排序完成, 结果丢给Reduce函数进行计算</p></li></ol></blockquote></li><li><p>MapReduce运行流程</p><p>了解MapReduce各阶段的工作细节后, 我们跳出细节看看MapReduce的整体运行流程</p><ul><li>Map任务流程<ol><li>读取HDFS中的文件. 每一行解析成一个&lt;k,v>, 每一个键值对调用一次map函数. <code>&lt;0,hello you> &lt;10,hello me></code></li><li>覆盖map(), 接收上一步产生的&lt;k,v>, 进行处理, 转换为新的&lt;k,v>输出. <code>&lt;hello,1> &lt;you,1> &lt;hello,1> &lt;me,1></code></li><li>对上一步输出的&lt;k,v>进行分区. 默认分为一个区</li><li>对不同分区中的数据按照k进行排序、分组. 分组指的是相同key的value放到一个集合中. 排序后: <code>&lt;hello,1> &lt;hello,1> &lt;me,1> &lt;you,1></code>, 分组后: <code>&lt;hello,{1,1}>&lt;me,{1}>&lt;you,{1}></code></li><li>(可选)对分组后的数据进行本地Reduce归约</li></ol></li><li>Reduce任务处理<ol><li>多个map任务的输出, 按照不同的分区, 通过网络copy到不同的reduce节点上</li><li>对多个map的输出进行合并、排序. 覆盖reduce函数, 接收的是分组后的数据, 实现自己的业务逻辑. <code>&lt;hello,2> &lt;me,1> &lt;you,1></code>处理后, 产生新的&lt;k,v>输出</li><li>对reduce输出的&lt;k,v>写到HDFS中</li></ol></li></ul><p><img src=./mapreduce-process.png alt=mapreduce-process></p></li><li><p>MapReduce作业流程</p><p>MapReduce流程是整个Job(作业)流程中的核心内容, 此外作业还包括诸如作业提交, 作业调度等其他流程</p><p><img src=./mapreduce-job.png alt=mapreduce-job></p><ul><li>作业提交<ol><li>client 调用 job.waitForCompletion 方法, 向整个集群提交 MapReduce 作业</li><li>client 向 ResourceManager 申请一个作业 ID (jobid)</li><li>ResourceManager 给 client 返回该 job 资源的提交路径和作业 id</li><li>client 提交 jar 包、切片信息和配置文件到指定的资源提交路径</li><li>client 提交完资源后, 向 ResourceManager 申请运行 MrAppMaster</li></ol></li><li>作业初始化<ol><li>当 ResourceManager 收到 client 申请请求后, 将该 job 添加到容量调度器中</li><li>某一个空闲的 NodeManager 领取到该 job</li><li>该 NodeManager 创建 Container, 并产生 MRAppmaster</li><li>MRAppmaster下载 client 提交的资源到本地</li></ol></li><li>任务分配<ol><li>MrAppMaster 向 ResourceManager 申请运行多个 maptask 任务的资源</li><li>ResourceManager 将运行 maptask 的任务分配给另外的一个或多个 NodeManager, 这些 NodeManager 分别领取任务并创建容器</li></ol></li><li>任务运行<ol><li>MrAppMaster 向接收到任务的各个 NodeManager 发送程序启动脚本, 这些NodeManager 分别通过YarnChild程序启动 maptask, maptask 对数据分区排序</li><li>MrAppMaster 等待 maptask 运行完毕后, 向 ResourceManager 申请容器, 运行 reducetask, reducetask同样像maptask一样被分配到NodeManager并由其YarnChild程序启动运行</li><li>reduce task 向 maptask 获取相应分区的数据, 将数据拷贝到本地后执行reduce任务</li><li>程序运行完毕, Job完成后, MrAppMaster 会向 ResourceManager 申请注销自己</li></ol></li></ul><blockquote><p>maptask的请求优先于reducetask, 且在maptask完成5%之前, 不会创建reducetask的请求. 注意reducetask并不需要等待job内的所有maptask都运行完成才启动, 每个reducetask都只需要等待其所分配的分片相关的maptask执行完成即可</p><p>Task运行过程中会将其进度和状态返回给MrAppMaster, 对于maptask, 进度就是其处理的输入百分比, 对于reducetask, 就需要估算. client通过定期查询MrAppMaster可以获取进度更新</p><p>Client除了向MrAppMaster请求任务进度外, 也会周期性检查作业是否完成. 作</p><p>业完成之后, MrAppMaster和 container 会清理工作状态. 作业的信息会被JobHistory存储</p><p>以备之后用户核查</p></blockquote><p><img src=./mapreduce-yarn.png alt=mapreduce-yarn></p><p><img src=./mapreduce-mr.png alt=mapreduce-mr></p><p><img src=./mapreduce-read.png alt=mapreduce-read></p><p><img src=./mapreduce-write.png alt=mapreduce-write></p></li><li><p>失效问题</p><ul><li><p>task失效</p><p>最常见的失效情况是task代码里抛出了运行时异常, 执行task的jvm在其退出之前向application master报告错误, application master会标记该task是失败状态, 释放对应的容器, 该容器所占用的资源会被其他task所利用</p><p>类似jvm突然停止工作的异常, node manager会通知application master执行task的jvm进程退出了, task也将被application master置为失败状态</p><p>对于挂起状态的task通过超时来处理, application master在很久没有收到task的进度更新后, 会将其置为失效, 超时时间可以设置. 当然也可以设置为永不超时</p><p>application master将重新调度失败的task, 重新调度将避免选择先前失效时所在的node manager. 默认情况下, 一个task失败达到4次, 该task不再尝试执行, job也将失败. 对于一些不希望task失败就直接导致job失败的应用来说, 需要设置一个参数来控制task失效在某百分比以内时不会触发job失败</p><p>task可能会被杀死, 这种状况有别于失败, 例如node manager在失效状态下, 运行其中的所有task都将被杀死, 当然用户也可以自己通过工具将其杀死, 被杀死的task, 不计入尝试次数范围</p></li><li><p>application master失效</p><p>MapReduce application master的默认失败尝试次数是2, 所以达到2次时就认为job失败, 也可以自行设置. Yarn框架也提供了application master的最大尝试次数, 同时默认也是2</p><p>application master定期向resource manager发送心跳, resource manager一旦检测到application master失败, 就会在一个新的容器中启动新的application master实例. 在这种状况下, MapReduce application master使用job的执行历史来恢复task的运行状态, 已经运行的不会再重新运行</p><p>MapReduce客户端会不断从application master那里获取job的进度, application master失效后, 客户端将自动重新定位到新的application master</p></li><li><p>node manager失效</p><p>node manager定期向resource manager发送心跳, 默认超时为10分钟. 一旦失效, 将被移出节点池. 任何运行于失效node manager所在机器上的task或application master都将得到恢复</p><p>如果一个应用在某node manager 上发生失败过多, 该node manager将被application master加入黑名单(资源管理器并不跨应用维护黑名单, 所以新job的task可能会运行于一个被某application master列入黑名单的节点), 即使其本身并没有失效. 如果超过三个task失败, MapReduce application master将在不同的节点上重新调度task</p></li><li><p>resource manager失效</p><p>resource manager一旦失效, job以及task容器无法启动, 是一件很严重的故障, 所以很有必要做HA. 应用的信息被存储在HA的状态存储中(ZooKeeper或HDFS)</p><p>新的resource manager启动时, 从状态存储中读取应用的信息, 重启application master</p><p>客户端和node manager必须处理resource manager失效问题, 因为可能和两个resource manager交互</p></li></ul></li></ol><h4 id=配置文件-7>配置文件</h4><ul><li><p><strong>$HADOOP_HOME/etc/hadoop/mapred-site.xml</strong>: hadoop中mapreduce配置文件. <a href=http://hadoop.apache.org/docs/r3.3.0/hadoop-mapreduce-client/hadoop-mapreduce-client-core/mapred-default.xml>default</a></p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:green;font-weight:700>&lt;configuration&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:green;font-weight:700>&lt;property&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;name&gt;</span>mapreduce.map.java.opts<span style=color:green;font-weight:700>&lt;/name&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;value&gt;</span>-Xmx3072m<span style=color:green;font-weight:700>&lt;/value&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;description&gt;</span>map任务的jvm最大堆内存<span style=color:green;font-weight:700>&lt;/description&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&lt;/property&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:green;font-weight:700>&lt;property&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;name&gt;</span>mapreduce.reduce.java.opts<span style=color:green;font-weight:700>&lt;/name&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;value&gt;</span>-Xmx6144m<span style=color:green;font-weight:700>&lt;/value&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;description&gt;</span>reduce任务的jvm最大堆内存<span style=color:green;font-weight:700>&lt;/description&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&lt;/property&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:green;font-weight:700>&lt;property&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;name&gt;</span>mapreduce.reduce.memory.mb<span style=color:green;font-weight:700>&lt;/name&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;value&gt;</span>8192<span style=color:green;font-weight:700>&lt;/value&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;description&gt;</span>每个reduce任务可申请的内存总量<span style=color:green;font-weight:700>&lt;/description&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&lt;/property&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:green;font-weight:700>&lt;property&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;name&gt;</span>yarn.app.mapreduce.am.env<span style=color:green;font-weight:700>&lt;/name&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;value&gt;</span>HADOOP_MAPRED_HOME=/home/xshrim/bigdata/hadoop<span style=color:green;font-weight:700>&lt;/value&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;description&gt;</span>传递给MrAppMaster的额外环境变量<span style=color:green;font-weight:700>&lt;/description&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&lt;/property&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:green;font-weight:700>&lt;property&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;name&gt;</span>mapreduce.map.memory.mb<span style=color:green;font-weight:700>&lt;/name&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;value&gt;</span>4096<span style=color:green;font-weight:700>&lt;/value&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;description&gt;</span>每个map任务可申请的内存总量<span style=color:green;font-weight:700>&lt;/description&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&lt;/property&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:green;font-weight:700>&lt;property&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;name&gt;</span>mapred.child.java.opts<span style=color:green;font-weight:700>&lt;/name&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;value&gt;</span>-Xmx4096m<span style=color:green;font-weight:700>&lt;/value&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;description&gt;</span>yarnChild的jvm最大堆内存<span style=color:green;font-weight:700>&lt;/description&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&lt;/property&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:green;font-weight:700>&lt;property&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;name&gt;</span>mapreduce.reduce.env<span style=color:green;font-weight:700>&lt;/name&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;value&gt;</span>HADOOP_MAPRED_HOME=/home/xshrim/bigdata/hadoop<span style=color:green;font-weight:700>&lt;/value&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;description&gt;</span>传递给reduce任务的额外环境变量<span style=color:green;font-weight:700>&lt;/description&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&lt;/property&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:green;font-weight:700>&lt;property&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;name&gt;</span>mapreduce.framework.name<span style=color:green;font-weight:700>&lt;/name&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;value&gt;</span>yarn<span style=color:green;font-weight:700>&lt;/value&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;description&gt;</span>执行mapreduce job运行时框架(local/classic/yarn)<span style=color:green;font-weight:700>&lt;/description&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&lt;/property&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:green;font-weight:700>&lt;property&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;name&gt;</span>mapreduce.map.env<span style=color:green;font-weight:700>&lt;/name&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;value&gt;</span>HADOOP_MAPRED_HOME=/home/xshrim/bigdata/hadoop<span style=color:green;font-weight:700>&lt;/value&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;description&gt;</span>传递给map任务的额外环境变量<span style=color:green;font-weight:700>&lt;/description&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&lt;/property&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:green;font-weight:700>&lt;property&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;name&gt;</span>yarn.nodemanager.bind-host<span style=color:green;font-weight:700>&lt;/name&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;value&gt;</span>0.0.0.0<span style=color:green;font-weight:700>&lt;/value&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;description&gt;</span>nodemanager绑定的地址<span style=color:green;font-weight:700>&lt;/description&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&lt;/property&gt;</span>
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>&lt;/configuration&gt;</span>
</span></span></code></pre></td></tr></table></div></div></li></ul><h4 id=运维命令-7>运维命令</h4><ol><li><p>执行mapreduce job</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/hadoop jar &lt;jar-path&gt; &lt;jar-args&gt; &lt;raw-path&gt; &lt;out-path&gt;
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># jar-path: 本地jar包路径</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># jar-args: main函数所在类名</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># raw-path: 原始输入数据的hdfs路径</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># out-path: 输出数据的hdfs路径</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p>Job管理</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#080;font-style:italic># 列出所有job</span>
</span></span><span style=display:flex><span>bin/hadoop job -list
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 杀死job</span>
</span></span><span style=display:flex><span>bin/hadoop job -kill &lt;jobid&gt;
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 查看指定路径下的job日志</span>
</span></span><span style=display:flex><span>bin/hadoop job -history &lt;path&gt;
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># job的详细信息</span>
</span></span><span style=display:flex><span>bin/hadoop job -history all &lt;path&gt;
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 打印map和reduce完成百分比和计数器</span>
</span></span><span style=display:flex><span>bin/hadoop job -status &lt;jobid&gt;
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 杀死任务(被杀死的任务不会重试)</span>
</span></span><span style=display:flex><span>bin/hadoop job -kill-task &lt;taskid&gt;
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 使任务失败(被失败的任务不会重试)</span>
</span></span><span style=display:flex><span>bin/hadoop job -fail-task &lt;taskid&gt;
</span></span></code></pre></td></tr></table></div></div></li></ol><h4 id=常用api-6>常用API</h4><h4 id=相关工具-6>相关工具</h4><h4 id=文章推荐-7>文章推荐</h4><ul><li><a href=http://hadoop.apache.org/docs/current/>官方文档</a></li><li><a href=https://hadoop.apache.org/docs/current/hadoop-mapreduce-client/hadoop-mapreduce-client-core/MapReduceTutorial.html>MapReduce Tutorial</a></li><li><a href=https://my.oschina.net/u/1778239/blog/3018432>剖析hadoop和Spark的Shuffle过程差异</a></li><li><a href=http://www.zhangrenhua.com/2015/12/05/hadoop-jar%E5%91%BD%E4%BB%A4%E8%AF%A6%E8%A7%A3%E4%BB%A5%E5%8F%8A%E7%AC%AC%E4%B8%89%E6%96%B9jar%E5%8C%85%E5%BC%95%E7%94%A8%E9%97%AE%E9%A2%98/>MapReduce Sample</a></li></ul><h4 id=排障经验-6>排障经验</h4><h3 id=yarn>YARN</h3><p><strong>Hadoop生态大数据资源调度管理器</strong></p><h4 id=基本概念-7>基本概念</h4><ol><li><strong>Container</strong>: 容器是Yarn对主机资源的抽象, CPU, 内存, 磁盘和网络等计算资源被封装成容器供作业任务使用, 容器不能跨主机, 一个主机上的资源可以抽象出多个容器, 容器之间是隔离的, 由NodeManager启动和管理并由ResourceManager动态调度生成和删除. Yarn中的容器与流行的Docker 容器类似, 但Docker 容器的隔离性更好一些. Yarn支持自定义容器执行器以使用Docker 创建Container</li><li><strong>Application</strong>: Yarn中的Application就是MapReduce中的Job(作业), 是运行在集群中的完成一整个计算工作的程序. 在Hadoop中Application和Job的ID是一致的</li><li><strong>ResourceManager</strong>: 资源管理器(简称RM)是Yarn的三大核心组件之一, 负责计算资源的全局调度分配和管理. ResourceManager由Scheduler(调度器)和ApplicationManager(应用管理器, 简称ASM)组成, 前者负责根据节点容量, 队列情况等为Application分配资源, 后者接受用户提交的请求, 在节点中启动ApplicationMaster, 并监控ApplicationMaster的状态, 进行必要的重启和清除</li><li><strong>ApplicationMaster</strong>: 应用主控器(简称AM)是Yarn的三个核心组件之一, 负责处理Application的执行调度, 也就是MapReduce中的MrAppMaster. ApplicationMaster是动态创建和销毁的, 且仅服务于一个具体的Application. 每当 Client 提交一个 Application 时候, 就会由ApplicationManager新建一个 ApplicationMaster , 由这个 ApplicationMaster 根据Application任务去与 ResourceManager 申请各个任务的容器资源, 获得资源后会将要运行的程序发送到容器上启动, 然后进行分布式计算, 同时监控任务的执行情况. Application执行完成后, ApplicationMaster会向ApplicationManager请求自销毁</li><li><strong>NodeManager</strong>: 节点管理器(简称NM)是Yarn的三个核心组件之一, Hadoop集群中的每个DataNode上都会运行一个NodeManager, 作为代理监控节点的资源使用情况并向ResourceManager上报节点和节点上的容器信息, 同时负责响应ApplicationMaster的请求执行容器的启停</li><li><strong>Timeline Server</strong>: 时间线服务器是Yarn的可选组件, 在Yarn中通过Timeline Server用一种通用的形式解决对application的当前和历史信息的存储和检索</li></ol><h4 id=架构特性-7>架构特性</h4><ol><li><p>集群架构</p><p><img src=./hadoop-yarn.png alt=hadoop-yarn></p><p><img src=./yarn-arch.png alt=yarn-arch></p></li><li><p>工作流程</p><ol><li>客户端向ResourceManager提交Application</li><li>ResourceManager的ApplicationManager组件指示NodeManager(运行在每一个工作节点的其中一个)为应用程序启动一个新的ApplicationMaster容器</li><li>ApplicationMaster首先向ResourceManager注册, 这样用户可以直接通过NodeManager查看应用程序的运行状态</li><li>ApplicationMaster计算应用完成所需要的资源, 然后向ResourceManager申请需要的资源(容器). ApplicationMaster在应用程序的整个生命周期内与ResourceManager保持联系, 确保其所需要资源的列表被ResourceManager严格遵守, 并且发送一些必要的Kill请求杀死任务</li><li>申请到资源后, ApplicationMaster指示NodeManager在对应的节点上创建容器</li><li>NodeManager创建容器, 设置好运行环境, 然后启动容器</li><li>各个容器定时向ApplicationMaster发送任务的运行状态和进度, 这样ApplicationMaster随时掌握各个任务的运行状态, 从而可以在任务失败时重新启动任务</li><li>应用程序完成后, ApplicationMaster会通知ResourceManager该作业已经完成并注销关闭自己</li></ol><blockquote><p>容器运行是NodeManager执行的, 容器调度则是由ResourceManager的Scheduler组件完成的, 它决定容器在哪个节点上运行</p><p>NodeManager会将节点状态和健康状况发送到ResourceManager, ResourceManager拥有全局资源视图才能分配资源</p></blockquote><p><img src=./yarn-process.jpg alt=yarn-process></p></li><li><p>时间线服务器</p><p>在hadoop2.4版本之前对任务执行的监控只开发了针对MapReduce的 Job History Server, 它可以提供给用户用户查询已经运行完成的作业的信息, 但是随着在YARN上面集成的越来越多的计算框架, 比如spark、Tez, 也有必要为基于这些计算引擎的技术开发相应的作业任务监控工具, 所以hadoop的开发人员就考虑开发一款更加通用的Job History Server. 即YARN Timeline Server</p><p><img src=./yarn-timeline.png alt=yarn-timeline></p><ul><li><p>职责</p><ul><li><p>持久化Applicatoin的具体信息</p><p>收集并检索Applicatoin或者框架的具体信息. 例如, hadoop MapReduce框架里面的与分片相关的信息, 诸如map tasks、reduce tasks、counters等. Applicatoin开发者可以在App Master端或者Applicatoin的containers中通过TimelineClient将这些信息发送给Timeline Server. 这些信息都可以通过REST API在具体App或者执行框架的UI界面查询到</p></li><li><p>持久化已完成的应用程序的Generic information</p><p>关于这一点, 在Application history server中, 显然只支持MapReduce框架的job. Generic information包括了像queue-name, 用户信息等用户程序级别的数据, 还有设置在 ApplicationSubmissionContext中的信息, 用于运行应用程序的application-attempts 列表, 关于每个application-attempt的信息, container列表以及运行在每个 application-attempt 下的每个container的信息</p></li></ul></li><li><p>结构</p><ul><li><p>Timeline Domain</p><p>Timeline Domain首先存储属主信息, 读写的ACL信息, 创建和修改时间戳. 每个Domain通过ID标识, ID必须是在YARN 集群全局唯一的</p><p>Timeline Domain为Timeline server提供了一个命名空间, 允许用户管理多个Entities, 将它们与其他用户和application隔离开来. Timeline server 安全机制定义在这一层级</p></li><li><p>Timeline Entity</p><p>Timeline Entity 包含了概念实体和它的相关event的元信息. Entity可以是一个application、application attempt、容器或者任意用户自定义的对象. 它包含 Primary filters, 用于索引timeline Store中的entities. 因此, 用户/application 应该谨慎选择他们想要存储为primary filters的信息. 其他的数据可以存储为非索引信息. 每个Entity通过EntityId和EntityType作为唯一标识</p></li><li><p>Timeline Events</p></li></ul><p>Timeline Event描述了一个application相关的特定Timeline Entity的事件. 用户可以自由定义一个event的含义, 比如启动一个application, 获得一个容器分配, 操作失败或者其他用户和集群操作相关的信息</p><p><img src=./yarn-timelinestr.jpeg alt=yarn-timelinestr></p></li></ul></li><li><p>批处理和流处理</p><ul><li><p>批处理</p><p>批处理在大数据世界有着悠久的历史. 批处理主要操作大容量静态数据集, 并在计算过程完成后返回结果</p><p>批处理模式中使用的数据集通常符合下列特征:</p><ul><li>有界: 批处理数据集代表数据的有限集合</li><li>持久: 数据通常始终存储在某种类型的持久存储位置中</li><li>大量: 批处理操作通常是处理极为海量数据集的唯一方法</li></ul><p>批处理非常适合需要访问全套记录才能完成的计算工作. 例如在计算总数和平均数时, 必须将数据集作为一个整体加以处理, 而不能将其视作多条记录的集合. 这些操作要求在计算进行过程中数据维持自己的状态
需要处理大量数据的任务通常最适合用批处理操作进行处理. 无论直接从持久存储设备处理数据集, 或首先将数据集载入内存, 批处理系统在设计过程中就充分考虑了数据的量, 可提供充足的处理资源. 由于批处理在应对大量持久数据方面的表现极为出色, 因此经常被用于对历史数据进行分析
大量数据的处理需要付出大量时间, 因此批处理不适合对处理时间要求较高的场合</p></li><li><p>流处理</p><p>流处理系统会对随时进入系统的数据进行计算. 相比批处理模式, 这是一种截然不同的处理方式. 流处理方式无需针对整个数据集执行操作, 而是对通过系统传输的每个数据项执行操作.</p><p>流处理中的数据集是"&ldquo;无边界"&ldquo;的, 这就产生了几个重要的影响:</p><ul><li>完整数据集只能代表截至目前已经进入到系统中的数据总量</li><li>工作数据集也许更相关, 在特定时间只能代表某个单一数据项</li><li>处理工作是基于事件的, 除非明确停止否则没有"尽头&rdquo;. 处理结果立刻可用, 并会随着新数据的抵达继续更新</li></ul><p>流处理系统可以处理几乎无限量的数据, 但同一时间只能处理一条(真正的流处理)或很少量(微批处理, Micro-batch Processing)数据, 不同记录间只维持最少量的状态. 虽然大部分系统提供了用于维持某些状态的方法, 但流处理主要针对副作用更少, 更加功能性的处理(Functional processing)进行优化
功能性操作主要侧重于状态或副作用有限的离散步骤. 针对同一个数据执行同一个操作会或略其他因素产生相同的结果, 此类处理非常适合流处理, 因为不同项的状态通常是某些困难、限制, 以及某些情况下不需要的结果的结合体. 因此虽然某些类型的状态管理通常是可行的, 但这些框架通常在不具备状态管理机制时更简单也更高效</p><blockquote><p>此类处理非常适合某些类型的工作负载. 有近实时处理需求的任务很适合使用流处理模式. 分析、服务器或应用程序错误日志, 以及其他基于时间的衡量指标是最适合的类型, 因为对这些领域的数据变化做出响应对于业务职能来说是极为关键的. 流处理很适合用来处理必须对变动或峰值做出响应, 并且关注一段时间内变化趋势的数据</p></blockquote></li><li><p>计算框架</p><p>鉴于这两种数据特性和处理方式的不同, 出现了一系列针对某种特定数据处理的计算框架, 这些框架主要包括:</p><ul><li><p>MapReduce: 仅批处理</p><p>MapReduce是Hadoop内置的计算框架. MapReduce将计算过程分为Map和Reduce, 每个任务需要多次执行读取和写入操作, 磁盘开销大, 依赖持久存储, 速度相对较慢, 但是MapReduce可以处理海量的数据集, 且依赖的硬件可以非常廉价, 具备极高的缩放潜力, 适合处理对时间要求不高的非常大规模数据集</p></li><li><p>Storm: 仅流处理</p><p>Apache Storm是一种侧重于极低延迟的流处理框架. Storm的流处理可对框架中名为Topology(拓扑)的DAG(Directed Acyclic Graph, 有向无环图)进行编排. 这些拓扑描述了当数据片段进入系统后, 需要对每个传入的片段执行的不同转换或步骤. Storm可以用极低延迟处理数据, 可用于希望获得最低延迟的工作负载, 与Trident配合可以支持微量批处理</p></li><li><p>Samza: 仅流处理</p><p>Apache Samza是一种与Apache Kafka消息系统紧密绑定的流处理框架. Samza可以更好地发挥Kafka独特的架构优势和保障, 提供容错、缓冲以及状态存储. Samza与Kafka之间紧密的关系使得处理步骤本身可以非常松散地耦合在一起. 无需事先协调, 即可在输出的任何步骤中增加任意数量的订阅者, 直接写入Kafka还可避免回压(Backpressure)问题, 还可以使用以本地键值存储方式实现的容错检查点系统存储数据. Samza本身很适合有多个团队需要使用(但相互之间并不一定紧密协调)不同处理阶段的多个数据流的组织. Samza可大幅简化很多流处理工作, 可实现低延迟的性能. 如果部署需求与当前系统不兼容, 也许并不适合使用, 但如果需要极低延迟的处理, 或对严格的一次处理语义有较高需求, 此时依然适合考虑</p></li><li><p>Spark: 批处理和流处理</p><p>Apache Spark是一种包含流处理能力的下一代批处理框架. 与Hadoop的MapReduce引擎基于各种相同原则开发而来的Spark主要侧重于通过完善的内存计算和处理优化机制加快批处理工作负载的运行速度. Spark可作为独立集群部署(需要相应存储层的配合), 或可与Hadoop集成并取代MapReduce引擎. 与MapReduce不同, Spark的数据处理工作全部在内存中进行, 只在一开始将数据读入内存, 以及将最终结果持久存储时需要与存储层交互, 所有中间态的处理结果均存储在内存中. 除了在内存中处理方式可大幅改善性能, Spark因为通过提前对整个任务集进行分析可以实现更完善的整体式优化, 在处理与磁盘有关的任务时速度也有很大提升. Spark本身在设计上主要面向批处理工作负载. 为了实现内存中批计算, Spark会使用一种名为Resilient Distributed Dataset(弹性分布式数据集), 即RDD的模型来处理数据. 而流处理能力是由Spark Streaming实现的, 该技术引入微批(Micro-batch)的概念, 将数据流视作一系列非常小的"批&rdquo;, 借此即可通过批处理引擎的原生语义进行处理, Spark Streaming会以亚秒级增量对流进行缓冲, 随后这些缓冲会作为小规模的固定数据集进行批处理. 这种方式的实际效果非常好, 但相比真正的流处理框架在性能方面依然存在不足. Spark相比MapReduce拥有更快的速度, 且架构多样化, 可同时支持批处理和流处理, 拥有丰富的生态系统, 任务编写也比MapReduce简单, 其缺点是流处理的缓冲机制不适合对延迟要求较高的工作负载, 且由于大量使用内存成本更高. Spark是多样化工作负载处理任务的最佳选择. Spark批处理能力以更高内存占用为代价提供了无与伦比的速度优势. 对于重视吞吐率而非延迟的工作负载, 则比较适合使用Spark Streaming作为流处理解决方案</p></li><li><p>Flink: 批处理和流处理</p><p>Apache Flink是一种新兴的可以处理批处理任务的流处理框架. Flink可将批处理数据视作具备有限边界的数据流, 借此将批处理任务作为流处理的子集加以处理. 为所有处理任务采取流处理为先的方法会产生一系列有趣的副作用. 这种流处理为先的方法也叫做Kappa架构, 与之相对的是更加被广为人知的Lambda架构(该架构中使用批处理作为主要处理方法, 使用流作为补充并提供早期未经提炼的结果). Kappa架构中会对一切进行流处理, 借此对模型进行简化, 而这一切是在最近流处理引擎逐渐成熟后才可行的. Flink的流处理模型在处理传入数据时会将每一项视作真正的数据流. Flink提供的DataStream API可用于处理无尽的数据流. 为了在计算过程中遇到问题后能够恢复, 流处理任务会在预定时间点创建快照. 为了实现状态存储, Flink可配合多种状态后端系统使用, 具体取决于所需实现的复杂度和持久性级别. Flink的批处理模型在很大程度上仅仅是对流处理模型的扩展. 此时模型不再从持续流中读取数据, 而是从持久存储中以流的形式读取有边界的数据集, Flink会对这些处理模型使用完全相同的运行时, 但可以对批处理工作负载实现一定的优化. Flink目前是处理框架领域一个独特的技术, 虽然Spark也可以执行批处理和流处理, 但Spark的流处理采取的微批架构使其无法适用于很多用例. Flink流处理为先的方法可提供低延迟, 高吞吐率, 近乎逐项处理的能力. Flink的很多组件是自行管理的, 可自行管理内存, 自行处理数据分区和自动缓存, 待处理数据的特征发生变化后无需手工优化和调整. Flink提供了基于Web的调度视图, 借此可轻松管理任务并查看系统状态, 能很好地与其他组件配合使用. Flink最大的局限之一在于这依然是一个非常"年幼"的项目. 现实环境中该项目的大规模部署尚不如其他处理框架那么常见, 对于Flink在缩放能力方面的局限目前也没有较为深入的研究. 随着快速开发周期的推进和兼容包等功能的完善, 当越来越多的组织开始尝试时, 可能会出现越来越多的Flink部署. Flink提供了低延迟流处理, 同时可支持传统的批处理任务. Flink也许最适合有极高流处理需求, 并有少量批处理任务的组织. 该技术可兼容原生Storm和Hadoop程序, 可在YARN管理的集群上运行, 因此可以很方便地进行评估. 快速进展的开发工作使其值得被大家关注</p></li></ul></li></ul><p><img src=./yarn-arch.jpeg alt=yarn-arch></p></li><li><p>插件化支持</p><ul><li><p>调度器</p><p>Yarn默认的调度器存在当大量的job提交、用尽所有计算资源后, 新的job要等待很久才能被处理, 即便新的job是非常重要的任务, 也只能等待的问题. 可以通过<code>scheduler plugin</code>(例如: <code>FIFO Scheduler</code>、<code>Fair Scheduler</code>、<code>Capacity Scheduler</code>)的方式, 配置不同的资源调度规则, 来尽量缓解该问题, 让重要的job可以优先获得资源调配</p></li><li><p>计算框架</p><p>Yarn是一种支持多种计算框架的资源统一管理和调度的全局资源管理器. 支持MapReduce, Tez, Storm, Samza, Spark, Flink等全部流行的计算框架</p></li><li><p>容器执行器</p><p>在 Yarn 的架构中, 将集群中的计算资源(主要是内存和 CPU)封装抽象出了 Container 的概念, 类似于 <code>container_001 &lt;memory:2048, vCores:1></code>. Container 由 ResourceManager 负责调度与分配, 由资源所在的 NodeManager 负责启动与管理</p><p>Container 所封装的计算资源是由集群中的 NodeManager 提供的, 所以 Container 的启动、运行、监控和管理也需要对应的 NodeManager 来执行. ContainerExecutor 正是 NodeManager 用来启动与管理 Container 的工具</p><p>Yarn 3.0 版本中, 在 Linux 系统环境下, ContainerExecutor 有两种实现:</p><ul><li><p>DefaultContainerExecutor: 简称 DCE ,, 如其名, 是默认的 ContainerExecutor 实现. 如果用户未指定 ContainerExecutor 的具体实现, NM 就会使用它. DCE 直接使用 bash 来启动 container 进程, 所有 container 都使用 NM 进程用户 (yarn) 启动</p></li><li><p>LinuxContainerExecutor: 简称 LCE, 相比于 DCE , 它能提供更多有用的功能, 如用户权限隔离, 支持使用提交任务用户来启动 container, 支持使用 cgroup 进行资源限制, 支持运行 docker container (合并了 2.x 版本中的 DockerContainerExecutor). LCE 使用可执行的二进制文件 container-executor 来启动 container 进程, container 的用户根据配置可以统一使用默认用户, 也可以使用提交任务的用户(需要提前在 NM 上添加所有支持的用户)</p></li></ul><p>LCE 是安全的 ContainerExecutor. 在默认的情况下, 如果我们的集群是 non-secure , 而且没有什么特殊需求时, 使用 DCE 就足够了, 因为 DCE 配置和使用都很简单. 但是当我们的集群要求安全性, 比如开启了 kerberos 验证, 我们就必须使用 LCE, 使用 DCE 的话 MapReduce 任务会在 reduce shuffle 阶段失败退出</p></li></ul></li></ol><h4 id=配置文件-8>配置文件</h4><ul><li><p><strong>$HADOOP_HOME/etc/hadoop/yarn-site.xml</strong>: hadoop中core配置文件. <a href=http://hadoop.apache.org/docs/r3.3.0/hadoop-yarn/hadoop-yarn-common/yarn-default.xml>default</a></p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 37
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 38
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 39
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 40
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 41
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 42
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 43
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 44
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 45
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 46
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 47
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 48
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 49
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 50
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 51
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 52
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 53
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 54
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 55
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 56
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 57
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 58
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 59
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 60
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 61
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 62
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 63
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 64
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 65
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 66
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 67
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 68
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 69
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 70
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 71
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 72
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 73
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 74
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 75
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 76
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 77
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 78
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 79
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 80
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 81
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 82
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 83
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 84
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 85
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 86
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 87
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 88
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 89
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 90
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 91
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 92
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 93
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 94
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 95
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 96
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 97
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 98
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 99
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">100
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">101
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">102
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">103
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">104
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">105
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">106
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">107
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">108
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">109
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">110
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">111
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">112
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">113
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">114
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">115
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">116
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">117
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">118
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">119
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">120
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">121
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">122
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">123
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">124
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">125
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">126
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">127
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">128
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">129
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">130
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">131
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:green;font-weight:700>&lt;configuration&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:green;font-weight:700>&lt;property&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;name&gt;</span>yarn.timeline-service.enabled<span style=color:green;font-weight:700>&lt;/name&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;value&gt;</span>true<span style=color:green;font-weight:700>&lt;/value&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;description&gt;</span>启用timeline server<span style=color:green;font-weight:700>&lt;/description&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&lt;/property&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:green;font-weight:700>&lt;property&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;name&gt;</span>yarn.scheduler.capacity.root.default.maximum-allocation-vcores<span style=color:green;font-weight:700>&lt;/name&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;value&gt;</span>4<span style=color:green;font-weight:700>&lt;/value&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;description&gt;</span>每一个容器最大可申请的CPU核数<span style=color:green;font-weight:700>&lt;/description&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&lt;/property&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:green;font-weight:700>&lt;property&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;name&gt;</span>yarn.resourcemanager.system-metrics-publisher.enabled<span style=color:green;font-weight:700>&lt;/name&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;value&gt;</span>true<span style=color:green;font-weight:700>&lt;/value&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;description&gt;</span>是否发布系统级指标<span style=color:green;font-weight:700>&lt;/description&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&lt;/property&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:green;font-weight:700>&lt;property&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;name&gt;</span>yarn.resourcemanager.store.class<span style=color:green;font-weight:700>&lt;/name&gt;&lt;value&gt;</span>org.apache.hadoop.yarn.server.resourcemanager.recovery.FileSystemRMStateStore<span style=color:green;font-weight:700>&lt;/value&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&lt;/property&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&lt;description&gt;</span>Application状态信息数据持久化方式(RM HA模式必须为ZKRMStateStore), 用于Application恢复<span style=color:green;font-weight:700>&lt;/description&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:green;font-weight:700>&lt;property&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&lt;name&gt;</span>yarn.nodemanager.disk-health-checker.max-disk-utilization-per-disk-percentage<span style=color:green;font-weight:700>&lt;/name&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&lt;value&gt;</span>98.5<span style=color:green;font-weight:700>&lt;/value&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&lt;description&gt;</span>磁盘健康检查阈值<span style=color:green;font-weight:700>&lt;/description&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&lt;/property&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:green;font-weight:700>&lt;property&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;name&gt;</span>yarn.log.server.url<span style=color:green;font-weight:700>&lt;/name&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;value&gt;</span>http://historyserver:8188/applicationhistory/logs/<span style=color:green;font-weight:700>&lt;/value&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;description&gt;</span>日志服务器地址<span style=color:green;font-weight:700>&lt;/description&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&lt;/property&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:green;font-weight:700>&lt;property&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;name&gt;</span>yarn.resourcemanager.fs.state-store.uri<span style=color:green;font-weight:700>&lt;/name&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;value&gt;</span>/rmstate<span style=color:green;font-weight:700>&lt;/value&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;description&gt;</span>状态存储路径<span style=color:green;font-weight:700>&lt;/description&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&lt;/property&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:green;font-weight:700>&lt;property&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;name&gt;</span>yarn.timeline-service.generic-application-history.enabled<span style=color:green;font-weight:700>&lt;/name&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;value&gt;</span>true<span style=color:green;font-weight:700>&lt;/value&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;description&gt;</span>client是否通过timeline history-service查询通用的application数据<span style=color:green;font-weight:700>&lt;/description&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&lt;/property&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:green;font-weight:700>&lt;property&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;name&gt;</span>yarn.log-aggregation-enable<span style=color:green;font-weight:700>&lt;/name&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;value&gt;</span>true<span style=color:green;font-weight:700>&lt;/value&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;description&gt;</span>是否开启日志聚合<span style=color:green;font-weight:700>&lt;/description&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&lt;/property&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:green;font-weight:700>&lt;property&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;name&gt;</span>yarn.resourcemanager.hostname<span style=color:green;font-weight:700>&lt;/name&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;value&gt;</span>resourcemanager<span style=color:green;font-weight:700>&lt;/value&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;description&gt;</span>resourcemanager主机名<span style=color:green;font-weight:700>&lt;/description&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&lt;/property&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:green;font-weight:700>&lt;property&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;name&gt;</span>yarn.scheduler.capacity.root.default.maximum-allocation-mb<span style=color:green;font-weight:700>&lt;/name&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;value&gt;</span>8192<span style=color:green;font-weight:700>&lt;/value&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;description&gt;</span>每一个容器最大可申请的内存大小<span style=color:green;font-weight:700>&lt;/description&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&lt;/property&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&lt;property&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;name&gt;</span>yarn.nodemanager.aux-services<span style=color:green;font-weight:700>&lt;/name&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;value&gt;</span>mapreduce_shuffle<span style=color:green;font-weight:700>&lt;/value&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;description&gt;</span>使用的shuffle服务<span style=color:green;font-weight:700>&lt;/description&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&lt;/property&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&lt;property&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;name&gt;</span>yarn.resourcemanager.resource_tracker.address<span style=color:green;font-weight:700>&lt;/name&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;value&gt;</span>resourcemanager:8031<span style=color:green;font-weight:700>&lt;/value&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;description&gt;</span>资源跟踪地址<span style=color:green;font-weight:700>&lt;/description&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&lt;/property&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:green;font-weight:700>&lt;property&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;name&gt;</span>yarn.timeline-service.hostname<span style=color:green;font-weight:700>&lt;/name&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;value&gt;</span>historyserver<span style=color:green;font-weight:700>&lt;/value&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;description&gt;</span>timeline服务主机名<span style=color:green;font-weight:700>&lt;/description&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&lt;/property&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:green;font-weight:700>&lt;property&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;name&gt;</span>yarn.resourcemanager.scheduler.address<span style=color:green;font-weight:700>&lt;/name&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;value&gt;</span>resourcemanager:8030<span style=color:green;font-weight:700>&lt;/value&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;description&gt;</span>调度器地址<span style=color:green;font-weight:700>&lt;/description&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&lt;/property&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:green;font-weight:700>&lt;property&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;name&gt;</span>yarn.resourcemanager.address<span style=color:green;font-weight:700>&lt;/name&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;value&gt;</span>resourcemanager:8032<span style=color:green;font-weight:700>&lt;/value&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;description&gt;</span>资源管理器地址<span style=color:green;font-weight:700>&lt;/description&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&lt;/property&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:green;font-weight:700>&lt;property&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;name&gt;</span>mapred.map.output.compress.codec<span style=color:green;font-weight:700>&lt;/name&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;value&gt;</span>org.apache.hadoop.io.compress.SnappyCodec<span style=color:green;font-weight:700>&lt;/value&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;description&gt;</span>map输出压缩编码<span style=color:green;font-weight:700>&lt;/description&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&lt;/property&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:green;font-weight:700>&lt;property&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;name&gt;</span>yarn.nodemanager.remote-app-log-dir<span style=color:green;font-weight:700>&lt;/name&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;value&gt;</span>/app-logs<span style=color:green;font-weight:700>&lt;/value&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;description&gt;</span>日志汇总路径<span style=color:green;font-weight:700>&lt;/description&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&lt;/property&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:green;font-weight:700>&lt;property&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;name&gt;</span>yarn.resourcemanager.scheduler.class<span style=color:green;font-weight:700>&lt;/name&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&lt;value&gt;</span>org.apache.hadoop.yarn.server.resourcemanager.scheduler.capacity.CapacityScheduler<span style=color:green;font-weight:700>&lt;/value&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;description&gt;</span>使用的调度器<span style=color:green;font-weight:700>&lt;/description&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&lt;/property&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:green;font-weight:700>&lt;property&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;name&gt;</span>mapreduce.map.output.compress<span style=color:green;font-weight:700>&lt;/name&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;value&gt;</span>true<span style=color:green;font-weight:700>&lt;/value&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;description&gt;</span>map输出是否压缩<span style=color:green;font-weight:700>&lt;/description&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&lt;/property&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:green;font-weight:700>&lt;property&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;name&gt;</span>yarn.nodemanager.resource.memory-mb<span style=color:green;font-weight:700>&lt;/name&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;value&gt;</span>16384<span style=color:green;font-weight:700>&lt;/value&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;description&gt;</span>可为容器分配的内存大小<span style=color:green;font-weight:700>&lt;/description&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&lt;/property&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:green;font-weight:700>&lt;property&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;name&gt;</span>yarn.resourcemanager.recovery.enabled<span style=color:green;font-weight:700>&lt;/name&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;value&gt;</span>true<span style=color:green;font-weight:700>&lt;/value&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;description&gt;</span>是否启用Application自动恢复<span style=color:green;font-weight:700>&lt;/description&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&lt;/property&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:green;font-weight:700>&lt;property&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;name&gt;</span>yarn.nodemanager.resource.cpu-vcores<span style=color:green;font-weight:700>&lt;/name&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;value&gt;</span>8<span style=color:green;font-weight:700>&lt;/value&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;description&gt;</span>可为容器分配的CPU核数<span style=color:green;font-weight:700>&lt;/description&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&lt;/property&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:green;font-weight:700>&lt;property&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;name&gt;</span>yarn.resourcemanager.bind-host<span style=color:green;font-weight:700>&lt;/name&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;value&gt;</span>0.0.0.0<span style=color:green;font-weight:700>&lt;/value&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;description&gt;</span>resourcemanager绑定地址<span style=color:green;font-weight:700>&lt;/description&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&lt;/property&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:green;font-weight:700>&lt;property&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;name&gt;</span>yarn.nodemanager.bind-host<span style=color:green;font-weight:700>&lt;/name&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;value&gt;</span>0.0.0.0<span style=color:green;font-weight:700>&lt;/value&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;description&gt;</span>nodemanager绑定地址<span style=color:green;font-weight:700>&lt;/description&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&lt;/property&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:green;font-weight:700>&lt;property&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;name&gt;</span>yarn.timeline-service.bind-host<span style=color:green;font-weight:700>&lt;/name&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;value&gt;</span>0.0.0.0<span style=color:green;font-weight:700>&lt;/value&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;description&gt;</span>timeline server绑定地址<span style=color:green;font-weight:700>&lt;/description&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&lt;/property&gt;</span>
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>&lt;/configuration&gt;</span>
</span></span></code></pre></td></tr></table></div></div></li></ul><h4 id=运维命令-8>运维命令</h4><ol><li><p>应用管理</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#080;font-style:italic># 查看application列表</span>
</span></span><span style=display:flex><span>yarn application -list
</span></span><span style=display:flex><span>yarn application -list -appStates ALL
</span></span><span style=display:flex><span>yarn application -list -appStates RUNNING
</span></span><span style=display:flex><span>yarn application -list -appTypes MAPREDUCE
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 杀死application</span>
</span></span><span style=display:flex><span>yarn  application -kill &lt;applicationid&gt;
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 查看application状态</span>
</span></span><span style=display:flex><span>yarn application -status &lt;applicationid&gt;
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 查看application日志</span>
</span></span><span style=display:flex><span>yarn logs -applicationId &lt;applicationid&gt;
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># 移动application到其他队列</span>
</span></span><span style=display:flex><span>yarn application -movetoqueue &lt;applicationid&gt; -queue other
</span></span></code></pre></td></tr></table></div></div></li><li><p>节点管理</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#080;font-style:italic># 查看各node上的application</span>
</span></span><span style=display:flex><span>yarn  node --list
</span></span></code></pre></td></tr></table></div></div></li></ol><h4 id=常用api-7>常用API</h4><h4 id=相关工具-7>相关工具</h4><h4 id=文章推荐-8>文章推荐</h4><ul><li><a href=http://hadoop.apache.org/docs/current/>官方文档</a></li><li><a href="https://blog.csdn.net/han_zw/article/details/84823008?utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromMachineLearnPai2%7Edefault-2.control&dist_request_id=&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromMachineLearnPai2%7Edefault-2.control">The YARN Timeline Server</a></li><li><a href=https://hadoop.apache.org/docs/r3.1.1/hadoop-yarn/hadoop-yarn-site/DockerContainers.html>DockerContainerExecutor</a></li><li><a href=https://www.jianshu.com/p/5cc07eae1a0c>批处理和流处理</a></li></ul><h4 id=排障经验-7>排障经验</h4><h3 id=hadoop>Hadoop</h3><p><strong>分布式数据存储与分析框架</strong></p><h4 id=基本概念-8>基本概念</h4><ul><li><strong>BigData</strong>: 大数据是指高速 (Velocity) 涌现的大量 (Volume) 的多样化 (Variety) 数据, 表示越来越庞大、越来越复杂的数据集. 大数据技术就是围绕大数据的采集, 集成, 管理, 分析, 可视化等一系列挖掘数据价值的相关技术</li><li><strong>HDFS</strong>: 全称Hadoop Distributed File System, 是一个可扩展、容错、高性能的分布式文件系统, 异步复制, 一次写入多次读取. HDFS是Hadoop四大组件之一(核心, Storage layer), 主要负责数据存储</li><li><strong>MapReduce</strong>: Hadoop内置的大规模数据集分布式并行计算框架, MapReduce框架基于MapReduce编程模型实现, 是一种成本低廉的批处理离线计算框架. MapReduce是hadoop四大组件之一(核心, Processing layer), 主要负责数据计算</li><li><strong>YARN</strong>: Hadoop集成的新一代全局资源管理与调度框架, 负责为计算任务分配计算资源, 支持多种计算框架. Yarn是hadoop四大组件之一(核心, Resource Management layer), 主要负责资源管理与调度</li><li><strong>Common</strong>: Hadoop内支持其他模块的工具模块, Common是hadoop四大组件之一, 负责为其他hadoop模块提供基础设施, 是其他组件的底层指出, 主要提供基础工具包和 RPC 框架等</li></ul><h4 id=架构特性-8>架构特性</h4><ol><li><p>集群架构</p><p><img src=./hadoop-architecture.jpg alt=hadoop-architecture></p></li><li><p>生态系统</p><p><img src=./hadoop-ecosys.drawio.png alt=hadoop-ecosys.drawio></p><p><img src=./hadoop-ecosystem.jpg alt=hadoop-ecosystem></p><p>大数据领域的核心是Hadoop, 虽然Hadoop本身只包括四大组件, 但围绕着Hadoop诞生了众多的大数据相关项目, 形成了庞大的Hadoop大数据生态圈:</p><ul><li><p><strong>Zookeeper</strong>: Zookeeper是流行的分布式协调服务, 它并不是为大数据设计, 大量的分布式系统依赖Zookeeper实现分布式一致性</p><p><img src=./hadoop-zk.jpg alt=hadoop-zk></p></li><li><p><strong>Kafka</strong>: Kafka是高吞吐量的分布式发布订阅消息队列系统, 它并不是为大数据设计, 在大数据生态系统中, 可以将Kafka作为数据交换枢纽, 不同类型的分布式系统(关系数据库、NoSQL数据库、流处理系统、批处理系统等), 可以统一接入到Kafka, 实现和Hadoop各个组件之间的不同类型数据的实时高效交换, 较好地满足各种企业应用需求</p><p><img src=./hadoop-kafka.jpg alt=hadoop-kafka></p></li><li><p><strong>HBase</strong>: HBase是分布式可扩展的大数据列式数据库, 基于bigtable模型, 使用HDFS作为其底层存储系统, 支持大规模数据的随机和实时读写访问</p><p><img src=./hadoop-hbase.jpg alt=hadoop-hbase></p><p><img src=./hadoop-hbase1.png alt=hadoop-hbase1></p></li><li><p><strong>Spark</strong>: spark是当前最流行的大数据内存计算框架, 可独立部署或与Hadoop集成, 相比MapReduce性能提升明显, 特别适合迭代计算场景. spark能够同时支持批处理和微批流处理. spark生态系统已经发展成为一个包含多个子项目的集合, 其中包含SparkSQL、Spark Streaming、GraphX、MLib、SparkR等子项目, 能够处理大数据计算中的大多数场景</p><p><img src=./hadoop-spark.png alt=hadoop-spark></p><p><img src=./hadoop-spark2.png alt=hadoop-spark2></p></li><li><p><strong>Storm</strong>: Storm是一个开源的分布式流处理计算框架, 具有低延迟、容错、高可用等特性. 它可以轻松可靠地处理无限数据流, 是实时分析、在线机器学习、持续计算、分布式 RPC 、ETL 的优良选择</p><p><img src=./hadoop-storm.jpg alt=hadoop-storm></p><p><img src=./hadoop-storm2.png alt=hadoop-storm2></p></li><li><p><strong>Flink</strong>: Flink是一个面向数据流处理和批量数据处理的开源框架和分布式处理引擎, 完全兼容Hadoop, 具有高吞吐、低延迟、高扩展、支持容错等特性, Flink和Spark都是下一代大数据计算引擎的有力竞争者</p><p><img src=./hadoop-flink.jpg alt=hadoop-flink></p><p><img src=./hadoop-flink2.png alt=hadoop-flink2></p></li><li><p><strong>Tez</strong>: Tez是开源的支持DAG(有向无环图)作业的计算框架, 通过DAG作业的方式运行MapReduce 作业, 提供了程序运行的整体处理逻辑, 就可以去除工作流当中多余的Map阶段, 减少不必要的操作, 提升数据处理的性能. 可以让Tez 框架运行在YARN 框架之上, 然后让MapReduce、Pig 和Hive等计算框架运行在Tez框架之上, 从而借助于Tez 框架实现对MapReduce、Pig 和Hive等的性能优化, 更好地解决现有MapReduce框架在迭代计算(如PageRank计算)和交互式计算方面存在的问题</p><p><img src=./hadoop-tez.png alt=hadoop-tez></p><p><img src=./hadoop-tez2.png alt=hadoop-tez2></p></li><li><p><strong>Hive</strong>: Hive是建立在Hadoop基础上的数据仓库软件包, 支持将结构化数据文件映射为数据库表并提供类SQL查询语言HiveQL实现简单的SQL查询功能, 通过HiveQL能够将SQL语句转换为MapReduce作业, Hive依赖HDFS和MapReduce进行数据存储和任务计算, 利用Hive能够降低Hadoop使用门槛, 特别适合数据仓库统计分析</p><p><img src=./hadoop-hive2.jpg alt=hadoop-hive2></p><p><img src=./hadoop-hive.svg alt=hadoop-hive></p></li><li><p><strong>Pig</strong>: Pig与Hive类似, 也是对大数据集进行分析和评估的工具, 不同于Hive的是Pig提供了一种高层的, 面向领域的抽象语言Pig Latin. 同样Pig也可以将Pig Latin转化为MapReduce作业. 相比与SQL, Pig Latin更加灵活, 但学习成本更高</p><p><img src=./hadoop-pig.png alt=hadoop-pig></p></li><li><p><strong>Impala</strong>: Impala可以对存储HDFS、HBase的海量数据提供交互查询的SQL接口. 除了和Hive使用相同的统一存储平台, Impala也使用相同的元数据, SQL语法, ODBC驱动程序和用户界面. Impala还提供了一个熟悉的面向批量或者实时查询的统一平台. Impala的特点是查询非常迅速, 其性能大幅度领先于Hive. Impala并不是基于MapReduce的, 它的定位是OLAP, 是Google的新三驾马车之一Dremel的开源实现</p><p><img src=./hadoop-impala.webp alt=hadoop-impala></p></li><li><p><strong>Solr</strong>: Solr是基于Lucene的高性能全文检索引擎, 通过与HBase配合, 建立HBase表中条件过滤字段和rowkey索引可以实现快速的大数据条件查询</p><p><img src=./hadoop-solr.png alt=hadoop-solr></p></li><li><p><strong>Mahout</strong>: Mahout是一个机器学习和数据挖掘库, 它利用MapReduce编程模型实现k-means, Native, Bayes, Collaborative Filtering等经典的机器学习算法, 并使其具有良好的可扩展性</p><p><img src=./hadoop-mahout.png alt=hadoop-mahout></p></li><li><p><strong>Kylin</strong>: Kylin是一个开源的分布式分析型数据仓库, 提供Hadoop/Spark 之上的 SQL查询接口及多维分析(OLAP)能力以支持超大规模数据, 能够在亚秒内查询巨大的表</p><p><img src=./hadoop-kylin.png alt=hadoop-kylin></p></li><li><p><strong>Sqoop</strong>: Sqoop是开源的数据转换工具, 主要用于在Hadoop(Hive)与传统的数据库(mysql、postgresql等)间进行数据的传递, 可以将一个关系型数据库中的数据导入到Hadoop的HDFS中, 也可以将HDFS的数据导出到关系型数据库中</p><p><img src=./hadoop-sqoop.webp alt=hadoop-sqoop></p></li><li><p><strong>Flume</strong>: Flume是一个高可用, 高可靠, 分布式的海量日志采集、聚合和传输系统. 它是hadoop生态系统的日志采集系统, 用途广泛, 可以将日志、网络数据、kafka消息收集并存储在大数据HDFS系统之上. 现在Flume特指第二代Flume, 即flume-ng</p><p><img src=./hadoop-flume.png alt=hadoop-flume></p></li><li><p><strong>Oozie</strong>: Oozie是一个管理Hadoop作业(job)的工作流程调度管理系统, 是一个可伸缩、可靠和可扩展的系统. Oozie协调作业就是通过时间(频率)和有效数据触发当前的Oozie工作流程, Oozie与Hadoop生态圈的其他部分集成在一起, 支持多种类型的Hadoop作业(如Java map-reduce、流式map-reduce、Pig、Hive、Sqoop和Distcp)以及特定于系统的工作(如Java程序和shell脚本)</p><p><img src=./hadoop-oozie.png alt=hadoop-oozie></p></li><li><p><strong>Ranger</strong>: Ranger是大数据领域一个集中式安全管理框架, 管理授权和审计, 是Hadoop生态的综合安全管理组件. 通过制定策略(policies)实现对诸如HDFS、Yarn、Hive、Kafka、HBase、Storm等组件进行细粒度的权限控制. 通过Ranger控制台, 管理员通过配置策略来控制用户访问权限. 比如可以控制用户读取HDFS文件权限, 甚至可以控制用户对Hive某列的访问权限</p></li><li><p><img src=./hadoop-ranger2.png alt=hadoop-ranger2></p></li><li><p><img src=./hadoop-ranger.png alt=hadoop-ranger></p></li><li><p><strong>Atlas</strong>: Atlas是Hadoop社区为解决Hadoop生态系统的元数据治理问题而产生的开源项目, 它为Hadoop集群提供了包括数据分类、集中策略引擎、数据血缘、安全和生命周期管理在内的元数据治理核心功能. Atlas支持各种Hadoop和非Hadoop元数据类型, 提供了丰富的REST API进行集成, 对数据血缘的追溯达到了字段级别, 对权限也有很好的控制</p><p><img src=./hadoop-atlas.png alt=hadoop-atlas></p></li><li><p><strong>Ambari</strong>: Ambari是开源的大数据生态部署管理工具, 它可以创建、管理、监视Hadoop整个生态圈(例如Hive，Hbase，Sqoop，Zookeeper等)的集群, 使得Hadoop以及相关的大数据软件更容易使用. Ambari本身是一个分布式架构的软件, 由Ambari Server和Ambari Agent两部分组成, 用户可通过Ambari Server通知Ambari Agent安装对应的软件, Ambari Agent会定时地发送各个机器每个软件模块的状态给Ambari Server, 最终这些状态信息会呈现在Ambari的GUI, 方便用户了解到集群的各种状态, 并进行相应的维护</p><p><img src=./hadoop-ambari.png alt=hadoop-ambari></p></li></ul></li></ol><h4 id=配置文件-9>配置文件</h4><p><strong>$HADOOP_HOME/etc/hadoop/core-site.xml</strong>: hadoop中core配置文件. <a href=http://hadoop.apache.org/docs/r3.3.0/hadoop-project-dist/hadoop-common/core-default.xml>default</a></p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:green;font-weight:700>&lt;configuration&gt;</span>
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>&lt;property&gt;&lt;name&gt;</span>hadoop.proxyuser.hue.hosts<span style=color:green;font-weight:700>&lt;/name&gt;&lt;value&gt;</span>*<span style=color:green;font-weight:700>&lt;/value&gt;&lt;/property&gt;</span>
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>&lt;property&gt;&lt;name&gt;</span>fs.defaultFS<span style=color:green;font-weight:700>&lt;/name&gt;&lt;value&gt;</span>hdfs://namenode:9000<span style=color:green;font-weight:700>&lt;/value&gt;&lt;/property&gt;</span>
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>&lt;property&gt;&lt;name&gt;</span>hadoop.http.staticuser.user<span style=color:green;font-weight:700>&lt;/name&gt;&lt;value&gt;</span>root<span style=color:green;font-weight:700>&lt;/value&gt;&lt;/property&gt;</span>
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>&lt;property&gt;&lt;name&gt;</span>io.compression.codecs<span style=color:green;font-weight:700>&lt;/name&gt;&lt;value&gt;</span>org.apache.hadoop.io.compress.SnappyCodec<span style=color:green;font-weight:700>&lt;/value&gt;&lt;/property&gt;</span>
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>&lt;property&gt;&lt;name&gt;</span>hadoop.proxyuser.hue.groups<span style=color:green;font-weight:700>&lt;/name&gt;&lt;value&gt;</span>*<span style=color:green;font-weight:700>&lt;/value&gt;&lt;/property&gt;</span>
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>&lt;property&gt;&lt;name&gt;</span>hadoop.proxyuser.hue.hosts<span style=color:green;font-weight:700>&lt;/name&gt;&lt;value&gt;</span>*<span style=color:green;font-weight:700>&lt;/value&gt;&lt;/property&gt;</span>
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>&lt;property&gt;&lt;name&gt;</span>fs.defaultFS<span style=color:green;font-weight:700>&lt;/name&gt;&lt;value&gt;</span>hdfs://namenode:9000<span style=color:green;font-weight:700>&lt;/value&gt;&lt;/property&gt;</span>
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>&lt;property&gt;&lt;name&gt;</span>hadoop.http.staticuser.user<span style=color:green;font-weight:700>&lt;/name&gt;&lt;value&gt;</span>root<span style=color:green;font-weight:700>&lt;/value&gt;&lt;/property&gt;</span>
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>&lt;property&gt;&lt;name&gt;</span>io.compression.codecs<span style=color:green;font-weight:700>&lt;/name&gt;&lt;value&gt;</span>org.apache.hadoop.io.compress.SnappyCodec<span style=color:green;font-weight:700>&lt;/value&gt;&lt;/property&gt;</span>
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>&lt;property&gt;&lt;name&gt;</span>hadoop.proxyuser.hue.groups<span style=color:green;font-weight:700>&lt;/name&gt;&lt;value&gt;</span>*<span style=color:green;font-weight:700>&lt;/value&gt;&lt;/property&gt;</span>
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>&lt;/configuration&gt;</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=运维命令-9>运维命令</h4><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span> <span style=color:#080;font-style:italic># 整个集群启停</span>
</span></span><span style=display:flex><span> sbin/start-all.sh
</span></span><span style=display:flex><span> sbin/stop-all.sh
</span></span><span style=display:flex><span> <span style=color:#080;font-style:italic># yarn启停</span>
</span></span><span style=display:flex><span> sbin/start-yarn.sh 
</span></span><span style=display:flex><span> sbin/stop-yarn.sh
</span></span><span style=display:flex><span> <span style=color:#080;font-style:italic># dfs启停</span>
</span></span><span style=display:flex><span> sbin/start-dfs.sh
</span></span><span style=display:flex><span> sbin/stop-dfs.sh
</span></span><span style=display:flex><span> <span style=color:#080;font-style:italic># 格式化zk</span>
</span></span><span style=display:flex><span> bin/hdfs zkfc -formatZK
</span></span><span style=display:flex><span> <span style=color:#080;font-style:italic># 格式化namenode</span>
</span></span><span style=display:flex><span> bin/hadoop namenode -format
</span></span><span style=display:flex><span> <span style=color:#080;font-style:italic># 启动journalnode集群</span>
</span></span><span style=display:flex><span> bin/hadoop-daemons.sh start journalnode
</span></span><span style=display:flex><span> <span style=color:#080;font-style:italic># 启动namenode</span>
</span></span><span style=display:flex><span> bin/hadoop-daemon.sh start namenode
</span></span><span style=display:flex><span> <span style=color:#080;font-style:italic># 启动datanode</span>
</span></span><span style=display:flex><span> bin/hadoop-daemon.sh start datanode
</span></span><span style=display:flex><span> <span style=color:#080;font-style:italic># 启动zkfc</span>
</span></span><span style=display:flex><span> bin/hadoop-daemon.sh start zkfc
</span></span><span style=display:flex><span> <span style=color:#080;font-style:italic># namenode变为stanbynode</span>
</span></span><span style=display:flex><span> bin/hdfs namenode -bootstrapStandby
</span></span><span style=display:flex><span> <span style=color:#080;font-style:italic># 启动resourcemanager</span>
</span></span><span style=display:flex><span> bin/start-yarn.sh
</span></span><span style=display:flex><span> bin/yarn-daemon.sh start resourcemanager
</span></span><span style=display:flex><span> <span style=color:#080;font-style:italic># 启动dfs(namenode,journalnode,datanode,zkfc都会启动)</span>
</span></span><span style=display:flex><span> sbin/start-dfs.sh
</span></span><span style=display:flex><span> <span style=color:#080;font-style:italic># 启动yarn(nodemanager, resourcemanager都会启动)</span>
</span></span><span style=display:flex><span> sbin/start-yarn.sh
</span></span><span style=display:flex><span> <span style=color:#080;font-style:italic># 启动journalnode(也可单独启动namenode, datanode)</span>
</span></span><span style=display:flex><span> sbin/hadoop-daemon.sh start journalnode
</span></span><span style=display:flex><span> <span style=color:#080;font-style:italic># 启动resourcemanager(也可单独启动nodemanager)</span>
</span></span><span style=display:flex><span> sbin/yarn-daemon.sh start resourcemanager
</span></span><span style=display:flex><span> <span style=color:#080;font-style:italic># 单独启动datanode</span>
</span></span><span style=display:flex><span> sbin/start-secure-dns.sh
</span></span><span style=display:flex><span> <span style=color:#080;font-style:italic># 下线节点</span>
</span></span><span style=display:flex><span> <span style=color:#080;font-style:italic># 修改/hadoop所在目录/etc/hadoop/slaves</span>
</span></span><span style=display:flex><span> <span style=color:#080;font-style:italic># 去掉要下线的数据节点</span>
</span></span><span style=display:flex><span> <span style=color:#080;font-style:italic># 修改/hadoop所在目录/etc/hadoop/excludes</span>
</span></span><span style=display:flex><span> <span style=color:#080;font-style:italic># 增加要下线的数据节点</span>
</span></span><span style=display:flex><span> <span style=color:#080;font-style:italic># 把这两个文件同步到所有的hadoop节点的相应目录下</span>
</span></span><span style=display:flex><span> <span style=color:#080;font-style:italic># 刷新节点列表</span>
</span></span><span style=display:flex><span> bin/hdfs dfsadmin -refreshNodes
</span></span></code></pre></td></tr></table></div></div><h4 id=文章推荐-9>文章推荐</h4><ul><li><a href=http://hadoop.apache.org/docs/current/>官方文档</a></li><li><a href=https://www.cnblogs.com/binarylei/p/8903601.html>Hadoop系列</a></li><li><a href=https://www.jianshu.com/p/59285372cc05>大数据系列</a></li><li><a href=https://xuwujing.blog.csdn.net/article/details/78637874>大数据学习系列</a></li><li><a href=https://blog.csdn.net/wjt199866/article/details/106473174>Hadoop配置文件详解</a></li><li><a href=https://www.jianshu.com/p/ed6b35f52e3c>Hadoop HDFS和MapReduce</a></li><li><a href=https://techvidvan.com/tutorials/hadoop-architecture/>Apache Hadoop Architecture</a></li><li><a href=https://zhuanlan.zhihu.com/p/94302767>大数据处理框架发展史</a></li><li><a href=https://www.cnblogs.com/laoqing/p/12091471.html>HBase架构剖析</a></li><li><a href=https://my.oschina.net/u/3875806/blog/2991993>HBase架构模型与读写流程</a></li><li><a href=https://blog.csdn.net/beliefer/article/details/79629729>Spark2.x系列</a></li><li><a href=https://ymgd.github.io/codereader/2018/03/24/Spark2.X-Deploy%E6%A8%A1%E5%9D%97%E8%A7%A3%E6%9E%90/>Spark2.x模块解析</a></li><li><a href=https://blog.csdn.net/qq_16038125/article/details/75913308>Storm架构</a></li><li><a href=https://blog.csdn.net/weiyongle1996/article/details/77142245>Storm架构与运行原理</a></li><li><a href=https://juejin.cn/post/6861119250241683464>Flink系列</a></li><li><a href=https://www.infoq.cn/article/sjrgodchr5nsfafvgjhx>Flink关键技术解析与优化实战</a></li><li><a href=https://my.oschina.net/repine/blog/667819>Tez是什么</a></li><li><a href=https://tsktech.medium.com/apache-tez-2fd0d6a1d4e3>Tez Overview</a></li><li><a href=https://waltyou.github.io/Hive-Introduce/>Hive介绍</a></li><li><a href=https://zhuanlan.zhihu.com/p/87545980>Hive架构原理</a></li><li><a href=https://www.w3cschool.cn/apache_pig/apache_pig_overview.html>Pig系列</a></li><li><a href=https://blog.csdn.net/sinat_25059791/article/details/68620549>Impala系列</a></li><li><a href=https://www.cnblogs.com/leeSmall/p/9032245.html>Solr系列</a></li><li><a href=https://www.infoq.cn/article/architecture-practice-07-solr>Solr搜索服务器</a></li><li><a href=https://blog.csdn.net/zhufenglonglove/article/details/51831845>Solr架构图</a></li><li><a href=http://www.vue5.com/mahout/mahout_quick_guide.html>Mahout快速指南</a></li><li><a href=https://www.cnblogs.com/tgzhu/p/6113334.html>Kylin系列</a></li><li><a href=https://blog.csdn.net/myrainblues/article/details/43673129>Sqoop使用手册</a></li><li><a href=https://www.jianshu.com/p/1c5c91e30079>Sqoop详解</a></li><li><a href=https://codingdict.com/article/9414>Flume系列</a></li><li><a href=https://blog.csdn.net/BeiisBei/article/details/104662977>Oozie系列</a></li><li><a href=https://blog.csdn.net/Happy_Sunshine_Boy/article/details/93171950>Ranger学习总结</a></li><li><a href=https://blog.csdn.net/qq_38247150/article/details/108756790>Atlas详解</a></li><li><a href=https://blog.csdn.net/oDaiLiDong/article/details/78052017>Atlas实践</a></li><li><a href=https://blog.csdn.net/shifenglov/article/details/41831983>Ambari系列</a></li><li><a href=https://blog.csdn.net/chengyuqiang/article/details/60963480>Ambari架构详解</a></li></ul></div><footer class=post-footer><div class=post-tags><a href=/tags/ops rel=tag title=ops>#ops#</a>
<a href=/tags/%e8%bf%90%e7%bb%b4 rel=tag title=运维>#运维#</a></div><div class=addthis_inline_share_toolbox></div><div class=post-nav><div class=article-copyright><div class=article-copyright-img><img src=/img/qq_qrcode.png width=129px height=129px><div style=text-align:center>QQ扫一扫交流</div></div><div class=article-copyright-info><p><span>声明：</span>日常运维手记</p><p><span>链接：</span>https://xshrim.github.io/post/%E6%97%A5%E5%B8%B8%E8%BF%90%E7%BB%B4%E6%89%8B%E8%AE%B0/</p><p><span>作者：</span>xshrim</p><p><span>声明： </span>本博客文章除特别声明外，均采用 <a href=https://creativecommons.org/licenses/by-nc-sa/3.0/ target=_blank style=text-decoration:underline>CC BY-NC-SA 3.0</a>许可协议，转载请注明出处！</p></div></div><div class=clear></div></div><div class=reward-qr-info><div>创作实属不易，如有帮助，那就打赏博主些许茶钱吧 ^_^</div><button id=rewardButton disable=enable onclick='var qr=document.getElementById("QR");qr.style.display==="none"?qr.style.display="block":qr.style.display="none"'>
<span>赏</span></button><div id=QR style=display:none><div id=wechat style=display:inline-block><img id=wechat_qr src=/img/wechat-pay.png alt="WeChat Pay"><p>微信打赏</p></div><div id=alipay style=display:inline-block><img id=alipay_qr src=/img/ali-pay.png alt=Alipay><p>支付宝打赏</p></div></div></div><div class=post-nav><div class="post-nav-next post-nav-item"><a href=https://xshrim.github.io/post/%E5%AE%B9%E5%99%A8%E4%BA%91%E7%A8%B3%E5%AE%9A%E6%80%A7/ rel=next title=容器云稳定性><i class="fa fa-chevron-left"></i> 容器云稳定性</a></div><div class="post-nav-prev post-nav-item"><a href=https://xshrim.github.io/post/loki%E4%BA%91%E5%8E%9F%E7%94%9F%E6%97%A5%E5%BF%97%E7%B3%BB%E7%BB%9F/ rel=prev title=Loki云原生日志系统>Loki云原生日志系统
<i class="fa fa-chevron-right"></i></a></div></div><div id=wcomments></div></footer></article></section></div></div><div class=sidebar-toggle><div class=sidebar-toggle-line-wrap><span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
<span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
<span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id=sidebar class=sidebar><div class=sidebar-inner><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target=post-toc-wrap>文章目录</li><li class=sidebar-nav-overview data-target=site-overview>站点概览</li></ul><section class="site-overview sidebar-panel"><div class="site-author motion-element" itemprop=author itemscope itemtype=http://schema.org/Person><img class=site-author-image itemprop=image src=/img/avatar.png alt=xshrim><p class=site-author-name itemprop=name>xshrim</p><p class="site-description motion-element" itemprop=description>再平凡的人也有属于他自己的梦想!</p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href=/post/><span class=site-state-item-count>15</span>
<span class=site-state-item-name>日志</span></a></div><div class="site-state-item site-state-categories"><a href=/categories/><span class=site-state-item-count>4</span>
<span class=site-state-item-name>分类</span></a></div><div class="site-state-item site-state-tags"><a href=/tags/><span class=site-state-item-count>17</span>
<span class=site-state-item-name>标签</span></a></div></nav><div class="links-of-author motion-element"><span class=links-of-author-item><a href=https://github.com/xshrim/ target=_blank title=GitHub><i class="fa fa-fw fa-github"></i>
GitHub</a></span>
<span class=links-of-author-item><a href=https://www.zhihu.com/people/xshrim target=_blank title=知乎><i class="fa fa-fw fa-globe"></i>
知乎</a></span></div><div class="links-of-blogroll motion-element links-of-blogroll-inline"><div class=links-of-blogroll-title><i class="fa fa-fw fa-globe"></i>
友情链接</div><ul class=links-of-blogroll-list><li class=links-of-blogroll-item><a href=https://www.liaoxuefeng.com/ title=廖雪峰 target=_blank>廖雪峰</a></li></ul></div><div class="tagcloud-of-blogroll motion-element tagcloud-of-blogroll-inline"><div class=tagcloud-of-blogroll-title><i class="fa fa-fw fa-tags"></i>
标签云</div><ul class=tagcloud-of-blogroll-list><li class=tagcloud-of-blogroll-item><a href=/tags/kubernetes>Kubernetes</a></li><li class=tagcloud-of-blogroll-item><a href=/tags/markdown>Markdown</a></li><li class=tagcloud-of-blogroll-item><a href=/tags/crd>Crd</a></li><li class=tagcloud-of-blogroll-item><a href=/tags/css>Css</a></li><li class=tagcloud-of-blogroll-item><a href=/tags/emoji>Emoji</a></li><li class=tagcloud-of-blogroll-item><a href=/tags/html>HTML</a></li><li class=tagcloud-of-blogroll-item><a href=/tags/log>Log</a></li><li class=tagcloud-of-blogroll-item><a href=/tags/loki>Loki</a></li><li class=tagcloud-of-blogroll-item><a href=/tags/operator>Operator</a></li><li class=tagcloud-of-blogroll-item><a href=/tags/ops>Ops</a></li></ul></div><div class="links-of-blogroll motion-element inline"><script type=text/javascript src="//rf.revolvermaps.com/0/0/6.js?i=Your%20RevolverMapId&m=7&c=e63100&cr1=ffffff&f=arial&l=0&bv=90&lx=-420&ly=420&hi=20&he=7&hc=a8ddff&rs=80" async></script></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class=post-toc><div class=post-toc-content><nav id=TableOfContents><ul><li><a href=#运维命令>运维命令</a><ul><li><a href=#进程信息>进程信息</a></li><li><a href=#系统信息>系统信息</a></li><li><a href=#网络信息>网络信息</a></li><li><a href=#日志分析>日志分析</a></li><li><a href=#抓包分析>抓包分析</a></li><li><a href=#数据库分析>数据库分析</a></li><li><a href=#容器分析>容器分析</a></li><li><a href=#jvm分析>JVM分析</a></li></ul></li><li><a href=#运维工具>运维工具</a><ul><li><a href=#ansible>Ansible</a></li></ul></li><li><a href=#运维服务>运维服务</a><ul><li><a href=#zookeeper>Zookeeper</a></li><li><a href=#kafka>Kafka</a></li><li><a href=#elasticsearch>ElasticSearch</a></li><li><a href=#prometheus>Prometheus</a></li><li><a href=#grafana>Grafana</a></li><li><a href=#loki>Loki</a></li><li><a href=#redis>Redis</a></li><li><a href=#mysql>MySQL</a></li><li><a href=#postgresql>PostgreSQL</a></li><li><a href=#mongodb>MongoDB</a></li><li><a href=#etcd>Etcd</a></li><li><a href=#kubernetes>Kubernetes</a></li><li><a href=#harbor>Harbor</a></li><li><a href=#kerberos>Kerberos</a></li><li><a href=#hdfs>HDFS</a></li><li><a href=#mapreduce>MapReduce</a></li><li><a href=#yarn>YARN</a></li><li><a href=#hadoop>Hadoop</a></li></ul></li></ul></nav></div></div></section></div></aside></div></main><footer id=footer class=footer><div class=footer-inner><div class=copyright><span class=copyright-year>&copy; 2010 - 2023</span>
<span class=with-love><i class="fa fa-heart"></i></span>
<span class=copyright-author>热爱生活与梦想</span></div><div class=powered-info><span class=powered-by>Powered by - <a class=powered-link href=//gohugo.io target=_blank title=hugo>Hugo v0.106.0</a></span>
<span class=separator-line>/</span>
<span class=theme-info>Theme by - <a class=powered-link href=//github.com/elkan1788/hugo-theme-next target=_blank>NexT</a></span></div><div class=vistor-info><span class=cnzz_icon id="cnzz_stat_icon_Your CNNZSiteId"><a href="//www.cnzz.com/stat/website.php?web_id=Your%20CNNZSiteId" target=_blank title=站长统计><img border=0 hspace=0 vspace=0 src=//icon.cnzz.com/img/pic1.gif></a></span>
<script type=text/javascript>(function(){var t,e=document.createElement("script");e.type="text/javascript",e.async=!0,e.charset="utf-8",e.src="https://s4.cnzz.com/z_stat.php?id=Your CNNZSiteId&show=pic1",t=document.getElementsByTagName("script")[0],t.parentNode.insertBefore(e,t)})()</script><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script>
<span class=site-uv><i class="fa fa-user"></i>
<span class=busuanzi-value id=busuanzi_value_site_uv></span></span>
<span class=separator-line>/</span>
<span class=site-pv><i class="fa fa-eye"></i>
<span class=busuanzi-value id=busuanzi_value_site_pv></span></span></div><div class=license-info><span class=storage-info>Storage by
<a href=https://github.com style=font-weight:700 target=_blank>Github Page</a></span>
<span class=separator-line>/</span>
<span class=license-num><a href target=_blank>-</a></span></div></div></footer><div class=back-to-top><i class="fa fa-arrow-up"></i>
<span id=scrollpercent><span>0</span>%</span></div></div><script type=text/javascript src=//cdn.bootcdn.net/ajax/libs/jquery/2.1.4/jquery.min.js></script>
<script type=text/javascript src=/js/search.js></script>
<script type=text/javascript src=/js/copycode.js></script>
<script type=text/javascript src=/js/affix.js></script>
<script type=text/javascript src=/js/scrollspy.js></script>
<script type=text/javascript>function detectIE(){var e=window.navigator.userAgent,t=e.indexOf("MSIE "),n=e.indexOf("Trident/"),s=e.indexOf("Edge/");return t>0||n>0||s>0?-1:1}function getCntViewHeight(){var t=$("#content").height(),e=$(window).height(),n=t>e?t-e:$(document).height()-e;return n}function getScrollbarWidth(){var e=$("<div />").addClass("scrollbar-measure").prependTo("body"),t=e[0],n=t.offsetWidth-t.clientWidth;return e.remove(),n}function registerBackTop(){var t=50,e=$(".back-to-top");$(window).on("scroll",function(){e.toggleClass("back-to-top-on",window.pageYOffset>t);var s=$(window).scrollTop(),o=getCntViewHeight(),i=s/o,n=Math.round(i*100),a=n>100?100:n;$("#scrollpercent>span").html(a)}),e.on("click",function(){$("html,body").animate({scrollTop:0,screenLeft:0},800)})}function initScrollSpy(){var e=".post-toc",s=$(e),t=".active-current";s.on("activate.bs.scrollspy",function(){var t=$(e+" .active").last();n(),t.addClass("active-current")}).on("clear.bs.scrollspy",n),$("body").scrollspy({target:e});function n(){$(e+" "+t).removeClass(t.substring(1))}}function initAffix(){var e=$(".header-inner").height(),t=parseInt($(".main").css("padding-bottom"),10),n=e+10;$(".sidebar-inner").affix({offset:{top:n,bottom:t}}),$(document).on("affixed.bs.affix",function(){updateTOCHeight(document.body.clientHeight-100)})}function initTOCDimension(){$(window).on("resize",function(){e&&clearTimeout(e),e=setTimeout(function(){var e=document.body.clientHeight-100;updateTOCHeight(e)},0)}),updateTOCHeight(document.body.clientHeight-100);var e,t=getScrollbarWidth();$(".post-toc").css("width","calc(100% + "+t+"px)")}function updateTOCHeight(e){e=e||"auto",$(".post-toc").css("max-height",e)}$(function(){var e=$(".header-inner").height()+10;$("#sidebar").css({"margin-top":e}).show(),$(".site-nav-toggle").on("click",function(){var e=$(".site-nav"),o=$(".toggle"),t="site-nav-on",i="toggle-close",n=e.hasClass(t),a=n?"slideUp":"slideDown",s=n?"removeClass":"addClass";e.stop()[a]("normal",function(){e[s](t),o[s](i)})}),registerBackTop(),initScrollSpy(),initAffix(),initTOCDimension(),$(".sidebar-nav-toc").click(function(){$(this).addClass("sidebar-nav-active"),$(this).next().removeClass("sidebar-nav-active"),$("."+$(this).next().attr("data-target")).toggle(500),$("."+$(this).attr("data-target")).toggle(500)}),$(".sidebar-nav-overview").click(function(){$(this).addClass("sidebar-nav-active"),$(this).prev().removeClass("sidebar-nav-active"),$("."+$(this).prev().attr("data-target")).toggle(500),$("."+$(this).attr("data-target")).toggle(500)})})</script><script src=//cdn.bootcdn.net/ajax/libs/imageviewer/0.1.0/viewer.min.js></script>
<script type=text/javascript>$(function(){$(".post-body").viewer()})</script><script type=text/javascript>$(function(){detectIE()>0?$.getScript(document.location.protocol+"//cdn.jsdelivr.net/npm/@waline/client/dist/Waline.min.js",function(){new Waline({el:"#wcomments",visitor:!0,avatar:"wavatar",avatarCDN:"https://sdn.geekzu.org/avatar/",avatarForce:!1,wordLimit:"200",placeholder:" 欢迎留下您的宝贵建议，请填写您的昵称和邮箱便于后续交流. ^_^ ",requiredFields:["nick","mail"],serverURL:"Your WalineSerURL",lang:"zh-cn"})}):$("#wcomments").html("抱歉，Waline插件不支持IE或Edge，建议使用Chrome浏览器。")})</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_SVG"></script>
<script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=Your%20AddthisId"></script>
<script>(function(){var t,e=document.createElement("script"),n=window.location.protocol.split(":")[0];n==="https"?e.src="https://zz.bdstatic.com/linksubmit/push.js":e.src="http://push.zhanzhang.baidu.com/push.js",t=document.getElementsByTagName("script")[0],t.parentNode.insertBefore(e,t)})()</script><script type=text/javascript>$(function(){if(document.body.clientWidth>900){var t=document.getElementsByTagName("HEAD").item(0),e=document.createElement("script");e.type="text/javascript",e.innerHTML=`(function(i,s,o,g,r,a,m){i["DaoVoiceObject"]=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;a.charset="utf-8";m.parentNode.insertBefore(a,m)})(window,document,"script",('https:' == document.location.protocol ? 'https:' : 'http:') + "//widget.daovoice.io/widget/Your DaoVoiceId.js","daovoice")`,t.appendChild(e),daovoice("init",{app_id:"Your DaoVoiceId"}),daovoice("update")}})</script></body></html>